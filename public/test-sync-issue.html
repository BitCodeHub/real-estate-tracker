<!DOCTYPE html>
<html>
<head>
    <title>Test Sync Issue</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #1a1a1a; color: white; }
        button { margin: 10px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .section { background: #242424; padding: 20px; margin: 20px 0; border-radius: 8px; }
        pre { background: #0a0a0a; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Property Sync Issue</h1>
    
    <div class="section">
        <h2>Step-by-Step Test</h2>
        <ol>
            <li>Click "Show Current State" to see what's in DB and localStorage</li>
            <li>Click "Simulate Add Property" to add a test property like the main app does</li>
            <li>Click "Simulate Page Reload" to see if property persists</li>
            <li>Click "Simulate Delete Property" to delete last property</li>
            <li>Click "Simulate Page Reload" again to see if delete persists</li>
        </ol>
    </div>
    
    <div class="section">
        <button onclick="showCurrentState()">Show Current State</button>
        <button onclick="simulateAddProperty()">Simulate Add Property</button>
        <button onclick="simulateReload()">Simulate Page Reload</button>
        <button onclick="simulateDeleteProperty()">Simulate Delete Property</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
    </div>
    
    <div class="section">
        <h2>Results:</h2>
        <pre id="output"></pre>
    </div>

    <script>
        let properties = [];
        const output = document.getElementById('output');
        
        function log(message, data = null) {
            const timestamp = new Date().toISOString().split('T')[1];
            output.innerHTML += `[${timestamp}] ${message}\n`;
            if (data) {
                output.innerHTML += JSON.stringify(data, null, 2) + '\n';
            }
            output.innerHTML += '\n';
        }
        
        async function showCurrentState() {
            log('=== CURRENT STATE ===');
            
            // Check database
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                log(`Database: ${data.data.length} properties`);
                data.data.slice(0, 3).forEach(p => {
                    log(`  - ID: ${p.id}, ${p.address}, hasID: ${!!p.id}`);
                });
            } catch (error) {
                log('Error fetching from database:', error.message);
            }
            
            // Check localStorage
            const localData = localStorage.getItem('properties');
            const localProps = localData ? JSON.parse(localData) : [];
            log(`LocalStorage: ${localProps.length} properties`);
            localProps.slice(0, 3).forEach(p => {
                log(`  - ID: ${p.id || 'NO ID'}, ${p.address}, hasID: ${!!p.id}`);
            });
        }
        
        async function simulateAddProperty() {
            log('=== SIMULATING ADD PROPERTY (like main app) ===');
            
            // This simulates what handleAddProperty does
            const newProperty = {
                address: `Test ${Date.now()}`,
                city: 'Las Vegas',
                state: 'NV',
                zip: '89101',
                purchasePrice: 450000,
                monthlyRent: 3000,
                status: 'available',
                dateAdded: new Date().toISOString()
            };
            
            log('1. Adding to local array:', newProperty);
            properties.push(newProperty);
            
            log('2. Calling saveProperties()...');
            await saveProperties();
            
            log('3. Property after save:', properties[properties.length - 1]);
        }
        
        async function saveProperties() {
            // This simulates the main app's saveProperties function
            log('saveProperties: Saving to localStorage...');
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // Try to save to server
            for (let i = 0; i < properties.length; i++) {
                const property = properties[i];
                
                if (!property.id) {
                    log(`saveProperties: Creating new property in DB: ${property.address}`);
                    
                    try {
                        const response = await fetch('/api/properties', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(property)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            log(`✅ Created with ID: ${data.data.id}`);
                            // CRITICAL: Assign ID to property in array
                            properties[i].id = data.data.id;
                            log('Property after ID assignment:', properties[i]);
                            
                            // Update localStorage with new ID
                            localStorage.setItem('properties', JSON.stringify(properties));
                        } else {
                            log(`❌ Failed to create: ${data.error}`);
                        }
                    } catch (error) {
                        log(`❌ Error: ${error.message}`);
                    }
                }
            }
        }
        
        async function simulateReload() {
            log('=== SIMULATING PAGE RELOAD ===');
            
            // Clear local array
            properties = [];
            
            // Load from database (simulating loadProperties)
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                
                if (data.success && data.data) {
                    properties = data.data;
                    localStorage.setItem('properties', JSON.stringify(properties));
                    log(`✅ Loaded ${properties.length} properties from database`);
                }
            } catch (error) {
                log('Failed to load from DB, using localStorage');
                const saved = localStorage.getItem('properties');
                if (saved) {
                    properties = JSON.parse(saved);
                }
            }
            
            log(`After reload: ${properties.length} properties loaded`);
            properties.slice(0, 3).forEach(p => {
                log(`  - ID: ${p.id}, ${p.address}`);
            });
        }
        
        async function simulateDeleteProperty() {
            log('=== SIMULATING DELETE PROPERTY ===');
            
            if (properties.length === 0) {
                log('No properties to delete');
                return;
            }
            
            const index = properties.length - 1;
            const property = properties[index];
            
            log(`Deleting property: ID=${property.id}, ${property.address}`);
            
            if (property.id) {
                try {
                    const response = await fetch(`/api/properties/${property.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        log('✅ Deleted from database');
                        properties.splice(index, 1);
                        localStorage.setItem('properties', JSON.stringify(properties));
                        log('✅ Removed from local array and localStorage');
                    } else {
                        log('❌ Failed to delete from database');
                    }
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                }
            } else {
                // No ID, just remove locally
                properties.splice(index, 1);
                localStorage.setItem('properties', JSON.stringify(properties));
                log('Property had no ID, removed from local only');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('properties');
            properties = [];
            log('✅ Cleared localStorage and local array');
        }
        
        // Initialize
        showCurrentState();
    </script>
</body>
</html>