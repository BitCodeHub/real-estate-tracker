<!DOCTYPE html>
<html>
<head>
    <title>Verify Add Property Fix</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #1a1a1a; color: white; }
        button { margin: 10px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .section { background: #242424; padding: 20px; margin: 20px 0; border-radius: 8px; }
        pre { background: #0a0a0a; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Verify Add Property Fix</h1>
    
    <div class="section">
        <h2>Test Instructions</h2>
        <ol>
            <li>Click "Test Add Property" to add a test property directly via API</li>
            <li>Click "Check Properties in Database" to see current database state</li>
            <li>Click "Check Properties in LocalStorage" to see local state</li>
            <li>Click "Clear LocalStorage" to reset local data</li>
        </ol>
        <p><strong>Expected Result:</strong> After adding a property, it should have an ID and persist after page reload.</p>
    </div>
    
    <div class="section">
        <button onclick="testAddProperty()">Test Add Property</button>
        <button onclick="checkDatabaseProperties()">Check Properties in Database</button>
        <button onclick="checkLocalStorageProperties()">Check Properties in LocalStorage</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
        <button onclick="simulateReload()">Simulate Page Reload</button>
    </div>
    
    <div class="section">
        <h2>Results:</h2>
        <pre id="output"></pre>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, data = null) {
            const timestamp = new Date().toISOString().split('T')[1];
            output.innerHTML += `[${timestamp}] ${message}\n`;
            if (data) {
                output.innerHTML += JSON.stringify(data, null, 2) + '\n';
            }
            output.innerHTML += '\n';
            output.scrollTop = output.scrollHeight;
        }
        
        async function testAddProperty() {
            log('=== TESTING ADD PROPERTY ===');
            
            try {
                const testProperty = {
                    address: `Test Property ${Date.now()}`,
                    city: 'Las Vegas',
                    state: 'NV',
                    zip: '89101',
                    purchasePrice: 450000,
                    monthlyRent: 3200,
                    status: 'available',
                    dateAdded: new Date().toISOString()
                };
                
                log('1. Creating property via API:', testProperty);
                
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testProperty)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Property created successfully:', data.data);
                    log(`Property ID: ${data.data.id}`);
                    
                    // Check if it has required fields
                    if (data.data.id && data.data.address && data.data.city) {
                        log('‚úÖ Property has all required fields');
                    } else {
                        log('‚ùå Property missing required fields');
                    }
                    
                } else {
                    log('‚ùå Failed to create property:', data.error);
                }
                
            } catch (error) {
                log('‚ùå Error:', error.message);
            }
        }
        
        async function checkDatabaseProperties() {
            log('=== CHECKING DATABASE PROPERTIES ===');
            
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                
                if (data.success) {
                    log(`Database has ${data.data.length} properties:`);
                    data.data.slice(-3).forEach(p => {
                        log(`  - ID: ${p.id}, ${p.address}, hasID: ${!!p.id}`);
                    });
                } else {
                    log('‚ùå Failed to fetch from database');
                }
            } catch (error) {
                log('‚ùå Error:', error.message);
            }
        }
        
        function checkLocalStorageProperties() {
            log('=== CHECKING LOCALSTORAGE PROPERTIES ===');
            
            const localData = localStorage.getItem('properties');
            if (localData) {
                const properties = JSON.parse(localData);
                log(`LocalStorage has ${properties.length} properties:`);
                properties.slice(-3).forEach(p => {
                    log(`  - ID: ${p.id || 'NO ID'}, ${p.address}, hasID: ${!!p.id}`);
                });
            } else {
                log('No properties in localStorage');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('properties');
            log('‚úÖ Cleared localStorage');
        }
        
        async function simulateReload() {
            log('=== SIMULATING PAGE RELOAD ===');
            
            // Clear localStorage temporarily to test server loading
            const savedData = localStorage.getItem('properties');
            localStorage.removeItem('properties');
            
            try {
                // Simulate loading from server (like the app does on reload)
                const response = await fetch('/api/properties');
                const data = await response.json();
                
                if (data.success && data.data !== undefined) {
                    // This is what the app should do
                    localStorage.setItem('properties', JSON.stringify(data.data));
                    log(`‚úÖ Reloaded ${data.data.length} properties from server`);
                    log('Properties after reload:');
                    data.data.slice(-3).forEach(p => {
                        log(`  - ID: ${p.id}, ${p.address}`);
                    });
                } else {
                    log('‚ùå Failed to reload from server');
                }
            } catch (error) {
                log('‚ùå Error during reload:', error.message);
                // Restore original data if something went wrong
                if (savedData) {
                    localStorage.setItem('properties', savedData);
                }
            }
        }
        
        // Initialize
        log('Ready to test add property fix');
    </script>
</body>
</html>