<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        header h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 600;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .refresh-icon {
            transition: all 0.3s ease;
        }
        
        .refresh-icon:hover {
            opacity: 1 !important;
            transform: rotate(180deg);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
            color: white;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-ai:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
        }
        
        .actions-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        button, .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: #f7fafc;
        }
        
        .address-cell {
            font-weight: 600;
            color: #2d3748;
        }
        
        .positive {
            color: #48bb78;
            font-weight: 600;
        }
        
        .negative {
            color: #f56565;
            font-weight: 600;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .close {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .financial-details {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
        }
        
        .financial-details h3 {
            margin-bottom: 20px;
            color: #4a5568;
        }
        
        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        /* Form styles for adding properties */
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Add property button styles */
        .add-property-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .add-property-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .table-container {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 5px;
            }
        }
        
        /* Charts container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 400px;
            position: relative;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }
        
        .chart-card canvas {
            max-height: 350px !important;
            height: 350px !important;
        }
        
        @media (max-width: 768px) {
            .chart-card {
                height: 300px;
            }
            
            .chart-card canvas {
                max-height: 250px !important;
                height: 250px !important;
            }
        }
        
        /* Editable cells */
        .editable-cell {
            cursor: text;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        
        .editable-cell:focus {
            outline: 2px solid #667eea;
            background-color: white;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-rented {
            background-color: #c6f6d5;
            color: #22543d;
        }
        
        .status-vacant {
            background-color: #fed7d7;
            color: #742a2a;
        }
        
        .status-pending {
            background-color: #fefcbf;
            color: #744210;
        }
        
        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* Analysis modal specific styles */
        .analysis-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .analysis-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .metric-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        /* Badge styles */
        .real-time-badge {
            background-color: #4ade80;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            display: inline-block;
        }
        
        .sold-badge {
            background-color: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            display: inline-block;
        }
        
        .last-updated {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 8px;
        }
        
        /* Sort controls */
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sort-controls select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .sort-controls label {
            font-weight: 600;
            color: #4a5568;
        }
        
        /* Import/Export buttons */
        .data-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            background: #10b981;
            color: white;
        }
        
        .btn-export:hover {
            background: #059669;
        }
        
        .btn-import {
            background: #3b82f6;
            color: white;
        }
        
        .btn-import:hover {
            background: #2563eb;
        }
        
        /* Notes section in modal */
        .notes-section {
            margin-top: 20px;
            padding: 20px;
            background: #fefcbf;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .notes-section h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .notes-content {
            color: #78350f;
            line-height: 1.6;
        }
        
        /* Property type badge */
        .property-type-badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* Refresh animation */
        @keyframes refresh-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .refreshing {
            animation: refresh-spin 1s linear infinite;
        }
        
        /* Success/Error messages */
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Update the refresh icon styles */
        .refresh-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .refresh-icon:hover {
            background: #f3f4f6;
            transform: rotate(180deg);
        }
        
        /* Sold property styles */
        .property-sold {
            background-color: #fee !important;
        }
        
        .property-sold td {
            color: #dc3545;
            opacity: 0.8;
        }
        
        .property-sold .address-sold {
            color: #dc3545 !important;
            text-decoration: line-through;
            font-weight: 600;
        }
        
        /* Mark sold button styles */
        .btn-mark-sold {
            background: #dc3545;
            color: white;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .btn-mark-sold:hover {
            background: #c82333;
        }
        
        /* Unmark sold button */
        .btn-unmark-sold {
            background: #28a745;
            color: white;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .btn-unmark-sold:hover {
            background: #218838;
        }
        
        /* Sold filter button */
        .filter-sold {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-sold input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-sold label {
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            color: #4a5568;
        }
        
        /* API status indicator */
        .api-status {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            z-index: 100;
        }
        
        .api-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .api-status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .api-status-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        /* Property analysis form styles */
        .analysis-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .analysis-form h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Results section */
        #analysisResults {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
        }
        
        #analysisLoading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        /* Sort indicator */
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.8rem;
            color: #718096;
        }
        
        .ai-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Feature tags */
        .feature-tag {
            display: inline-block;
            background: #f3f4f6;
            color: #4b5563;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .feature-tag.premium {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Maintenance tracker styles */
        .maintenance-list {
            list-style: none;
            padding: 0;
        }
        
        .maintenance-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .maintenance-overdue {
            background: #fee;
            border-left: 4px solid #dc3545;
        }
        
        .maintenance-upcoming {
            background: #fff7ed;
            border-left: 4px solid #f97316;
        }
        
        /* Comparison view */
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .comparison-card.selected {
            border: 2px solid #667eea;
        }
        
        /* Performance metrics */
        .performance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .performance-indicator.excellent {
            background: #d1fae5;
            color: #065f46;
        }
        
        .performance-indicator.good {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .performance-indicator.fair {
            background: #fef3c7;
            color: #92400e;
        }
        
        .performance-indicator.poor {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üèòÔ∏è Real Estate Investment Tracker</h1>
        </div>
    </header>
    
    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalProperties">0</div>
                <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">$0</div>
                <div class="stat-label">Portfolio Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyIncome">$0</div>
                <div class="stat-label">Monthly Income</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEquity">$0</div>
                <div class="stat-label">Total Equity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgROI">0%</div>
                <div class="stat-label">Average ROI</div>
            </div>
        </div>

        <!-- Quick Property Analysis Section -->
        <div class="analysis-form">
            <h2>üîç Quick Property Analysis</h2>
            <div class="input-group">
                <input type="text" id="propertyAddressInput" 
                       placeholder="Enter property address (e.g., 1613 Capistrano Ave, Placentia, CA 92870)"
                       onkeypress="if(event.key === 'Enter') analyzeNewProperty()">
                <button class="btn btn-primary" onclick="analyzeNewProperty()">
                    Analyze Property
                </button>
                <button class="btn btn-ai" onclick="generateAIInsights()">
                    <svg class="ai-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    AI Market Insights
                </button>
            </div>
            
            <div id="analysisLoading" class="loading">
                <div class="spinner"></div>
                <p>Analyzing property data...</p>
            </div>
            
            <div id="analysisResults"></div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>üìä Cash Flow by Property</h3>
                <canvas id="cashFlowChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üìà ROI Comparison</h3>
                <canvas id="roiChart"></canvas>
            </div>
        </div>
        
        <!-- Actions Bar -->
        <div class="actions-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search properties..." onkeyup="filterProperties()">
                <span class="search-icon">üîç</span>
            </div>
            <div class="filter-sold">
                <input type="checkbox" id="showSoldProperties" onchange="updateDisplay()">
                <label for="showSoldProperties">Show Sold Properties</label>
            </div>
            <div class="sort-controls">
                <label>Sort by:</label>
                <select id="sortSelect" onchange="sortProperties()">
                    <option value="address">Address</option>
                    <option value="value">Property Value</option>
                    <option value="cashflow">Cash Flow</option>
                    <option value="roi">ROI</option>
                    <option value="equity">Equity</option>
                </select>
            </div>
            <div class="data-controls">
                <button class="btn btn-export" onclick="exportToCSV()">üì• Export</button>
                <button class="btn btn-import" onclick="document.getElementById('importFile').click()">üì§ Import</button>
                <input type="file" id="importFile" style="display: none;" accept=".csv" onchange="importFromCSV(event)">
            </div>
        </div>
        
        <!-- Properties Table -->
        <div class="table-container">
            <table id="propertyTable">
                <thead>
                    <tr>
                        <th>Address <span class="sort-indicator" id="sort-address"></span></th>
                        <th>City</th>
                        <th>Purchase Price</th>
                        <th>Current Value</th>
                        <th>Monthly Rent</th>
                        <th>Mortgage</th>
                        <th>Cash Flow</th>
                        <th>ROI</th>
                        <th>Equity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- Properties will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add Property Button -->
    <button class="add-property-btn" onclick="showAddPropertyModal()">+</button>
    
    <!-- Property Detail Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Property Details</h2>
                <span class="close" onclick="closeModal('propertyModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Property details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addPropertyTitle">Add New Property</h2>
                <span class="close" onclick="closeModal('addPropertyModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="propertyForm" onsubmit="saveProperty(event)">
                    <div class="form-group">
                        <label for="address">Property Address *</label>
                        <input type="text" id="address" name="address" required 
                               placeholder="123 Main St">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <input type="text" id="state" name="state" required maxlength="2" 
                                   placeholder="CA">
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code *</label>
                            <input type="text" id="zip" name="zip" required pattern="[0-9]{5}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchasePrice">Purchase Price *</label>
                            <input type="number" id="purchasePrice" name="purchasePrice" required min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label for="currentValue">Current Value</label>
                            <input type="number" id="currentValue" name="currentValue" min="0" step="1000">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthlyRent">Monthly Rent</label>
                            <input type="number" id="monthlyRent" name="monthlyRent" min="0" step="50">
                        </div>
                        <div class="form-group">
                            <label for="monthlyMortgage">Monthly Mortgage</label>
                            <input type="number" id="monthlyMortgage" name="monthlyMortgage" min="0" step="50">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="propertyType">Property Type</label>
                            <select id="propertyType" name="propertyType">
                                <option value="Single Family">Single Family</option>
                                <option value="Condo">Condo</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Multi-Family">Multi-Family</option>
                                <option value="Commercial">Commercial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="beds">Bedrooms</label>
                            <input type="number" id="beds" name="beds" min="0" max="20">
                        </div>
                        <div class="form-group">
                            <label for="baths">Bathrooms</label>
                            <input type="number" id="baths" name="baths" min="0" max="20" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="sqft">Square Feet</label>
                            <input type="number" id="sqft" name="sqft" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="yearBuilt">Year Built</label>
                            <input type="number" id="yearBuilt" name="yearBuilt" min="1800" max="2024">
                        </div>
                        <div class="form-group">
                            <label for="purchaseDate">Purchase Date</label>
                            <input type="date" id="purchaseDate" name="purchaseDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
                    </div>
                    
                    <input type="hidden" id="propertyId" name="propertyId">
                    <input type="hidden" id="propertyIndex" name="propertyIndex">
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Save Property</button>
                        <button type="button" class="btn" onclick="closeModal('addPropertyModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- API Status Indicator -->
    <div class="api-status" id="apiStatus">
        <span class="api-status-indicator" id="apiStatusIndicator"></span>
        <span id="apiStatusText">Checking API...</span>
    </div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="color: #667eea; font-size: 18px; font-weight: 500;">Loading Real Estate Tracker...</p>
        </div>
    </div>
    
    <!-- Import Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let properties = [];
        let charts = {};
        let currentEditIndex = -1;
        let apiKeyConfigured = false;
        let chartUpdateTimer = null;
        
        // Load properties on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProperties();
            updateStats();
            initCharts();
            checkApiStatus();
            
            // Hide loading indicator after a short delay
            setTimeout(function() {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.transition = 'opacity 0.3s ease';
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => loadingIndicator.remove(), 300);
                }
            }, 300);
        });
        
        // Check API status on startup
        async function checkApiStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                apiKeyConfigured = data.apiKeyConfigured;
                updateApiStatusIndicator(apiKeyConfigured);
            } catch (error) {
                console.error('Error checking API status:', error);
                updateApiStatusIndicator(false);
            }
        }
        
        function updateApiStatusIndicator(isConfigured) {
            const indicator = document.getElementById('apiStatusIndicator');
            const text = document.getElementById('apiStatusText');
            
            if (isConfigured) {
                indicator.className = 'api-status-indicator connected';
                text.textContent = 'RentCast API Connected';
            } else {
                indicator.className = 'api-status-indicator disconnected';
                text.textContent = 'RentCast API Not Configured';
            }
        }
        
        // Load properties from localStorage and server
        async function loadProperties() {
            // First, try to load from server
            let serverProperties = [];
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                if (data.success && data.data) {
                    serverProperties = data.data;
                    console.log('Loaded properties from server:', serverProperties.length);
                }
            } catch (error) {
                console.error('Error loading from server:', error);
            }
            
            // Then load from localStorage
            const saved = localStorage.getItem('properties');
            const localProperties = saved ? JSON.parse(saved) : [];
            console.log('Loaded properties from localStorage:', localProperties.length);
            
            // Merge properties, preferring server data for duplicates
            const propertyMap = new Map();
            
            // Add local properties first
            localProperties.forEach(prop => {
                propertyMap.set(prop.address, prop);
            });
            
            // Override with server properties (they're more authoritative)
            serverProperties.forEach(prop => {
                propertyMap.set(prop.address, prop);
            });
            
            // Convert back to array
            properties = Array.from(propertyMap.values());
            
            // Save merged data back to localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
        }
        
        // Save properties to localStorage and server
        async function saveProperties() {
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // Try to save to server if it's a new property
            if (currentEditIndex === -1 && properties.length > 0) {
                const latestProperty = properties[properties.length - 1];
                try {
                    const response = await fetch('/api/properties', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(latestProperty)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Update the property with server-generated ID if available
                        properties[properties.length - 1] = { ...latestProperty, ...data.data };
                        localStorage.setItem('properties', JSON.stringify(properties));
                        console.log('Property saved to server');
                    }
                    
                    if (data.warning) {
                        console.warn('Server warning:', data.warning);
                    }
                } catch (error) {
                    console.error('Error saving to server:', error);
                    // Property is already saved locally, so no need to show error to user
                }
            }
        }
        
        // FIX 1: Update fetchRentCastData to properly handle the API response
        async function fetchRentCastData(addressComponents) {
            const { streetAddress, city, state, zip } = addressComponents;
            
            console.log('=== fetchRentCastData called ===');
            console.log('Address components:', { streetAddress, city, state, zip });
            
            try {
                // Use server-side proxy endpoint to protect API key
                const queryParams = new URLSearchParams({
                    address: streetAddress,
                    city: city,
                    state: state,
                    zipcode: zip
                });
                
                console.log('Fetching property data via server proxy...');
                console.log('URL:', `/api/rentcast/properties?${queryParams}`);
                
                const response = await fetch(`/api/rentcast/properties?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('RentCast API Error:', errorData);
                    
                    // Check if it's the API key not configured error
                    if (response.status === 503 && errorData.error && errorData.error.includes('not configured')) {
                        console.error('‚ùå RentCast API key not configured on server!');
                        console.error('Server message:', errorData.message);
                    }
                    
                    throw new Error(errorData.message || `API error: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('RentCast API response:', responseData);
                
                // Check if server returned success
                if (!responseData.success) {
                    console.error('Server API Error:', responseData.error);
                    return { success: false, error: responseData.error };
                }
                
                const data = responseData.data;
                
                // Debug: Log the full RentCast response
                console.log('RentCast API Response:', data);
                console.log('Query params:', {
                    address: streetAddress,
                    city: city,
                    state: state,
                    zipcode: zip
                });
                
                // Process RentCast response - handle both array and single object responses
                let properties = Array.isArray(data) ? data : (data.properties || [data]);
                
                if (properties && properties.length > 0) {
                    const property = properties[0]; // Take the first match
                    console.log('First property match:', property);
                    
                    // FIX: Handle the actual RentCast API response format correctly
                    // RentCast uses different field names than we expect
                    const extractedData = {
                        // Address info
                        streetAddress: property.addressLine1 || property.address || streetAddress,
                        address: property.addressLine1 || property.address || streetAddress,
                        city: property.city || city,
                        state: property.state || state,
                        zip: property.zipCode || property.zip || zip,
                        lat: property.latitude || property.lat || 0,
                        lon: property.longitude || property.lng || 0,
                        formattedAddress: property.formattedAddress || `${streetAddress}, ${city}, ${state} ${zip}`,
                        
                        // Property details - FIXED field mapping
                        beds: property.bedrooms || property.beds || 3,
                        baths: property.bathrooms || property.baths || 2,
                        sqft: property.squareFootage || property.buildingSize || property.livingArea || 1500,
                        year: property.yearBuilt || 2000,
                        propertyType: property.propertyType || 'Single Family',
                        lotSize: property.lotSize || property.lotSquareFootage || 6000,
                        
                        // Financial data - FIXED to use tax assessment properly
                        price: property.price || property.lastSoldPrice || 
                               (property.taxAssessedValue ? Math.round(property.taxAssessedValue * 1.1) : null) ||
                               property.lastSalePrice || 500000,
                        rentEstimate: property.rent || property.rentEstimate || 
                                    (property.rentRangeLow && property.rentRangeHigh ? 
                                     Math.round((property.rentRangeLow + property.rentRangeHigh) / 2) : null) ||
                                    (property.squareFootage ? Math.round(property.squareFootage * 1.5) : 2500),
                        
                        // Additional financial details
                        taxRate: property.taxRate || 0.012,
                        insuranceRate: 0.004,
                        hoaMonthly: property.hoaFee || 0,
                        
                        // Market data
                        lastSaleDate: property.lastSoldDate,
                        lastSalePrice: property.lastSoldPrice,
                        pricePerSqft: property.pricePerSquareFoot || 
                                     (property.price && property.squareFootage ? 
                                      Math.round(property.price / property.squareFootage) : 0),
                        rentPerSqft: property.rentPerSquareFoot || 0,
                        
                        // Tax assessment data
                        taxAssessedValue: property.taxAssessedValue || 0,
                        taxAssessedYear: property.taxAssessedYear || new Date().getFullYear()
                    };
                    
                    console.log('‚úÖ Extracted property data:', extractedData);
                    
                    return {
                        success: true,
                        data: extractedData
                    };
                } else {
                    console.log('No properties found in RentCast response');
                    return { 
                        success: false, 
                        error: 'No properties found for the given address' 
                    };
                }
                
            } catch (error) {
                console.error('Error fetching from RentCast:', error);
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }
        
        // FIX 2: Update refreshSingleProperty to work correctly
        async function refreshSingleProperty(index) {
            const prop = properties[index];
            if (!prop) {
                console.error('Property not found at index:', index);
                return;
            }
            
            const fullAddress = `${prop.address}, ${prop.city}, ${prop.state} ${prop.zip}`;
            
            // Show loading state
            const statusMsg = `Refreshing property data for ${prop.address}...`;
            console.log(statusMsg);
            
            // Find the refresh icon and add spinning animation
            const rows = document.querySelectorAll('#propertyTableBody tr');
            const refreshIcon = rows[index]?.querySelector('.refresh-icon');
            
            if (refreshIcon) {
                // Add spinning animation
                refreshIcon.style.animation = 'spin 1s linear infinite';
                refreshIcon.style.opacity = '1';
            }
            
            try {
                // Parse address components
                const addressComponents = parseAddressComponents(fullAddress);
                
                // Fetch RentCast data
                const rentCastResult = await fetchRentCastData(addressComponents);
                
                if (rentCastResult.success && rentCastResult.data) {
                    const data = rentCastResult.data;
                    
                    console.log(`‚úÖ RentCast data received for ${fullAddress}:`, data);
                    
                    // Update property with real-time data
                    properties[index] = {
                        ...properties[index],
                        realTimeData: true,
                        lastUpdated: new Date().toISOString(),
                        // Update property details
                        beds: data.beds || properties[index].beds,
                        baths: data.baths || properties[index].baths,
                        sqft: data.sqft || properties[index].sqft,
                        yearBuilt: data.year || properties[index].yearBuilt,
                        lotSize: data.lotSize || properties[index].lotSize,
                        // Update financial data if available
                        currentValue: data.price || properties[index].currentValue,
                        monthlyRent: data.rentEstimate || properties[index].monthlyRent,
                        // Store additional market data
                        marketData: {
                            lastSaleDate: data.lastSaleDate,
                            lastSalePrice: data.lastSalePrice,
                            pricePerSqft: data.pricePerSqft,
                            rentPerSqft: data.rentPerSqft,
                            comparables: data.comparables
                        }
                    };
                    
                    // Save to localStorage and server
                    await saveProperties();
                    
                    // Update display
                    updateDisplay();
                    updateStats();
                    updateCharts();
                    
                    // Show success message
                    showMessage(`Successfully refreshed data for ${prop.address}`, 'success');
                    
                } else {
                    console.error(`Failed to fetch RentCast data for ${fullAddress}:`, rentCastResult.error);
                    showMessage(`Could not refresh data: ${rentCastResult.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error refreshing property:', error);
                showMessage(`Error refreshing property: ${error.message}`, 'error');
            } finally {
                // Remove loading state and stop spinning
                if (refreshIcon) {
                    refreshIcon.style.animation = '';
                    refreshIcon.style.opacity = '0.7';
                }
            }
        }
        
        // Helper function to show messages
        function showMessage(text, type = 'info') {
            // Create toast element for better visibility
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = text;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            document.body.appendChild(toast);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Parse address into components for API calls
        function parseAddressComponents(address) {
            // Remove newlines and extra spaces and normalize
            address = address.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            
            // Try to parse standard format: "123 Main St, City, State ZIP"
            const parts = address.split(',').map(p => p.trim());
            
            let streetAddress = '';
            let city = '';
            let state = '';
            let zip = '';
            
            if (parts.length >= 3) {
                streetAddress = parts[0];
                city = parts[1];
                const stateZip = parts[2];
                const stateZipMatch = stateZip.match(/([A-Z]{2})\s+(\d{5}(-\d{4})?)/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2].split('-')[0];
                } else {
                    // Try to extract state and zip separately
                    const words = stateZip.split(' ');
                    state = words[0];
                    zip = words[1] || '';
                }
            } else if (parts.length === 2) {
                // Try "123 Main St City, State ZIP" format
                const firstPart = parts[0];
                const secondPart = parts[1];
                const stateZipMatch = secondPart.match(/([A-Z]{2})\s+(\d{5})/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2];
                    // Extract city from end of first part
                    const words = firstPart.split(' ');
                    city = words[words.length - 1];
                    streetAddress = words.slice(0, -1).join(' ');
                }
            }
            
            return {
                streetAddress,
                city,
                state,
                zip
            };
        }
        
        // FIX 3: Ensure click handlers work properly
        function updateDisplay() {
            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = '';
            
            // Filter properties based on search and sold filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const showSold = document.getElementById('showSoldProperties').checked;
            
            let filteredProperties = properties.filter(prop => {
                // Check if property matches search
                const matchesSearch = !searchTerm || 
                    prop.address.toLowerCase().includes(searchTerm) ||
                    prop.city.toLowerCase().includes(searchTerm) ||
                    prop.state.toLowerCase().includes(searchTerm) ||
                    prop.zip.includes(searchTerm);
                
                // Check sold filter
                const matchesSold = showSold || !prop.isSold;
                
                return matchesSearch && matchesSold;
            });
            
            // Display each property
            filteredProperties.forEach((prop, originalIndex) => {
                // Find the actual index in the main properties array
                const index = properties.indexOf(prop);
                const row = document.createElement('tr');
                
                // Add sold styling if property is sold
                if (prop.isSold) {
                    row.classList.add('property-sold');
                    row.style.backgroundColor = '#fee';
                }
                
                // Check if property has exceeded target value
                if (prop.currentValue && prop.purchasePrice) {
                    const appreciation = ((prop.currentValue - prop.purchasePrice) / prop.purchasePrice) * 100;
                    if (appreciation >= 20) {
                        row.style.backgroundColor = '#e8f5e9';
                    }
                }
                
                // Make entire row clickable - ENHANCED EVENT HANDLER
                row.style.cursor = 'pointer';
                
                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('property-sold')) {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                row.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('property-sold') && 
                        !this.style.backgroundColor.includes('rgb(232, 245, 233)')) {
                        this.style.backgroundColor = '';
                    }
                });
                
                // Click handler with better event handling
                row.addEventListener('click', function(e) {
                    // Check if the click is not on an interactive element
                    const target = e.target;
                    const isEditableCell = target.classList.contains('editable-cell');
                    const isRefreshIcon = target.classList.contains('refresh-icon') || target.closest('.refresh-icon');
                    const isActionButton = target.tagName === 'BUTTON' || target.closest('button');
                    
                    if (!isEditableCell && !isRefreshIcon && !isActionButton) {
                        console.log(`Property row clicked, showing details for: ${prop.address} (index: ${index})`);
                        showPropertyDetail(index);
                    }
                });
                
                // Address cell with refresh icon
                const addressCell = document.createElement('td');
                addressCell.className = 'address-cell';
                
                const addressContainer = document.createElement('div');
                addressContainer.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                
                const addressSpan = document.createElement('span');
                addressSpan.textContent = prop.address;
                addressSpan.style.cursor = 'pointer';
                addressSpan.title = 'Click to view property details';
                
                if (prop.isSold) {
                    addressSpan.className = 'address-sold';
                } else {
                    // Add underline and color for non-sold properties
                    addressSpan.style.color = '#667eea';
                    addressSpan.style.textDecoration = 'underline';
                }
                
                // Add direct click handler to address span
                addressSpan.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log(`Address clicked: ${prop.address} (index: ${index})`);
                    showPropertyDetail(index);
                });
                
                addressContainer.appendChild(addressSpan);
                
                // Create refresh icon
                const refreshIcon = document.createElement('span');
                refreshIcon.className = 'refresh-icon';
                refreshIcon.textContent = 'üîÑ';
                refreshIcon.style.cssText = 'cursor: pointer; font-size: 14px; opacity: 0.7; transition: opacity 0.2s;';
                refreshIcon.title = 'Refresh real-time data for this property';
                refreshIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    refreshSingleProperty(index);
                });
                refreshIcon.addEventListener('mouseenter', function() {
                    this.style.opacity = '1';
                });
                refreshIcon.addEventListener('mouseleave', function() {
                    this.style.opacity = '0.7';
                });
                
                addressContainer.appendChild(refreshIcon);
                addressCell.appendChild(addressContainer);
                
                // Add badges
                if (prop.isSold) {
                    const soldBadge = document.createElement('span');
                    soldBadge.className = 'sold-badge';
                    soldBadge.textContent = 'SOLD';
                    addressCell.appendChild(soldBadge);
                }
                
                if (prop.realTimeData) {
                    const liveBadge = document.createElement('span');
                    liveBadge.className = 'real-time-badge';
                    liveBadge.title = 'Real-time data from RentCast';
                    liveBadge.textContent = 'LIVE';
                    addressCell.appendChild(liveBadge);
                }
                
                if (prop.lastUpdated) {
                    const updatedDate = new Date(prop.lastUpdated);
                    const timeAgo = getTimeAgo(updatedDate);
                    const updateSpan = document.createElement('span');
                    updateSpan.className = 'last-updated';
                    updateSpan.title = `Last updated: ${updatedDate.toLocaleString()}`;
                    updateSpan.textContent = timeAgo;
                    addressCell.appendChild(updateSpan);
                }
                
                row.appendChild(addressCell);
                
                // City (editable)
                row.appendChild(createEditableCell(prop.city || '', 'city', index));
                
                // Purchase Price (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.purchasePrice || 0), 'purchasePrice', index, true));
                
                // Current Value (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.currentValue || prop.purchasePrice || 0), 'currentValue', index, true));
                
                // Monthly Rent (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.monthlyRent || 0), 'monthlyRent', index, true));
                
                // Monthly Mortgage (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.monthlyMortgage || 0), 'monthlyMortgage', index, true));
                
                // Cash Flow
                const cashFlow = calculateCashFlow(prop);
                const cashFlowCell = document.createElement('td');
                cashFlowCell.textContent = formatCurrency(cashFlow);
                cashFlowCell.className = cashFlow >= 0 ? 'positive' : 'negative';
                row.appendChild(cashFlowCell);
                
                // ROI
                const roi = calculateROI(prop);
                const roiCell = document.createElement('td');
                roiCell.textContent = roi + '%';
                roiCell.className = roi >= 0 ? 'positive' : 'negative';
                row.appendChild(roiCell);
                
                // Equity
                const equity = calculateEquity(prop);
                const equityCell = document.createElement('td');
                equityCell.textContent = formatCurrency(equity);
                equityCell.className = 'positive';
                row.appendChild(equityCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="btn btn-sm" onclick="event.stopPropagation(); editProperty(${index})">‚úèÔ∏è</button>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); deleteProperty(${index})">üóëÔ∏è</button>
                `;
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
            
            // Update totals
            document.getElementById('totalProperties').textContent = properties.length;
        }
        
        function createEditableCell(value, field, index, isCurrency = false) {
            const cell = document.createElement('td');
            cell.className = 'editable-cell';
            cell.contentEditable = true;
            cell.textContent = value;
            cell.dataset.field = field;
            cell.dataset.index = index;
            
            // Handle editing
            cell.addEventListener('blur', function() {
                let newValue = this.textContent.trim();
                
                if (isCurrency) {
                    // Remove currency formatting
                    newValue = newValue.replace(/[$,]/g, '');
                    newValue = parseFloat(newValue) || 0;
                    properties[index][field] = newValue;
                    this.textContent = formatCurrency(newValue);
                } else {
                    properties[index][field] = newValue;
                }
                
                saveProperties();
                updateStats();
                debouncedUpdateCharts();
            });
            
            // Prevent row click when editing
            cell.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            return cell;
        }
        
        // Show property detail modal
        function showPropertyDetail(index) {
            console.log('showPropertyDetail called for property index:', index);
            
            // Ensure properties exist
            if (!properties || properties.length === 0) {
                console.error('No properties loaded');
                alert('No properties loaded. Please refresh the page.');
                return;
            }
            
            // Ensure valid index
            if (index < 0 || index >= properties.length) {
                console.error('Invalid property index:', index);
                alert('Invalid property index');
                return;
            }
            
            const prop = properties[index];
            const modal = document.getElementById('propertyModal');
            
            if (!modal) {
                console.error('Property modal element not found!');
                return;
            }
            
            document.getElementById('modalTitle').textContent = prop.address;
            
            // Calculate financial metrics
            const cashFlow = calculateCashFlow(prop);
            const roi = calculateROI(prop);
            const equity = calculateEquity(prop);
            const totalExpenses = calculateTotalExpenses(prop);
            const capRate = calculateCapRate(prop);
            
            let modalContent = `
                <div class="property-details">
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">${prop.propertyType || 'Single Family'}</div>
                        ${prop.propertyType ? '<span class="property-type-badge">' + prop.propertyType + '</span>' : ''}
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">${prop.beds || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">${prop.baths || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">${prop.sqft ? prop.sqft.toLocaleString() : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">${prop.yearBuilt || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Date</div>
                        <div class="detail-value">${prop.purchaseDate ? new Date(prop.purchaseDate).toLocaleDateString() : 'N/A'}</div>
                    </div>
                </div>
                
                <div class="financial-details">
                    <h3>Financial Overview</h3>
                    <div class="financial-grid">
                        <div class="detail-item">
                            <div class="detail-label">Purchase Price</div>
                            <div class="detail-value">${formatCurrency(prop.purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Current Value</div>
                            <div class="detail-value">${formatCurrency(prop.currentValue || prop.purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Equity</div>
                            <div class="detail-value positive">${formatCurrency(equity)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Rent</div>
                            <div class="detail-value">${formatCurrency(prop.monthlyRent)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Mortgage</div>
                            <div class="detail-value">${formatCurrency(prop.monthlyMortgage)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Expenses</div>
                            <div class="detail-value">${formatCurrency(totalExpenses)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Cash Flow</div>
                            <div class="detail-value ${cashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(cashFlow)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Annual ROI</div>
                            <div class="detail-value ${roi >= 0 ? 'positive' : 'negative'}">${roi}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cap Rate</div>
                            <div class="detail-value">${capRate}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add market data section if available
            if (prop.marketData) {
                modalContent += `
                    <div class="analysis-section">
                        <h3>Market Data</h3>
                        <div class="metric-grid">
                            ${prop.marketData.lastSaleDate ? `
                                <div class="metric-item">
                                    <div class="metric-value">${new Date(prop.marketData.lastSaleDate).toLocaleDateString()}</div>
                                    <div class="metric-label">Last Sale Date</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.lastSalePrice ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.lastSalePrice)}</div>
                                    <div class="metric-label">Last Sale Price</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.pricePerSqft ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.pricePerSqft)}/sqft</div>
                                    <div class="metric-label">Price per Sqft</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.rentPerSqft ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.rentPerSqft)}/sqft</div>
                                    <div class="metric-label">Rent per Sqft</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Add notes section if available
            if (prop.notes) {
                modalContent += `
                    <div class="notes-section">
                        <h3>üìù Notes</h3>
                        <div class="notes-content">${prop.notes}</div>
                    </div>
                `;
            }
            
            // Add action buttons with refresh
            modalContent += `
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: space-between;">
                    <div>
                        <button class="btn btn-primary" onclick="refreshPropertyInModal(${index})">
                            üîÑ Refresh Real-Time Data
                        </button>
                        <button class="btn" onclick="editProperty(${index})">‚úèÔ∏è Edit</button>
                        ${prop.isSold ? 
                            `<button class="btn btn-unmark-sold" onclick="toggleSoldStatus(${index})">‚úÖ Unmark as Sold</button>` :
                            `<button class="btn btn-mark-sold" onclick="toggleSoldStatus(${index})">üí∞ Mark as Sold</button>`
                        }
                    </div>
                    <button class="btn" style="background: #dc3545; color: white;" onclick="deleteProperty(${index})">üóëÔ∏è Delete</button>
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = modalContent;
            modal.style.display = 'block';
        }
        
        // Refresh property data from modal
        async function refreshPropertyInModal(index) {
            // Close modal
            closeModal('propertyModal');
            
            // Refresh the property
            await refreshSingleProperty(index);
            
            // Reopen modal with updated data
            setTimeout(() => {
                showPropertyDetail(index);
            }, 500);
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days}d ago`;
            const months = Math.floor(days / 30);
            if (months < 12) return `${months}mo ago`;
            const years = Math.floor(months / 12);
            return `${years}y ago`;
        }
        
        // Toggle sold status
        function toggleSoldStatus(index) {
            properties[index].isSold = !properties[index].isSold;
            properties[index].soldDate = properties[index].isSold ? new Date().toISOString() : null;
            
            saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            
            // Close modal and show success message
            closeModal('propertyModal');
            
            const status = properties[index].isSold ? 'sold' : 'active';
            showMessage(`Property marked as ${status}`, 'success');
        }
        
        // Show add property modal
        function showAddPropertyModal() {
            document.getElementById('addPropertyTitle').textContent = 'Add New Property';
            document.getElementById('propertyForm').reset();
            document.getElementById('propertyId').value = '';
            document.getElementById('propertyIndex').value = '';
            currentEditIndex = -1;
            document.getElementById('addPropertyModal').style.display = 'block';
        }
        
        // Edit property
        function editProperty(index) {
            const prop = properties[index];
            
            document.getElementById('addPropertyTitle').textContent = 'Edit Property';
            document.getElementById('propertyIndex').value = index;
            currentEditIndex = index;
            
            // Fill form with property data
            document.getElementById('address').value = prop.address || '';
            document.getElementById('city').value = prop.city || '';
            document.getElementById('state').value = prop.state || '';
            document.getElementById('zip').value = prop.zip || '';
            document.getElementById('purchasePrice').value = prop.purchasePrice || '';
            document.getElementById('currentValue').value = prop.currentValue || '';
            document.getElementById('monthlyRent').value = prop.monthlyRent || '';
            document.getElementById('monthlyMortgage').value = prop.monthlyMortgage || '';
            document.getElementById('propertyType').value = prop.propertyType || 'Single Family';
            document.getElementById('beds').value = prop.beds || '';
            document.getElementById('baths').value = prop.baths || '';
            document.getElementById('sqft').value = prop.sqft || '';
            document.getElementById('yearBuilt').value = prop.yearBuilt || '';
            document.getElementById('purchaseDate').value = prop.purchaseDate || '';
            document.getElementById('notes').value = prop.notes || '';
            
            // Close detail modal if open
            closeModal('propertyModal');
            
            // Show edit modal
            document.getElementById('addPropertyModal').style.display = 'block';
        }
        
        // Save property (add or edit)
        async function saveProperty(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const index = formData.get('propertyIndex');
            
            const property = {
                address: formData.get('address'),
                city: formData.get('city'),
                state: formData.get('state'),
                zip: formData.get('zip'),
                purchasePrice: parseFloat(formData.get('purchasePrice')) || 0,
                currentValue: parseFloat(formData.get('currentValue')) || parseFloat(formData.get('purchasePrice')) || 0,
                monthlyRent: parseFloat(formData.get('monthlyRent')) || 0,
                monthlyMortgage: parseFloat(formData.get('monthlyMortgage')) || 0,
                propertyType: formData.get('propertyType'),
                beds: parseInt(formData.get('beds')) || null,
                baths: parseFloat(formData.get('baths')) || null,
                sqft: parseInt(formData.get('sqft')) || null,
                yearBuilt: parseInt(formData.get('yearBuilt')) || null,
                purchaseDate: formData.get('purchaseDate'),
                notes: formData.get('notes'),
                lastModified: new Date().toISOString()
            };
            
            if (index && index !== '') {
                // Edit existing property
                properties[parseInt(index)] = { ...properties[parseInt(index)], ...property };
            } else {
                // Add new property
                property.id = Date.now();
                property.createdAt = new Date().toISOString();
                properties.push(property);
            }
            
            await saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            closeModal('addPropertyModal');
            
            showMessage(index ? 'Property updated successfully' : 'Property added successfully', 'success');
        }
        
        // Delete property
        function deleteProperty(index) {
            if (confirm(`Are you sure you want to delete ${properties[index].address}?`)) {
                properties.splice(index, 1);
                saveProperties();
                updateDisplay();
                updateStats();
                debouncedUpdateCharts();
                closeModal('propertyModal');
                
                showMessage('Property deleted successfully', 'success');
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Filter properties
        function filterProperties() {
            updateDisplay();
        }
        
        // Sort properties
        function sortProperties() {
            const sortBy = document.getElementById('sortSelect').value;
            
            properties.sort((a, b) => {
                switch (sortBy) {
                    case 'address':
                        return a.address.localeCompare(b.address);
                    case 'value':
                        return (b.currentValue || b.purchasePrice || 0) - (a.currentValue || a.purchasePrice || 0);
                    case 'cashflow':
                        return calculateCashFlow(b) - calculateCashFlow(a);
                    case 'roi':
                        return calculateROI(b) - calculateROI(a);
                    case 'equity':
                        return calculateEquity(b) - calculateEquity(a);
                    default:
                        return 0;
                }
            });
            
            updateDisplay();
        }
        
        // Calculate cash flow
        function calculateCashFlow(property) {
            const rent = property.monthlyRent || 0;
            const mortgage = property.monthlyMortgage || 0;
            const expenses = calculateMonthlyExpenses(property);
            return rent - mortgage - expenses;
        }
        
        // Calculate monthly expenses (property tax, insurance, HOA, maintenance)
        function calculateMonthlyExpenses(property) {
            const value = property.currentValue || property.purchasePrice || 0;
            const propertyTax = (value * 0.012) / 12; // 1.2% annually
            const insurance = (value * 0.004) / 12; // 0.4% annually
            const hoa = property.hoaMonthly || 0;
            const maintenance = (value * 0.01) / 12; // 1% annually for maintenance
            return propertyTax + insurance + hoa + maintenance;
        }
        
        // Calculate total expenses
        function calculateTotalExpenses(property) {
            return (property.monthlyMortgage || 0) + calculateMonthlyExpenses(property);
        }
        
        // Calculate ROI
        function calculateROI(property) {
            const annualCashFlow = calculateCashFlow(property) * 12;
            const totalInvestment = property.purchasePrice || 1; // Avoid division by zero
            return Math.round((annualCashFlow / totalInvestment) * 100 * 100) / 100;
        }
        
        // Calculate Cap Rate
        function calculateCapRate(property) {
            const noi = (property.monthlyRent || 0) * 12 - calculateMonthlyExpenses(property) * 12;
            const value = property.currentValue || property.purchasePrice || 1;
            return Math.round((noi / value) * 100 * 100) / 100;
        }
        
        // Calculate equity
        function calculateEquity(property) {
            const currentValue = property.currentValue || property.purchasePrice || 0;
            const remainingMortgage = property.remainingMortgage || (property.purchasePrice * 0.8); // Assume 20% down
            return currentValue - remainingMortgage;
        }
        
        // Update statistics
        function updateStats() {
            const totalValue = properties.reduce((sum, prop) => sum + (prop.currentValue || prop.purchasePrice || 0), 0);
            const monthlyIncome = properties.reduce((sum, prop) => sum + (prop.monthlyRent || 0), 0);
            const totalEquity = properties.reduce((sum, prop) => sum + calculateEquity(prop), 0);
            
            // Calculate average ROI
            let avgROI = 0;
            if (properties.length > 0) {
                const totalROI = properties.reduce((sum, prop) => sum + calculateROI(prop), 0);
                avgROI = Math.round((totalROI / properties.length) * 100) / 100;
            }
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('avgROI').textContent = avgROI + '%';
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Initialize charts
        function initCharts() {
            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            charts.cashFlow = new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly Cash Flow',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                maxTicksLimit: 8
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
            
            // ROI Chart
            const roiCtx = document.getElementById('roiChart').getContext('2d');
            charts.roi = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ROI %',
                        data: [],
                        backgroundColor: '#667eea',
                        borderColor: '#5a67d8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Debounced update charts to prevent excessive updates
        function debouncedUpdateCharts() {
            if (chartUpdateTimer) {
                clearTimeout(chartUpdateTimer);
            }
            chartUpdateTimer = setTimeout(() => {
                updateCharts();
            }, 100);
        }
        
        // Update charts
        function updateCharts() {
            if (!charts.cashFlow || !charts.roi) return;
            
            // Limit to 20 properties for performance
            let displayProperties = properties;
            if (properties.length > 20) {
                // Show top 20 properties by ROI
                displayProperties = [...properties]
                    .sort((a, b) => calculateROI(b) - calculateROI(a))
                    .slice(0, 20);
            }
            
            // Prepare data
            const labels = displayProperties.map(prop => {
                const addr = prop.address || '';
                return addr.length > 15 ? addr.substring(0, 15) + '...' : addr;
            });
            const cashFlowData = displayProperties.map(prop => calculateCashFlow(prop));
            const roiData = displayProperties.map(prop => calculateROI(prop));
            
            // Update Cash Flow Chart with no animation
            charts.cashFlow.data.labels = labels;
            charts.cashFlow.data.datasets[0].data = cashFlowData;
            charts.cashFlow.data.datasets[0].backgroundColor = cashFlowData.map(value => 
                value >= 0 ? 'rgba(72, 187, 120, 0.8)' : 'rgba(245, 101, 101, 0.8)'
            );
            charts.cashFlow.data.datasets[0].borderColor = cashFlowData.map(value => 
                value >= 0 ? '#48bb78' : '#f56565'
            );
            charts.cashFlow.update('none');
            
            // Update ROI Chart with no animation
            charts.roi.data.labels = labels;
            charts.roi.data.datasets[0].data = roiData;
            charts.roi.update('none');
        }
        
        // Export to CSV
        function exportToCSV() {
            const headers = ['Address', 'City', 'State', 'ZIP', 'Purchase Price', 'Current Value', 
                           'Monthly Rent', 'Monthly Mortgage', 'Cash Flow', 'ROI', 'Equity',
                           'Property Type', 'Beds', 'Baths', 'Sqft', 'Year Built', 'Purchase Date', 'Notes'];
            
            const rows = properties.map(prop => [
                prop.address,
                prop.city,
                prop.state,
                prop.zip,
                prop.purchasePrice,
                prop.currentValue || prop.purchasePrice,
                prop.monthlyRent,
                prop.monthlyMortgage,
                calculateCashFlow(prop),
                calculateROI(prop),
                calculateEquity(prop),
                prop.propertyType || 'Single Family',
                prop.beds || '',
                prop.baths || '',
                prop.sqft || '',
                prop.yearBuilt || '',
                prop.purchaseDate || '',
                prop.notes || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `real-estate-portfolio-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showMessage('Portfolio exported successfully', 'success');
        }
        
        // Import from CSV
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].match(/(".*?"|[^,]+)/g).map(v => v.replace(/"/g, '').trim());
                    const property = {
                        id: Date.now() + i,
                        createdAt: new Date().toISOString()
                    };
                    
                    headers.forEach((header, index) => {
                        const value = values[index];
                        switch (header.toLowerCase()) {
                            case 'address':
                                property.address = value;
                                break;
                            case 'city':
                                property.city = value;
                                break;
                            case 'state':
                                property.state = value;
                                break;
                            case 'zip':
                                property.zip = value;
                                break;
                            case 'purchase price':
                                property.purchasePrice = parseFloat(value) || 0;
                                break;
                            case 'current value':
                                property.currentValue = parseFloat(value) || 0;
                                break;
                            case 'monthly rent':
                                property.monthlyRent = parseFloat(value) || 0;
                                break;
                            case 'monthly mortgage':
                                property.monthlyMortgage = parseFloat(value) || 0;
                                break;
                            case 'property type':
                                property.propertyType = value;
                                break;
                            case 'beds':
                                property.beds = parseInt(value) || null;
                                break;
                            case 'baths':
                                property.baths = parseFloat(value) || null;
                                break;
                            case 'sqft':
                                property.sqft = parseInt(value) || null;
                                break;
                            case 'year built':
                                property.yearBuilt = parseInt(value) || null;
                                break;
                            case 'purchase date':
                                property.purchaseDate = value;
                                break;
                            case 'notes':
                                property.notes = value;
                                break;
                        }
                    });
                    
                    if (property.address) {
                        properties.push(property);
                    }
                }
                
                saveProperties();
                updateDisplay();
                updateStats();
                debouncedUpdateCharts();
                
                showMessage(`Imported ${properties.length} properties successfully`, 'success');
            };
            
            reader.readAsText(file);
        }
        
        // Analyze new property
        async function analyzeNewProperty() {
            const address = document.getElementById('propertyAddressInput').value.trim();
            
            if (!address) {
                alert('Please enter a property address');
                return;
            }
            
            // Show loading
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            try {
                console.log('=== Starting property analysis for:', address);
                
                // Check API status first
                const apiStatus = await fetch('/api/status').then(r => r.json()).catch(() => ({ apiKeyConfigured: false }));
                console.log('API Key Status:', apiStatus.apiKeyConfigured ? 'Configured' : 'Not configured');
                
                // Fetch real property data - This calls RentCast API when adding new property
                console.log('Calling fetchRealPropertyData...');
                const propertyData = await fetchRealPropertyData(address);
                console.log('fetchRealPropertyData result:', propertyData);
                
                if (propertyData.success && propertyData.source === 'RentCast API') {
                    console.log('‚úÖ RentCast data fetched successfully for new property');
                    console.log('Property data:', propertyData.data);
                    generateEnhancedPropertyAnalysis(address, propertyData.data);
                } else {
                    console.log('‚ö†Ô∏è RentCast data not available, using estimates');
                    console.log('Reason:', propertyData.error || 'Unknown');
                    // Fallback to original parsing
                    generatePropertyAnalysis(address);
                }
            } catch (error) {
                console.error('Error analyzing property:', error);
                alert('Error analyzing property. Using estimated data instead.');
                // Fallback to original parsing
                generatePropertyAnalysis(address);
            }
        }
        
        // Fetch real property data using multiple sources
        async function fetchRealPropertyData(address) {
            const results = {
                success: false,
                source: 'none',
                data: null
            };

            try {
                // First, parse the address to get components
                const parsedAddress = parseAddressComponents(address);
                
                // Try RentCast API first
                const rentcastData = await fetchRentCastData(parsedAddress);
                
                if (rentcastData && rentcastData.success) {
                    results.data = rentcastData.data;
                    results.success = true;
                    results.source = 'RentCast API';
                } else {
                    // Fallback to OpenStreetMap Nominatim for geocoding
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`;
                    const geoResponse = await fetch(geocodeUrl);
                    const geoData = await geoResponse.json();
                    
                    if (geoData && geoData[0]) {
                        const location = geoData[0];
                        const addressDetails = location.address || {};
                        
                        results.data = {
                            lat: location.lat,
                            lon: location.lon,
                            streetNumber: addressDetails.house_number || '',
                            streetName: addressDetails.road || '',
                            address: parsedAddress.streetAddress || address.split(',')[0].trim(),
                            city: addressDetails.city || addressDetails.town || addressDetails.village || parsedAddress.city || '',
                            state: addressDetails.state || parsedAddress.state || '',
                            zip: addressDetails.postcode || parsedAddress.zip || '',
                            country: addressDetails.country || 'USA',
                            formattedAddress: location.display_name
                        };
                        
                        // Get estimates based on location
                        const propertyDetails = await fetchPropertyDetails(results.data);
                        results.data = { ...results.data, ...propertyDetails };
                        results.success = true;
                        results.source = 'OpenStreetMap + Estimates';
                    }
                }
            } catch (error) {
                console.error('Error fetching property data:', error);
            }
            
            return results;
        }
        
        // Generate enhanced property analysis with real data
        function generateEnhancedPropertyAnalysis(address, propertyData) {
            const {
                streetNumber, streetName, city, state, zip, 
                beds, baths, sqft, year, price, rentEstimate,
                taxRate, insuranceRate, hoaMonthly, propertyType,
                lat, lon, formattedAddress
            } = propertyData;
            
            // Use the address field from propertyData if available, otherwise parse from input
            const fullAddress = propertyData.address || address.split(',')[0].trim();
            
            // Financial calculations
            const purchasePrice = price || 500000;
            const downPayment = purchasePrice * 0.20;
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            const monthlyRent = rentEstimate || 2500;
            
            // Calculate expenses
            const propertyTax = (purchasePrice * (taxRate || 0.012)) / 12;
            const insurance = (purchasePrice * (insuranceRate || 0.004)) / 12;
            const hoa = hoaMonthly || 0;
            const maintenance = (purchasePrice * 0.01) / 12;
            const propertyManagement = monthlyRent * 0.08;
            
            const totalExpenses = propertyTax + insurance + hoa + maintenance + propertyManagement;
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((monthlyRent * 12 - totalExpenses * 12) / purchasePrice) * 100;
            
            // Display results
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>üìç Property Details (from RentCast)</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${fullAddress}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${city}, ${state} ${zip}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms</div>
                            <div class="detail-value">${beds}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bathrooms</div>
                            <div class="detail-value">${baths}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${sqft ? sqft.toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">${year || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estimated Value</div>
                            <div class="detail-value">${formatCurrency(purchasePrice)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üí∞ Investment Analysis</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                            <div class="metric-label">Down Payment (20%)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(monthlyRent)}</div>
                            <div class="metric-label">Est. Monthly Rent</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(monthlyMortgage)}</div>
                            <div class="metric-label">Monthly Mortgage</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                            <div class="metric-label">Monthly Cash Flow</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üìä Return Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value ${cashOnCashReturn >= 0 ? 'positive' : 'negative'}">${cashOnCashReturn.toFixed(2)}%</div>
                            <div class="metric-label">Cash-on-Cash Return</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${capRate.toFixed(2)}%</div>
                            <div class="metric-label">Cap Rate</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(annualCashFlow)}</div>
                            <div class="metric-label">Annual Cash Flow</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${((monthlyRent / purchasePrice) * 100).toFixed(2)}%</div>
                            <div class="metric-label">1% Rule</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üìã Monthly Expenses Breakdown</h3>
                    <div class="financial-grid">
                        <div class="detail-item">
                            <div class="detail-label">Property Tax</div>
                            <div class="detail-value">${formatCurrency(propertyTax)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Insurance</div>
                            <div class="detail-value">${formatCurrency(insurance)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HOA</div>
                            <div class="detail-value">${formatCurrency(hoa)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Maintenance</div>
                            <div class="detail-value">${formatCurrency(maintenance)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Mgmt</div>
                            <div class="detail-value">${formatCurrency(propertyManagement)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Expenses</div>
                            <div class="detail-value"><strong>${formatCurrency(totalExpenses)}</strong></div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addAnalyzedProperty('${fullAddress}', '${city}', '${state}', '${zip}', ${purchasePrice}, ${monthlyRent}, ${monthlyMortgage}, '${propertyType}', ${beds}, ${baths}, ${sqft}, ${year})">
                        ‚ûï Add to Portfolio
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('propertyAddressInput').value=''; document.getElementById('analysisResults').style.display='none';">
                        üîç Analyze Another
                    </button>
                </div>
            `;
            
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
        }
        
        // Original property analysis (fallback)
        function generatePropertyAnalysis(address) {
            // Parse address
            const parts = address.split(',').map(p => p.trim());
            const streetAddress = parts[0] || '';
            const city = parts[1] || '';
            const stateZip = parts[2] || '';
            
            // Extract state and zip
            let state = '';
            let zip = '';
            if (stateZip) {
                const stateZipMatch = stateZip.match(/([A-Z]{2})\s+(\d{5})/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2];
                }
            }
            
            // Estimate property details based on typical values
            const estimatedPrice = 500000;
            const estimatedRent = 2500;
            const downPayment = estimatedPrice * 0.20;
            const loanAmount = estimatedPrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            // Calculate expenses
            const propertyTax = (estimatedPrice * 0.012) / 12;
            const insurance = (estimatedPrice * 0.004) / 12;
            const hoa = 150;
            const maintenance = (estimatedPrice * 0.01) / 12;
            const propertyManagement = estimatedRent * 0.08;
            
            const totalExpenses = propertyTax + insurance + hoa + maintenance + propertyManagement;
            const monthlyCashFlow = estimatedRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((estimatedRent * 12 - totalExpenses * 12) / estimatedPrice) * 100;
            
            // Display results
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>üìç Property Details (Estimated)</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${streetAddress}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City</div>
                            <div class="detail-value">${city}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">State</div>
                            <div class="detail-value">${state}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ZIP</div>
                            <div class="detail-value">${zip}</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #e53e3e; font-size: 0.9rem;">
                        ‚ö†Ô∏è Note: Using estimated values. For accurate data, ensure RentCast API is configured.
                    </p>
                </div>
                
                <div class="analysis-section">
                    <h3>üí∞ Investment Analysis (Estimated)</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(estimatedPrice)}</div>
                            <div class="metric-label">Estimated Value</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                            <div class="metric-label">Down Payment (20%)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(estimatedRent)}</div>
                            <div class="metric-label">Est. Monthly Rent</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                            <div class="metric-label">Monthly Cash Flow</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addAnalyzedProperty('${streetAddress}', '${city}', '${state}', '${zip}', ${estimatedPrice}, ${estimatedRent}, ${monthlyMortgage})">
                        ‚ûï Add to Portfolio
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('propertyAddressInput').value=''; document.getElementById('analysisResults').style.display='none';">
                        üîç Analyze Another
                    </button>
                </div>
            `;
            
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
        }
        
        // Calculate mortgage payment
        function calculateMortgagePayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 12;
            const numPayments = years * 12;
            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            return Math.round(payment);
        }
        
        // Add analyzed property to portfolio
        function addAnalyzedProperty(address, city, state, zip, purchasePrice, monthlyRent, monthlyMortgage, propertyType, beds, baths, sqft, yearBuilt) {
            const property = {
                id: Date.now(),
                address: address,
                city: city,
                state: state,
                zip: zip,
                purchasePrice: purchasePrice,
                currentValue: purchasePrice,
                monthlyRent: monthlyRent,
                monthlyMortgage: monthlyMortgage,
                propertyType: propertyType || 'Single Family',
                beds: beds || null,
                baths: baths || null,
                sqft: sqft || null,
                yearBuilt: yearBuilt || null,
                purchaseDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            properties.push(property);
            saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            
            // Clear form and hide results
            document.getElementById('propertyAddressInput').value = '';
            document.getElementById('analysisResults').style.display = 'none';
            
            showMessage('Property added to portfolio successfully!', 'success');
        }
        
        // Fetch property details estimates based on location
        async function fetchPropertyDetails(locationData) {
            // This would normally call various APIs for property details
            // For now, return reasonable estimates based on location
            
            const estimates = {
                beds: 3,
                baths: 2,
                sqft: 1500,
                year: 2000,
                price: 500000,
                rentEstimate: 2500,
                propertyType: 'Single Family',
                taxRate: 0.012,
                insuranceRate: 0.004,
                hoaMonthly: 150
            };
            
            // Adjust estimates based on state/city if available
            if (locationData.state === 'CA') {
                estimates.price *= 1.5;
                estimates.rentEstimate *= 1.4;
            } else if (locationData.state === 'TX') {
                estimates.price *= 0.8;
                estimates.rentEstimate *= 0.9;
                estimates.taxRate = 0.02;
            }
            
            return estimates;
        }
        
        // Generate AI insights (placeholder)
        async function generateAIInsights() {
            alert('AI Market Insights feature coming soon! This will analyze market trends, comparable properties, and investment opportunities in your target areas.');
        }
        
        // Handle window clicks for closing modals
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
    
    <!-- Performance Optimization Script -->
    <script src="performance-fix.js"></script>
</body>
</html>