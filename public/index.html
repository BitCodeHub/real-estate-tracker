<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Dark Theme Variables */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-hover: #2d2d2d;
            --bg-input: #1f1f1f;
            --bg-modal: #1a1a1a;
            
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            
            --border-color: #333333;
            --border-light: #404040;
            
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #06b6d4;
            
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Container Styles */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            padding: 30px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: var(--accent-primary);
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--accent-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }
        
        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-export {
            background: var(--accent-info);
            color: white;
        }
        
        .btn-export:hover {
            background: #0891b2;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Card Styles */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-light);
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Filter Section */
        .filter-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Table Styles */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
        }
        
        table {
            width: 100%;
            min-width: 1800px;
            border-collapse: collapse;
        }
        
        th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            text-align: left;
            padding: 16px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        /* Sticky first column (Address) */
        thead th:first-child,
        tbody td:first-child {
            position: sticky;
            left: 0;
            background: var(--bg-card);
            z-index: 5;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Rental listings table styling */
        #rentalListingsContent table {
            font-size: 0.9em;
        }
        
        #rentalListingsContent tbody tr:hover {
            background: var(--bg-hover) !important;
            transition: background 0.2s ease;
        }
        
        #rentalListingsContent .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
        
        thead th:first-child {
            background: var(--bg-secondary);
            z-index: 11;
        }
        
        /* Ensure proper hover state for sticky column */
        tbody tr:hover td:first-child {
            background: var(--bg-hover);
        }
        
        tr:hover {
            background: var(--bg-hover);
            cursor: pointer;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        
        .modal-content {
            position: relative;
            background: var(--bg-modal);
            margin: 20px auto;
            padding: 0;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            /* animation: slideIn 0.3s ease; - Removed for instant display */
            border: 1px solid var(--border-color);
            /* Force instant display - no animations or transitions */
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
        
        .modal-header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .modal-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Analysis Section Styles */
        .analysis-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .analysis-section h3 {
            color: var(--text-primary);
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .metric-value.positive {
            color: var(--accent-success);
        }
        
        .metric-value.negative {
            color: var(--accent-danger);
        }
        
        .metric-value.warning {
            color: var(--accent-warning);
        }
        
        .metric-subtext {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Investment Table */
        .investment-table {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .investment-table th {
            background: var(--bg-secondary);
            padding: 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .investment-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .investment-table td.positive {
            color: var(--accent-success);
            font-weight: 500;
        }
        
        .investment-table td.negative {
            color: var(--accent-danger);
            font-weight: 500;
        }
        
        /* Status Indicators */
        .status-available {
            color: var(--accent-success);
            font-weight: 500;
        }
        
        .status-sold {
            color: var(--accent-danger);
            font-weight: 500;
        }
        
        .status-pending {
            color: var(--accent-warning);
            font-weight: 500;
        }
        
        /* Icons */
        .icon-refresh {
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .icon-refresh:hover {
            color: var(--accent-primary);
            transform: rotate(180deg);
        }
        
        .text-warning {
            color: var(--accent-warning) !important;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Removed fadeIn animation for instant display
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        } */
        
        /* Removed slideIn animation for instant display
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        } */
        
        /* Export Button Styles */
        .export-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* AI Content Formatting */
        .ai-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            color: var(--text-primary);
        }
        
        .ai-content h4 {
            color: var(--accent-primary);
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .ai-content ul {
            margin-left: 20px;
            color: var(--text-secondary);
        }
        
        .ai-content strong {
            color: var(--text-primary);
        }
        
        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                font-size: 12px;
            }
            
            table {
                min-width: 1600px;
            }
            
            th, td {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
            }
        }
        
        /* Editable fields */
        .editable-field {
            transition: all 0.2s ease;
            border-radius: 4px;
            display: inline-block;
        }
        
        .editable-field:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        /* Inline edit input */
        .inline-edit-input {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: inherit;
            font-weight: inherit;
            width: 120px;
            text-align: right;
        }
        
        /* Animations - Removed for instant display
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        } */
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Notification animations - Removed for instant display
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        } */
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Modal Styles - Fixed for immediate response */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            /* No animations for immediate response */
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Ensure modal shows immediately when display:block */
        .modal[style*="display: block"] {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-content {
            background-color: var(--bg-modal);
            margin: 50px auto;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            /* animation: slideIn 0.3s ease; - Removed for instant display */
            /* Force instant display - no animations or transitions */
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }

        /* Global override to ensure ALL modals display instantly */
        .modal,
        .modal *,
        .modal-content,
        .modal-content * {
            animation: none !important;
            transition: none !important;
        }

        /* When modal is shown, ensure immediate visibility */
        .modal[style*="display: block"],
        .modal[style*="display: flex"] {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .modal[style*="display: block"] .modal-content,
        .modal[style*="display: flex"] .modal-content {
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
        
        .modal-header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(80vh - 120px);
            overflow-y: auto;
        }
        
        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover,
        .close:focus {
            color: var(--text-primary);
        }
        
        /* Form styles within modals */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Analysis section within modals */
        .analysis-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .analysis-section h3 {
            margin: 0 0 16px 0;
            color: var(--accent-primary);
            font-size: 20px;
        }
        
        /* Property details grid */
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .detail-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* FINAL OVERRIDE: Absolutely ensure NO animations on modals */
        .modal,
        .modal *,
        .modal-content,
        .modal-content *,
        .modal[style*="display: block"],
        .modal[style*="display: block"] *,
        .modal[style*="display: block"] .modal-content,
        .modal[style*="display: block"] .modal-content * {
            animation: none !important;
            transition: none !important;
            animation-duration: 0s !important;
            transition-duration: 0s !important;
            animation-delay: 0s !important;
            transition-delay: 0s !important;
        }

        /* Ensure immediate visibility for displayed modals */
        .modal[style*="display: block"] {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .modal[style*="display: block"] .modal-content {
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
    </style>
    <!-- XLSX library for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Mammoth.js library for Word document parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Real Estate Investment Tracker</h1>
            <div>
                <button class="btn btn-primary" onclick="openAddPropertyModal()">
                    <i class="fas fa-plus"></i> Add Property
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-value" id="totalProperties">0</div>
                <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">$0</div>
                <div class="stat-label">Portfolio Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEquity">$0</div>
                <div class="stat-label">Total Equity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyCashFlow">$0</div>
                <div class="stat-label">Monthly Cash Flow</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCashOnCash">0%</div>
                <div class="stat-label">Avg Cash-on-Cash</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>City</label>
                    <select id="filterCity" onchange="filterProperties()">
                        <option value="">All Cities</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="filterProperties()">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="sold">Sold</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Cash Flow</label>
                    <input type="number" id="filterMinCashFlow" placeholder="Min cash flow" onchange="filterProperties()">
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search properties..." oninput="filterProperties()">
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-times"></i> Reset
                </button>
            </div>
        </div>

        <!-- Properties Table -->
        <div class="table-container">
            <table id="propertyTable">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>City</th>
                        <th>Type</th>
                        <th>Bed/Bath</th>
                        <th>Sqft</th>
                        <th>Purchase Price</th>
                        <th>Est. Value</th>
                        <th>Monthly Rent</th>
                        <th>Rent Est.</th>
                        <th>Cash Flow</th>
                        <th>Annual CF</th>
                        <th>Cash-on-Cash</th>
                        <th>Cap Rate</th>
                        <th>Down Payment</th>
                        <th>DSCR</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- Properties will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Property Details Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-home"></i> Property Details</h2>
                <span class="close" onclick="closeModal('propertyModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Property details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Add New Property</h2>
                <span class="close" onclick="closeModal('addPropertyModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPropertyForm">
                    <!-- New full address field -->
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label for="fullAddress" style="font-weight: 600; color: var(--accent-primary);">Quick Add: Paste Full Address</label>
                        <input type="text" id="fullAddress" 
                               placeholder="e.g. 1613 Capistrano Ave Las Vegas, NV 89169" 
                               style="background: var(--bg-primary); border: 2px solid var(--border-light);" 
                               oninput="parseAndFillAddress()">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Paste or type a complete address to auto-fill the fields below
                        </small>
                    </div>
                    
                    <!-- Bulk Import Section -->
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight: 600; color: var(--accent-primary);">Bulk Import: Upload Excel/CSV/Word File</label>
                        <input type="file" id="bulkImportFile" accept=".csv,.xlsx,.xls,.docx,.doc" 
                               style="display: none;" onchange="handleFileUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulkImportFile').click()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-file-upload"></i> Choose Excel/CSV/Word File
                        </button>
                        <small style="color: var(--text-muted); display: block; margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Upload a file with property addresses. Supported formats: CSV, Excel (.xlsx, .xls), Word (.docx)
                        </small>
                        <div id="fileUploadStatus" style="margin-top: 10px; display: none;">
                            <div class="loading"></div>
                            <p style="color: var(--text-secondary);">Processing file...</p>
                        </div>
                        <div id="importPreview" style="margin-top: 15px; display: none;">
                            <h4 style="color: var(--accent-primary); margin-bottom: 10px;">Properties to Import:</h4>
                            <div id="importPreviewList" style="max-height: 200px; overflow-y: auto; background: var(--bg-primary); padding: 10px; border-radius: 4px;"></div>
                            <button type="button" class="btn btn-primary" onclick="confirmBulkImport()" style="margin-top: 10px;">
                                <i class="fas fa-check"></i> Import All Properties
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelBulkImport()" style="margin-top: 10px; margin-left: 10px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <span style="color: var(--text-muted);">‚Äî OR ‚Äî</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Street Address *</label>
                        <input type="text" id="address" name="address" required placeholder="123 Main St">
                    </div>
                    
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required placeholder="Las Vegas">
                    </div>
                    
                    <div class="form-group">
                        <label for="state">State *</label>
                        <input type="text" id="state" name="state" required placeholder="NV" maxlength="2" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="zip">ZIP Code *</label>
                        <input type="text" id="zip" name="zip" required placeholder="89101">
                    
                    <div class="form-group">
                        <label for="propertyType">Property Type</label>
                        <select id="propertyType" name="propertyType">
                            <option value="single-family">Single Family</option>
                            <option value="condo">Condo</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchasePrice">Purchase Price</label>
                        <input type="number" id="purchasePrice" name="purchasePrice" placeholder="500000">
                        <small style="color: var(--text-muted);">Optional - Leave blank to fetch from RentCast</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="monthlyRent">Monthly Rent</label>
                        <input type="number" id="monthlyRent" name="monthlyRent" placeholder="2500">
                        <small style="color: var(--text-muted);">Optional - Leave blank to fetch from RentCast</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="beds">Bedrooms</label>
                        <input type="number" id="beds" name="beds" placeholder="3">
                    </div>
                    
                    <div class="form-group">
                        <label for="baths">Bathrooms</label>
                        <input type="number" id="baths" name="baths" step="0.5" placeholder="2">
                    </div>
                    
                    <div class="form-group">
                        <label for="sqft">Square Feet</label>
                        <input type="number" id="sqft" name="sqft" placeholder="1500">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Property
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Analyze Property Modal -->
    <div id="analyzeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-search"></i> Analyze Property</h2>
                <span class="close" onclick="closeModal('analyzeModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="propertyAddressInput">Enter Property Address</label>
                    <input type="text" id="propertyAddressInput" placeholder="e.g., 123 Main St, Las Vegas, NV 89101" 
                           onkeypress="if(event.key === 'Enter') analyzeNewProperty()">
                </div>
                
                <button class="btn btn-primary" onclick="analyzeNewProperty()">
                    <i class="fas fa-search"></i> Analyze
                </button>
                
                <div id="analysisLoading" style="display: none; text-align: center; margin-top: 20px;">
                    <div class="loading"></div>
                    <p>Analyzing property...</p>
                </div>
                
                <div id="analysisResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- AI Market Insights Modal -->
    <div id="marketInsightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-brain"></i> AI Market Insights</h2>
                <span class="close" onclick="closeModal('marketInsightsModal')">&times;</span>
            </div>
            <div class="modal-body" id="marketInsightsBody">
                <div id="marketInsightsLoading" style="text-align: center;">
                    <div class="loading"></div>
                    <p>Generating market insights...</p>
                </div>
                <div id="marketInsightsContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let properties = [];
        let selectedPropertyIndex = null;
        let samplePropertiesLoaded = false;

        // Edit field inline
        function editField(index, field, currentValue, isInModal = false) {
            console.log('Editing field:', field, 'for property at index:', index, 'Current value:', currentValue);
            
            // Stop the event from bubbling up to the row click handler
            if (event) {
                event.stopPropagation();
            }
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'inline-edit-input';
            input.value = currentValue;
            input.min = '0';
            input.step = field === 'monthlyRent' ? '50' : '10000';
            
            // Get the element that was clicked
            const clickedElement = event.target;
            const originalHTML = clickedElement.innerHTML;
            
            // Replace the content with input
            clickedElement.innerHTML = '';
            clickedElement.appendChild(input);
            input.focus();
            input.select();
            
            // Save function
            const saveValue = () => {
                const newValue = parseFloat(input.value) || 0;
                
                if (newValue !== currentValue && newValue >= 0) {
                    // Find property by ID if in modal, otherwise by index
                    let propertyToUpdate;
                    let propertyIndex;
                    
                    // Always use index to find property
                    propertyIndex = index;
                    propertyToUpdate = properties[index];
                    
                    if (propertyToUpdate) {
                        // Update the property
                        propertyToUpdate[field] = newValue;
                        
                        // Recalculate metrics
                        calculatePropertyMetrics(propertyToUpdate);
                        
                        // Save to database and localStorage
                        saveProperties();
                        
                        // Update the display
                        updateDisplay();
                        
                        // If modal is open, refresh it
                        if (isInModal) {
                            showPropertyDetails(propertyIndex);
                        }
                        
                        // Show success notification
                        showNotification(`${field === 'purchasePrice' ? 'Purchase price' : 'Monthly rent'} updated to ${formatCurrency(newValue)}`, 'success');
                    }
                } else {
                    // Restore original value if invalid or unchanged
                    clickedElement.innerHTML = originalHTML;
                }
            };
            
            // Handle blur and enter key
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveValue();
                }
                if (e.key === 'Escape') {
                    clickedElement.innerHTML = originalHTML;
                }
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--accent-success)' : 'var(--accent-info)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Check and sync properties between localStorage and server
        async function checkAndSyncProperties() {
            console.log('üîÑ Checking property sync...');
            
            try {
                // Get server status
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                
                if (status.databaseConnected) {
                    console.log('‚úÖ Database is connected');
                    
                    // Don't automatically clear localStorage
                    // Instead, we'll handle sync in loadProperties
                    const localProps = localStorage.getItem('properties');
                    if (localProps) {
                        const parsed = JSON.parse(localProps);
                        console.log(`üì± Found ${parsed.length} properties in localStorage - will sync with database`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Database not connected - using localStorage only');
                }
            } catch (error) {
                console.error('Error checking sync:', error);
            }
        }

        // Modal functions - MUST be defined outside DOMContentLoaded for onclick handlers
        window.openModal = function(modalId) {
            console.log(`Opening modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal not found: ${modalId}`);
                return;
            }
            
            // Find modal content
            const modalContent = modal.querySelector('.modal-content');
            
            // Remove ALL animations and transitions before showing
            modal.style.animation = 'none';
            modal.style.transition = 'none';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            
            if (modalContent) {
                modalContent.style.animation = 'none';
                modalContent.style.transition = 'none';
                modalContent.style.opacity = '1';
                modalContent.style.transform = 'none';
                modalContent.style.visibility = 'visible';
            }
            
            // Display the modal
            modal.style.display = 'block';
            
            // Force a repaint to ensure the display change is applied immediately
            void modal.offsetHeight;
            
            // Double-check visibility
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
        }

        window.closeModal = function(modalId) {
            console.log(`Closing modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        window.openAddPropertyModal = function() {
            console.log('Opening Add Property Modal');
            document.getElementById('addPropertyForm').reset();
            document.getElementById('fullAddress').value = ''; // Clear the full address field
            window.openModal('addPropertyModal');
        }

        window.openAnalyzeModal = function() {
            console.log('Opening Analyze Modal');
            document.getElementById('propertyAddressInput').value = '';
            document.getElementById('analysisResults').innerHTML = '';
            document.getElementById('analysisLoading').style.display = 'none';
            window.openModal('analyzeModal');
        }

        // Analyze new property
        window.analyzeNewProperty = async function() {
            console.log('Analyzing new property');
            const address = document.getElementById('propertyAddressInput').value.trim();
            
            if (!address) {
                alert('Please enter a property address');
                return;
            }
            
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            try {
                // Parse address
                const parsedAddress = parseAddressComponents(address);
                
                // Show basic analysis without making API call
                generatePropertyAnalysis(address);
                
                // Add a note about fetching real-time data
                const analysisResults = document.getElementById('analysisResults');
                const apiNote = document.createElement('div');
                apiNote.style.cssText = 'background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--border-color);';
                apiNote.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="color: var(--accent-info);"></i> 
                        To fetch real-time market data from RentCast, add this property and click the refresh icon.
                    </p>
                    <button class="btn btn-primary" onclick="
                        document.getElementById('addPropertyForm').reset();
                        document.getElementById('fullAddress').value = '${address.replace(/'/g, "\\'")}';
                        parseAndFillAddress();
                        closeModal('analyzeModal');
                        openAddPropertyModal();
                    ">
                        <i class="fas fa-plus"></i> Add This Property
                    </button>
                `;
                analysisResults.appendChild(apiNote);
                
            } catch (error) {
                console.error('Error analyzing property:', error);
                alert('Error analyzing property. Please try again.');
            } finally {
                document.getElementById('analysisLoading').style.display = 'none';
                document.getElementById('analysisResults').style.display = 'block';
            }
        }

        // Generate AI market insights
        window.generateMarketInsights = async function() {
            console.log('Generating Market Insights');
            window.openModal('marketInsightsModal');
            document.getElementById('marketInsightsLoading').style.display = 'block';
            document.getElementById('marketInsightsContent').style.display = 'none';
            
            try {
                const marketData = await fetchMarketData();
                const content = generateMarketInsightsContent(marketData);
                
                document.getElementById('marketInsightsContent').innerHTML = content;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } catch (error) {
                console.error('Error generating insights:', error);
                document.getElementById('marketInsightsContent').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to generate market insights at this time. Please try again later.</p>
                    </div>
                `;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } finally {
                document.getElementById('marketInsightsLoading').style.display = 'none';
            }
        }

        // Global variables for bulk import
        let pendingBulkImportProperties = [];

        // Handle file upload
        window.handleFileUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name);
            document.getElementById('fileUploadStatus').style.display = 'block';
            document.getElementById('importPreview').style.display = 'none';

            try {
                let addresses = [];
                
                if (file.name.endsWith('.csv')) {
                    addresses = await parseCSVFile(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    addresses = await parseExcelFile(file);
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    addresses = await parseWordFile(file);
                } else {
                    throw new Error('Unsupported file format. Please use CSV, Excel, or Word files.');
                }

                if (addresses.length === 0) {
                    throw new Error('No valid addresses found in the file.');
                }

                // Store for bulk import
                pendingBulkImportProperties = addresses;
                
                // Show preview
                showImportPreview(addresses);
                
                // If we found incomplete addresses, show a warning
                if (addresses.length === 0 && (file.name.endsWith('.xlsx') || file.name.endsWith('.docx'))) {
                    const fileType = file.name.endsWith('.xlsx') ? 'Excel' : 'Word';
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: var(--accent-warning); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;';
                    warningDiv.innerHTML = `
                        <h4 style="margin-bottom: 10px;">‚ö†Ô∏è Could not parse addresses from ${fileType} file</h4>
                        <p style="margin-bottom: 10px;">Make sure your ${fileType} file has complete addresses in one of these formats:</p>
                        <ul style="margin-left: 20px;">
                            <li>Single line: "123 Main St, Las Vegas, NV 89101"</li>
                            <li>Two lines: "123 Main St" (next line) "Las Vegas, NV 89101"</li>
                            ${fileType === 'Excel' ? '<li>Two cells: "123 Main St" | "Las Vegas, NV 89101"</li>' : ''}
                        </ul>
                        <p style="margin-top: 10px;">Check the browser console for detailed parsing information.</p>
                    `;
                    document.getElementById('importPreview').insertBefore(warningDiv, document.getElementById('importPreview').firstChild);
                    document.getElementById('importPreview').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error processing file:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('fileUploadStatus').style.display = 'none';
                // Reset file input
                event.target.value = '';
            }
        }

        // Parse CSV file
        async function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const addresses = [];
                        
                        // Helper function to parse CSV line (handles quotes and commas)
                        const parseCSVLine = (line) => {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            
                            if (current) {
                                result.push(current.trim());
                            }
                            
                            return result;
                        };
                        
                        // Helper function to check if a string looks like a city/state/zip
                        const isCityStateZip = (str) => {
                            if (!str) return false;
                            return /[A-Za-z\s]+,?\s+[A-Z]{2}\s+\d{5}(-\d{4})?/.test(str);
                        };
                        
                        // Helper function to check if a string looks like just a street address
                        const isStreetOnly = (str) => {
                            if (!str) return false;
                            return /^\d+\s+[A-Za-z\s]+$/.test(str) && !/[A-Z]{2}\s+\d{5}/.test(str);
                        };
                        
                        // Skip header if it exists
                        const startIndex = lines[0].toLowerCase().includes('address') ? 1 : 0;
                        
                        for (let i = startIndex; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Parse CSV line into fields
                            const fields = parseCSVLine(line);
                            
                            // Process fields to find addresses
                            for (let j = 0; j < fields.length; j++) {
                                const field = fields[j];
                                if (!field) continue;
                                
                                // Check if this looks like a street address only
                                if (isStreetOnly(field)) {
                                    // Look for city/state/zip in the next field
                                    const nextField = fields[j + 1];
                                    if (nextField && isCityStateZip(nextField)) {
                                        // Combine street + city/state/zip
                                        addresses.push(`${field}, ${nextField}`);
                                        j++; // Skip the next field since we used it
                                        continue;
                                    }
                                }
                                
                                // Check if this is a complete address
                                if (field.match(/\d+\s+[A-Za-z]/) || isCityStateZip(field)) {
                                    // Only add if it's not just a city/state/zip without street
                                    if (!isCityStateZip(field) || field.match(/^\d+/)) {
                                        addresses.push(field);
                                    }
                                }
                            }
                        }
                        
                        // Remove duplicates
                        const uniqueAddresses = [...new Set(addresses)];
                        
                        console.log('Parsed addresses from CSV:', uniqueAddresses);
                        resolve(uniqueAddresses);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Parse Excel file
        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON - get all data
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        
                        console.log('Excel raw data:', jsonData); // Debug log
                        
                        const addresses = [];
                        const processedRows = new Set(); // Track which rows we've processed
                        
                        // Helper function to check if a string contains city/state/zip components
                        const hasCityStateZip = (str) => {
                            if (!str) return false;
                            // More flexible patterns - check for various formats
                            const patterns = [
                                /[A-Za-z\s]+,\s*[A-Za-z]{2}\s+\d{5}/i,  // "Las Vegas, NV 89101"
                                /[A-Za-z\s]+\s+[A-Za-z]{2}\s+\d{5}/i,   // "Las Vegas NV 89101"
                                /^[A-Za-z]{2}\s+\d{5}(-\d{4})?$/i,      // "NV 89101" or "NV 89101-1234"
                                /\d{5}(-\d{4})?$/                        // Just zip at end
                            ];
                            
                            for (const pattern of patterns) {
                                if (pattern.test(str)) {
                                    console.log(`    Pattern matched for "${str}": ${pattern}`);
                                    return true;
                                }
                            }
                            return false;
                        };
                        
                        // Helper function to check if a string looks like just a street address
                        const isStreetAddress = (str) => {
                            if (!str) return false;
                            // Has numbers at start followed by text
                            return /^\d+\s+[A-Za-z]/.test(str);
                        };
                        
                        // Process each row looking for address patterns
                        for (let i = 0; i < jsonData.length; i++) {
                            if (processedRows.has(i)) continue;
                            
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;
                            
                            // Debug log
                            console.log(`Row ${i}:`, row);
                            
                            // Skip header rows
                            if (i === 0) {
                                const hasHeader = row.some(cell => 
                                    cell && cell.toString().toLowerCase().match(/address|street|city|state|zip/)
                                );
                                if (hasHeader) {
                                    console.log('Skipping header row');
                                    continue;
                                }
                            }
                            
                            // Strategy 1: Look for street address + city/state/zip in adjacent cells
                            for (let j = 0; j < row.length; j++) {
                                const cellValue = row[j] ? row[j].toString().trim() : '';
                                if (!cellValue) continue;
                                
                                if (isStreetAddress(cellValue)) {
                                    // Found a street address, now look for city/state/zip
                                    let cityStateZip = '';
                                    
                                    // Check next cells in the same row
                                    for (let k = j + 1; k < row.length && k <= j + 3; k++) {
                                        const nextCell = row[k] ? row[k].toString().trim() : '';
                                        if (!nextCell) continue;
                                        
                                        console.log(`  Checking cell ${k}: "${nextCell}"`);
                                        
                                        // Check if this cell has city/state/zip
                                        if (hasCityStateZip(nextCell)) {
                                            cityStateZip = nextCell;
                                            console.log('  -> Found city/state/zip!');
                                            break;
                                        }
                                        
                                        // Also check if it's just a city name, and combine with next cells
                                        if (/^[A-Za-z\s]+$/.test(nextCell) && !nextCell.match(/\d/) && k + 1 < row.length) {
                                            // Might be just city name, check next cell for state/zip
                                            const possibleStateZip = row[k + 1] ? row[k + 1].toString().trim() : '';
                                            console.log(`    Checking if "${nextCell}" is city and "${possibleStateZip}" is state/zip`);
                                            
                                            if (possibleStateZip && /[A-Z]{2}\s*\d{5}/.test(possibleStateZip)) {
                                                cityStateZip = `${nextCell}, ${possibleStateZip}`;
                                                console.log('  -> Found city + state/zip in separate cells!');
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // If not found in same row, check the next row (some formats have city/state/zip below)
                                    if (!cityStateZip && i + 1 < jsonData.length) {
                                        const nextRow = jsonData[i + 1];
                                        if (nextRow) {
                                            console.log(`  Checking next row (${i + 1}):`, nextRow);
                                            
                                            // First check the same column index in the next row
                                            const sameCellBelow = nextRow[j] ? nextRow[j].toString().trim() : '';
                                            if (sameCellBelow && hasCityStateZip(sameCellBelow)) {
                                                cityStateZip = sameCellBelow;
                                                processedRows.add(i + 1); // Mark next row as processed
                                                console.log(`  -> Found city/state/zip in same column below: "${cityStateZip}"`);
                                            } else {
                                                // Check all cells in next row
                                                for (let k = 0; k < nextRow.length; k++) {
                                                    const nextRowCell = nextRow[k] ? nextRow[k].toString().trim() : '';
                                                    if (nextRowCell && hasCityStateZip(nextRowCell)) {
                                                        cityStateZip = nextRowCell;
                                                        processedRows.add(i + 1); // Mark next row as processed
                                                        console.log(`  -> Found city/state/zip in next row: "${cityStateZip}"`);
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    if (cityStateZip) {
                                        const fullAddress = `${cellValue}, ${cityStateZip}`;
                                        addresses.push(fullAddress);
                                        console.log('Found complete address:', fullAddress);
                                        break; // Move to next row
                                    } else {
                                        // Don't add incomplete addresses - log warning instead
                                        console.warn(`Incomplete address found (missing city/state/zip): "${cellValue}"`);
                                        console.log('Looking in next few cells/rows for city/state/zip...');
                                        
                                        // One more attempt: check if any cell in this row or next has just a city name
                                        let foundCity = false;
                                        for (let k = 0; k < row.length; k++) {
                                            const cell = row[k] ? row[k].toString().trim() : '';
                                            // Check for common city names
                                            if (cell && /^(Las Vegas|Henderson|North Las Vegas|Los Angeles|Phoenix)$/i.test(cell)) {
                                                // Found a city, now find state/zip
                                                for (let m = 0; m < row.length; m++) {
                                                    const stateZipCell = row[m] ? row[m].toString().trim() : '';
                                                    if (stateZipCell && /^[A-Z]{2}\s+\d{5}/.test(stateZipCell)) {
                                                        const fullAddress = `${cellValue}, ${cell}, ${stateZipCell}`;
                                                        addresses.push(fullAddress);
                                                        console.log('Found complete address with separate city:', fullAddress);
                                                        foundCity = true;
                                                        break;
                                                    }
                                                }
                                                if (foundCity) break;
                                            }
                                        }
                                        
                                        if (!foundCity) {
                                            console.error(`Skipping incomplete address: "${cellValue}" - no city/state/zip found`);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Remove duplicates
                        const uniqueAddresses = [...new Set(addresses)];
                        
                        console.log('Final parsed addresses:', uniqueAddresses);
                        resolve(uniqueAddresses);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Parse Word document file
        async function parseWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        
                        // Use mammoth to extract text from the Word document
                        mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                            .then(function(result) {
                                const text = result.value;
                                console.log('Extracted text from Word document:', text);
                                
                                // Parse addresses from the extracted text
                                const addresses = [];
                                
                                // Split text by newlines
                                const lines = text.split(/\r?\n/).filter(line => line.trim());
                                
                                console.log('Parsing', lines.length, 'lines from Word document');
                                
                                let i = 0;
                                while (i < lines.length) {
                                    const line = lines[i].trim();
                                    
                                    if (!line) {
                                        i++;
                                        continue;
                                    }
                                    
                                    console.log(`Line ${i}: "${line}"`);
                                    
                                    // Check if it's a complete address
                                    if (line.match(/,.*[A-Z]{2}\s+\d{5}/) || line.match(/\d{5}(?:-\d{4})?$/)) {
                                        // Looks like a complete address
                                        addresses.push(line);
                                        console.log('  -> Complete address found');
                                    } else {
                                        // Might be a street address, check next line for city/state/zip
                                        const streetPattern = /^\d+\s+[A-Za-z\s]+$/;
                                        const cityStateZipPattern = /[A-Za-z\s]+,?\s*[A-Z]{2}\s+\d{5}(?:-\d{4})?/;
                                        
                                        if (streetPattern.test(line) && i + 1 < lines.length) {
                                            const nextLine = lines[i + 1].trim();
                                            console.log(`  Checking next line: "${nextLine}"`);
                                            
                                            if (cityStateZipPattern.test(nextLine)) {
                                                // Combine the two lines
                                                const fullAddress = `${line}, ${nextLine}`;
                                                addresses.push(fullAddress);
                                                console.log('  -> Combined address:', fullAddress);
                                                i++; // Skip the next line since we used it
                                            }
                                        }
                                    }
                                    
                                    i++;
                                }
                                
                                // Also try to find addresses in table format (common in Word docs)
                                // Look for patterns like "Address" followed by actual addresses
                                const tablePattern = /(?:address|property|location)[\s:]*([^\n]+)/gi;
                                let match;
                                while ((match = tablePattern.exec(text)) !== null) {
                                    const potentialAddress = match[1].trim();
                                    // Validate it looks like an address
                                    if (potentialAddress.match(/\d+.*[A-Z]{2}\s+\d{5}/) && 
                                        !addresses.includes(potentialAddress)) {
                                        addresses.push(potentialAddress);
                                        console.log('Found address in table format:', potentialAddress);
                                    }
                                }
                                
                                // Remove duplicates
                                const uniqueAddresses = [...new Set(addresses)];
                                
                                console.log('Final parsed addresses from Word:', uniqueAddresses);
                                resolve(uniqueAddresses);
                            })
                            .catch(function(err) {
                                console.error('Mammoth parsing error:', err);
                                reject(new Error('Failed to parse Word document: ' + err.message));
                            });
                            
                    } catch (error) {
                        console.error('Word parsing error:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Show import preview
        function showImportPreview(addresses) {
            const previewList = document.getElementById('importPreviewList');
            previewList.innerHTML = '';
            
            addresses.forEach((address, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 5px 0; border-bottom: 1px solid var(--border-color);';
                item.innerHTML = `
                    <small style="color: var(--text-muted);">${index + 1}.</small> 
                    <span style="color: var(--text-primary);">${address}</span>
                `;
                previewList.appendChild(item);
            });
            
            document.getElementById('importPreview').style.display = 'block';
            
            // Update preview header
            const header = document.querySelector('#importPreview h4');
            header.textContent = `Properties to Import (${addresses.length} found):`;
        }

        // Confirm bulk import
        window.confirmBulkImport = async function() {
            if (pendingBulkImportProperties.length === 0) {
                showNotification('No properties to import', 'error');
                return;
            }

            // Hide preview and show progress
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileUploadStatus').style.display = 'block';
            document.querySelector('#fileUploadStatus p').textContent = `Importing ${pendingBulkImportProperties.length} properties...`;

            let successCount = 0;
            let failCount = 0;
            const failedAddresses = [];

            for (let i = 0; i < pendingBulkImportProperties.length; i++) {
                const address = pendingBulkImportProperties[i];
                
                try {
                    // Update progress
                    document.querySelector('#fileUploadStatus p').textContent = 
                        `Importing property ${i + 1} of ${pendingBulkImportProperties.length}...`;
                    
                    // Parse address
                    const parsedAddress = parseAddressComponents(address);
                    
                    if (!parsedAddress || !parsedAddress.streetAddress || !parsedAddress.city || !parsedAddress.state || !parsedAddress.zip) {
                        const missing = [];
                        if (!parsedAddress) {
                            throw new Error('Could not parse address');
                        }
                        if (!parsedAddress.streetAddress) missing.push('street');
                        if (!parsedAddress.city) missing.push('city');
                        if (!parsedAddress.state) missing.push('state');
                        if (!parsedAddress.zip) missing.push('ZIP');
                        throw new Error(`Missing: ${missing.join(', ')}`);
                    }
                    
                    // Create property object
                    const property = {
                        address: parsedAddress.streetAddress,
                        city: parsedAddress.city,
                        state: parsedAddress.state,
                        zip: parsedAddress.zip,
                        propertyType: 'single-family', // Default
                        purchasePrice: null,
                        monthlyRent: null,
                        beds: null,
                        baths: null,
                        sqft: null,
                        dateAdded: new Date().toISOString(),
                        status: 'available',
                        // Mark as not having RentCast data yet
                        rentcastCache: null,
                        needsRentCastData: true
                    };
                    
                    // Skip RentCast API calls during bulk import to minimize API usage
                    // Users can refresh individual properties later if needed
                    console.log(`Property ${i + 1}: Skipping RentCast API call for bulk import`);
                    
                    // Calculate metrics
                    calculatePropertyMetrics(property);
                    
                    // Add property
                    properties.push(property);
                    successCount++;
                    
                } catch (error) {
                    console.error(`Error importing property "${address}":`, error);
                    failCount++;
                    failedAddresses.push(address);
                }
            }
            
            // Save all properties
            await saveProperties();
            updateDisplay();
            
            // Hide loading
            document.getElementById('fileUploadStatus').style.display = 'none';
            
            // Show results
            let message = `Successfully imported ${successCount} properties`;
            if (failCount > 0) {
                message += `. Failed to import ${failCount} properties`;
                console.log('Failed addresses:', failedAddresses);
            }
            showNotification(message, successCount > 0 ? 'success' : 'error');
            
            // Show additional notification about RentCast data
            if (successCount > 0) {
                setTimeout(() => {
                    showNotification('Click the refresh icon (üîÑ) on each property to fetch market data from RentCast', 'info');
                }, 2000);
            }
            
            // Close modal if all successful
            if (failCount === 0) {
                closeModal('addPropertyModal');
            }
            
            // Reset
            pendingBulkImportProperties = [];
        }

        // Cancel bulk import
        window.cancelBulkImport = function() {
            pendingBulkImportProperties = [];
            document.getElementById('importPreview').style.display = 'none';
            showNotification('Import cancelled', 'info');
        }

        // Generate AI Market Insights with Gemini
        window.generateAIInsights = async function() {
            console.log('Generating AI Insights');
            const modal = document.getElementById('marketInsightsModal');
            const modalTitle = modal.querySelector('.modal-header h2');
            modalTitle.innerHTML = '<i class="fas fa-brain"></i> AI Market Insights';
            
            window.openModal('marketInsightsModal');
            document.getElementById('marketInsightsLoading').style.display = 'block';
            document.getElementById('marketInsightsContent').style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:3000/api/gemini/market-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ properties })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate AI insights');
                }

                const data = await response.json();
                
                document.getElementById('marketInsightsContent').innerHTML = data.insights;
                document.getElementById('marketInsightsContent').style.display = 'block';
                
                // Add download button if not exists
                const modalBody = document.querySelector('#marketInsightsModal .modal-body');
                if (!modalBody.querySelector('.download-btn')) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-primary download-btn';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
                    downloadBtn.onclick = () => downloadMarketReport(data.insights);
                    modalBody.appendChild(downloadBtn);
                }
            } catch (error) {
                console.error('Error generating AI insights:', error);
                document.getElementById('marketInsightsContent').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to generate AI insights. Please check your Gemini API configuration.</p>
                    </div>
                `;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } finally {
                document.getElementById('marketInsightsLoading').style.display = 'none';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing Real Estate Tracker...');
            
            // Check and sync properties first
            await checkAndSyncProperties();
            
            // Check API and database status
            await checkAPIStatus();
            
            // Load properties
            await loadProperties();
            
            // Setup UI
            setupEventListeners();
            
            // Update display after everything is loaded
            updateDisplay();
        });
        
        // Check API and database connection status
        async function checkAPIStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('üèõÔ∏è Server health check:', data);
                
                if (data.database !== 'connected') {
                    console.warn('‚ö†Ô∏è Database is not connected. Properties will be stored locally only.');
                    if (typeof showNotification === 'function') {
                        showNotification('Database offline - properties saved locally only', 'warning');
                    }
                }
                
                return data;
            } catch (error) {
                console.error('Failed to check API status:', error);
                return { status: 'error', database: 'disconnected' };
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('addPropertyForm').addEventListener('submit', handleAddProperty);
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };
        }

        // Load properties from server/localStorage
        async function loadProperties() {
            console.log('üì• Loading properties...');
            try {
                // Try to load from server first
                const response = await fetch('/api/properties');
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üìä Server response: success=${data.success}, properties=${data.data?.length || 0}`);
                    
                    if (data.success && data.data) {
                        // Always use server data when available
                        properties = data.data;
                        
                        // Ensure all properties have proper field names for the UI
                        properties = properties.map(p => ({
                            ...p,
                            // Ensure camelCase versions exist for UI
                            purchasePrice: p.purchasePrice || p.purchase_price,
                            monthlyRent: p.monthlyRent || p.monthly_rent,
                            currentValue: p.currentValue || p.value_estimate || p.purchase_price || p.purchasePrice,
                            propertyTax: p.propertyTax || p.property_tax,
                            managementFees: p.managementFees || p.management_fees,
                            cashFlow: p.cashFlow || p.cash_flow,
                            monthlyCashFlow: p.cashFlow || p.cash_flow,
                            cocReturn: p.cocReturn || p.coc_return,
                            cashOnCashReturn: p.cocReturn || p.coc_return,
                            capRate: p.capRate || p.cap_rate,
                            rentToValue: p.rentToValue || p.rent_to_value,
                            floodRisk: p.floodRisk || p.flood_risk,
                            marketRisk: p.marketRisk || p.market_risk
                        }));
                        
                        // After loading from server, update localStorage to sync
                        localStorage.setItem('properties', JSON.stringify(properties));
                        
                        console.log(`‚úÖ Loaded ${properties.length} properties from server and synced to localStorage`);
                        
                        // Calculate metrics for all properties after loading
                        properties.forEach(prop => {
                            if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                calculatePropertyMetrics(prop);
                            }
                        });
                        
                        // Debug: Check first 2 properties
                        if (properties.length > 0) {
                            console.log('üîç Sample properties:');
                            properties.slice(0, 2).forEach((p, i) => {
                                console.log(`Property ${i+1}: ${p.address}`, {
                                    id: p.id,
                                    purchasePrice: p.purchasePrice,
                                    monthlyRent: p.monthlyRent,
                                    cashFlow: p.cashFlow,
                                    monthlyCashFlow: p.monthlyCashFlow
                                });
                            });
                        }
                    } else if (data.warning) {
                        // Server is not connected, use localStorage
                        console.warn('‚ö†Ô∏è', data.warning);
                        const saved = localStorage.getItem('properties');
                        if (saved) {
                            properties = JSON.parse(saved);
                            console.log(`üì± Loaded ${properties.length} properties from localStorage (database offline)`);
                            // Calculate metrics for properties loaded from localStorage
                            properties.forEach(prop => {
                                if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                    calculatePropertyMetrics(prop);
                                }
                            });
                        } else {
                            properties = [];
                        }
                    }
                } else {
                    // Server error, fallback to localStorage
                    console.error('‚ùå Server response not OK:', response.status);
                    const saved = localStorage.getItem('properties');
                    if (saved) {
                        properties = JSON.parse(saved);
                        console.log(`üì± Loaded ${properties.length} properties from localStorage (server error)`);
                        // Calculate metrics for properties loaded from localStorage
                        properties.forEach(prop => {
                            if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                calculatePropertyMetrics(prop);
                            }
                        });
                    } else {
                        properties = [];
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading properties:', error);
                // Network error, fallback to localStorage
                const saved = localStorage.getItem('properties');
                if (saved) {
                    properties = JSON.parse(saved);
                    console.log(`üì± Loaded ${properties.length} properties from localStorage (network error)`);
                    // Calculate metrics for properties loaded from localStorage
                    properties.forEach(prop => {
                        if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                            calculatePropertyMetrics(prop);
                        }
                    });
                } else {
                    properties = [];
                    console.log('üì± No properties in localStorage');
                }
            }
            
            updateDisplay();
        }

        // Save properties
        async function saveProperties() {
            // Always save to localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // Try to save to server
            let updatedCount = 0;
            let createdCount = 0;
            let failedCount = 0;
            
            try {
                // First check if database is connected
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                
                if (!status.databaseConnected) {
                    console.warn('‚ö†Ô∏è Database not connected - saving to localStorage only');
                    return { success: false, warning: 'Database not connected - data saved locally only' };
                }
                
                for (let i = 0; i < properties.length; i++) {
                    const property = properties[i];
                    
                    if (!property.id) {
                        // New property, create it
                        console.log('Creating new property in database:', property.address);
                        
                        // Ensure we send all required fields with both naming conventions
                        const propertyToCreate = {
                            ...property,
                            // Include both camelCase and snake_case versions
                            purchasePrice: property.purchasePrice || property.purchase_price || 0,
                            monthlyRent: property.monthlyRent || property.monthly_rent || 0,
                            propertyTax: property.propertyTax || property.property_tax || 0,
                            managementFees: property.managementFees || property.management_fees || 0,
                            cashFlow: property.cashFlow || property.cash_flow || 0,
                            cocReturn: property.cocReturn || property.coc_return || 0,
                            rentToValue: property.rentToValue || property.rent_to_value || 0,
                            capRate: property.capRate || property.cap_rate || 0,
                            // Also include snake_case versions for database
                            purchase_price: property.purchasePrice || property.purchase_price || 0,
                            monthly_rent: property.monthlyRent || property.monthly_rent || 0,
                            property_tax: property.propertyTax || property.property_tax || 0,
                            management_fees: property.managementFees || property.management_fees || 0,
                            cash_flow: property.cashFlow || property.cash_flow || 0,
                            coc_return: property.cocReturn || property.coc_return || 0,
                            rent_to_value: property.rentToValue || property.rent_to_value || 0,
                            cap_rate: property.capRate || property.cap_rate || 0
                        };
                        
                        console.log('üì¶ Data being sent to server:', {
                            address: propertyToCreate.address,
                            city: propertyToCreate.city,
                            state: propertyToCreate.state,
                            zip: propertyToCreate.zip,
                            purchasePrice: propertyToCreate.purchasePrice,
                            monthlyRent: propertyToCreate.monthlyRent
                        });
                        
                        const response = await fetch('/api/properties', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(propertyToCreate)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            // CRITICAL: Update the property in the array with the server response
                            properties[i] = {
                                ...property,
                                ...data.data,
                                // Ensure camelCase fields are preserved
                                purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                                monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                            };
                            createdCount++;
                            console.log('‚úÖ Property created with ID:', properties[i].id);
                            console.log('Updated property in array:', properties[i]);
                            
                            // Show warning if database wasn't available
                            if (data.warning) {
                                console.warn('‚ö†Ô∏è Warning:', data.warning);
                            }
                        } else {
                            console.error('‚ùå Failed to create property:', data.error || 'Unknown error');
                            
                            // Show error notification if available
                            if (typeof showNotification === 'function' && data.error) {
                                showNotification(data.error, 'error');
                            }
                            
                            // If it's a duplicate property error, remove it from the array
                            if (data.existingProperty) {
                                const index = properties.indexOf(property);
                                if (index > -1) {
                                    properties.splice(index, 1);
                                    console.log('Removed duplicate property from local array');
                                }
                            }
                        }
                    } else {
                        // Existing property, update it
                        // Debug: Log what we're sending for first 2 properties
                        if (property.address === '1613 Capistrano Ave' || property.address === '1701 Canosa Ave') {
                            console.log(`üì§ Saving property: ${property.address}`, {
                                id: property.id,
                                beds: property.beds,
                                bedrooms: property.bedrooms,
                                realTimeData: property.realTimeData,
                                estimatedValue: property.estimatedValue,
                                rentEstimate: property.rentEstimate,
                                lastRentCastUpdate: property.lastRentCastUpdate
                            });
                        }
                        
                        // Ensure we send all necessary fields with proper names
                        const propertyToSave = {
                            ...property,
                            // Ensure both field name variants are included
                            bedrooms: property.beds || property.bedrooms,
                            bathrooms: property.baths || property.bathrooms,
                            square_footage: property.sqft || property.square_footage,
                            value_estimate: property.estimatedValue || property.value_estimate || property.currentValue,
                            rent_estimate: property.rentEstimate || property.rent_estimate
                        };
                        
                        const response = await fetch(`/api/properties/${property.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(propertyToSave)
                        });
                        if (response.ok) {
                            const updatedData = await response.json();
                            console.log(`‚úÖ Updated property ${property.id}: ${property.address}, ${property.city}`);
                            
                            // Debug: Check what the server returned for first 2 properties
                            if (property.address === '1613 Capistrano Ave' || property.address === '1701 Canosa Ave') {
                                console.log(`üì• Server returned for ${property.address}:`, {
                                    beds: updatedData.data.beds,
                                    bedrooms: updatedData.data.bedrooms,
                                    realTimeData: updatedData.data.realTimeData,
                                    estimatedValue: updatedData.data.estimatedValue
                                });
                            }
                            
                            updatedCount++;
                        } else {
                            console.error(`Failed to update property ${property.id}:`, await response.text());
                        }
                    }
                }
                
                // Log summary of save operation
                if (createdCount > 0 || updatedCount > 0) {
                    console.log(`üíæ Save complete: ${createdCount} created, ${updatedCount} updated`);
                    
                    // IMPORTANT: Update localStorage again with all the new IDs
                    localStorage.setItem('properties', JSON.stringify(properties));
                    console.log('‚úÖ Updated localStorage with new IDs');
                }
            } catch (error) {
                console.error('Error saving to server:', error);
                failedCount = properties.filter(p => !p.id).length;
                // Continue anyway, we have localStorage backup
            }
            
            // Return save result
            return {
                success: true,
                createdCount,
                updatedCount,
                failedCount,
                localStorageSaved: true
            };
        }

        // Update display
        function updateDisplay() {
            updateStats();
            updateTable();
            updateCityFilter();
        }

        // Update statistics
        function updateStats() {
            const availableProperties = properties.filter(p => p.status !== 'sold');
            
            const totalProperties = properties.length;
            const totalValue = availableProperties.reduce((sum, p) => sum + (p.currentValue || p.purchasePrice || 0), 0);
            const totalEquity = availableProperties.reduce((sum, p) => {
                const value = p.currentValue || p.purchasePrice || 0;
                const loan = (p.purchasePrice || 0) * 0.8;
                return sum + (value - loan);
            }, 0);
            const totalCashFlow = availableProperties.reduce((sum, p) => sum + (p.monthlyCashFlow || 0), 0);
            
            const avgCashOnCash = availableProperties.length > 0 ? 
                availableProperties.reduce((sum, p) => sum + (p.cashOnCashReturn || 0), 0) / availableProperties.length : 0;
            
            document.getElementById('totalProperties').textContent = totalProperties;
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('monthlyCashFlow').textContent = formatCurrency(totalCashFlow);
            document.getElementById('avgCashOnCash').textContent = avgCashOnCash.toFixed(1) + '%';
        }

        // Update table
        function updateTable() {
            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = '';
            
            const filteredProperties = getFilteredProperties();
            
            // Debug: Check order of properties in table
            if (filteredProperties.length > 0) {
                console.log('üìä Table order - First 3 properties:');
                filteredProperties.slice(0, 3).forEach((p, i) => {
                    console.log(`Row ${i+1}: ${p.address}, ${p.city} - beds: ${p.beds || p.bedrooms || 0}`);
                });
            }
            
            filteredProperties.forEach((property, index) => {
                const row = createPropertyRow(property, properties.indexOf(property));
                tbody.appendChild(row);
            });
        }

        // Create property row
        function createPropertyRow(property, index) {
            const row = document.createElement('tr');
            row.onclick = () => showPropertyDetails(index);
            
            const statusClass = property.status === 'sold' ? 'status-sold' : 
                               property.status === 'pending' ? 'status-pending' : 'status-available';
            
            const cashFlowClass = (property.monthlyCashFlow || 0) >= 0 ? 'positive' : 'negative';
            const annualCashFlowClass = (property.annualCashFlow || 0) >= 0 ? 'positive' : 'negative';
            
            // Calculate additional metrics if not already calculated
            if (!property.monthlyCashFlow) {
                calculatePropertyMetrics(property);
            }
            
            // Calculate DSCR (Debt Service Coverage Ratio)
            const purchasePrice = property.purchasePrice || property.estimatedValue || 0;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            const noi = (property.monthlyRent || property.rentEstimate || 0) * 12 - (calculateTotalExpenses(property) * 12);
            const annualDebtService = monthlyMortgage * 12;
            const dscr = annualDebtService > 0 ? noi / annualDebtService : 0;
            
            // Determine styling classes for financial metrics
            const capRateClass = (property.capRate || 0) >= 6 ? 'positive' : 'warning';
            const cashOnCashClass = (property.cashOnCashReturn || 0) >= 8 ? 'positive' : 'warning';
            const dscrClass = dscr >= 1.25 ? 'positive' : dscr >= 1.0 ? 'warning' : 'negative';
            
            row.innerHTML = `
                <td style="min-width: 200px;">${property.address || ''}</td>
                <td style="min-width: 120px;">${property.city || ''}</td>
                <td style="min-width: 100px;">${property.propertyType || 'Single Family'}</td>
                <td style="min-width: 80px; text-align: center;">
                    ${property.beds || property.bedrooms || 0}/${property.baths || property.bathrooms || 0}
                </td>
                <td style="min-width: 80px; text-align: right;">
                    ${property.sqft || property.squareFootage ? (property.sqft || property.squareFootage).toLocaleString() : 'N/A'}
                </td>
                <td style="min-width: 120px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'purchasePrice', ${property.purchasePrice || 0})" 
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(property.purchasePrice || 0)}
                    </span>
                </td>
                <td style="min-width: 120px; text-align: right;">
                    ${formatCurrency(property.estimatedValue || property.currentValue || property.purchasePrice || 0)}
                    ${property.realTimeData && property.estimatedValue ? '<span style="color: #10b981; font-size: 10px;">üìä</span>' : ''}
                </td>
                <td style="min-width: 120px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'monthlyRent', ${property.monthlyRent || 0})" 
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(property.monthlyRent || 0)}
                    </span>
                </td>
                <td style="min-width: 120px; text-align: right;">
                    ${formatCurrency(property.rentEstimate || 0)}
                    ${property.realTimeData && property.rentEstimate ? '<span style="color: #10b981; font-size: 10px;">üìä</span>' : ''}
                </td>
                <td class="${cashFlowClass}" style="min-width: 100px; text-align: right; font-weight: 500;">
                    ${formatCurrency(property.monthlyCashFlow || 0)}
                </td>
                <td class="${annualCashFlowClass}" style="min-width: 100px; text-align: right;">
                    ${formatCurrency(property.annualCashFlow || 0)}
                </td>
                <td class="${cashOnCashClass}" style="min-width: 90px; text-align: right; font-weight: 500;">
                    ${(property.cashOnCashReturn || 0).toFixed(1)}%
                </td>
                <td class="${capRateClass}" style="min-width: 80px; text-align: right; font-weight: 500;">
                    ${(property.capRate || 0).toFixed(1)}%
                </td>
                <td style="min-width: 120px; text-align: right;">
                    ${formatCurrency(downPayment)}
                </td>
                <td class="${dscrClass}" style="min-width: 80px; text-align: right; font-weight: 500;">
                    ${dscr > 0 ? dscr.toFixed(2) : 'N/A'}
                </td>
                <td class="${statusClass}" style="min-width: 80px; text-align: center;">
                    ${property.status || 'Available'}
                </td>
                <td onclick="event.stopPropagation()" style="min-width: 80px;">
                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                        <i class="fas fa-sync-alt icon-refresh ${property.rentcastCache ? '' : 'text-warning'}" 
                           onclick="refreshProperty(${index})" 
                           title="${property.rentcastCache ? 'Refresh RentCast Data (Last updated: ' + new Date(property.rentcastCache.timestamp).toLocaleDateString() + ')' : 'Fetch RentCast Data (No data cached yet)'}"></i>
                        ${property.realTimeData ? 
                            `<span style="color: #10b981; font-size: 12px;" title="RentCast data available (${property.lastRentCastUpdate ? new Date(property.lastRentCastUpdate).toLocaleDateString() : 'Unknown date'})">üìä</span>` : 
                            `<span style="color: #ef4444; font-size: 12px;" title="No RentCast data - click refresh">‚ùå</span>`
                        }
                    </div>
                </td>
            `;
            
            return row;
        }

        // Show property details
        async function showPropertyDetails(index) {
            selectedPropertyIndex = index;
            const property = properties[index];
            
            document.getElementById('modalTitle').innerHTML = `<i class="fas fa-home"></i> ${property.address}`;
            document.getElementById('modalBody').innerHTML = generatePropertyDetailsHTML(property, index);
            document.getElementById('propertyModal').style.display = 'block';
            
            // Fetch and display rental listings
            await fetchAndDisplayRentalListings(property);
            
            // Fetch and display market statistics
            await fetchAndDisplayMarketStats(property);
        }

        // Generate property details HTML
        function generatePropertyDetailsHTML(property, propertyIndex) {
            // Debug log to check property data in modal
            console.log('üè† Property data in modal:', {
                address: property.address,
                beds: property.beds,
                baths: property.baths,
                sqft: property.sqft,
                yearBuilt: property.yearBuilt,
                estimatedValue: property.estimatedValue,
                currentValue: property.currentValue,
                realTimeData: property.realTimeData
            });
            
            const monthlyMortgage = calculateMortgagePayment(
                (property.purchasePrice || 0) * 0.8,
                0.065,
                30
            );
            
            const totalExpenses = calculateTotalExpenses(property);
            const noi = (property.monthlyRent || 0) * 12 - totalExpenses * 12;
            const capRate = property.purchasePrice > 0 ? (noi / property.purchasePrice) * 100 : 0;
            
            return `
                <div class="analysis-section">
                    <h3>Property Information</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${property.address || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${property.city || ''}, ${property.state || ''} ${property.zip || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${property.propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms / Bathrooms</div>
                            <div class="detail-value">${property.beds || 0} / ${property.baths || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${(property.sqft || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">${property.yearBuilt || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${property.status || 'Available'}</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>Financial Analysis</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Purchase Price</div>
                            <div class="metric-value editable-field" 
                                 onclick="event.stopPropagation(); editField(${propertyIndex}, 'purchasePrice', ${property.purchasePrice || 0}, true)" 
                                 style="cursor: pointer; border-bottom: 2px dashed var(--border-light);"
                                 title="Click to edit">
                                ${formatCurrency(property.purchasePrice || 0)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Current Value</div>
                            <div class="metric-value">${formatCurrency(property.currentValue || property.purchasePrice || 0)}</div>
                        </div>
                        ${property.estimatedValue ? `
                        <div class="metric-card">
                            <div class="metric-label">Est. Value (RentCast)</div>
                            <div class="metric-value">${formatCurrency(property.estimatedValue)}</div>
                        </div>
                        ` : ''}
                        <div class="metric-card">
                            <div class="metric-label">Monthly Rent</div>
                            <div class="metric-value positive editable-field"
                                 onclick="event.stopPropagation(); editField(${propertyIndex}, 'monthlyRent', ${property.monthlyRent || 0}, true)" 
                                 style="cursor: pointer; border-bottom: 2px dashed var(--border-light);"
                                 title="Click to edit">
                                ${formatCurrency(property.monthlyRent || 0)}
                            </div>
                        </div>
                        ${property.rentEstimate ? `
                        <div class="metric-card">
                            <div class="metric-label">Rent Est. (RentCast)</div>
                            <div class="metric-value positive">${formatCurrency(property.rentEstimate)}</div>
                        </div>
                        ` : ''}
                        <div class="metric-card">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${(property.monthlyCashFlow || 0) >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(property.monthlyCashFlow || 0)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${(property.cashOnCashReturn || 0) >= 8 ? 'positive' : 'warning'}">
                                ${(property.cashOnCashReturn || 0).toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                </div>

                ${property.marketStats ? `
                <div class="analysis-section">
                    <h3>Market Statistics (${property.zip})</h3>
                    <div class="metrics-grid">
                        ${property.marketStats.medianRent ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(property.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.medianPrice ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(property.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.avgDaysOnMarket ? `
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${property.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.inventoryCount ? `
                        <div class="metric-card">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${property.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Rental Listings Section -->
                <div class="analysis-section" style="margin-top: 20px;">
                    <h3>üè† Comparable Rental Listings</h3>
                    <div id="rentalListingsLoading" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading rental listings...
                    </div>
                    <div id="rentalListingsContent" style="display: none;">
                        <!-- Rental listings will be populated here -->
                    </div>
                </div>

                <div id="aiAnalysisSection" style="display: none; margin: 20px 0;">
                    <h3>ü§ñ AI Investment Analysis</h3>
                    <div id="aiAnalysisContent" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; border: 1px solid var(--border-color);"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generatePropertyAIAnalysis(${selectedPropertyIndex})" style="background: #8b5cf6;">
                        <i class="fas fa-brain"></i> AI Analysis
                    </button>
                    ${property.status !== 'sold' ? `
                        <button class="btn btn-secondary" onclick="editProperty(${selectedPropertyIndex})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-success" onclick="markAsSold(${selectedPropertyIndex})">
                            <i class="fas fa-check"></i> Mark as Sold
                        </button>
                    ` : ''}
                    <button class="btn btn-danger" onclick="deleteProperty(${selectedPropertyIndex})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
        }

        // Refresh property data
        async function refreshProperty(index) {
            const property = properties[index];
            if (!property) {
                console.error('No property found at index:', index);
                return;
            }
            
            try {
                // Animate the refresh icon
                const rows = document.querySelectorAll('#propertyTableBody tr');
                const refreshIcon = rows[index]?.querySelector('.icon-refresh');
                if (refreshIcon) {
                    refreshIcon.style.animation = 'spin 1s linear infinite';
                }
                
                console.log(`üîÑ Refreshing property ${index}:`, {
                    address: property.address,
                    city: property.city,
                    state: property.state,
                    zip: property.zip
                });
                
                // Validate address components
                if (!property.address || !property.city || !property.state) {
                    throw new Error(`Incomplete address for property: ${property.address || 'No address'}`);
                }
                
                // Check if we have recent cached data (less than 24 hours old)
                const cacheAge = property.rentcastCache?.timestamp ? 
                    (Date.now() - new Date(property.rentcastCache.timestamp).getTime()) / (1000 * 60 * 60) : Infinity;
                
                if (cacheAge < 24 && property.rentcastCache?.data) {
                    console.log('üì¶ Cache is recent (< 24 hours old), consider using cached data');
                }
                
                // Fetch updated data from RentCast
                const fullAddress = `${property.address}, ${property.city}, ${property.state} ${property.zip}`;
                console.log('üìç Full address for API call:', fullAddress);
                console.log('üéØ API Call Strategy: Optimized to minimize calls');
                
                const rentcastData = await fetchRentCastData({
                    streetAddress: property.address,
                    city: property.city,
                    state: property.state,
                    zip: property.zip
                });
                
                console.log('üìä RentCast API response:', rentcastData);
                if (rentcastData?.data?.apiCallCount) {
                    console.log(`üéØ Total API calls made: ${rentcastData.data.apiCallCount}`);
                }
                
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    console.log('‚úÖ RentCast data found, updating property...');
                    
                    // Store original values for comparison
                    const originalRent = property.monthlyRent;
                    const originalValue = property.currentValue;
                    
                    // Cache the full RentCast API response
                    property.rentcastCache = {
                        data: rentcastData.data,
                        timestamp: new Date().toISOString(),
                        success: true
                    };
                    
                    // Update property with new data - mark as real-time data
                    property.realTimeData = true;
                    property.lastRentCastUpdate = new Date().toISOString();
                    
                    // Update with fetched data - preserve our field naming convention
                    const mappedData = {
                        ...rentcastData.data,
                        // Ensure we have both sets of field names for compatibility
                        beds: rentcastData.data.beds || rentcastData.data.bedrooms,
                        baths: rentcastData.data.baths || rentcastData.data.bathrooms,
                        sqft: rentcastData.data.sqft || rentcastData.data.squareFootage,
                        // Also keep the database column names
                        bedrooms: rentcastData.data.beds || rentcastData.data.bedrooms,
                        bathrooms: rentcastData.data.baths || rentcastData.data.bathrooms,
                        square_footage: rentcastData.data.sqft || rentcastData.data.squareFootage,
                        // Ensure yearBuilt is set
                        yearBuilt: rentcastData.data.yearBuilt,
                        year_built: rentcastData.data.yearBuilt
                    };
                    
                    Object.assign(property, mappedData);
                    
                    // Debug log to check property data
                    console.log('üìä Property after RentCast update:', {
                        beds: property.beds,
                        baths: property.baths,
                        sqft: property.sqft,
                        bedrooms: property.bedrooms,
                        bathrooms: property.bathrooms,
                        square_footage: property.square_footage,
                        estimatedValue: property.estimatedValue,
                        currentValue: property.currentValue,
                        yearBuilt: property.yearBuilt
                    });
                    
                    // Recalculate financial metrics
                    calculatePropertyMetrics(property);
                    
                    // Log what changed
                    console.log('üìà Property updated:', {
                        rentChange: `${originalRent} ‚Üí ${property.monthlyRent || property.rentEstimate}`,
                        valueChange: `${originalValue} ‚Üí ${property.currentValue || property.estimatedValue}`,
                        hasMarketStats: !!property.marketStats
                    });
                    
                    // Save and update display
                    await saveProperties();
                    updateDisplay();
                    
                    // Success - data refreshed silently without interrupting the user
                    console.log('‚úÖ Property data refreshed successfully');
                    
                } else {
                    console.warn('‚ö†Ô∏è No RentCast data returned:', rentcastData);
                    
                    // Try to get specific error details
                    let errorMessage = 'No data available for this address from RentCast API.';
                    if (rentcastData && rentcastData.error) {
                        errorMessage = `API Error: ${rentcastData.error}`;
                    }
                    
                    // Log warning without interrupting the user
                    console.warn(`‚ö†Ô∏è Refresh completed but no new data found for ${fullAddress}. ${errorMessage}`);
                }
            } catch (error) {
                console.error('‚ùå Error refreshing property:', error);
                // Only log errors to console, don't interrupt the user
                console.error(`Failed to refresh data for ${property.address || 'Unknown address'}:`, error.message);
            } finally {
                // Stop animation
                const rows = document.querySelectorAll('#propertyTableBody tr');
                const refreshIcon = rows[index]?.querySelector('.icon-refresh');
                if (refreshIcon) {
                    refreshIcon.style.animation = '';
                }
            }
        }

        // Fetch RentCast data
        async function fetchRentCastData(address, forceRefresh = true) {
            let apiCallCount = 0; // Track number of API calls
            try {
                console.log('üåê Fetching RentCast data for:', address);
                
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                console.log('üìã API Parameters:', params.toString());
                
                // OPTIMIZATION: Try to get all data from the properties endpoint first
                console.log('üéØ Making single API call to properties endpoint...');
                apiCallCount++;
                const response = await fetch(`/api/rentcast/properties?${params}`);
                const data = await response.json();
                
                console.log('üèòÔ∏è Properties API Response:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    const property = data.data[0];
                    console.log('‚úÖ Found property data:', property);
                    
                    // Check if property data already includes rent and value estimates
                    const hasRentEstimate = property.rent || property.rentEstimate || property.rentRangeLow;
                    const hasValueEstimate = property.price || property.value || property.estimatedValue;
                    
                    console.log('üìã Checking existing data:', {
                        hasRentEstimate,
                        hasValueEstimate,
                        rentValue: property.rent || property.rentEstimate || property.rentRangeLow,
                        valueEstimate: property.price || property.value || property.estimatedValue
                    });
                    
                    // Only fetch additional data if not already present
                    let rentData = null;
                    let valueData = null;
                    let marketData = null;
                    
                    // Determine what additional data we need
                    const needsRent = !hasRentEstimate;
                    const needsValue = !hasValueEstimate;
                    // OPTIMIZATION: Skip market stats - it's not essential for property data
                    // Market stats can be fetched separately if needed
                    const needsMarket = false; // Skip to reduce API calls
                    
                    if (needsRent || needsValue || needsMarket) {
                        console.log('üîÑ Fetching only missing data:', {
                            needsRent,
                            needsValue,
                            needsMarket
                        });
                        
                        // Fetch only what's needed
                        const promises = [];
                        if (needsRent) {
                            promises.push(fetchRentEstimate(address));
                            apiCallCount++;
                        }
                        if (needsValue) {
                            promises.push(fetchValueEstimate(address));
                            apiCallCount++;
                        }
                        if (needsMarket) {
                            promises.push(fetchMarketStats(address.zip));
                            apiCallCount++;
                        }
                        
                        const results = await Promise.all(promises);
                        
                        // Assign results based on what was fetched
                        let resultIndex = 0;
                        if (needsRent) rentData = results[resultIndex++];
                        if (needsValue) valueData = results[resultIndex++];
                        if (needsMarket) marketData = results[resultIndex++];
                        
                        console.log('üìä Additional data fetched:', {
                            rentData: rentData?.rent ? `$${rentData.rent}` : (hasRentEstimate ? 'Already had data' : 'No data'),
                            valueData: valueData?.value ? `$${valueData.value.toLocaleString()}` : (hasValueEstimate ? 'Already had data' : 'No data'),
                            marketData: marketData?.zipCode ? `ZIP ${marketData.zipCode}` : 'No data'
                        });
                    } else {
                        console.log('‚úÖ Property data already contains all estimates, skipping additional API calls');
                    }
                    
                    return {
                        success: true,
                        data: {
                            ...property,
                            // Map RentCast field names to our application's field names
                            beds: property.bedrooms,
                            baths: property.bathrooms,
                            sqft: property.squareFootage,
                            yearBuilt: property.yearBuilt,
                            // Use existing data if available, otherwise use fetched data
                            rentEstimate: property.rent || property.rentEstimate || property.rentRangeLow || rentData?.rent,
                            estimatedValue: property.price || property.value || property.estimatedValue || valueData?.price || valueData?.value,
                            marketStats: marketData || {},
                            // Add metadata
                            dataSource: 'RentCast API',
                            fetchedAt: new Date().toISOString(),
                            realTimeData: true,
                            apiCallCount: apiCallCount // Track how many API calls were made
                        }
                    };
                } else {
                    console.warn('‚ö†Ô∏è Properties API returned no data:', data);
                    
                    // OPTIMIZATION: If properties API fails, only try rent estimate as fallback
                    // This reduces from 3 API calls to just 1
                    console.log('üîÑ Trying minimal fallback: rent estimate only...');
                    apiCallCount++;
                    const rentData = await fetchRentEstimate(address);
                    
                    if (rentData?.rent) {
                        console.log('‚úÖ Found fallback rent data');
                        return {
                            success: true,
                            data: {
                                address: `${address.streetAddress || address.address}, ${address.city}, ${address.state} ${address.zip}`,
                                rentEstimate: rentData.rent,
                                estimatedValue: null, // No value data in minimal mode
                                marketStats: {}, // No market stats in minimal mode
                                dataSource: 'RentCast API (Rent Estimate Only)',
                                fetchedAt: new Date().toISOString(),
                                realTimeData: true,
                                minimalData: true, // Flag to indicate limited data
                                apiCallCount: apiCallCount // Track how many API calls were made
                            }
                        };
                    }
                    
                    return { 
                        success: false, 
                        error: data.error || 'No property data found',
                        message: data.message || 'The address may not exist in RentCast database'
                    };
                }
                
                console.log(`üìä Total RentCast API calls made: ${apiCallCount}`);
            } catch (error) {
                console.error('‚ùå Error fetching RentCast data:', error);
                console.log(`üìä Total RentCast API calls made before error: ${apiCallCount}`);
                return { 
                    success: false, 
                    error: error.message,
                    message: 'Network or server error occurred'
                };
            }
        }

        // Fetch rent estimate
        async function fetchRentEstimate(address) {
            try {
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                const response = await fetch(`/api/rentcast/rent-estimate?${params}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching rent estimate:', error);
            }
            return null;
        }

        // Fetch value estimate
        async function fetchValueEstimate(address) {
            try {
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                const response = await fetch(`/api/rentcast/value-estimate?${params}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching value estimate:', error);
            }
            return null;
        }

        // Fetch market statistics
        async function fetchMarketStats(zipCode) {
            try {
                const response = await fetch(`/api/rentcast/market-stats?zipCode=${zipCode}&historyRange=12`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching market stats:', error);
            }
            return null;
        }

        // Fetch and display rental listings
        // Fetch and display market statistics
        async function fetchAndDisplayMarketStats(property) {
            try {
                console.log('üìà Displaying market stats section for:', property.zip);
                
                // Add market stats section
                const marketStatsHTML = `
                    <div class="property-section">
                        <h3><i class="fas fa-chart-line"></i> Market Statistics</h3>
                        <div id="marketStatsContent" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>Market statistics are not loaded to minimize API usage.</p>
                            <p style="margin-top: 10px; color: var(--text-muted);">
                                To view current market statistics, please click the refresh icon 
                                <i class="fas fa-sync-alt" style="color: var(--accent-primary);"></i> 
                                on this property in the main table.
                            </p>
                        </div>
                    </div>
                `;
                
                // Add to modal after rental listings
                const rentalSection = document.querySelector('#rentalListingsContent').parentElement.parentElement;
                if (rentalSection) {
                    rentalSection.insertAdjacentHTML('afterend', marketStatsHTML);
                }
                
                console.log('üì¶ Skipping market stats API call - use refresh button to load data');
                
                // IMPORTANT: API calls removed to prevent excessive usage
                // Market stats are only fetched when user explicitly clicks refresh
                // This follows our caching strategy to minimize RentCast API calls
            } catch (error) {
                console.error('Error displaying market stats section:', error);
                const statsContent = document.getElementById('marketStatsContent');
                if (statsContent) {
                    statsContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>Unable to display market statistics section.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Display market statistics
        function displayMarketStats(stats, property) {
            document.getElementById('marketStatsLoading').style.display = 'none';
            document.getElementById('marketStatsContent').style.display = 'block';
            
            const html = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${stats.rentalData?.medianRent ? formatCurrency(stats.rentalData.medianRent) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Median Sale Price</div>
                            <div class="metric-value">${stats.saleData?.medianPrice ? formatCurrency(stats.saleData.medianPrice) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${stats.rentalData?.averageDaysOnMarket ? Math.round(stats.rentalData.averageDaysOnMarket) : 'N/A'} days</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Rentals</div>
                            <div class="metric-value">${stats.rentalData?.totalListings || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${stats.rentalData || stats.salesData ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-secondary);">Historical Trends</h4>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                        ${stats.rentalData && stats.rentalData.history ? `
                            <div style="margin-bottom: 10px;">
                                <strong>Rental Market (Last 3 months):</strong><br>
                                ${Object.entries(stats.rentalData.history).slice(-3).map(([key, data]) => 
                                    `${key}: ${formatCurrency(data.medianRent)} (${data.totalListings} listings)`
                                ).join(', ')}
                            </div>
                        ` : ''}
                        ${stats.saleData && stats.saleData.history ? `
                            <div>
                                <strong>Sales Market (Last 3 months):</strong><br>
                                ${Object.entries(stats.saleData.history).slice(-3).map(([key, data]) => 
                                    `${key}: ${formatCurrency(data.medianPrice)} (${data.totalListings} listings)`
                                ).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <p style="margin: 0; font-size: 0.9em;">
                        <strong>üìä Market Context:</strong> 
                        ${getMarketContext(stats, property)}
                    </p>
                </div>
            `;
            
            document.getElementById('marketStatsContent').innerHTML = html;
        }
        
        // Get market context message
        function getMarketContext(stats, property) {
            if (!stats.rentalData?.medianRent) return 'Limited market data available for this ZIP code.';
            
            const rentRatio = property.rentEstimate / stats.rentalData.medianRent;
            if (rentRatio > 1.1) {
                return `This property's estimated rent is ${((rentRatio - 1) * 100).toFixed(0)}% above the ZIP code median. This could indicate premium features or a desirable location within the area.`;
            } else if (rentRatio < 0.9) {
                return `This property's estimated rent is ${((1 - rentRatio) * 100).toFixed(0)}% below the ZIP code median. Consider evaluating if improvements could justify higher rent.`;
            } else {
                return 'This property aligns well with the median rental rates in the ZIP code.';
            }
        }

        async function fetchAndDisplayRentalListings(property) {
            try {
                console.log('üè† Displaying rental listings section for:', property.address);
                // Hide loading indicator immediately
                document.getElementById('rentalListingsLoading').style.display = 'none';
                document.getElementById('rentalListingsContent').style.display = 'block';
                
                // Instead of making API calls, show a message to use the refresh button
                document.getElementById('rentalListingsContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                        <p>Rental listings data is not loaded to minimize API usage.</p>
                        <p style="margin-top: 10px; color: var(--text-muted);">
                            To view current rental listings, please click the refresh icon 
                            <i class="fas fa-sync-alt" style="color: var(--accent-primary);"></i> 
                            on this property in the main table.
                        </p>
                    </div>
                `;
                
                console.log('üì¶ Skipping rental listings API call - use refresh button to load data');
                
                // IMPORTANT: API calls removed to prevent excessive usage
                // Rental listings are only fetched when user explicitly clicks refresh
                // This follows our caching strategy to minimize RentCast API calls
            } catch (error) {
                console.error('Error in rental listings section:', error);
                document.getElementById('rentalListingsLoading').style.display = 'none';
                document.getElementById('rentalListingsContent').style.display = 'block';
                document.getElementById('rentalListingsContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                        <p>Unable to display rental listings section.</p>
                    </div>
                `;
            }
        }

        // Show no listings message with helpful information
        function showNoListingsMessage(property) {
            document.getElementById('rentalListingsLoading').style.display = 'none';
            document.getElementById('rentalListingsContent').style.display = 'block';
            document.getElementById('rentalListingsContent').innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                    <p style="font-weight: 500; margin-bottom: 15px;">No rental listings found in the area.</p>
                    
                    <div style="text-align: left; max-width: 500px; margin: 0 auto; background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                        <p style="margin: 0 0 10px 0; font-size: 0.9em;">
                            <strong>Possible reasons:</strong>
                        </p>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.85em; color: var(--text-muted);">
                            <li>Limited rental inventory in ZIP ${property.zip}</li>
                            <li>No current listings match the property criteria</li>
                            <li>The area may have low rental turnover</li>
                            <li>RentCast may not have complete coverage for this ZIP code</li>
                        </ul>
                        
                        <p style="margin: 15px 0 0 0; font-size: 0.85em; color: var(--text-secondary);">
                            <strong>Alternatives:</strong> Try searching on 
                            <a href="https://www.zillow.com/homes/for_rent/${property.zip}_rb/" target="_blank" style="color: var(--accent-primary);">Zillow</a>, 
                            <a href="https://www.realtor.com/apartments/${property.city}-${property.state}/${property.zip}" target="_blank" style="color: var(--accent-primary);">Realtor.com</a>, or
                            <a href="https://www.apartments.com/${property.city.toLowerCase()}-${property.state.toLowerCase()}/${property.zip}/" target="_blank" style="color: var(--accent-primary);">Apartments.com</a>
                        </p>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="retryWithCityState(${JSON.stringify({city: property.city, state: property.state, zip: property.zip}).replace(/"/g, '&quot;')})" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Try searching by ${property.city}, ${property.state}
                    </button>
                    
                    <button class="btn btn-secondary" onclick="testRentCastAPI('${property.zip}')" style="margin-top: 15px; margin-left: 10px;">
                        <i class="fas fa-vial"></i> Test API Response
                    </button>
                </div>
            `;
        }

        // Retry rental search with city/state instead of ZIP
        async function retryWithCityState(location) {
            document.getElementById('rentalListingsLoading').style.display = 'block';
            document.getElementById('rentalListingsContent').style.display = 'none';
            
            try {
                const params = new URLSearchParams({
                    city: location.city,
                    state: location.state,
                    radius: 10,
                    limit: 50
                });
                
                console.log('üîç Retrying with city/state:', params.toString());
                
                const response = await fetch(`/api/rentcast/rental-listings?${params}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const property = properties.find(p => p.zip === location.zip) || { zip: location.zip };
                    displayRentalListings(data.data, property);
                    
                    // Add note about city/state search
                    const noteDiv = document.createElement('div');
                    noteDiv.style.cssText = 'padding: 10px; background: var(--bg-secondary); border: 1px solid var(--accent-info); border-radius: 4px; margin-bottom: 10px;';
                    noteDiv.innerHTML = `
                        <i class="fas fa-info-circle" style="color: var(--accent-info);"></i>
                        <span style="color: var(--text-secondary); margin-left: 5px;">
                            Showing rentals for ${location.city}, ${location.state} area (not limited to ZIP ${location.zip})
                        </span>
                    `;
                    document.getElementById('rentalListingsContent').insertBefore(noteDiv, document.getElementById('rentalListingsContent').firstChild);
                } else {
                    showNoListingsMessage({ city: location.city, state: location.state, zip: location.zip });
                }
            } catch (error) {
                console.error('Error retrying with city/state:', error);
                showNoListingsMessage({ city: location.city, state: location.state, zip: location.zip });
            }
        }

        // Test RentCast API directly
        async function testRentCastAPI(zipCode) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-card);
                padding: 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <h3 style="margin-bottom: 15px;">RentCast API Test for ZIP ${zipCode}</h3>
                <div id="apiTestResults" style="font-family: monospace; font-size: 0.85em;">
                    <p>Testing different API configurations...</p>
                </div>
                <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="margin-top: 15px;">Close</button>
            `;
            
            document.body.appendChild(modal);
            
            const resultsDiv = document.getElementById('apiTestResults');
            let results = '';
            
            // Test 1: ZIP only
            try {
                results += '<p><strong>Test 1: ZIP only</strong></p>';
                const response1 = await fetch(`/api/rentcast/rental-listings?zip=${zipCode}&limit=5`);
                const data1 = await response1.json();
                results += `<pre>${JSON.stringify(data1, null, 2)}</pre><hr>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p><hr>`;
            }
            
            // Test 2: ZIP without bedroom filter
            try {
                results += '<p><strong>Test 2: ZIP without bedroom filter</strong></p>';
                const response2 = await fetch(`/api/rentcast/rental-listings?zip=${zipCode}&limit=10`);
                const data2 = await response2.json();
                results += `<pre>${JSON.stringify(data2, null, 2)}</pre><hr>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p><hr>`;
            }
            
            // Test 3: Check API status
            try {
                results += '<p><strong>Test 3: API Status Check</strong></p>';
                const response3 = await fetch('/api/status');
                const data3 = await response3.json();
                results += `<pre>${JSON.stringify(data3, null, 2)}</pre>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p>`;
            }
            
            resultsDiv.innerHTML = results;
        }

        // Display rental listings
        function displayRentalListings(listings, property) {
            console.log('üìä Displaying rental listings:', listings);
            document.getElementById('rentalListingsLoading').style.display = 'none';
            document.getElementById('rentalListingsContent').style.display = 'block';
            
            // Calculate average rent from listings
            const avgRent = listings.reduce((sum, l) => sum + (l.rent || l.price || 0), 0) / listings.length;
            const rentDiff = property.rentEstimate ? ((property.rentEstimate - avgRent) / avgRent * 100).toFixed(1) : 0;
            
            let html = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="metric-card">
                            <div class="metric-label">Listings Found</div>
                            <div class="metric-value">${listings.length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Market Rent</div>
                            <div class="metric-value">${formatCurrency(avgRent)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${calculateAvgDaysOnMarket(listings)}</div>
                        </div>
                        ${property.rentEstimate ? `
                        <div class="metric-card">
                            <div class="metric-label">Your Rent vs Market</div>
                            <div class="metric-value ${rentDiff >= 0 ? 'positive' : 'negative'}">
                                ${rentDiff >= 0 ? '+' : ''}${rentDiff}%
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                            <tr>
                                <th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--border-color);">Address</th>
                                <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--border-color);">Bed/Bath</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">Sqft</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">Rent</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">$/Sqft</th>
                                <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--border-color);">Days Listed</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            listings.forEach((listing, index) => {
                // Log the first listing structure for debugging
                if (index === 0) {
                    console.log('üìã First listing structure:', listing);
                }
                
                const rent = listing.rent || listing.price || listing.rentAmount || listing.monthlyRent || 0;
                const sqft = listing.squareFootage || listing.squareFeet || listing.sqft || listing.size || 0;
                const pricePerSqft = sqft && rent ? (rent / sqft).toFixed(2) : 'N/A';
                
                // Use daysOnMarket from API or calculate from listedDate
                const daysListed = listing.daysOnMarket || listing.daysActive || 
                    (listing.listedDate || listing.datePosted ? 
                        Math.floor((Date.now() - new Date(listing.listedDate || listing.datePosted).getTime()) / (1000 * 60 * 60 * 24)) : 
                        'N/A');
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-light); ${index % 2 === 0 ? 'background: var(--bg-secondary);' : ''}">
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${listing.propertyType ? `
                                    <div style="width: 50px; height: 50px; background: var(--bg-card); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas ${getPropertyIcon(listing.propertyType)}" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    </div>
                                ` : ''}
                                <div>
                                    <div style="font-weight: 500;">
                                        ${listing.addressLine1 || listing.formattedAddress || listing.address || listing.street || 'N/A'}
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                                        ${listing.city || ''} ${listing.state || listing.stateCode || ''} ${listing.zipCode || listing.zip || listing.postalCode || ''}
                                    </div>
                                    ${listing.county ? `<div style="font-size: 0.8em; color: var(--text-muted);">${listing.county} County</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center; padding: 12px;">
                            ${listing.bedrooms || 0}/${listing.bathrooms || 0}
                        </td>
                        <td style="text-align: right; padding: 12px;">
                            ${sqft ? sqft.toLocaleString() : 'N/A'}
                        </td>
                        <td style="text-align: right; padding: 12px; font-weight: 500; color: var(--accent-success);">
                            ${formatCurrency(rent)}
                        </td>
                        <td style="text-align: right; padding: 12px;">
                            ${pricePerSqft !== 'N/A' ? `$${pricePerSqft}` : pricePerSqft}
                        </td>
                        <td style="text-align: center; padding: 12px;">
                            <div style="${daysListed > 30 ? 'color: var(--accent-warning);' : ''}">
                                ${daysListed !== 'N/A' ? `${daysListed}d` : 'N/A'}
                            </div>
                            ${listing.status ? `
                                <div style="font-size: 0.8em; margin-top: 2px; color: ${listing.status === 'Active' ? 'var(--accent-success)' : 'var(--text-muted)'}">
                                    ${listing.status}
                                </div>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-info); margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 0.9em;">
                            <strong>üí° Market Insight:</strong> 
                            ${rentDiff > 5 ? 
                                `Your estimated rent is ${rentDiff}% above the market average. This property may have premium features or the market data may be outdated.` :
                                rentDiff < -5 ?
                                `Your estimated rent is ${Math.abs(rentDiff)}% below the market average. Consider reviewing your rental pricing strategy.` :
                                `Your estimated rent is aligned with the current market rates in this area.`
                            }
                        </p>
                    </div>
                    
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <p style="margin: 0; font-size: 0.85em; color: var(--text-secondary);">
                            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                            <strong>Note:</strong> Property photos are not available through the RentCast API. 
                            To view property photos and detailed listings, visit popular real estate websites like Zillow, Realtor.com, or Apartments.com
                            and search for rentals in the ${property.zip || 'area'} zip code.
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('rentalListingsContent').innerHTML = html;
        }

        // Calculate property metrics
        function calculatePropertyMetrics(property) {
            const purchasePrice = property.purchasePrice || property.estimatedValue || 0;
            const monthlyRent = property.monthlyRent || property.rentEstimate || 0;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice - downPayment;
            
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            const totalExpenses = calculateTotalExpenses(property);
            
            property.monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            property.annualCashFlow = property.monthlyCashFlow * 12;
            property.cashOnCashReturn = downPayment > 0 ? (property.annualCashFlow / downPayment) * 100 : 0;
            
            const noi = monthlyRent * 12 - totalExpenses * 12;
            property.capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;
        }

        // Calculate total expenses
        function calculateTotalExpenses(property) {
            const purchasePrice = property.purchasePrice || property.estimatedValue || 0;
            const monthlyRent = property.monthlyRent || property.rentEstimate || 0;
            
            const propertyTax = (purchasePrice * 0.012) / 12;
            const insurance = (purchasePrice * 0.004) / 12;
            const hoa = property.hoaMonthly || 0;
            const maintenance = (purchasePrice * 0.01) / 12;
            const propertyManagement = monthlyRent * 0.08;
            
            return propertyTax + insurance + hoa + maintenance + propertyManagement;
        }

        // Calculate mortgage payment
        function calculateMortgagePayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 12;
            const numPayments = years * 12;
            
            if (monthlyRate === 0) return principal / numPayments;
            
            const payment = principal * 
                (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return payment;
        }

        // Get property type icon
        function getPropertyIcon(propertyType) {
            const type = (propertyType || '').toLowerCase();
            if (type.includes('single family') || type.includes('house')) return 'fa-home';
            if (type.includes('condo') || type.includes('condominium')) return 'fa-building';
            if (type.includes('townhouse') || type.includes('townhome')) return 'fa-city';
            if (type.includes('apartment')) return 'fa-building';
            if (type.includes('duplex') || type.includes('triplex') || type.includes('fourplex')) return 'fa-house-user';
            if (type.includes('mobile') || type.includes('manufactured')) return 'fa-caravan';
            if (type.includes('land') || type.includes('lot')) return 'fa-mountain';
            return 'fa-home';
        }
        
        // Calculate average days on market
        function calculateAvgDaysOnMarket(listings) {
            const validListings = listings.filter(l => l.daysOnMarket || l.listedDate);
            if (validListings.length === 0) return 'N/A';
            
            const totalDays = validListings.reduce((sum, listing) => {
                const days = listing.daysOnMarket || 
                    (listing.listedDate ? 
                        Math.floor((Date.now() - new Date(listing.listedDate).getTime()) / (1000 * 60 * 60 * 24)) : 
                        0);
                return sum + days;
            }, 0);
            
            return Math.round(totalDays / validListings.length) + ' days';
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Show notification message
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? 'var(--accent-success)' : type === 'error' ? 'var(--accent-danger)' : 'var(--accent-info)'};
                color: white;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                /* animation: slideIn 0.3s ease; - Removed for instant display */
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Handle add property
        async function handleAddProperty(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Property...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const property = {};
                
                for (let [key, value] of formData.entries()) {
                    property[key] = value;
                }
                
                // Convert numeric fields
                property.purchasePrice = parseFloat(property.purchasePrice) || 0;
                property.monthlyRent = parseFloat(property.monthlyRent) || 0;
                property.beds = parseInt(property.beds) || 0;
                property.baths = parseFloat(property.baths) || 0;
                property.sqft = parseInt(property.sqft) || 0;
                
                // Set defaults
                property.status = 'available';
                property.dateAdded = new Date().toISOString();
                
                // Try to fetch additional data from RentCast
                const rentcastData = await fetchRentCastData(property);
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    // Cache the full RentCast API response
                    property.rentcastCache = {
                        data: rentcastData.data,
                        timestamp: new Date().toISOString(),
                        success: true
                    };
                    
                    // Merge with proper field mapping
                    const mappedData = {
                        ...rentcastData.data,
                        // Ensure we have both sets of field names
                        beds: rentcastData.data.beds || rentcastData.data.bedrooms || property.beds,
                        baths: rentcastData.data.baths || rentcastData.data.bathrooms || property.baths,
                        sqft: rentcastData.data.sqft || rentcastData.data.squareFootage || property.sqft,
                        // Database column names
                        bedrooms: rentcastData.data.beds || rentcastData.data.bedrooms || property.beds,
                        bathrooms: rentcastData.data.baths || rentcastData.data.bathrooms || property.baths,
                        square_footage: rentcastData.data.sqft || rentcastData.data.squareFootage || property.sqft
                    };
                    Object.assign(property, mappedData);
                    
                    // If user didn't provide purchase price or rent, use RentCast estimates
                    if (!property.purchasePrice && rentcastData.data.estimatedValue) {
                        property.purchasePrice = rentcastData.data.estimatedValue;
                        property.currentValue = rentcastData.data.estimatedValue;
                        console.log('Using RentCast estimated value:', property.purchasePrice);
                    }
                    
                    if (!property.monthlyRent && rentcastData.data.rentEstimate) {
                        property.monthlyRent = rentcastData.data.rentEstimate;
                        console.log('Using RentCast rent estimate:', property.monthlyRent);
                    }
                }
                
                // Set current value if not already set
                if (!property.currentValue) {
                    property.currentValue = property.purchasePrice || 0;
                }
                
                // Validate that we have minimum required data
                if (!property.address || !property.city || !property.state || !property.zip) {
                    throw new Error('Please provide complete address information');
                }
                
                // Calculate metrics
                calculatePropertyMetrics(property);
                
                // Create property in database first
                console.log('Creating property in database:', property.address);
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(property)
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // CRITICAL: Add the complete property from server response with ID
                    const propertyWithId = {
                        ...property,
                        ...data.data,
                        // Preserve camelCase fields
                        purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                        monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                    };
                    
                    console.log('‚úÖ Property created with ID:', propertyWithId.id);
                    console.log('Property with ID:', propertyWithId);
                    
                    // Add to properties array
                    properties.push(propertyWithId);
                    
                    // Update localStorage immediately
                    localStorage.setItem('properties', JSON.stringify(properties));
                    console.log('‚úÖ Updated localStorage with new property');
                    
                    updateDisplay();
                    closeModal('addPropertyModal');
                    
                    // Show success message
                    if (typeof showNotification === 'function') {
                        showNotification(`Property "${property.address}" added successfully!`, 'success');
                    }
                } else {
                    throw new Error(data.error || 'Failed to create property');
                }
                
            } catch (error) {
                console.error('Error adding property:', error);
                alert(error.message || 'Error adding property. Please try again.');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        // Generate enhanced property analysis
        function generateEnhancedPropertyAnalysis(address, propertyData) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            const totalExpenses = calculateTotalExpenses({
                purchasePrice,
                monthlyRent,
                hoaMonthly: propertyData.hoaMonthly || 0
            });
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>üìç Property Details</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${propertyData.address || address}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${propertyData.city}, ${propertyData.state} ${propertyData.zip}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${propertyData.propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms / Bathrooms</div>
                            <div class="detail-value">${propertyData.beds || 0} / ${propertyData.baths || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${(propertyData.sqft || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estimated Value</div>
                            <div class="detail-value">${formatCurrency(purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rent Estimate</div>
                            <div class="detail-value">${formatCurrency(monthlyRent)}/mo</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>üìä Investment Analysis</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(monthlyCashFlow)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">
                                ${cashOnCashReturn.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Down Payment</div>
                            <div class="metric-value">
                                ${formatCurrency(downPayment)}
                            </div>
                        </div>
                    </div>
                </div>

                ${propertyData.marketStats && Object.keys(propertyData.marketStats).length > 0 ? `
                <div class="analysis-section">
                    <h3>üìà Market Statistics (${propertyData.zip})</h3>
                    <div class="metrics-grid">
                        ${propertyData.marketStats.medianRent ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPrice ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.avgDaysOnMarket ? `
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${propertyData.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.inventoryCount ? `
                        <div class="metric-card">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${propertyData.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="export-controls">
                    <button class="btn btn-export" onclick="exportAnalysisReport('${address}', ${JSON.stringify(propertyData).replace(/"/g, '&quot;')})">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button class="btn btn-primary" onclick="addPropertyFromAnalysis(${JSON.stringify(propertyData).replace(/"/g, '&quot;')})">
                        <i class="fas fa-plus"></i> Add to Portfolio
                    </button>
                </div>
            `;
        }

        // Generate basic property analysis (fallback)
        function generatePropertyAnalysis(address) {
            const parsedAddress = parseAddressComponents(address);
            const estimatedPrice = 500000;
            const estimatedRent = 2500;
            
            generateEnhancedPropertyAnalysis(address, {
                address: parsedAddress.streetAddress,
                city: parsedAddress.city,
                state: parsedAddress.state,
                zip: parsedAddress.zip,
                estimatedValue: estimatedPrice,
                rentEstimate: estimatedRent,
                beds: 3,
                baths: 2,
                sqft: 1500,
                propertyType: 'Single Family'
            });
        }

        // Parse address components - enhanced to handle various formats
        function parseAddressComponents(address) {
            let streetAddress = '', city = '', state = '', zip = '';
            
            // First try comma-separated format
            let parts = address.split(',').map(s => s.trim());
            
            if (parts.length >= 3) {
                // Format: "123 Main St, Las Vegas, NV 89169"
                streetAddress = parts[0];
                city = parts[1];
                
                const stateZip = parts[2].trim().split(' ');
                if (stateZip.length >= 2) {
                    state = stateZip[0];
                    zip = stateZip[1];
                } else if (stateZip.length === 1) {
                    state = stateZip[0];
                }
            } else {
                // Try parsing without commas: "123 Main St Las Vegas NV 89169"
                // Look for ZIP code pattern
                const zipMatch = address.match(/(\d{5}(?:-\d{4})?)$/);
                if (zipMatch) {
                    zip = zipMatch[1];
                    address = address.replace(zipMatch[0], '').trim();
                }
                
                // Look for state abbreviation (2 uppercase letters at the end)
                const stateMatch = address.match(/\b([A-Z]{2})\s*$/);
                if (stateMatch) {
                    state = stateMatch[1];
                    address = address.replace(stateMatch[0], '').trim();
                }
                
                // Split remaining address
                const words = address.split(' ');
                if (words.length >= 3) {
                    // Assume last part is city, rest is street address
                    // Common patterns: city names can be 1-3 words
                    // Check for common multi-word city patterns
                    const addressLower = address.toLowerCase();
                    const multiWordCities = ['las vegas', 'los angeles', 'san francisco', 'san diego', 'new york', 'salt lake city', 'san antonio', 'santa monica', 'san jose'];
                    
                    let cityFound = false;
                    for (const cityName of multiWordCities) {
                        if (addressLower.includes(cityName)) {
                            const cityIndex = addressLower.indexOf(cityName);
                            streetAddress = address.substring(0, cityIndex).trim();
                            city = address.substring(cityIndex, cityIndex + cityName.length).trim();
                            // Preserve original case
                            city = words.slice(-cityName.split(' ').length).join(' ');
                            cityFound = true;
                            break;
                        }
                    }
                    
                    if (!cityFound) {
                        // Default: assume last 1-2 words are city
                        const possibleCityWords = Math.min(2, Math.max(1, words.length - 2));
                        city = words.slice(-possibleCityWords).join(' ');
                        streetAddress = words.slice(0, -possibleCityWords).join(' ');
                    }
                }
            }
            
            // Clean up state abbreviation to uppercase
            if (state) {
                state = state.toUpperCase();
            }
            
            return { streetAddress: streetAddress || address, city, state, zip };
        }
        
        // Parse and fill address fields in Add Property form
        function parseAndFillAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim();
            
            if (!fullAddress) {
                return;
            }
            
            const parsed = parseAddressComponents(fullAddress);
            
            // Fill in the individual fields
            if (parsed.streetAddress) {
                document.getElementById('address').value = parsed.streetAddress;
            }
            if (parsed.city) {
                document.getElementById('city').value = parsed.city;
            }
            if (parsed.state) {
                document.getElementById('state').value = parsed.state;
            }
            if (parsed.zip) {
                document.getElementById('zip').value = parsed.zip;
            }
            
            // Visual feedback - briefly highlight filled fields
            ['address', 'city', 'state', 'zip'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field.value) {
                    field.style.border = '2px solid var(--accent-success)';
                    field.style.transition = 'border 0.3s ease';
                    setTimeout(() => {
                        field.style.border = '';
                    }, 1000);
                }
            });
        }

        // Export analysis report
        function exportAnalysisReport(address, propertyData) {
            const reportContent = generateReportHTML(address, propertyData);
            
            // Create a blob with the HTML content
            const blob = new Blob([reportContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `property-analysis-${propertyData.address || 'report'}-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Generate report HTML
        function generateReportHTML(address, propertyData) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            const totalExpenses = calculateTotalExpenses({
                purchasePrice,
                monthlyRent,
                hoaMonthly: propertyData.hoaMonthly || 0
            });
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Property Analysis Report - ${propertyData.address || address}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #f5f5f5;
                    }
                    .header {
                        background: #1a1a1a;
                        color: white;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                    }
                    .header h1 {
                        margin: 0;
                        font-size: 28px;
                    }
                    .header p {
                        margin: 10px 0 0 0;
                        color: #ccc;
                    }
                    .section {
                        background: white;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .section h2 {
                        color: #333;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #3b82f6;
                        padding-bottom: 10px;
                    }
                    .metrics {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                    }
                    .metric-label {
                        color: #666;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .warning { color: #f59e0b; }
                    .details {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 15px;
                    }
                    .detail-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid #eee;
                    }
                    .detail-label {
                        color: #666;
                    }
                    .detail-value {
                        font-weight: 500;
                    }
                    .footer {
                        text-align: center;
                        color: #666;
                        margin-top: 40px;
                        padding: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Property Investment Analysis</h1>
                    <p>${propertyData.address || address}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="section">
                    <h2>Property Details</h2>
                    <div class="details">
                        <div class="detail-row">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">${propertyData.city}, ${propertyData.state} ${propertyData.zip}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Property Type</span>
                            <span class="detail-value">${propertyData.propertyType || 'Single Family'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bedrooms</span>
                            <span class="detail-value">${propertyData.beds || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bathrooms</span>
                            <span class="detail-value">${propertyData.baths || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Square Feet</span>
                            <span class="detail-value">${propertyData.sqft ? propertyData.sqft.toLocaleString() : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Year Built</span>
                            <span class="detail-value">${propertyData.yearBuilt || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Financial Analysis</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Purchase Price</div>
                            <div class="metric-value">${formatCurrency(purchasePrice)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Down Payment (20%)</div>
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Monthly Rent</div>
                            <div class="metric-value">${formatCurrency(monthlyRent)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Monthly Mortgage</div>
                            <div class="metric-value">${formatCurrency(monthlyMortgage)}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Investment Metrics</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(monthlyCashFlow)}
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">
                                ${cashOnCashReturn.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Annual Cash Flow</div>
                            <div class="metric-value ${annualCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(annualCashFlow)}
                            </div>
                        </div>
                    </div>
                </div>

                ${propertyData.marketStats && Object.keys(propertyData.marketStats).length > 0 ? `
                <div class="section">
                    <h2>Market Statistics (${propertyData.zip})</h2>
                    <div class="metrics">
                        ${propertyData.marketStats.medianRent ? `
                        <div class="metric">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPrice ? `
                        <div class="metric">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.avgDaysOnMarket ? `
                        <div class="metric">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${propertyData.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.inventoryCount ? `
                        <div class="metric">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${propertyData.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="footer">
                    <p>Real Estate Investment Tracker</p>
                    <p>This report is for informational purposes only.</p>
                </div>
            </body>
            </html>
            `;
        }

        // Add property from analysis
        async function addPropertyFromAnalysis(propertyData) {
            const property = {
                ...propertyData,
                purchasePrice: propertyData.estimatedValue || propertyData.price || 500000,
                monthlyRent: propertyData.rentEstimate || 2500,
                currentValue: propertyData.estimatedValue || propertyData.price || 500000,
                status: 'available',
                dateAdded: new Date().toISOString()
            };
            
            calculatePropertyMetrics(property);
            
            // Create property in database first
            try {
                console.log('Creating property in database:', property.address);
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(property)
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Add the complete property from server response with ID
                    const propertyWithId = {
                        ...property,
                        ...data.data,
                        // Preserve camelCase fields
                        purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                        monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                    };
                    
                    console.log('‚úÖ Property created with ID:', propertyWithId.id);
                    
                    // Add to properties array
                    properties.push(propertyWithId);
                    
                    // Update localStorage immediately
                    localStorage.setItem('properties', JSON.stringify(properties));
                    console.log('‚úÖ Updated localStorage with new property');
                    
                    updateDisplay();
                    closeModal('analyzeModal');
                    alert('Property added to portfolio!');
                } else {
                    throw new Error(data.error || 'Failed to create property');
                }
            } catch (error) {
                console.error('Error adding property:', error);
                alert(error.message || 'Error adding property. Please try again.');
            }
        }

        // Generate market insights content
        function generateMarketInsightsContent(marketData) {
            const availableProperties = properties.filter(p => p.status !== 'sold');
            const totalValue = availableProperties.reduce((sum, p) => sum + (p.currentValue || p.purchasePrice || 0), 0);
            const avgCashFlow = availableProperties.length > 0 ? 
                availableProperties.reduce((sum, p) => sum + (p.monthlyCashFlow || 0), 0) / availableProperties.length : 0;
            
            let content = `
                <div class="analysis-section">
                    <h3>üìä Portfolio Overview</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Properties</div>
                            <div class="metric-value">${properties.length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Portfolio Value</div>
                            <div class="metric-value">${formatCurrency(totalValue)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Monthly Cash Flow</div>
                            <div class="metric-value ${avgCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(avgCashFlow)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Markets</div>
                            <div class="metric-value">${Object.keys(marketData).length}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Market analysis by ZIP
            for (const [zip, data] of Object.entries(marketData)) {
                const propertiesInZip = properties.filter(p => p.zip === zip && p.status !== 'sold');
                if (propertiesInZip.length === 0) continue;
                
                content += `
                    <div class="analysis-section">
                        <h3>üìç Market Analysis: ${zip}</h3>
                        <p><strong>Properties in this market:</strong> ${propertiesInZip.length}</p>
                        
                        <div class="metrics-grid">
                            ${data.medianRent ? `
                            <div class="metric-card">
                                <div class="metric-label">Median Rent</div>
                                <div class="metric-value">${formatCurrency(data.medianRent)}</div>
                            </div>
                            ` : ''}
                            ${data.medianPrice ? `
                            <div class="metric-card">
                                <div class="metric-label">Median Price</div>
                                <div class="metric-value">${formatCurrency(data.medianPrice)}</div>
                            </div>
                            ` : ''}
                            ${data.avgDaysOnMarket ? `
                            <div class="metric-card">
                                <div class="metric-label">Avg Days on Market</div>
                                <div class="metric-value">${data.avgDaysOnMarket}</div>
                            </div>
                            ` : ''}
                            ${data.yearOverYearPriceChange ? `
                            <div class="metric-card">
                                <div class="metric-label">YoY Price Change</div>
                                <div class="metric-value ${data.yearOverYearPriceChange >= 0 ? 'positive' : 'negative'}">
                                    ${data.yearOverYearPriceChange.toFixed(1)}%
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="ai-content" style="margin-top: 20px;">
                            <h4>Market Insights</h4>
                            <p>${generateZipCodeInsights(zip, data, propertiesInZip)}</p>
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="analysis-section">
                    <h3>üéØ Investment Recommendations</h3>
                    <div class="ai-content">
                        ${generateInvestmentRecommendations(properties, marketData)}
                    </div>
                </div>
                
                <div class="export-controls">
                    <button class="btn btn-export" onclick="exportMarketInsights()">
                        <i class="fas fa-download"></i> Export Market Report
                    </button>
                </div>
            `;
            
            return content;
        }

        // Generate insights for a specific ZIP code
        function generateZipCodeInsights(zip, data, propertiesInZip) {
            const avgPropertyRent = propertiesInZip.reduce((sum, p) => sum + (p.monthlyRent || 0), 0) / propertiesInZip.length;
            const rentComparison = data.medianRent ? ((avgPropertyRent - data.medianRent) / data.medianRent * 100).toFixed(1) : 0;
            
            let insights = [];
            
            if (data.medianRent && rentComparison > 0) {
                insights.push(`Your properties in ${zip} are achieving rents ${rentComparison}% above the market median, indicating strong rental performance.`);
            } else if (data.medianRent && rentComparison < -10) {
                insights.push(`Your properties in ${zip} are renting ${Math.abs(rentComparison)}% below market median. Consider evaluating rent increases.`);
            }
            
            if (data.avgDaysOnMarket < 30) {
                insights.push(`Properties in this area are selling quickly (avg ${data.avgDaysOnMarket} days), indicating high demand.`);
            } else if (data.avgDaysOnMarket > 90) {
                insights.push(`Properties are taking longer to sell (avg ${data.avgDaysOnMarket} days), which may provide negotiation opportunities.`);
            }
            
            if (data.yearOverYearPriceChange > 5) {
                insights.push(`Strong price appreciation of ${data.yearOverYearPriceChange.toFixed(1)}% year-over-year suggests a growing market.`);
            } else if (data.yearOverYearPriceChange < 0) {
                insights.push(`Prices have declined ${Math.abs(data.yearOverYearPriceChange).toFixed(1)}% year-over-year. This could present buying opportunities.`);
            }
            
            return insights.length > 0 ? insights.join(' ') : 'Market data suggests stable conditions in this area.';
        }

        // Generate investment recommendations
        function generateInvestmentRecommendations(properties, marketData) {
            const recommendations = [];
            
            // Analyze portfolio performance
            const avgCashOnCash = properties.filter(p => p.status !== 'sold').reduce((sum, p) => sum + (p.cashOnCashReturn || 0), 0) / properties.length;
            
            if (avgCashOnCash >= 8) {
                recommendations.push('<li><strong>Portfolio Performance:</strong> Your portfolio is achieving excellent returns with an average cash-on-cash return of ' + avgCashOnCash.toFixed(1) + '%. Continue focusing on similar property profiles.</li>');
            } else if (avgCashOnCash < 5) {
                recommendations.push('<li><strong>Portfolio Optimization:</strong> Consider strategies to improve returns, such as reducing expenses, increasing rents where possible, or focusing on higher cash-flow properties.</li>');
            }
            
            // Market-specific recommendations
            for (const [zip, data] of Object.entries(marketData)) {
                if (data.yearOverYearPriceChange > 8) {
                    recommendations.push(`<li><strong>${zip} Market:</strong> Strong appreciation trend. Consider acquiring more properties in this area before prices rise further.</li>`);
                }
                
                if (data.inventoryCount && data.inventoryCount < 50) {
                    recommendations.push(`<li><strong>${zip} Inventory:</strong> Low inventory (${data.inventoryCount} properties) suggests a seller's market. Act quickly on good opportunities.</li>`);
                }
            }
            
            // Diversification advice
            const uniqueZips = [...new Set(properties.map(p => p.zip))];
            if (uniqueZips.length < 3) {
                recommendations.push('<li><strong>Diversification:</strong> Consider expanding into additional markets to reduce geographic concentration risk.</li>');
            }
            
            return '<ul>' + recommendations.join('') + '</ul>';
        }

        // Export market insights
        function exportMarketInsights() {
            const content = document.getElementById('marketInsightsContent').innerHTML;
            const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Market Insights Report - ${new Date().toLocaleDateString()}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 1000px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #f5f5f5;
                    }
                    .header {
                        background: #1a1a1a;
                        color: white;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        text-align: center;
                    }
                    .analysis-section {
                        background: white;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .metrics-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric-card {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                    }
                    .metric-label {
                        color: #666;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .ai-content {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        margin-top: 20px;
                    }
                    h3 { color: #333; margin-bottom: 15px; }
                    h4 { color: #3b82f6; margin: 15px 0 10px 0; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>AI Market Insights Report</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                ${content}
            </body>
            </html>
            `;
            
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market-insights-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Filter properties
        function filterProperties() {
            updateTable();
        }

        // Get filtered properties
        function getFilteredProperties() {
            let filtered = [...properties];
            
            // Ensure all properties have metrics calculated before filtering
            filtered.forEach(prop => {
                if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined && !prop.monthlyCashFlow) {
                    calculatePropertyMetrics(prop);
                }
            });
            
            const cityFilter = document.getElementById('filterCity').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const minCashFlowValue = document.getElementById('filterMinCashFlow').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            if (cityFilter) {
                filtered = filtered.filter(p => p.city === cityFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(p => p.status === statusFilter);
            }
            
            // Only apply cash flow filter if a value is explicitly entered
            if (minCashFlowValue !== '' && minCashFlowValue !== null) {
                const minCashFlow = parseFloat(minCashFlowValue);
                if (!isNaN(minCashFlow)) {
                    filtered = filtered.filter(p => (p.monthlyCashFlow || 0) >= minCashFlow);
                }
            }
            
            if (searchText) {
                filtered = filtered.filter(p => 
                    (p.address && p.address.toLowerCase().includes(searchText)) ||
                    (p.city && p.city.toLowerCase().includes(searchText)) ||
                    (p.zip && p.zip.includes(searchText))
                );
            }
            
            return filtered;
        }

        // Update city filter
        function updateCityFilter() {
            const cities = [...new Set(properties.map(p => p.city).filter(c => c))];
            const select = document.getElementById('filterCity');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Cities</option>';
            cities.sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterCity').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterMinCashFlow').value = '';
            document.getElementById('searchInput').value = '';
            filterProperties();
        }

        // Edit property
        function editProperty(index) {
            const property = properties[index];
            if (!property) return;
            
            // Populate form
            document.getElementById('address').value = property.address || '';
            document.getElementById('city').value = property.city || '';
            document.getElementById('state').value = property.state || '';
            document.getElementById('zip').value = property.zip || '';
            document.getElementById('propertyType').value = property.propertyType || 'single-family';
            document.getElementById('purchasePrice').value = property.purchasePrice || '';
            document.getElementById('monthlyRent').value = property.monthlyRent || '';
            document.getElementById('beds').value = property.beds || '';
            document.getElementById('baths').value = property.baths || '';
            document.getElementById('sqft').value = property.sqft || '';
            
            // Update form submit handler
            document.getElementById('addPropertyForm').onsubmit = function(e) {
                e.preventDefault();
                updateProperty(index);
            };
            
            openModal('addPropertyModal');
        }

        // Update property
        function updateProperty(index) {
            const formData = new FormData(document.getElementById('addPropertyForm'));
            const updatedData = {};
            
            for (let [key, value] of formData.entries()) {
                updatedData[key] = value;
            }
            
            // Convert numeric fields
            updatedData.purchasePrice = parseFloat(updatedData.purchasePrice) || 0;
            updatedData.monthlyRent = parseFloat(updatedData.monthlyRent) || 0;
            updatedData.beds = parseInt(updatedData.beds) || 0;
            updatedData.baths = parseFloat(updatedData.baths) || 0;
            updatedData.sqft = parseInt(updatedData.sqft) || 0;
            
            // Update property
            Object.assign(properties[index], updatedData);
            calculatePropertyMetrics(properties[index]);
            
            // Save and update display
            saveProperties();
            updateDisplay();
            closeModal('addPropertyModal');
            
            // Reset form handler
            document.getElementById('addPropertyForm').onsubmit = handleAddProperty;
        }

        // Mark property as sold
        function markAsSold(index) {
            if (confirm('Mark this property as sold?')) {
                properties[index].status = 'sold';
                properties[index].soldDate = new Date().toISOString();
                saveProperties();
                updateDisplay();
                closeModal('propertyModal');
            }
        }

        // Delete property
        async function deleteProperty(index) {
            if (confirm('Are you sure you want to delete this property?')) {
                const property = properties[index];
                
                // If property has an ID, delete it from the database
                if (property.id) {
                    try {
                        console.log(`üóëÔ∏è Deleting property ${property.id} from database...`);
                        const response = await fetch(`/api/properties/${property.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Property deleted from database');
                        } else {
                            console.error('‚ùå Failed to delete from database');
                            showNotification('Failed to delete property from database', 'error');
                            return; // Don't remove from local array if database delete failed
                        }
                    } catch (error) {
                        console.error('‚ùå Error deleting property:', error);
                        showNotification('Error deleting property', 'error');
                        return; // Don't remove from local array if database delete failed
                    }
                }
                
                // Remove from local array
                properties.splice(index, 1);
                
                // Update localStorage
                localStorage.setItem('properties', JSON.stringify(properties));
                
                updateDisplay();
                closeModal('propertyModal');
            }
        }

        // Format AI response
        function formatAIResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Fetch real property data using existing functions or fallback
        async function fetchRealPropertyData(address) {
            try {
                const parsedAddress = parseAddressComponents(address);
                const rentcastData = await fetchRentCastData(parsedAddress);
                
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    return {
                        success: true,
                        data: {
                            ...rentcastData.data,
                            city: parsedAddress.city,
                            state: parsedAddress.state,
                            zip: parsedAddress.zip,
                            formattedAddress: address
                        }
                    };
                }
                
                // Fallback to estimated data
                return {
                    success: true,
                    data: {
                        address: parsedAddress.streetAddress,
                        city: parsedAddress.city,
                        state: parsedAddress.state,
                        zip: parsedAddress.zip,
                        formattedAddress: address,
                        estimatedValue: 500000,
                        rentEstimate: 2500,
                        beds: 3,
                        baths: 2,
                        sqft: 1500,
                        propertyType: 'Single Family'
                    }
                };
            } catch (error) {
                console.error('Error fetching property data:', error);
                throw error;
            }
        }
        // Generate AI analysis for individual property
        async function generatePropertyAIAnalysis(propertyIndex) {
            const property = properties[propertyIndex];
            if (!property) {
                alert('Property not found');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('aiAnalysisContent').innerHTML = 'Generating AI analysis...';
                document.getElementById('aiAnalysisSection').style.display = 'block';
                
                console.log('ü§ñ Generating AI analysis for property:', property.address);
                
                // Calculate financial metrics
                const purchasePrice = property.purchasePrice || property.estimatedValue || 0;
                const monthlyRent = property.monthlyRent || property.rentEstimate || 0;
                const downPayment = purchasePrice * 0.2;
                const loanAmount = purchasePrice - downPayment;
                const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
                const totalExpenses = calculateTotalExpenses(property);
                const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
                const annualCashFlow = monthlyCashFlow * 12;
                const cashOnCashReturn = downPayment > 0 ? (annualCashFlow / downPayment) * 100 : 0;
                const noi = monthlyRent * 12 - totalExpenses * 12;
                const capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;
                const dscr = monthlyMortgage > 0 ? (monthlyRent * 12) / (monthlyMortgage * 12) : 0;
                
                // 5-year projections
                const rentGrowth = 0.03;
                const appreciationRate = 0.04;
                const projectedValue5yr = purchasePrice * Math.pow(1 + appreciationRate, 5);
                const projectedRent5yr = monthlyRent * Math.pow(1 + rentGrowth, 5);
                const totalReturn5yr = (projectedValue5yr - purchasePrice) + (annualCashFlow * 5);
                const roi5yr = downPayment > 0 ? (totalReturn5yr / downPayment) * 100 : 0;
                
                // Create enhanced prompt for individual property analysis
                const prompt = `You are a real estate investment expert. Analyze this property and provide a comprehensive investment report.

PROPERTY DETAILS:
Address: ${property.address}, ${property.city}, ${property.state} ${property.zip}
Property Type: ${property.propertyType || 'Single Family'}
Bedrooms: ${property.beds || property.bedrooms || 'N/A'}
Bathrooms: ${property.baths || property.bathrooms || 'N/A'}
Square Feet: ${property.sqft || property.squareFootage || 'N/A'}
Year Built: ${property.yearBuilt || 'N/A'}

FINANCIAL ANALYSIS:
Purchase Price: $${purchasePrice.toLocaleString()}
Down Payment (20%): $${downPayment.toLocaleString()}
Monthly Rent: $${monthlyRent.toLocaleString()}
Rent Estimate (RentCast): $${property.rentEstimate || 'N/A'}
Estimated Value (RentCast): $${property.estimatedValue ? property.estimatedValue.toLocaleString() : 'N/A'}

CASH FLOW ANALYSIS:
Monthly Cash Flow: $${monthlyCashFlow.toLocaleString()}
Annual Cash Flow: $${annualCashFlow.toLocaleString()}
Cash-on-Cash Return: ${cashOnCashReturn.toFixed(2)}%
Cap Rate: ${capRate.toFixed(2)}%
Debt Service Coverage Ratio: ${dscr.toFixed(2)}

PROJECTIONS (5-Year):
Projected Property Value: $${projectedValue5yr.toLocaleString()}
Projected Monthly Rent: $${projectedRent5yr.toLocaleString()}
Total ROI (5-Year): ${roi5yr.toFixed(1)}%

MARKET DATA:
${property.marketStats ? JSON.stringify(property.marketStats, null, 2) : 'Market data not available'}

DATA SOURCE: ${property.realTimeData ? 'Real-time RentCast API data' : 'Manual/estimated data'}
Last Updated: ${property.lastRentCastUpdate ? new Date(property.lastRentCastUpdate).toLocaleDateString() : 'N/A'}

Please provide a comprehensive analysis covering:

1. **INVESTMENT GRADE** (A+ to F): Overall rating with brief explanation
2. **FINANCIAL PERFORMANCE**: Analysis of cash flow, returns, and key ratios
3. **MARKET POSITION**: How this property compares to market averages
4. **RISK ASSESSMENT**: Identify potential risks and concerns
5. **GROWTH POTENTIAL**: Long-term appreciation and income growth prospects
6. **RECOMMENDATIONS**: Specific actionable advice (buy, hold, pass, negotiate)
7. **OPTIMIZATION OPPORTUNITIES**: Ways to improve returns
8. **RED FLAGS**: Any concerning aspects that need attention

Format your response in clear sections with bullet points where appropriate. Be specific and actionable in your recommendations.`;

                // Send to AI for analysis
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (!response.ok) {
                    throw new Error(`AI Analysis failed: ${response.status}`);
                }
                
                const aiData = await response.json();
                if (!aiData.success) {
                    throw new Error(aiData.error || 'AI analysis failed');
                }
                
                // Format and display the analysis
                const analysisText = aiData.analysis || 'No analysis returned';
                document.getElementById('aiAnalysisContent').innerHTML = formatAIResponse(analysisText);
                
                console.log('‚úÖ AI analysis completed successfully');
                
            } catch (error) {
                console.error('‚ùå Error generating property AI analysis:', error);
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <div style="color: var(--accent-danger); padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid var(--accent-danger);">
                        <h4 style="margin-top: 0;">‚ùå Analysis Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        
                        <p><strong>Troubleshooting:</strong></p>
                        <ul style="margin: 10px 0;">
                            <li>Make sure the server is running (npm start)</li>
                            <li>Check that you're accessing http://localhost:3000</li>
                            <li>Verify Gemini API key is configured</li>
                            <li>Check server console for detailed errors</li>
                        </ul>
                        
                        <button class="btn btn-secondary" onclick="generatePropertyAIAnalysis(${propertyIndex})" style="margin-top: 10px;">
                            <i class="fas fa-redo"></i> Retry Analysis
                        </button>
                    </div>
                `;
            }
        }

        // Export AI Insights Report
        function exportAIInsightsReport(address, propertyData, aiAnalysis) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice * 0.8;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.07, 30);
            
            const propertyTax = (purchasePrice * 0.012) / 12;
            const insurance = (purchasePrice * 0.004) / 12;
            const maintenance = purchasePrice * 0.001;
            const management = monthlyRent * 0.1;
            const totalExpenses = propertyTax + insurance + maintenance + management;
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            const dscr = monthlyRent / monthlyMortgage;
            
            const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>AI Investment Analysis - ${address}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 900px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #0a0a0a;
                        color: #ffffff;
                    }
                    .header {
                        background: #1a1a1a;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        text-align: center;
                        border: 1px solid #333;
                    }
                    .header h1 {
                        margin: 0;
                        color: #3b82f6;
                    }
                    .section {
                        background: #1a1a1a;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        border: 1px solid #333;
                    }
                    .section h2 {
                        color: #3b82f6;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #3b82f6;
                        padding-bottom: 10px;
                    }
                    .metrics {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric {
                        background: #242424;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                        border: 1px solid #404040;
                    }
                    .metric-label {
                        color: #b0b0b0;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #ffffff;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .warning { color: #f59e0b; }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                        background: #242424;
                    }
                    th, td {
                        padding: 12px;
                        text-align: left;
                        border-bottom: 1px solid #404040;
                    }
                    th {
                        background: #1a1a1a;
                        font-weight: 600;
                        color: #3b82f6;
                    }
                    .ai-content {
                        background: #242424;
                        padding: 20px;
                        border-radius: 6px;
                        margin-top: 20px;
                        border: 1px solid #404040;
                        color: #ffffff;
                    }
                    .ai-content h3 {
                        color: #3b82f6;
                        margin-top: 0;
                    }
                    .footer {
                        text-align: center;
                        color: #808080;
                        margin-top: 40px;
                        padding: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>AI Investment Analysis Report</h1>
                    <p>${address}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="section">
                    <h2>Financial Metrics Summary</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">${cashOnCashReturn.toFixed(1)}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">${capRate.toFixed(1)}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">DSCR</div>
                            <div class="metric-value ${dscr >= 1.25 ? 'positive' : 'warning'}">${dscr.toFixed(2)}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>AI Analysis</h2>
                    <div class="ai-content">
                        ${formatAIResponse(aiAnalysis)}
                    </div>
                </div>

                <div class="footer">
                    <p>Real Estate Investment Tracker - AI Powered Analysis</p>
                    <p>This report is for informational purposes only. Consult with professionals before making investment decisions.</p>
                </div>
            </body>
            </html>
            `;
            
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-investment-analysis-${address.replace(/[^a-z0-9]/gi, '-')}-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        /* REMOVED - Test property button was removed
        // Add test property for RentCast testing
        async function addTestProperty() {
            const testProperty = {
                address: '1500 S Eastern Ave',
                city: 'Las Vegas',
                state: 'NV',
                zip: '89104',
                propertyType: 'single-family',
                purchasePrice: 450000,
                monthlyRent: 2100,
                beds: 3,
                baths: 2,
                sqft: 1500,
                currentValue: 450000,
                status: 'available',
                dateAdded: new Date().toISOString(),
                realTimeData: false
            };
            
            console.log('üß™ Adding test property for RentCast testing:', testProperty);
            
            // Calculate initial metrics
            calculatePropertyMetrics(testProperty);
            
            // Add to properties array
            properties.push(testProperty);
            
            // Save and update display
            await saveProperties();
            updateDisplay();
            
            // Show instructions
            // Log success message to console instead of showing alert
            console.log(`üß™ Test Property Added Successfully!`);
            console.log(`üìç Address: ${testProperty.address}, ${testProperty.city}, ${testProperty.state} ${testProperty.zip}`);
            console.log(`üí° This address is known to work with RentCast API for testing!`);
        }
        */ // End of removed addTestProperty function
        
        // Debug: Log that we reached the end of script
        console.log('‚úÖ Main script loaded completely');
        
        // Debug: Check if functions exist
        console.log('Function check:', {
            openModal: typeof window.openModal,
            closeModal: typeof window.closeModal,
            openAddPropertyModal: typeof window.openAddPropertyModal,
            openAnalyzeModal: typeof window.openAnalyzeModal,
            generateMarketInsights: typeof window.generateMarketInsights,
            generateAIInsights: typeof window.generateAIInsights,
            analyzeNewProperty: typeof window.analyzeNewProperty
        });
    </script>
    
    <!-- EMERGENCY FIX COMPLETELY REMOVED - It was breaking working modal functions -->
    <!--
    <script>
    /* COMPLETELY DISABLED AND REMOVED
        console.log('üö® EMERGENCY FIX: Redefining modal functions...');
        
        // Helper function to safely get element
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`‚ùå Element not found: ${id}`);
            }
            return element;
        }
        
        // Redefine openModal function with lag fix
        window.openModal = function(modalId) {
            console.log(`üîß EMERGENCY openModal called with: ${modalId}`);
            try {
                const modal = safeGetElement(modalId);
                if (modal) {
                    // Remove any animations temporarily
                    const originalAnimation = modal.style.animation;
                    modal.style.animation = 'none';
                    
                    // Show modal
                    modal.style.display = 'block';
                    
                    // Force immediate repaint to fix lag
                    void modal.offsetWidth; // Force reflow
                    modal.style.opacity = '1';
                    modal.style.visibility = 'visible';
                    
                    // Restore animation after repaint
                    requestAnimationFrame(() => {
                        modal.style.animation = originalAnimation || '';
                    });
                    
                    console.log(`‚úÖ Modal opened with repaint fix: ${modalId}`);
                } else {
                    console.error(`‚ùå Cannot open modal - element not found: ${modalId}`);
                }
            } catch (error) {
                console.error('‚ùå Error in openModal:', error);
            }
        };
        
        // Redefine closeModal function
        window.closeModal = function(modalId) {
            console.log(`üîß EMERGENCY closeModal called with: ${modalId}`);
            try {
                const modal = safeGetElement(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    console.log(`‚úÖ Modal closed: ${modalId}`);
                }
            } catch (error) {
                console.error('‚ùå Error in closeModal:', error);
            }
        };
        
        // Redefine openAnalyzeModal function
        window.openAnalyzeModal = function() {
            console.log('üîß EMERGENCY openAnalyzeModal called');
            try {
                // Check if analyzeModal exists (note: no hyphen!)
                const modal = safeGetElement('analyzeModal');
                if (!modal) {
                    console.error('‚ùå analyzeModal not found in DOM');
                    // List all modals in DOM for debugging
                    const allModals = document.querySelectorAll('.modal');
                    console.log('üìã Available modals:', Array.from(allModals).map(m => m.id));
                    return;
                }
                
                // Open the modal
                window.openModal('analyzeModal');
                
                // Clear form
                const form = safeGetElement('analyze-form');
                if (form) {
                    form.reset();
                    console.log('‚úÖ Analyze form reset');
                }
                
                // Clear results
                const results = safeGetElement('analyze-results');
                if (results) {
                    results.innerHTML = '';
                    console.log('‚úÖ Analyze results cleared');
                }
            } catch (error) {
                console.error('‚ùå Error in openAnalyzeModal:', error);
            }
        };
        
        // Redefine generateMarketInsights function
        window.generateMarketInsights = function() {
            console.log('üîß EMERGENCY generateMarketInsights called');
            try {
                // Check if marketInsightsModal exists (note: camelCase!)
                const modal = safeGetElement('marketInsightsModal');
                if (!modal) {
                    console.error('‚ùå marketInsightsModal not found in DOM');
                    // List all modals in DOM for debugging
                    const allModals = document.querySelectorAll('.modal');
                    console.log('üìã Available modals:', Array.from(allModals).map(m => m.id));
                    return;
                }
                
                // Check if properties exist
                if (typeof window.properties === 'undefined' || !Array.isArray(window.properties)) {
                    console.error('‚ùå Properties array not found or invalid');
                    window.properties = [];
                }
                
                if (window.properties.length === 0) {
                    alert('Add some properties first to generate insights!');
                    return;
                }
                
                // Open the modal
                window.openModal('marketInsightsModal');
                
                // Generate insights
                if (typeof window.generateAIInsights === 'function') {
                    console.log('‚úÖ Calling generateAIInsights...');
                    window.generateAIInsights();
                } else {
                    console.error('‚ùå generateAIInsights function not found');
                    // Fallback: Show basic message
                    const content = safeGetElement('insights-content');
                    if (content) {
                        content.innerHTML = '<p>AI insights generation is currently unavailable. Please refresh the page and try again.</p>';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in generateMarketInsights:', error);
            }
        };
        
        // Test modal existence on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç EMERGENCY FIX: Checking modal elements...');
            
            const modalsToCheck = ['analyzeModal', 'marketInsightsModal', 'addPropertyModal', 'propertyModal'];
            modalsToCheck.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    console.log(`‚úÖ Modal found: ${modalId}`);
                } else {
                    console.error(`‚ùå Modal NOT found: ${modalId}`);
                }
            });
            
            // Check if buttons exist and have correct onclick handlers
            const analyzeBtn = document.querySelector('button[onclick*="openAnalyzeModal"]');
            const insightsBtn = document.querySelector('button[onclick*="generateMarketInsights"]');
            
            if (analyzeBtn) {
                console.log('‚úÖ Analyze button found');
            } else {
                console.error('‚ùå Analyze button NOT found');
            }
            
            if (insightsBtn) {
                console.log('‚úÖ Insights button found');
            } else {
                console.error('‚ùå Insights button NOT found');
            }
            
            // Final function availability check
            console.log('üìã Final function check:', {
                openModal: typeof window.openModal,
                closeModal: typeof window.closeModal,
                openAnalyzeModal: typeof window.openAnalyzeModal,
                generateMarketInsights: typeof window.generateMarketInsights
            });
        });
        
        console.log('‚úÖ EMERGENCY FIX: Modal functions redefined successfully');
    */ // END OF DISABLED EMERGENCY FIX
    </script>
    -->
        
        <!-- ============= MODAL LAG FIX COMPLETELY REMOVED ============= -->
        <!--
        <script>
        /* DISABLED AND REMOVED - This was overriding working modal functions
        // Fix for delayed modal response - Final override
        setTimeout(() => {
            console.log('üöÄ Applying final modal lag fix...');
            
            // Store references to current functions
            const _openModal = window.openModal;
            const _openAnalyzeModal = window.openAnalyzeModal;
            const _generateMarketInsights = window.generateMarketInsights;
            
            // Enhanced openModal with immediate response
            window.openModal = function(modalId) {
                console.log(`‚ö° Fast openModal: ${modalId}`);
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                // Find modal content element
                const modalContent = modal.querySelector('.modal-content');
                
                // Disable ALL transitions/animations on modal and content
                modal.style.transition = 'none !important';
                modal.style.animation = 'none !important';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                
                if (modalContent) {
                    modalContent.style.transition = 'none !important';
                    modalContent.style.animation = 'none !important';
                    modalContent.style.opacity = '1';
                    modalContent.style.transform = 'none';
                    modalContent.style.visibility = 'visible';
                }
                
                // Show immediately
                modal.style.display = 'block';
                
                // Force repaint
                void modal.offsetHeight;
                
                // Ensure visibility after repaint
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                
                // Keep animations disabled for instant response
                // Do NOT re-enable animations as it causes lag
            };
            
            // Fast openAnalyzeModal
            window.openAnalyzeModal = function() {
                console.log('‚ö° Fast openAnalyzeModal');
                // Clear fields
                const input = document.getElementById('propertyAddressInput');
                const results = document.getElementById('analysisResults');
                const loading = document.getElementById('analysisLoading');
                
                if (input) input.value = '';
                if (results) results.innerHTML = '';
                if (loading) loading.style.display = 'none';
                
                // Use fast openModal
                window.openModal('analyzeModal');
            };
            
            // Fast generateMarketInsights
            window.generateMarketInsights = async function() {
                console.log('‚ö° Fast generateMarketInsights');
                // Open modal immediately
                window.openModal('marketInsightsModal');
                
                // Show loading state
                const loading = document.getElementById('marketInsightsLoading');
                const content = document.getElementById('marketInsightsContent');
                
                if (loading) loading.style.display = 'block';
                if (content) content.style.display = 'none';
                
                // Load market insights content
                try {
                    const marketData = await fetchMarketData();
                    const html = generateMarketInsightsContent(marketData);
                    
                    if (content) content.innerHTML = html;
                    if (content) content.style.display = 'block';
                } catch (error) {
                    console.error('Error generating insights:', error);
                    if (content) {
                        content.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Unable to generate market insights at this time. Please try again later.</p>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                } finally {
                    if (loading) loading.style.display = 'none';
                }
            };
            
            // Fast openAddPropertyModal (ensure consistency)
            window.openAddPropertyModal = function() {
                console.log('‚ö° Fast openAddPropertyModal');
                // Clear form
                const form = document.getElementById('addPropertyForm');
                const fullAddress = document.getElementById('fullAddress');
                
                if (form) form.reset();
                if (fullAddress) fullAddress.value = '';
                
                // Use fast openModal
                window.openModal('addPropertyModal');
            };
            
            console.log('‚úÖ Modal lag fix applied - immediate response enabled');
        }, 100); // Small delay to ensure everything is loaded
        */ // END OF DISABLED MODAL LAG FIX
    </script>
    -->
</body>
</html>