<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        header h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 600;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .refresh-icon {
            transition: all 0.3s ease;
        }
        
        .refresh-icon:hover {
            opacity: 1 !important;
            transform: rotate(180deg);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
            color: white;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-ai:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
        }
        
        .actions-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        button, .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: #f7fafc;
        }
        
        .address-cell {
            font-weight: 600;
            color: #2d3748;
        }
        
        .positive {
            color: #48bb78;
            font-weight: 600;
        }
        
        .negative {
            color: #f56565;
            font-weight: 600;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 900px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .close {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .financial-details {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
        }
        
        .financial-details h3 {
            margin-bottom: 20px;
            color: #4a5568;
        }
        
        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        /* Property features styles */
        .property-features {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .feature-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid #e2e8f0;
        }
        
        /* Construction details styles */
        .construction-details {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* Owner section styles */
        .owner-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Tax section styles */
        .tax-section {
            background: #fef5e7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }
        
        /* Neighborhood stats styles */
        .neighborhood-stats {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .neighborhood-stats h4 {
            color: #2e7d32;
            margin-bottom: 15px;
        }
        
        /* Range display styles */
        .range-section {
            margin: 20px 0;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
        }
        
        .range-section h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .range-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .range-low {
            color: #e53e3e;
        }
        
        .range-high {
            color: #38a169;
        }
        
        .range-divider {
            color: #a0aec0;
        }
        
        .percentile-badge {
            margin-top: 10px;
            text-align: center;
            font-size: 0.85rem;
            color: #4a5568;
            font-weight: 500;
        }
        
        /* Form styles for adding properties */
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Add property button styles */
        .add-property-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .add-property-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .table-container {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 5px;
            }
        }
        
        /* Charts container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 400px;
            position: relative;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }
        
        .chart-card canvas {
            max-height: 350px !important;
            height: 350px !important;
        }
        
        @media (max-width: 768px) {
            .chart-card {
                height: 300px;
            }
            
            .chart-card canvas {
                max-height: 250px !important;
                height: 250px !important;
            }
        }
        
        /* Editable cells */
        .editable-cell {
            cursor: text;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        
        .editable-cell:focus {
            outline: 2px solid #667eea;
            background-color: white;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-rented {
            background-color: #c6f6d5;
            color: #22543d;
        }
        
        .status-vacant {
            background-color: #fed7d7;
            color: #742a2a;
        }
        
        .status-pending {
            background-color: #fefcbf;
            color: #744210;
        }
        
        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* Analysis modal specific styles */
        .analysis-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .analysis-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .metric-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        /* Badge styles */
        .real-time-badge {
            background-color: #4ade80;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            display: inline-block;
        }
        
        .sold-badge {
            background-color: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            display: inline-block;
        }
        
        .last-updated {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 8px;
        }
        
        /* Sort controls */
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sort-controls select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .sort-controls label {
            font-weight: 600;
            color: #4a5568;
        }
        
        /* Import/Export buttons */
        .data-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn-export {
            background: #10b981;
            color: white;
        }
        
        .btn-export:hover {
            background: #059669;
        }
        
        .btn-import {
            background: #3b82f6;
            color: white;
        }
        
        .btn-import:hover {
            background: #2563eb;
        }
        
        /* Notes section in modal */
        .notes-section {
            margin-top: 20px;
            padding: 20px;
            background: #fefcbf;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .notes-section h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .notes-content {
            color: #78350f;
            line-height: 1.6;
        }
        
        /* Property type badge */
        .property-type-badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* Refresh animation */
        @keyframes refresh-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .refreshing {
            animation: refresh-spin 1s linear infinite;
        }
        
        /* Success/Error messages */
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Update the refresh icon styles */
        .refresh-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .refresh-icon:hover {
            background: #f3f4f6;
            transform: rotate(180deg);
        }
        
        /* Sold property styles */
        .property-sold {
            background-color: #fee !important;
        }
        
        .property-sold td {
            color: #dc3545;
            opacity: 0.8;
        }
        
        .property-sold .address-sold {
            color: #dc3545 !important;
            text-decoration: line-through;
            font-weight: 600;
        }
        
        /* Mark sold button styles */
        .btn-mark-sold {
            background: #dc3545;
            color: white;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .btn-mark-sold:hover {
            background: #c82333;
        }
        
        /* Unmark sold button */
        .btn-unmark-sold {
            background: #28a745;
            color: white;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .btn-unmark-sold:hover {
            background: #218838;
        }
        
        /* Sold filter button */
        .filter-sold {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-sold input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-sold label {
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            color: #4a5568;
        }
        
        /* API status indicator - redesigned to prevent overlap */
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 200px;
        }
        
        .api-status:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }
        
        .api-status.collapsed {
            padding: 8px 12px;
            max-width: 40px;
            overflow: hidden;
        }
        
        .api-status.collapsed #apiStatusText {
            display: none;
        }
        
        .api-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }
        
        .api-status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
            animation: pulse-green 2s infinite;
        }
        
        .api-status-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 6px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 12px rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 6px rgba(16, 185, 129, 0.5); }
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 6px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 12px rgba(239, 68, 68, 0.8); }
            100% { box-shadow: 0 0 6px rgba(239, 68, 68, 0.5); }
        }
        
        #apiStatusText {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #4b5563;
            font-weight: 500;
        }
        
        /* Property analysis form styles */
        .analysis-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .analysis-form h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Results section */
        #analysisResults {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
        }
        
        #analysisLoading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        /* Sort indicator */
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.8rem;
            color: #718096;
        }
        
        .ai-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Feature tags */
        .feature-tag {
            display: inline-block;
            background: #f3f4f6;
            color: #4b5563;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .feature-tag.premium {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Maintenance tracker styles */
        .maintenance-list {
            list-style: none;
            padding: 0;
        }
        
        .maintenance-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .maintenance-overdue {
            background: #fee;
            border-left: 4px solid #dc3545;
        }
        
        .maintenance-upcoming {
            background: #fff7ed;
            border-left: 4px solid #f97316;
        }
        
        /* Comparison view */
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .comparison-card.selected {
            border: 2px solid #667eea;
        }
        
        /* Performance metrics */
        .performance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .performance-indicator.excellent {
            background: #d1fae5;
            color: #065f46;
        }
        
        .performance-indicator.good {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .performance-indicator.fair {
            background: #fef3c7;
            color: #92400e;
        }
        
        .performance-indicator.poor {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* AI Insights Styles */
        .ai-insights-container {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .metric-value.positive {
            color: #28a745;
        }
        
        .metric-value.negative {
            color: #dc3545;
        }
        
        .metric-value.warning {
            color: #ffc107;
        }
        
        .metric-subtext {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .ai-analysis {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .ai-content {
            margin-top: 15px;
            line-height: 1.8;
        }
        
        .ai-content ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .ai-content li {
            margin-bottom: 8px;
        }
        
        .ai-content strong {
            color: #2d3748;
        }
        
        .investment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .investment-table th,
        .investment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .investment-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .investment-table td {
            font-weight: 500;
        }
        
        .investment-table td.positive {
            color: #28a745;
        }
        
        .investment-table td.negative {
            color: #dc3545;
        }
        
        .property-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .property-details p {
            margin: 8px 0;
            color: #4a5568;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üèòÔ∏è Real Estate Investment Tracker</h1>
        </div>
    </header>
    
    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalProperties">0</div>
                <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">$0</div>
                <div class="stat-label">Portfolio Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyIncome">$0</div>
                <div class="stat-label">Monthly Income</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEquity">$0</div>
                <div class="stat-label">Total Equity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgROI">0%</div>
                <div class="stat-label">Average ROI</div>
            </div>
        </div>

        <!-- Quick Property Analysis Section -->
        <div class="analysis-form">
            <h2>üîç Quick Property Analysis</h2>
            <div class="input-group">
                <input type="text" id="propertyAddressInput" 
                       placeholder="Enter property address (e.g., 1613 Capistrano Ave, Placentia, CA 92870)"
                       onkeypress="if(event.key === 'Enter') analyzeNewProperty()">
                <button class="btn btn-primary" onclick="analyzeNewProperty()">
                    Analyze Property
                </button>
                <button class="btn btn-ai" onclick="generateAIInsights()">
                    <svg class="ai-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    AI Market Insights
                </button>
            </div>
            
            <div id="analysisLoading" class="loading">
                <div class="spinner"></div>
                <p>Analyzing property data...</p>
            </div>
            
            <div id="analysisResults"></div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>üìä Cash Flow by Property</h3>
                <canvas id="cashFlowChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üìà ROI Comparison</h3>
                <canvas id="roiChart"></canvas>
            </div>
        </div>
        
        <!-- Actions Bar -->
        <div class="actions-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search properties..." onkeyup="filterProperties()">
                <span class="search-icon">üîç</span>
            </div>
            <div class="filter-sold">
                <input type="checkbox" id="showSoldProperties" onchange="updateDisplay()">
                <label for="showSoldProperties">Show Sold Properties</label>
            </div>
            <div class="sort-controls">
                <label>Sort by:</label>
                <select id="sortSelect" onchange="sortProperties()">
                    <option value="address">Address</option>
                    <option value="value">Property Value</option>
                    <option value="cashflow">Cash Flow</option>
                    <option value="roi">ROI</option>
                    <option value="equity">Equity</option>
                </select>
            </div>
            <div class="data-controls">
                <button class="btn btn-export" onclick="exportToCSV()">üì• Export</button>
                <button class="btn btn-import" onclick="document.getElementById('importFile').click()">üì§ Import</button>
                <input type="file" id="importFile" style="display: none;" accept=".csv" onchange="importFromCSV(event)">
            </div>
        </div>
        
        <!-- Properties Table -->
        <div class="table-container">
            <table id="propertyTable">
                <thead>
                    <tr>
                        <th>Address <span class="sort-indicator" id="sort-address"></span></th>
                        <th>City</th>
                        <th>Purchase Price</th>
                        <th>Current Value</th>
                        <th>Monthly Rent</th>
                        <th>Mortgage</th>
                        <th>Cash Flow</th>
                        <th>ROI</th>
                        <th>Equity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- Properties will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Add Property Button -->
    <button class="add-property-btn" onclick="showAddPropertyModal()">+</button>
    
    <!-- Property Detail Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Property Details</h2>
                <span class="close" onclick="closeModal('propertyModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Property details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addPropertyTitle">Add New Property</h2>
                <span class="close" onclick="closeModal('addPropertyModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="propertyForm" onsubmit="saveProperty(event)">
                    <div class="form-group">
                        <label for="address">Property Address *</label>
                        <input type="text" id="address" name="address" required 
                               placeholder="123 Main St">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <input type="text" id="state" name="state" required maxlength="2" 
                                   placeholder="CA">
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code *</label>
                            <input type="text" id="zip" name="zip" required pattern="[0-9]{5}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchasePrice">Purchase Price *</label>
                            <input type="number" id="purchasePrice" name="purchasePrice" required min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label for="currentValue">Current Value</label>
                            <input type="number" id="currentValue" name="currentValue" min="0" step="1000">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthlyRent">Monthly Rent</label>
                            <input type="number" id="monthlyRent" name="monthlyRent" min="0" step="50">
                        </div>
                        <div class="form-group">
                            <label for="monthlyMortgage">Monthly Mortgage</label>
                            <input type="number" id="monthlyMortgage" name="monthlyMortgage" min="0" step="50">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="propertyType">Property Type</label>
                            <select id="propertyType" name="propertyType">
                                <option value="Single Family">Single Family</option>
                                <option value="Condo">Condo</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Multi-Family">Multi-Family</option>
                                <option value="Commercial">Commercial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="beds">Bedrooms</label>
                            <input type="number" id="beds" name="beds" min="0" max="20">
                        </div>
                        <div class="form-group">
                            <label for="baths">Bathrooms</label>
                            <input type="number" id="baths" name="baths" min="0" max="20" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="sqft">Square Feet</label>
                            <input type="number" id="sqft" name="sqft" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="yearBuilt">Year Built</label>
                            <input type="number" id="yearBuilt" name="yearBuilt" min="1800" max="2024">
                        </div>
                        <div class="form-group">
                            <label for="purchaseDate">Purchase Date</label>
                            <input type="date" id="purchaseDate" name="purchaseDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
                    </div>
                    
                    <input type="hidden" id="propertyId" name="propertyId">
                    <input type="hidden" id="propertyIndex" name="propertyIndex">
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">Save Property</button>
                        <button type="button" class="btn" onclick="closeModal('addPropertyModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- API Status Indicator -->
    <div class="api-status" id="apiStatus" onclick="toggleApiStatus()" title="Click to expand/collapse">
        <span class="api-status-indicator" id="apiStatusIndicator"></span>
        <span id="apiStatusText">Checking API...</span>
    </div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="color: #667eea; font-size: 18px; font-weight: 500;">Loading Real Estate Tracker...</p>
        </div>
    </div>
    
    <!-- Import Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let properties = [];
        let charts = {};
        let currentEditIndex = -1;
        let apiKeyConfigured = false;
        let chartUpdateTimer = null;
        
        // Load properties on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProperties();
            updateStats();
            initCharts();
            checkApiStatus();
            
            // Hide loading indicator after a short delay
            setTimeout(function() {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.transition = 'opacity 0.3s ease';
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => loadingIndicator.remove(), 300);
                }
            }, 300);
        });
        
        // Check API status on startup
        async function checkApiStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                apiKeyConfigured = data.apiKeyConfigured;
                updateApiStatusIndicator(apiKeyConfigured);
            } catch (error) {
                console.error('Error checking API status:', error);
                updateApiStatusIndicator(false);
            }
        }
        
        function updateApiStatusIndicator(isConfigured) {
            const indicator = document.getElementById('apiStatusIndicator');
            const text = document.getElementById('apiStatusText');
            
            if (isConfigured) {
                indicator.className = 'api-status-indicator connected';
                text.textContent = 'RentCast Connected';
            } else {
                indicator.className = 'api-status-indicator disconnected';
                text.textContent = 'RentCast Not Setup';
            }
        }
        
        // Toggle API status indicator collapse/expand
        function toggleApiStatus() {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.classList.toggle('collapsed');
        }
        
        // Load properties from localStorage and server
        async function loadProperties() {
            // First, try to load from server
            let serverProperties = [];
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                if (data.success && data.data) {
                    serverProperties = data.data;
                    console.log('Loaded properties from server:', serverProperties.length);
                }
            } catch (error) {
                console.error('Error loading from server:', error);
            }
            
            // Then load from localStorage
            const saved = localStorage.getItem('properties');
            const localProperties = saved ? JSON.parse(saved) : [];
            console.log('Loaded properties from localStorage:', localProperties.length);
            
            // Merge properties, preferring server data for duplicates
            const propertyMap = new Map();
            
            // Add server properties first
            serverProperties.forEach(prop => {
                propertyMap.set(prop.address, prop);
            });
            
            // Merge with local properties, preserving newer RentCast data
            localProperties.forEach(localProp => {
                const existingProp = propertyMap.get(localProp.address);
                
                if (existingProp) {
                    // If local property has more recent RentCast data, preserve it
                    const existingLastUpdated = existingProp.lastUpdated ? new Date(existingProp.lastUpdated) : new Date(0);
                    const localLastUpdated = localProp.lastUpdated ? new Date(localProp.lastUpdated) : new Date(0);
                    
                    if (localProp.realTimeData && localLastUpdated > existingLastUpdated) {
                        console.log(`Preserving newer RentCast data for ${localProp.address} from localStorage`);
                        console.log('Server version lastUpdated:', existingProp.lastUpdated);
                        console.log('Local version lastUpdated:', localProp.lastUpdated);
                        // Merge server data with local RentCast data
                        propertyMap.set(localProp.address, {
                            ...existingProp,
                            ...localProp,
                            id: existingProp.id // Keep server ID
                        });
                    } else if (!existingProp.realTimeData && localProp.realTimeData) {
                        // Server doesn't have RentCast data but local does
                        console.log(`Server missing RentCast data for ${localProp.address}, using local version`);
                        propertyMap.set(localProp.address, {
                            ...existingProp,
                            ...localProp,
                            id: existingProp.id // Keep server ID
                        });
                    }
                } else {
                    // Property only exists locally
                    console.log(`Property ${localProp.address} only exists locally`);
                    propertyMap.set(localProp.address, localProp);
                }
            });
            
            // Convert back to array
            properties = Array.from(propertyMap.values());
            
            console.log('Final merged properties:', properties.length);
            properties.forEach((prop, index) => {
                if (prop.realTimeData) {
                    console.log(`Property ${index}: ${prop.address} has RentCast data, lastUpdated: ${prop.lastUpdated}`);
                }
            });
            
            // Save merged data back to localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            console.log('Saved merged properties to localStorage');
            
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
        }
        
        // Save properties to localStorage and server
        async function saveProperties(propertyIndex = -1) {
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // If a specific property index is provided, update that property
            if (propertyIndex >= 0 && propertyIndex < properties.length) {
                const property = properties[propertyIndex];
                
                // If property has a database ID, update it
                if (property.id && typeof property.id === 'number') {
                    try {
                        const response = await fetch(`/api/properties/${property.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(property)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success && data.data) {
                            // Update the property with server response, but preserve RentCast data if it's newer
                            const serverData = data.data;
                            const localLastUpdated = property.lastUpdated ? new Date(property.lastUpdated) : new Date(0);
                            const serverLastUpdated = serverData.lastUpdated ? new Date(serverData.lastUpdated) : new Date(0);
                            
                            if (property.realTimeData && localLastUpdated >= serverLastUpdated) {
                                console.log('Preserving local RentCast data as it\'s newer or same');
                                properties[propertyIndex] = { ...serverData, ...property };
                            } else {
                                console.log('Using server data');
                                properties[propertyIndex] = { ...property, ...serverData };
                            }
                            
                            localStorage.setItem('properties', JSON.stringify(properties));
                            console.log('Property updated on server and localStorage');
                        }
                    } catch (error) {
                        console.error('Error updating property on server:', error);
                    }
                } else {
                    // Property doesn't have an ID, try to create it
                    try {
                        const response = await fetch('/api/properties', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(property)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success && data.data) {
                            // Update the property with server-generated ID
                            properties[propertyIndex] = { ...property, ...data.data };
                            localStorage.setItem('properties', JSON.stringify(properties));
                            console.log('Property saved to server');
                        }
                    } catch (error) {
                        console.error('Error saving property to server:', error);
                    }
                }
            }
            // Try to save to server if it's a new property
            else if (currentEditIndex === -1 && properties.length > 0) {
                const latestProperty = properties[properties.length - 1];
                try {
                    const response = await fetch('/api/properties', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(latestProperty)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Update the property with server-generated ID if available
                        properties[properties.length - 1] = { ...latestProperty, ...data.data };
                        localStorage.setItem('properties', JSON.stringify(properties));
                        console.log('Property saved to server');
                    }
                    
                    if (data.warning) {
                        console.warn('Server warning:', data.warning);
                    }
                } catch (error) {
                    console.error('Error saving to server:', error);
                    // Property is already saved locally, so no need to show error to user
                }
            }
        }
        
        // FIX 1: Update fetchRentCastData to properly handle the API response
        async function fetchRentCastData(addressComponents) {
            const { streetAddress, city, state, zip } = addressComponents;
            
            console.log('=== fetchRentCastData called ===');
            console.log('Address components:', { streetAddress, city, state, zip });
            
            try {
                // 1. First fetch basic property data
                const queryParams = new URLSearchParams({
                    address: streetAddress,
                    city: city,
                    state: state,
                    zipcode: zip
                });
                
                console.log('Fetching property data via server proxy...');
                
                const response = await fetch(`/api/rentcast/properties?${queryParams}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('RentCast API Error:', errorData);
                    
                    if (response.status === 503 && errorData.error && errorData.error.includes('not configured')) {
                        console.error('‚ùå RentCast API key not configured on server!');
                        console.error('Server message:', errorData.message);
                    }
                    
                    throw new Error(errorData.message || `API error: ${response.status}`);
                }
                
                const responseData = await response.json();
                
                if (!responseData.success) {
                    console.error('Server API Error:', responseData.error);
                    return { success: false, error: responseData.error };
                }
                
                const data = responseData.data;
                
                // Process RentCast response
                let properties = Array.isArray(data) ? data : (data.properties || [data]);
                
                if (properties && properties.length > 0) {
                    const property = properties[0];
                    console.log('Property data received:', property);
                    
                    // Basic property data
                    const extractedData = {
                        // Address info
                        streetAddress: property.addressLine1 || property.address || streetAddress,
                        address: property.addressLine1 || property.address || streetAddress,
                        city: property.city || city,
                        state: property.state || state,
                        zip: property.zipCode || property.zip || zip,
                        county: property.county || '',
                        lat: property.latitude || property.lat || 0,
                        lon: property.longitude || property.lng || 0,
                        formattedAddress: property.formattedAddress || `${streetAddress}, ${city}, ${state} ${zip}`,
                        
                        // Property details
                        beds: property.bedrooms || property.beds || 3,
                        baths: property.bathrooms || property.baths || 2,
                        sqft: property.squareFootage || property.buildingSize || property.livingArea || 1500,
                        year: property.yearBuilt || 2000,
                        propertyType: property.propertyType || 'Single Family',
                        lotSize: property.lotSize || property.lotSquareFootage || 6000,
                        
                        // Financial data
                        price: property.price || property.lastSoldPrice || 
                               (property.taxAssessedValue ? Math.round(property.taxAssessedValue * 1.1) : null) ||
                               property.lastSalePrice || 500000,
                        rentEstimate: property.rent || property.rentEstimate || 
                                    (property.rentRangeLow && property.rentRangeHigh ? 
                                     Math.round((property.rentRangeLow + property.rentRangeHigh) / 2) : null) ||
                                    (property.squareFootage ? Math.round(property.squareFootage * 1.5) : 2500),
                        
                        // Additional details
                        taxRate: property.taxRate || 0.012,
                        insuranceRate: 0.004,
                        hoaMonthly: property.hoaFee || 0,
                        
                        // Market data
                        lastSaleDate: property.lastSoldDate,
                        lastSalePrice: property.lastSoldPrice,
                        pricePerSqft: property.pricePerSquareFoot || 
                                     (property.price && property.squareFootage ? 
                                      Math.round(property.price / property.squareFootage) : 0),
                        rentPerSqft: property.rentPerSquareFoot || 0,
                        
                        // Tax assessment data
                        taxAssessedValue: property.taxAssessedValue || 0,
                        taxAssessedYear: property.taxAssessedYear || new Date().getFullYear(),
                        
                        // Owner info
                        ownerName: property.ownerName || '',
                        ownerType: property.ownerType || '',
                        ownerOccupied: property.ownerOccupied || false,
                        
                        // Property characteristics
                        stories: property.stories || 1,
                        garage: property.garage || 0,
                        pool: property.pool || false,
                        fireplace: property.fireplace || false,
                        airConditioning: property.airConditioning || 'Central',
                        heating: property.heating || 'Central',
                        basement: property.basement || false,
                        
                        // Construction details
                        foundation: property.foundation || '',
                        roofType: property.roofType || '',
                        exteriorWall: property.exteriorWall || '',
                        architecturalStyle: property.architecturalStyle || ''
                    };
                    
                    // 2. Fetch rent estimate with additional details
                    try {
                        console.log('Fetching rent estimate...');
                        const rentParams = new URLSearchParams({
                            address: streetAddress,
                            city: city,
                            state: state,
                            zipcode: zip,
                            bedrooms: extractedData.beds,
                            bathrooms: extractedData.baths,
                            squareFootage: extractedData.sqft
                        });
                        
                        const rentResponse = await fetch(`/api/rentcast/rent-estimate?${rentParams}`);
                        if (rentResponse.ok) {
                            const rentData = await rentResponse.json();
                            if (rentData.success && rentData.data) {
                                console.log('Rent estimate data:', rentData.data);
                                extractedData.rentEstimate = rentData.data.rent || extractedData.rentEstimate;
                                extractedData.rentRangeLow = rentData.data.rentRangeLow || 0;
                                extractedData.rentRangeHigh = rentData.data.rentRangeHigh || 0;
                                extractedData.rentPercentile = rentData.data.percentile || 50;
                            }
                        }
                    } catch (err) {
                        console.log('Could not fetch rent estimate:', err.message);
                    }
                    
                    // 3. Fetch value estimate
                    try {
                        console.log('Fetching value estimate...');
                        const valueResponse = await fetch(`/api/rentcast/value-estimate?${queryParams}`);
                        if (valueResponse.ok) {
                            const valueData = await valueResponse.json();
                            if (valueData.success && valueData.data) {
                                console.log('Value estimate data:', valueData.data);
                                extractedData.estimatedValue = valueData.data.price || extractedData.price;
                                extractedData.priceRangeLow = valueData.data.priceRangeLow || 0;
                                extractedData.priceRangeHigh = valueData.data.priceRangeHigh || 0;
                                extractedData.confidence = valueData.data.confidence || 'Medium';
                            }
                        }
                    } catch (err) {
                        console.log('Could not fetch value estimate:', err.message);
                    }
                    
                    // 4. Fetch market statistics
                    try {
                        console.log('Fetching market statistics...');
                        const marketResponse = await fetch(`/api/rentcast/market-stats?zipCode=${zip}&historyRange=12`);
                        if (marketResponse.ok) {
                            const marketData = await marketResponse.json();
                            if (marketData.success && marketData.data) {
                                console.log('Market statistics:', marketData.data);
                                extractedData.marketStats = {
                                    medianRent: marketData.data.medianRent || 0,
                                    medianPrice: marketData.data.medianPrice || 0,
                                    avgDaysOnMarket: marketData.data.averageDaysOnMarket || 0,
                                    inventoryCount: marketData.data.inventoryCount || 0,
                                    medianPricePerSqft: marketData.data.medianPricePerSquareFoot || 0,
                                    yearOverYearChange: marketData.data.yearOverYearPriceChange || 0,
                                    monthlyTrends: marketData.data.history || []
                                };
                            }
                        }
                    } catch (err) {
                        console.log('Could not fetch market statistics:', err.message);
                    }
                    
                    console.log('‚úÖ Comprehensive property data:', extractedData);
                    
                    return {
                        success: true,
                        data: extractedData
                    };
                } else {
                    console.log('No properties found in RentCast response');
                    return { 
                        success: false, 
                        error: 'No properties found for the given address' 
                    };
                }
                
            } catch (error) {
                console.error('Error fetching from RentCast:', error);
                return { 
                    success: false, 
                    error: error.message 
                };
            }
        }
        
        // FIX 2: Update refreshSingleProperty to work correctly
        async function refreshSingleProperty(index) {
            const prop = properties[index];
            if (!prop) {
                console.error('Property not found at index:', index);
                return;
            }
            
            const fullAddress = `${prop.address}, ${prop.city}, ${prop.state} ${prop.zip}`;
            
            // Show loading state
            const statusMsg = `Refreshing property data for ${prop.address}...`;
            console.log(statusMsg);
            
            // Find the refresh icon and add spinning animation
            const rows = document.querySelectorAll('#propertyTableBody tr');
            const refreshIcon = rows[index]?.querySelector('.refresh-icon');
            
            if (refreshIcon) {
                // Add spinning animation
                refreshIcon.style.animation = 'spin 1s linear infinite';
                refreshIcon.style.opacity = '1';
            }
            
            try {
                // Parse address components
                const addressComponents = parseAddressComponents(fullAddress);
                
                // Fetch RentCast data
                const rentCastResult = await fetchRentCastData(addressComponents);
                
                if (rentCastResult.success && rentCastResult.data) {
                    const data = rentCastResult.data;
                    
                    console.log(`‚úÖ RentCast data received for ${fullAddress}:`, data);
                    console.log('Current property before update:', properties[index]);
                    
                    // Update property with comprehensive real-time data
                    properties[index] = {
                        ...properties[index],
                        realTimeData: true,
                        lastUpdated: new Date().toISOString(),
                        // Update property details
                        beds: data.beds || properties[index].beds,
                        baths: data.baths || properties[index].baths,
                        sqft: data.sqft || properties[index].sqft,
                        yearBuilt: data.year || properties[index].yearBuilt,
                        lotSize: data.lotSize || properties[index].lotSize,
                        propertyType: data.propertyType || properties[index].propertyType,
                        county: data.county || properties[index].county,
                        // Update financial data if available
                        currentValue: data.estimatedValue || data.price || properties[index].currentValue,
                        monthlyRent: data.rentEstimate || properties[index].monthlyRent,
                        // Property characteristics
                        stories: data.stories || properties[index].stories,
                        garage: data.garage || properties[index].garage,
                        pool: data.pool || properties[index].pool,
                        fireplace: data.fireplace || properties[index].fireplace,
                        airConditioning: data.airConditioning || properties[index].airConditioning,
                        heating: data.heating || properties[index].heating,
                        basement: data.basement || properties[index].basement,
                        // Construction details
                        foundation: data.foundation || properties[index].foundation,
                        roofType: data.roofType || properties[index].roofType,
                        exteriorWall: data.exteriorWall || properties[index].exteriorWall,
                        architecturalStyle: data.architecturalStyle || properties[index].architecturalStyle,
                        // Owner info
                        ownerName: data.ownerName || properties[index].ownerName,
                        ownerType: data.ownerType || properties[index].ownerType,
                        ownerOccupied: data.ownerOccupied || properties[index].ownerOccupied,
                        // Tax data
                        taxAssessedValue: data.taxAssessedValue || properties[index].taxAssessedValue,
                        taxAssessedYear: data.taxAssessedYear || properties[index].taxAssessedYear,
                        // Store comprehensive market data
                        marketData: {
                            lastSaleDate: data.lastSaleDate,
                            lastSalePrice: data.lastSalePrice,
                            pricePerSqft: data.pricePerSqft,
                            rentPerSqft: data.rentPerSqft,
                            // Value estimates
                            estimatedValue: data.estimatedValue,
                            priceRangeLow: data.priceRangeLow,
                            priceRangeHigh: data.priceRangeHigh,
                            confidence: data.confidence,
                            // Rent estimates
                            rentRangeLow: data.rentRangeLow,
                            rentRangeHigh: data.rentRangeHigh,
                            rentPercentile: data.rentPercentile,
                            // Market statistics
                            marketStats: data.marketStats || {}
                        }
                    };
                    
                    console.log('Updated property with RentCast data:', properties[index]);
                    
                    // Save to localStorage and server with specific property index
                    await saveProperties(index);
                    console.log('Property saved to localStorage and server');
                    
                    // Verify data was saved
                    const savedProperties = JSON.parse(localStorage.getItem('properties') || '[]');
                    console.log('Verified saved property:', savedProperties[index]);
                    
                    // Update display
                    updateDisplay();
                    updateStats();
                    updateCharts();
                    
                    // Show success message
                    showMessage(`Successfully refreshed data for ${prop.address}`, 'success');
                    
                } else {
                    console.error(`Failed to fetch RentCast data for ${fullAddress}:`, rentCastResult.error);
                    showMessage(`Could not refresh data: ${rentCastResult.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error refreshing property:', error);
                showMessage(`Error refreshing property: ${error.message}`, 'error');
            } finally {
                // Remove loading state and stop spinning
                if (refreshIcon) {
                    refreshIcon.style.animation = '';
                    refreshIcon.style.opacity = '0.7';
                }
            }
        }
        
        // Helper function to show messages
        function showMessage(text, type = 'info') {
            // Create toast element for better visibility
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = text;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            document.body.appendChild(toast);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Parse address into components for API calls
        function parseAddressComponents(address) {
            // Remove newlines and extra spaces and normalize
            address = address.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            
            // Try to parse standard format: "123 Main St, City, State ZIP"
            const parts = address.split(',').map(p => p.trim());
            
            let streetAddress = '';
            let city = '';
            let state = '';
            let zip = '';
            
            if (parts.length >= 3) {
                streetAddress = parts[0];
                city = parts[1];
                const stateZip = parts[2];
                const stateZipMatch = stateZip.match(/([A-Z]{2})\s+(\d{5}(-\d{4})?)/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2].split('-')[0];
                } else {
                    // Try to extract state and zip separately
                    const words = stateZip.split(' ');
                    state = words[0];
                    zip = words[1] || '';
                }
            } else if (parts.length === 2) {
                // Try "123 Main St City, State ZIP" format
                const firstPart = parts[0];
                const secondPart = parts[1];
                const stateZipMatch = secondPart.match(/([A-Z]{2})\s+(\d{5})/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2];
                    // Extract city from end of first part
                    const words = firstPart.split(' ');
                    city = words[words.length - 1];
                    streetAddress = words.slice(0, -1).join(' ');
                }
            }
            
            return {
                streetAddress,
                city,
                state,
                zip
            };
        }
        
        // FIX 3: Ensure click handlers work properly
        function updateDisplay() {
            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = '';
            
            // Filter properties based on search and sold filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const showSold = document.getElementById('showSoldProperties').checked;
            
            let filteredProperties = properties.filter(prop => {
                // Check if property matches search
                const matchesSearch = !searchTerm || 
                    prop.address.toLowerCase().includes(searchTerm) ||
                    prop.city.toLowerCase().includes(searchTerm) ||
                    prop.state.toLowerCase().includes(searchTerm) ||
                    prop.zip.includes(searchTerm);
                
                // Check sold filter
                const matchesSold = showSold || !prop.isSold;
                
                return matchesSearch && matchesSold;
            });
            
            // Display each property
            filteredProperties.forEach((prop, originalIndex) => {
                // Find the actual index in the main properties array
                const index = properties.indexOf(prop);
                const row = document.createElement('tr');
                
                // Add sold styling if property is sold
                if (prop.isSold) {
                    row.classList.add('property-sold');
                    row.style.backgroundColor = '#fee';
                }
                
                // Check if property has exceeded target value
                if (prop.currentValue && prop.purchasePrice) {
                    const appreciation = ((prop.currentValue - prop.purchasePrice) / prop.purchasePrice) * 100;
                    if (appreciation >= 20) {
                        row.style.backgroundColor = '#e8f5e9';
                    }
                }
                
                // Make entire row clickable - ENHANCED EVENT HANDLER
                row.style.cursor = 'pointer';
                
                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('property-sold')) {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                row.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('property-sold') && 
                        !this.style.backgroundColor.includes('rgb(232, 245, 233)')) {
                        this.style.backgroundColor = '';
                    }
                });
                
                // Click handler with better event handling
                row.addEventListener('click', function(e) {
                    // Check if the click is not on an interactive element
                    const target = e.target;
                    const isEditableCell = target.classList.contains('editable-cell');
                    const isRefreshIcon = target.classList.contains('refresh-icon') || target.closest('.refresh-icon');
                    const isActionButton = target.tagName === 'BUTTON' || target.closest('button');
                    
                    if (!isEditableCell && !isRefreshIcon && !isActionButton) {
                        console.log(`Property row clicked, showing details for: ${prop.address} (index: ${index})`);
                        showPropertyDetail(index);
                    }
                });
                
                // Address cell with refresh icon
                const addressCell = document.createElement('td');
                addressCell.className = 'address-cell';
                
                const addressContainer = document.createElement('div');
                addressContainer.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                
                const addressSpan = document.createElement('span');
                addressSpan.textContent = prop.address;
                addressSpan.style.cursor = 'pointer';
                addressSpan.title = 'Click to view property details';
                
                if (prop.isSold) {
                    addressSpan.className = 'address-sold';
                } else {
                    // Add underline and color for non-sold properties
                    addressSpan.style.color = '#667eea';
                    addressSpan.style.textDecoration = 'underline';
                }
                
                // Add direct click handler to address span
                addressSpan.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log(`Address clicked: ${prop.address} (index: ${index})`);
                    showPropertyDetail(index);
                });
                
                addressContainer.appendChild(addressSpan);
                
                // Create refresh icon
                const refreshIcon = document.createElement('span');
                refreshIcon.className = 'refresh-icon';
                refreshIcon.textContent = 'üîÑ';
                refreshIcon.style.cssText = 'cursor: pointer; font-size: 14px; opacity: 0.7; transition: opacity 0.2s;';
                refreshIcon.title = 'Refresh real-time data for this property';
                refreshIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    refreshSingleProperty(index);
                });
                refreshIcon.addEventListener('mouseenter', function() {
                    this.style.opacity = '1';
                });
                refreshIcon.addEventListener('mouseleave', function() {
                    this.style.opacity = '0.7';
                });
                
                addressContainer.appendChild(refreshIcon);
                addressCell.appendChild(addressContainer);
                
                // Add badges
                if (prop.isSold) {
                    const soldBadge = document.createElement('span');
                    soldBadge.className = 'sold-badge';
                    soldBadge.textContent = 'SOLD';
                    addressCell.appendChild(soldBadge);
                }
                
                if (prop.realTimeData) {
                    const liveBadge = document.createElement('span');
                    liveBadge.className = 'real-time-badge';
                    liveBadge.title = 'Real-time data from RentCast';
                    liveBadge.textContent = 'LIVE';
                    addressCell.appendChild(liveBadge);
                }
                
                if (prop.lastUpdated) {
                    const updatedDate = new Date(prop.lastUpdated);
                    const timeAgo = getTimeAgo(updatedDate);
                    const updateSpan = document.createElement('span');
                    updateSpan.className = 'last-updated';
                    updateSpan.title = `Last updated: ${updatedDate.toLocaleString()}`;
                    updateSpan.textContent = timeAgo;
                    addressCell.appendChild(updateSpan);
                }
                
                row.appendChild(addressCell);
                
                // City (editable)
                row.appendChild(createEditableCell(prop.city || '', 'city', index));
                
                // Purchase Price (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.purchasePrice || 0), 'purchasePrice', index, true));
                
                // Current Value (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.currentValue || prop.purchasePrice || 0), 'currentValue', index, true));
                
                // Monthly Rent (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.monthlyRent || 0), 'monthlyRent', index, true));
                
                // Monthly Mortgage (editable)
                row.appendChild(createEditableCell(formatCurrency(prop.monthlyMortgage || 0), 'monthlyMortgage', index, true));
                
                // Cash Flow
                const cashFlow = calculateCashFlow(prop);
                const cashFlowCell = document.createElement('td');
                cashFlowCell.textContent = formatCurrency(cashFlow);
                cashFlowCell.className = cashFlow >= 0 ? 'positive' : 'negative';
                row.appendChild(cashFlowCell);
                
                // ROI
                const roi = calculateROI(prop);
                const roiCell = document.createElement('td');
                roiCell.textContent = roi + '%';
                roiCell.className = roi >= 0 ? 'positive' : 'negative';
                row.appendChild(roiCell);
                
                // Equity
                const equity = calculateEquity(prop);
                const equityCell = document.createElement('td');
                equityCell.textContent = formatCurrency(equity);
                equityCell.className = 'positive';
                row.appendChild(equityCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button class="btn btn-sm" onclick="event.stopPropagation(); editProperty(${index})">‚úèÔ∏è</button>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); deleteProperty(${index})">üóëÔ∏è</button>
                `;
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
            
            // Update totals
            document.getElementById('totalProperties').textContent = properties.length;
        }
        
        function createEditableCell(value, field, index, isCurrency = false) {
            const cell = document.createElement('td');
            cell.className = 'editable-cell';
            cell.contentEditable = true;
            cell.textContent = value;
            cell.dataset.field = field;
            cell.dataset.index = index;
            
            // Handle editing
            cell.addEventListener('blur', function() {
                let newValue = this.textContent.trim();
                
                if (isCurrency) {
                    // Remove currency formatting
                    newValue = newValue.replace(/[$,]/g, '');
                    newValue = parseFloat(newValue) || 0;
                    properties[index][field] = newValue;
                    this.textContent = formatCurrency(newValue);
                } else {
                    properties[index][field] = newValue;
                }
                
                saveProperties();
                updateStats();
                debouncedUpdateCharts();
            });
            
            // Prevent row click when editing
            cell.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            return cell;
        }
        
        // Show property detail modal
        function showPropertyDetail(index) {
            console.log('showPropertyDetail called for property index:', index);
            
            // Ensure properties exist
            if (!properties || properties.length === 0) {
                console.error('No properties loaded');
                alert('No properties loaded. Please refresh the page.');
                return;
            }
            
            // Ensure valid index
            if (index < 0 || index >= properties.length) {
                console.error('Invalid property index:', index);
                alert('Invalid property index');
                return;
            }
            
            const prop = properties[index];
            const modal = document.getElementById('propertyModal');
            
            if (!modal) {
                console.error('Property modal element not found!');
                return;
            }
            
            document.getElementById('modalTitle').textContent = prop.address;
            
            // Calculate financial metrics
            const cashFlow = calculateCashFlow(prop);
            const roi = calculateROI(prop);
            const equity = calculateEquity(prop);
            const totalExpenses = calculateTotalExpenses(prop);
            const capRate = calculateCapRate(prop);
            
            let modalContent = `
                <div class="property-details">
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">${prop.propertyType || 'Single Family'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">${prop.beds || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">${prop.baths || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">${prop.sqft ? prop.sqft.toLocaleString() : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Lot Size</div>
                        <div class="detail-value">${prop.lotSize ? prop.lotSize.toLocaleString() + ' sqft' : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">${prop.yearBuilt || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">County</div>
                        <div class="detail-value">${prop.county || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Date</div>
                        <div class="detail-value">${prop.purchaseDate ? new Date(prop.purchaseDate).toLocaleDateString() : 'N/A'}</div>
                    </div>
                </div>
                
                ${prop.stories || prop.garage || prop.pool !== undefined || prop.fireplace !== undefined || prop.basement !== undefined ? `
                <div class="property-features">
                    <h3>Property Features</h3>
                    <div class="features-grid">
                        ${prop.stories ? `<div class="feature-item">üìê ${prop.stories} ${prop.stories > 1 ? 'Stories' : 'Story'}</div>` : ''}
                        ${prop.garage ? `<div class="feature-item">üöó ${prop.garage}-Car Garage</div>` : ''}
                        ${prop.pool ? '<div class="feature-item">üèä Pool</div>' : ''}
                        ${prop.fireplace ? '<div class="feature-item">üî• Fireplace</div>' : ''}
                        ${prop.basement ? '<div class="feature-item">üè† Basement</div>' : ''}
                        ${prop.airConditioning ? `<div class="feature-item">‚ùÑÔ∏è ${prop.airConditioning} A/C</div>` : ''}
                        ${prop.heating ? `<div class="feature-item">üî• ${prop.heating} Heating</div>` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${prop.foundation || prop.roofType || prop.exteriorWall || prop.architecturalStyle ? `
                <div class="construction-details">
                    <h3>Construction Details</h3>
                    <div class="detail-grid">
                        ${prop.foundation ? `
                            <div class="detail-item">
                                <div class="detail-label">Foundation</div>
                                <div class="detail-value">${prop.foundation}</div>
                            </div>
                        ` : ''}
                        ${prop.roofType ? `
                            <div class="detail-item">
                                <div class="detail-label">Roof Type</div>
                                <div class="detail-value">${prop.roofType}</div>
                            </div>
                        ` : ''}
                        ${prop.exteriorWall ? `
                            <div class="detail-item">
                                <div class="detail-label">Exterior</div>
                                <div class="detail-value">${prop.exteriorWall}</div>
                            </div>
                        ` : ''}
                        ${prop.architecturalStyle ? `
                            <div class="detail-item">
                                <div class="detail-label">Style</div>
                                <div class="detail-value">${prop.architecturalStyle}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="financial-details">
                    <h3>Financial Overview</h3>
                    <div class="financial-grid">
                        <div class="detail-item">
                            <div class="detail-label">Purchase Price</div>
                            <div class="detail-value">${formatCurrency(prop.purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Current Value</div>
                            <div class="detail-value">${formatCurrency(prop.currentValue || prop.purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Equity</div>
                            <div class="detail-value positive">${formatCurrency(equity)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Rent</div>
                            <div class="detail-value">${formatCurrency(prop.monthlyRent)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Mortgage</div>
                            <div class="detail-value">${formatCurrency(prop.monthlyMortgage)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Expenses</div>
                            <div class="detail-value">${formatCurrency(totalExpenses)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Monthly Cash Flow</div>
                            <div class="detail-value ${cashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(cashFlow)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Annual ROI</div>
                            <div class="detail-value ${roi >= 0 ? 'positive' : 'negative'}">${roi}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Cap Rate</div>
                            <div class="detail-value">${capRate}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add owner information if available
            if (prop.ownerName || prop.ownerType || prop.ownerOccupied !== undefined) {
                modalContent += `
                    <div class="owner-section">
                        <h3>Owner Information</h3>
                        <div class="detail-grid">
                            ${prop.ownerName ? `
                                <div class="detail-item">
                                    <div class="detail-label">Owner</div>
                                    <div class="detail-value">${prop.ownerName}</div>
                                </div>
                            ` : ''}
                            ${prop.ownerType ? `
                                <div class="detail-item">
                                    <div class="detail-label">Type</div>
                                    <div class="detail-value">${prop.ownerType}</div>
                                </div>
                            ` : ''}
                            ${prop.ownerOccupied !== undefined ? `
                                <div class="detail-item">
                                    <div class="detail-label">Occupancy</div>
                                    <div class="detail-value">${prop.ownerOccupied ? 'Owner Occupied' : 'Non-Owner Occupied'}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Add tax assessment data
            if (prop.taxAssessedValue || prop.taxAssessedYear) {
                modalContent += `
                    <div class="tax-section">
                        <h3>Tax Assessment</h3>
                        <div class="detail-grid">
                            ${prop.taxAssessedValue ? `
                                <div class="detail-item">
                                    <div class="detail-label">Assessed Value</div>
                                    <div class="detail-value">${formatCurrency(prop.taxAssessedValue)}</div>
                                </div>
                            ` : ''}
                            ${prop.taxAssessedYear ? `
                                <div class="detail-item">
                                    <div class="detail-label">Assessment Year</div>
                                    <div class="detail-value">${prop.taxAssessedYear}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Add comprehensive market data section
            if (prop.marketData) {
                modalContent += `
                    <div class="analysis-section">
                        <h3>Market Analysis</h3>
                        <div class="metric-grid">
                            ${prop.marketData.lastSaleDate ? `
                                <div class="metric-item">
                                    <div class="metric-value">${new Date(prop.marketData.lastSaleDate).toLocaleDateString()}</div>
                                    <div class="metric-label">Last Sale Date</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.lastSalePrice ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.lastSalePrice)}</div>
                                    <div class="metric-label">Last Sale Price</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.estimatedValue ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.estimatedValue)}</div>
                                    <div class="metric-label">Est. Market Value</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.confidence ? `
                                <div class="metric-item">
                                    <div class="metric-value">${prop.marketData.confidence}</div>
                                    <div class="metric-label">Confidence</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${prop.marketData.priceRangeLow && prop.marketData.priceRangeHigh ? `
                        <div class="range-section">
                            <h4>Value Range</h4>
                            <div class="range-display">
                                <span class="range-low">${formatCurrency(prop.marketData.priceRangeLow)}</span>
                                <span class="range-divider">-</span>
                                <span class="range-high">${formatCurrency(prop.marketData.priceRangeHigh)}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${prop.marketData.rentRangeLow && prop.marketData.rentRangeHigh ? `
                        <div class="range-section">
                            <h4>Rent Estimate Range</h4>
                            <div class="range-display">
                                <span class="range-low">${formatCurrency(prop.marketData.rentRangeLow)}/mo</span>
                                <span class="range-divider">-</span>
                                <span class="range-high">${formatCurrency(prop.marketData.rentRangeHigh)}/mo</span>
                                ${prop.marketData.rentPercentile ? `<div class="percentile-badge">${prop.marketData.rentPercentile}th Percentile</div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${prop.marketData.marketStats && Object.keys(prop.marketData.marketStats).length > 0 ? `
                        <div class="neighborhood-stats">
                            <h4>Neighborhood Statistics (${prop.zip})</h4>
                            <div class="metric-grid">
                                ${prop.marketData.marketStats.medianRent ? `
                                    <div class="metric-item">
                                        <div class="metric-value">${formatCurrency(prop.marketData.marketStats.medianRent)}</div>
                                        <div class="metric-label">Median Rent</div>
                                    </div>
                                ` : ''}
                                ${prop.marketData.marketStats.medianPrice ? `
                                    <div class="metric-item">
                                        <div class="metric-value">${formatCurrency(prop.marketData.marketStats.medianPrice)}</div>
                                        <div class="metric-label">Median Price</div>
                                    </div>
                                ` : ''}
                                ${prop.marketData.marketStats.avgDaysOnMarket ? `
                                    <div class="metric-item">
                                        <div class="metric-value">${prop.marketData.marketStats.avgDaysOnMarket}</div>
                                        <div class="metric-label">Avg Days on Market</div>
                                    </div>
                                ` : ''}
                                ${prop.marketData.marketStats.inventoryCount ? `
                                    <div class="metric-item">
                                        <div class="metric-value">${prop.marketData.marketStats.inventoryCount}</div>
                                        <div class="metric-label">Active Listings</div>
                                    </div>
                                ` : ''}
                                ${prop.marketData.marketStats.yearOverYearChange ? `
                                    <div class="metric-item">
                                        <div class="metric-value ${prop.marketData.marketStats.yearOverYearChange >= 0 ? 'positive' : 'negative'}">${prop.marketData.marketStats.yearOverYearChange > 0 ? '+' : ''}${prop.marketData.marketStats.yearOverYearChange}%</div>
                                        <div class="metric-label">YoY Price Change</div>
                                    </div>
                                ` : ''}
                                ${prop.marketData.marketStats.medianPricePerSqft ? `
                                    <div class="metric-item">
                                        <div class="metric-value">${formatCurrency(prop.marketData.marketStats.medianPricePerSqft)}/sqft</div>
                                        <div class="metric-label">Median $/sqft</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="metric-grid">
                            ${prop.marketData.pricePerSqft ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.pricePerSqft)}/sqft</div>
                                    <div class="metric-label">Price per Sqft</div>
                                </div>
                            ` : ''}
                            ${prop.marketData.rentPerSqft ? `
                                <div class="metric-item">
                                    <div class="metric-value">${formatCurrency(prop.marketData.rentPerSqft)}/sqft</div>
                                    <div class="metric-label">Rent per Sqft</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Add notes section if available
            if (prop.notes) {
                modalContent += `
                    <div class="notes-section">
                        <h3>üìù Notes</h3>
                        <div class="notes-content">${prop.notes}</div>
                    </div>
                `;
            }
            
            // Add action buttons with refresh
            modalContent += `
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: space-between;">
                    <div>
                        <button class="btn btn-primary" onclick="refreshPropertyInModal(${index})">
                            üîÑ Refresh Real-Time Data
                        </button>
                        <button class="btn" onclick="editProperty(${index})">‚úèÔ∏è Edit</button>
                        ${prop.isSold ? 
                            `<button class="btn btn-unmark-sold" onclick="toggleSoldStatus(${index})">‚úÖ Unmark as Sold</button>` :
                            `<button class="btn btn-mark-sold" onclick="toggleSoldStatus(${index})">üí∞ Mark as Sold</button>`
                        }
                    </div>
                    <button class="btn" style="background: #dc3545; color: white;" onclick="deleteProperty(${index})">üóëÔ∏è Delete</button>
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = modalContent;
            modal.style.display = 'block';
        }
        
        // Refresh property data from modal
        async function refreshPropertyInModal(index) {
            // Close modal
            closeModal('propertyModal');
            
            // Refresh the property
            await refreshSingleProperty(index);
            
            // Reopen modal with updated data
            setTimeout(() => {
                showPropertyDetail(index);
            }, 500);
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days}d ago`;
            const months = Math.floor(days / 30);
            if (months < 12) return `${months}mo ago`;
            const years = Math.floor(months / 12);
            return `${years}y ago`;
        }
        
        // Toggle sold status
        function toggleSoldStatus(index) {
            properties[index].isSold = !properties[index].isSold;
            properties[index].soldDate = properties[index].isSold ? new Date().toISOString() : null;
            
            saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            
            // Close modal and show success message
            closeModal('propertyModal');
            
            const status = properties[index].isSold ? 'sold' : 'active';
            showMessage(`Property marked as ${status}`, 'success');
        }
        
        // Show add property modal
        function showAddPropertyModal() {
            document.getElementById('addPropertyTitle').textContent = 'Add New Property';
            document.getElementById('propertyForm').reset();
            document.getElementById('propertyId').value = '';
            document.getElementById('propertyIndex').value = '';
            currentEditIndex = -1;
            document.getElementById('addPropertyModal').style.display = 'block';
        }
        
        // Edit property
        function editProperty(index) {
            const prop = properties[index];
            
            document.getElementById('addPropertyTitle').textContent = 'Edit Property';
            document.getElementById('propertyIndex').value = index;
            currentEditIndex = index;
            
            // Fill form with property data
            document.getElementById('address').value = prop.address || '';
            document.getElementById('city').value = prop.city || '';
            document.getElementById('state').value = prop.state || '';
            document.getElementById('zip').value = prop.zip || '';
            document.getElementById('purchasePrice').value = prop.purchasePrice || '';
            document.getElementById('currentValue').value = prop.currentValue || '';
            document.getElementById('monthlyRent').value = prop.monthlyRent || '';
            document.getElementById('monthlyMortgage').value = prop.monthlyMortgage || '';
            document.getElementById('propertyType').value = prop.propertyType || 'Single Family';
            document.getElementById('beds').value = prop.beds || '';
            document.getElementById('baths').value = prop.baths || '';
            document.getElementById('sqft').value = prop.sqft || '';
            document.getElementById('yearBuilt').value = prop.yearBuilt || '';
            document.getElementById('purchaseDate').value = prop.purchaseDate || '';
            document.getElementById('notes').value = prop.notes || '';
            
            // Close detail modal if open
            closeModal('propertyModal');
            
            // Show edit modal
            document.getElementById('addPropertyModal').style.display = 'block';
        }
        
        // Save property (add or edit)
        async function saveProperty(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const index = formData.get('propertyIndex');
            
            const property = {
                address: formData.get('address'),
                city: formData.get('city'),
                state: formData.get('state'),
                zip: formData.get('zip'),
                purchasePrice: parseFloat(formData.get('purchasePrice')) || 0,
                currentValue: parseFloat(formData.get('currentValue')) || parseFloat(formData.get('purchasePrice')) || 0,
                monthlyRent: parseFloat(formData.get('monthlyRent')) || 0,
                monthlyMortgage: parseFloat(formData.get('monthlyMortgage')) || 0,
                propertyType: formData.get('propertyType'),
                beds: parseInt(formData.get('beds')) || null,
                baths: parseFloat(formData.get('baths')) || null,
                sqft: parseInt(formData.get('sqft')) || null,
                yearBuilt: parseInt(formData.get('yearBuilt')) || null,
                purchaseDate: formData.get('purchaseDate'),
                notes: formData.get('notes'),
                lastModified: new Date().toISOString()
            };
            
            if (index && index !== '') {
                // Edit existing property
                properties[parseInt(index)] = { ...properties[parseInt(index)], ...property };
            } else {
                // Add new property
                property.id = Date.now();
                property.createdAt = new Date().toISOString();
                properties.push(property);
            }
            
            await saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            closeModal('addPropertyModal');
            
            showMessage(index ? 'Property updated successfully' : 'Property added successfully', 'success');
        }
        
        // Delete property
        function deleteProperty(index) {
            if (confirm(`Are you sure you want to delete ${properties[index].address}?`)) {
                properties.splice(index, 1);
                saveProperties();
                updateDisplay();
                updateStats();
                debouncedUpdateCharts();
                closeModal('propertyModal');
                
                showMessage('Property deleted successfully', 'success');
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Filter properties
        function filterProperties() {
            updateDisplay();
        }
        
        // Sort properties
        function sortProperties() {
            const sortBy = document.getElementById('sortSelect').value;
            
            properties.sort((a, b) => {
                switch (sortBy) {
                    case 'address':
                        return a.address.localeCompare(b.address);
                    case 'value':
                        return (b.currentValue || b.purchasePrice || 0) - (a.currentValue || a.purchasePrice || 0);
                    case 'cashflow':
                        return calculateCashFlow(b) - calculateCashFlow(a);
                    case 'roi':
                        return calculateROI(b) - calculateROI(a);
                    case 'equity':
                        return calculateEquity(b) - calculateEquity(a);
                    default:
                        return 0;
                }
            });
            
            updateDisplay();
        }
        
        // Calculate cash flow
        function calculateCashFlow(property) {
            const rent = property.monthlyRent || 0;
            const mortgage = property.monthlyMortgage || 0;
            const expenses = calculateMonthlyExpenses(property);
            return rent - mortgage - expenses;
        }
        
        // Calculate monthly expenses (property tax, insurance, HOA, maintenance)
        function calculateMonthlyExpenses(property) {
            const value = property.currentValue || property.purchasePrice || 0;
            const propertyTax = (value * 0.012) / 12; // 1.2% annually
            const insurance = (value * 0.004) / 12; // 0.4% annually
            const hoa = property.hoaMonthly || 0;
            const maintenance = (value * 0.01) / 12; // 1% annually for maintenance
            return propertyTax + insurance + hoa + maintenance;
        }
        
        // Calculate total expenses
        function calculateTotalExpenses(property) {
            return (property.monthlyMortgage || 0) + calculateMonthlyExpenses(property);
        }
        
        // Calculate ROI
        function calculateROI(property) {
            const annualCashFlow = calculateCashFlow(property) * 12;
            const totalInvestment = property.purchasePrice || 1; // Avoid division by zero
            return Math.round((annualCashFlow / totalInvestment) * 100 * 100) / 100;
        }
        
        // Calculate Cap Rate
        function calculateCapRate(property) {
            const noi = (property.monthlyRent || 0) * 12 - calculateMonthlyExpenses(property) * 12;
            const value = property.currentValue || property.purchasePrice || 1;
            return Math.round((noi / value) * 100 * 100) / 100;
        }
        
        // Calculate equity
        function calculateEquity(property) {
            const currentValue = property.currentValue || property.purchasePrice || 0;
            const remainingMortgage = property.remainingMortgage || (property.purchasePrice * 0.8); // Assume 20% down
            return currentValue - remainingMortgage;
        }
        
        // Update statistics
        function updateStats() {
            const totalValue = properties.reduce((sum, prop) => sum + (prop.currentValue || prop.purchasePrice || 0), 0);
            const monthlyIncome = properties.reduce((sum, prop) => sum + (prop.monthlyRent || 0), 0);
            const totalEquity = properties.reduce((sum, prop) => sum + calculateEquity(prop), 0);
            
            // Calculate average ROI
            let avgROI = 0;
            if (properties.length > 0) {
                const totalROI = properties.reduce((sum, prop) => sum + calculateROI(prop), 0);
                avgROI = Math.round((totalROI / properties.length) * 100) / 100;
            }
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('avgROI').textContent = avgROI + '%';
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Initialize charts
        function initCharts() {
            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            charts.cashFlow = new Chart(cashFlowCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly Cash Flow',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                maxTicksLimit: 8
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
            
            // ROI Chart
            const roiCtx = document.getElementById('roiChart').getContext('2d');
            charts.roi = new Chart(roiCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ROI %',
                        data: [],
                        backgroundColor: '#667eea',
                        borderColor: '#5a67d8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Debounced update charts to prevent excessive updates
        function debouncedUpdateCharts() {
            if (chartUpdateTimer) {
                clearTimeout(chartUpdateTimer);
            }
            chartUpdateTimer = setTimeout(() => {
                updateCharts();
            }, 100);
        }
        
        // Update charts
        function updateCharts() {
            if (!charts.cashFlow || !charts.roi) return;
            
            // Limit to 20 properties for performance
            let displayProperties = properties;
            if (properties.length > 20) {
                // Show top 20 properties by ROI
                displayProperties = [...properties]
                    .sort((a, b) => calculateROI(b) - calculateROI(a))
                    .slice(0, 20);
            }
            
            // Prepare data
            const labels = displayProperties.map(prop => {
                const addr = prop.address || '';
                return addr.length > 15 ? addr.substring(0, 15) + '...' : addr;
            });
            const cashFlowData = displayProperties.map(prop => calculateCashFlow(prop));
            const roiData = displayProperties.map(prop => calculateROI(prop));
            
            // Update Cash Flow Chart with no animation
            charts.cashFlow.data.labels = labels;
            charts.cashFlow.data.datasets[0].data = cashFlowData;
            charts.cashFlow.data.datasets[0].backgroundColor = cashFlowData.map(value => 
                value >= 0 ? 'rgba(72, 187, 120, 0.8)' : 'rgba(245, 101, 101, 0.8)'
            );
            charts.cashFlow.data.datasets[0].borderColor = cashFlowData.map(value => 
                value >= 0 ? '#48bb78' : '#f56565'
            );
            charts.cashFlow.update('none');
            
            // Update ROI Chart with no animation
            charts.roi.data.labels = labels;
            charts.roi.data.datasets[0].data = roiData;
            charts.roi.update('none');
        }
        
        // Export to CSV
        function exportToCSV() {
            const headers = ['Address', 'City', 'State', 'ZIP', 'Purchase Price', 'Current Value', 
                           'Monthly Rent', 'Monthly Mortgage', 'Cash Flow', 'ROI', 'Equity',
                           'Property Type', 'Beds', 'Baths', 'Sqft', 'Year Built', 'Purchase Date', 'Notes'];
            
            const rows = properties.map(prop => [
                prop.address,
                prop.city,
                prop.state,
                prop.zip,
                prop.purchasePrice,
                prop.currentValue || prop.purchasePrice,
                prop.monthlyRent,
                prop.monthlyMortgage,
                calculateCashFlow(prop),
                calculateROI(prop),
                calculateEquity(prop),
                prop.propertyType || 'Single Family',
                prop.beds || '',
                prop.baths || '',
                prop.sqft || '',
                prop.yearBuilt || '',
                prop.purchaseDate || '',
                prop.notes || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `real-estate-portfolio-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showMessage('Portfolio exported successfully', 'success');
        }
        
        // Import from CSV
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].match(/(".*?"|[^,]+)/g).map(v => v.replace(/"/g, '').trim());
                    const property = {
                        id: Date.now() + i,
                        createdAt: new Date().toISOString()
                    };
                    
                    headers.forEach((header, index) => {
                        const value = values[index];
                        switch (header.toLowerCase()) {
                            case 'address':
                                property.address = value;
                                break;
                            case 'city':
                                property.city = value;
                                break;
                            case 'state':
                                property.state = value;
                                break;
                            case 'zip':
                                property.zip = value;
                                break;
                            case 'purchase price':
                                property.purchasePrice = parseFloat(value) || 0;
                                break;
                            case 'current value':
                                property.currentValue = parseFloat(value) || 0;
                                break;
                            case 'monthly rent':
                                property.monthlyRent = parseFloat(value) || 0;
                                break;
                            case 'monthly mortgage':
                                property.monthlyMortgage = parseFloat(value) || 0;
                                break;
                            case 'property type':
                                property.propertyType = value;
                                break;
                            case 'beds':
                                property.beds = parseInt(value) || null;
                                break;
                            case 'baths':
                                property.baths = parseFloat(value) || null;
                                break;
                            case 'sqft':
                                property.sqft = parseInt(value) || null;
                                break;
                            case 'year built':
                                property.yearBuilt = parseInt(value) || null;
                                break;
                            case 'purchase date':
                                property.purchaseDate = value;
                                break;
                            case 'notes':
                                property.notes = value;
                                break;
                        }
                    });
                    
                    if (property.address) {
                        properties.push(property);
                    }
                }
                
                saveProperties();
                updateDisplay();
                updateStats();
                debouncedUpdateCharts();
                
                showMessage(`Imported ${properties.length} properties successfully`, 'success');
            };
            
            reader.readAsText(file);
        }
        
        // Analyze new property
        async function analyzeNewProperty() {
            const address = document.getElementById('propertyAddressInput').value.trim();
            
            if (!address) {
                alert('Please enter a property address');
                return;
            }
            
            // Show loading
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            try {
                console.log('=== Starting property analysis for:', address);
                
                // Check API status first
                const apiStatus = await fetch('/api/status').then(r => r.json()).catch(() => ({ apiKeyConfigured: false }));
                console.log('API Key Status:', apiStatus.apiKeyConfigured ? 'Configured' : 'Not configured');
                
                // Fetch real property data - This calls RentCast API when adding new property
                console.log('Calling fetchRealPropertyData...');
                const propertyData = await fetchRealPropertyData(address);
                console.log('fetchRealPropertyData result:', propertyData);
                
                if (propertyData.success && propertyData.source === 'RentCast API') {
                    console.log('‚úÖ RentCast data fetched successfully for new property');
                    console.log('Property data:', propertyData.data);
                    generateEnhancedPropertyAnalysis(address, propertyData.data);
                } else {
                    console.log('‚ö†Ô∏è RentCast data not available, using estimates');
                    console.log('Reason:', propertyData.error || 'Unknown');
                    // Fallback to original parsing
                    generatePropertyAnalysis(address);
                }
            } catch (error) {
                console.error('Error analyzing property:', error);
                alert('Error analyzing property. Using estimated data instead.');
                // Fallback to original parsing
                generatePropertyAnalysis(address);
            }
        }
        
        // Fetch real property data using multiple sources
        async function fetchRealPropertyData(address) {
            const results = {
                success: false,
                source: 'none',
                data: null
            };

            try {
                // First, parse the address to get components
                const parsedAddress = parseAddressComponents(address);
                
                // Try RentCast API first
                const rentcastData = await fetchRentCastData(parsedAddress);
                
                if (rentcastData && rentcastData.success) {
                    results.data = rentcastData.data;
                    results.success = true;
                    results.source = 'RentCast API';
                } else {
                    // Fallback to OpenStreetMap Nominatim for geocoding
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`;
                    const geoResponse = await fetch(geocodeUrl);
                    const geoData = await geoResponse.json();
                    
                    if (geoData && geoData[0]) {
                        const location = geoData[0];
                        const addressDetails = location.address || {};
                        
                        results.data = {
                            lat: location.lat,
                            lon: location.lon,
                            streetNumber: addressDetails.house_number || '',
                            streetName: addressDetails.road || '',
                            address: parsedAddress.streetAddress || address.split(',')[0].trim(),
                            city: addressDetails.city || addressDetails.town || addressDetails.village || parsedAddress.city || '',
                            state: addressDetails.state || parsedAddress.state || '',
                            zip: addressDetails.postcode || parsedAddress.zip || '',
                            country: addressDetails.country || 'USA',
                            formattedAddress: location.display_name
                        };
                        
                        // Get estimates based on location
                        const propertyDetails = await fetchPropertyDetails(results.data);
                        results.data = { ...results.data, ...propertyDetails };
                        results.success = true;
                        results.source = 'OpenStreetMap + Estimates';
                    }
                }
            } catch (error) {
                console.error('Error fetching property data:', error);
            }
            
            return results;
        }
        
        // Generate enhanced property analysis with real data
        function generateEnhancedPropertyAnalysis(address, propertyData) {
            const {
                streetNumber, streetName, city, state, zip, 
                beds, baths, sqft, year, price, rentEstimate,
                taxRate, insuranceRate, hoaMonthly, propertyType,
                lat, lon, formattedAddress
            } = propertyData;
            
            // Use the address field from propertyData if available, otherwise parse from input
            const fullAddress = propertyData.address || address.split(',')[0].trim();
            
            // Financial calculations
            const purchasePrice = price || 500000;
            const downPayment = purchasePrice * 0.20;
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            const monthlyRent = rentEstimate || 2500;
            
            // Calculate expenses
            const propertyTax = (purchasePrice * (taxRate || 0.012)) / 12;
            const insurance = (purchasePrice * (insuranceRate || 0.004)) / 12;
            const hoa = hoaMonthly || 0;
            const maintenance = (purchasePrice * 0.01) / 12;
            const propertyManagement = monthlyRent * 0.08;
            
            const totalExpenses = propertyTax + insurance + hoa + maintenance + propertyManagement;
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((monthlyRent * 12 - totalExpenses * 12) / purchasePrice) * 100;
            
            // Create comprehensive property data object
            const comprehensiveData = {
                ...propertyData,
                purchasePrice,
                monthlyRent,
                monthlyMortgage,
                monthlyCashFlow,
                cashOnCashReturn,
                capRate,
                downPayment,
                totalExpenses,
                propertyTax,
                insurance,
                hoa,
                maintenance,
                propertyManagement
            };
            
            // Display results
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>üìç Property Details (from RentCast)</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${fullAddress}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${city}, ${state} ${zip}</div>
                        </div>
                        ${propertyData.county ? `
                        <div class="detail-item">
                            <div class="detail-label">County</div>
                            <div class="detail-value">${propertyData.county}</div>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms</div>
                            <div class="detail-value">${beds}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bathrooms</div>
                            <div class="detail-value">${baths}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${sqft ? sqft.toLocaleString() : 'N/A'}</div>
                        </div>
                        ${propertyData.lotSize ? `
                        <div class="detail-item">
                            <div class="detail-label">Lot Size</div>
                            <div class="detail-value">${propertyData.lotSize.toLocaleString()} sqft</div>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">${year || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">${propertyData.estimatedValue ? 'Market Value' : 'Estimated Value'}</div>
                            <div class="detail-value">${formatCurrency(propertyData.estimatedValue || purchasePrice)}</div>
                        </div>
                        ${propertyData.confidence ? `
                        <div class="detail-item">
                            <div class="detail-label">Confidence</div>
                            <div class="detail-value">${propertyData.confidence}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${propertyData.stories || propertyData.garage || propertyData.pool !== undefined || propertyData.fireplace !== undefined ? `
                <div class="analysis-section">
                    <h3>üè† Property Features</h3>
                    <div class="features-grid">
                        ${propertyData.stories ? `<div class="feature-item">üìê ${propertyData.stories} ${propertyData.stories > 1 ? 'Stories' : 'Story'}</div>` : ''}
                        ${propertyData.garage ? `<div class="feature-item">üöó ${propertyData.garage}-Car Garage</div>` : ''}
                        ${propertyData.pool ? '<div class="feature-item">üèä Pool</div>' : ''}
                        ${propertyData.fireplace ? '<div class="feature-item">üî• Fireplace</div>' : ''}
                        ${propertyData.basement ? '<div class="feature-item">üè† Basement</div>' : ''}
                        ${propertyData.airConditioning ? `<div class="feature-item">‚ùÑÔ∏è ${propertyData.airConditioning}</div>` : ''}
                        ${propertyData.heating ? `<div class="feature-item">üî• ${propertyData.heating}</div>` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="analysis-section">
                    <h3>üí∞ Investment Analysis</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                            <div class="metric-label">Down Payment (20%)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(monthlyRent)}</div>
                            <div class="metric-label">Est. Monthly Rent</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(monthlyMortgage)}</div>
                            <div class="metric-label">Monthly Mortgage</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                            <div class="metric-label">Monthly Cash Flow</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üìä Return Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value ${cashOnCashReturn >= 0 ? 'positive' : 'negative'}">${cashOnCashReturn.toFixed(2)}%</div>
                            <div class="metric-label">Cash-on-Cash Return</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${capRate.toFixed(2)}%</div>
                            <div class="metric-label">Cap Rate</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(annualCashFlow)}</div>
                            <div class="metric-label">Annual Cash Flow</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${((monthlyRent / purchasePrice) * 100).toFixed(2)}%</div>
                            <div class="metric-label">1% Rule</div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üìã Monthly Expenses Breakdown</h3>
                    <div class="financial-grid">
                        <div class="detail-item">
                            <div class="detail-label">Property Tax</div>
                            <div class="detail-value">${formatCurrency(propertyTax)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Insurance</div>
                            <div class="detail-value">${formatCurrency(insurance)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HOA</div>
                            <div class="detail-value">${formatCurrency(hoa)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Maintenance</div>
                            <div class="detail-value">${formatCurrency(maintenance)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Mgmt</div>
                            <div class="detail-value">${formatCurrency(propertyManagement)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Expenses</div>
                            <div class="detail-value"><strong>${formatCurrency(totalExpenses)}</strong></div>
                        </div>
                    </div>
                </div>
                
                ${propertyData.marketStats && Object.keys(propertyData.marketStats).length > 0 ? `
                <div class="analysis-section">
                    <h3>üìä Market Statistics (${zip})</h3>
                    <div class="metric-grid">
                        ${propertyData.marketStats.medianRent ? `
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(propertyData.marketStats.medianRent)}</div>
                                <div class="metric-label">Median Rent</div>
                            </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPrice ? `
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPrice)}</div>
                                <div class="metric-label">Median Price</div>
                            </div>
                        ` : ''}
                        ${propertyData.marketStats.avgDaysOnMarket ? `
                            <div class="metric-item">
                                <div class="metric-value">${propertyData.marketStats.avgDaysOnMarket}</div>
                                <div class="metric-label">Avg Days on Market</div>
                            </div>
                        ` : ''}
                        ${propertyData.marketStats.inventoryCount ? `
                            <div class="metric-item">
                                <div class="metric-value">${propertyData.marketStats.inventoryCount}</div>
                                <div class="metric-label">Active Listings</div>
                            </div>
                        ` : ''}
                        ${propertyData.marketStats.yearOverYearChange ? `
                            <div class="metric-item">
                                <div class="metric-value ${propertyData.marketStats.yearOverYearChange >= 0 ? 'positive' : 'negative'}">${propertyData.marketStats.yearOverYearChange > 0 ? '+' : ''}${propertyData.marketStats.yearOverYearChange}%</div>
                                <div class="metric-label">YoY Price Change</div>
                            </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPricePerSqft ? `
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPricePerSqft)}/sqft</div>
                                <div class="metric-label">Median $/sqft</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${propertyData.priceRangeLow && propertyData.priceRangeHigh ? `
                <div class="analysis-section">
                    <h3>üíµ Value & Rent Estimates</h3>
                    <div class="range-section">
                        <h4>Estimated Value Range</h4>
                        <div class="range-display">
                            <span class="range-low">${formatCurrency(propertyData.priceRangeLow)}</span>
                            <span class="range-divider">-</span>
                            <span class="range-high">${formatCurrency(propertyData.priceRangeHigh)}</span>
                        </div>
                    </div>
                    ${propertyData.rentRangeLow && propertyData.rentRangeHigh ? `
                    <div class="range-section">
                        <h4>Rent Estimate Range</h4>
                        <div class="range-display">
                            <span class="range-low">${formatCurrency(propertyData.rentRangeLow)}/mo</span>
                            <span class="range-divider">-</span>
                            <span class="range-high">${formatCurrency(propertyData.rentRangeHigh)}/mo</span>
                            ${propertyData.rentPercentile ? `<div class="percentile-badge">${propertyData.rentPercentile}th Percentile</div>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                
                ${propertyData.lastSaleDate || propertyData.lastSalePrice || propertyData.taxAssessedValue ? `
                <div class="analysis-section">
                    <h3>üè¢ Property History</h3>
                    <div class="detail-grid">
                        ${propertyData.lastSaleDate ? `
                            <div class="detail-item">
                                <div class="detail-label">Last Sale Date</div>
                                <div class="detail-value">${new Date(propertyData.lastSaleDate).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                        ${propertyData.lastSalePrice ? `
                            <div class="detail-item">
                                <div class="detail-label">Last Sale Price</div>
                                <div class="detail-value">${formatCurrency(propertyData.lastSalePrice)}</div>
                            </div>
                        ` : ''}
                        ${propertyData.taxAssessedValue ? `
                            <div class="detail-item">
                                <div class="detail-label">Tax Assessed Value</div>
                                <div class="detail-value">${formatCurrency(propertyData.taxAssessedValue)}</div>
                            </div>
                        ` : ''}
                        ${propertyData.taxAssessedYear ? `
                            <div class="detail-item">
                                <div class="detail-label">Assessment Year</div>
                                <div class="detail-value">${propertyData.taxAssessedYear}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick='addComprehensiveProperty(${JSON.stringify(comprehensiveData).replace(/'/g, "\\x27")})'>
                        ‚ûï Add to Portfolio
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('propertyAddressInput').value=''; document.getElementById('analysisResults').style.display='none';">
                        üîç Analyze Another
                    </button>
                </div>
            `;
            
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
        }
        
        // Original property analysis (fallback)
        function generatePropertyAnalysis(address) {
            // Parse address
            const parts = address.split(',').map(p => p.trim());
            const streetAddress = parts[0] || '';
            const city = parts[1] || '';
            const stateZip = parts[2] || '';
            
            // Extract state and zip
            let state = '';
            let zip = '';
            if (stateZip) {
                const stateZipMatch = stateZip.match(/([A-Z]{2})\s+(\d{5})/i);
                if (stateZipMatch) {
                    state = stateZipMatch[1];
                    zip = stateZipMatch[2];
                }
            }
            
            // Estimate property details based on typical values
            const estimatedPrice = 500000;
            const estimatedRent = 2500;
            const downPayment = estimatedPrice * 0.20;
            const loanAmount = estimatedPrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            // Calculate expenses
            const propertyTax = (estimatedPrice * 0.012) / 12;
            const insurance = (estimatedPrice * 0.004) / 12;
            const hoa = 150;
            const maintenance = (estimatedPrice * 0.01) / 12;
            const propertyManagement = estimatedRent * 0.08;
            
            const totalExpenses = propertyTax + insurance + hoa + maintenance + propertyManagement;
            const monthlyCashFlow = estimatedRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((estimatedRent * 12 - totalExpenses * 12) / estimatedPrice) * 100;
            
            // Display results
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>üìç Property Details (Estimated)</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${streetAddress}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City</div>
                            <div class="detail-value">${city}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">State</div>
                            <div class="detail-value">${state}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ZIP</div>
                            <div class="detail-value">${zip}</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #e53e3e; font-size: 0.9rem;">
                        ‚ö†Ô∏è Note: Using estimated values. For accurate data, ensure RentCast API is configured.
                    </p>
                </div>
                
                <div class="analysis-section">
                    <h3>üí∞ Investment Analysis (Estimated)</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(estimatedPrice)}</div>
                            <div class="metric-label">Estimated Value</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                            <div class="metric-label">Down Payment (20%)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${formatCurrency(estimatedRent)}</div>
                            <div class="metric-label">Est. Monthly Rent</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                            <div class="metric-label">Monthly Cash Flow</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addAnalyzedProperty('${streetAddress}', '${city}', '${state}', '${zip}', ${estimatedPrice}, ${estimatedRent}, ${monthlyMortgage})">
                        ‚ûï Add to Portfolio
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('propertyAddressInput').value=''; document.getElementById('analysisResults').style.display='none';">
                        üîç Analyze Another
                    </button>
                </div>
            `;
            
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
        }
        
        // Calculate mortgage payment
        function calculateMortgagePayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 12;
            const numPayments = years * 12;
            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            return Math.round(payment);
        }
        
        // Add comprehensive property with all RentCast data
        function addComprehensiveProperty(comprehensiveData) {
            const property = {
                id: Date.now(),
                address: comprehensiveData.address || comprehensiveData.streetAddress,
                city: comprehensiveData.city,
                state: comprehensiveData.state,
                zip: comprehensiveData.zip,
                county: comprehensiveData.county,
                purchasePrice: comprehensiveData.purchasePrice,
                currentValue: comprehensiveData.estimatedValue || comprehensiveData.purchasePrice,
                monthlyRent: comprehensiveData.monthlyRent,
                monthlyMortgage: comprehensiveData.monthlyMortgage,
                propertyType: comprehensiveData.propertyType || 'Single Family',
                beds: comprehensiveData.beds || null,
                baths: comprehensiveData.baths || null,
                sqft: comprehensiveData.sqft || null,
                yearBuilt: comprehensiveData.year || comprehensiveData.yearBuilt || null,
                lotSize: comprehensiveData.lotSize || null,
                purchaseDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                realTimeData: true,
                // Property features
                stories: comprehensiveData.stories,
                garage: comprehensiveData.garage,
                pool: comprehensiveData.pool,
                fireplace: comprehensiveData.fireplace,
                basement: comprehensiveData.basement,
                airConditioning: comprehensiveData.airConditioning,
                heating: comprehensiveData.heating,
                // Construction details
                foundation: comprehensiveData.foundation,
                roofType: comprehensiveData.roofType,
                exteriorWall: comprehensiveData.exteriorWall,
                architecturalStyle: comprehensiveData.architecturalStyle,
                // Owner info
                ownerName: comprehensiveData.ownerName,
                ownerType: comprehensiveData.ownerType,
                ownerOccupied: comprehensiveData.ownerOccupied,
                // Tax data
                taxAssessedValue: comprehensiveData.taxAssessedValue,
                taxAssessedYear: comprehensiveData.taxAssessedYear,
                // Market data
                marketData: {
                    lastSaleDate: comprehensiveData.lastSaleDate,
                    lastSalePrice: comprehensiveData.lastSalePrice,
                    pricePerSqft: comprehensiveData.pricePerSqft,
                    rentPerSqft: comprehensiveData.rentPerSqft,
                    estimatedValue: comprehensiveData.estimatedValue,
                    priceRangeLow: comprehensiveData.priceRangeLow,
                    priceRangeHigh: comprehensiveData.priceRangeHigh,
                    confidence: comprehensiveData.confidence,
                    rentRangeLow: comprehensiveData.rentRangeLow,
                    rentRangeHigh: comprehensiveData.rentRangeHigh,
                    rentPercentile: comprehensiveData.rentPercentile,
                    marketStats: comprehensiveData.marketStats || {}
                }
            };
            
            properties.push(property);
            saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            
            // Clear form and hide results
            document.getElementById('propertyAddressInput').value = '';
            document.getElementById('analysisResults').style.display = 'none';
            
            showMessage('Property added to portfolio with comprehensive RentCast data!', 'success');
        }
        
        // Legacy function for backward compatibility
        function addAnalyzedProperty(address, city, state, zip, purchasePrice, monthlyRent, monthlyMortgage, propertyType, beds, baths, sqft, yearBuilt) {
            const property = {
                id: Date.now(),
                address: address,
                city: city,
                state: state,
                zip: zip,
                purchasePrice: purchasePrice,
                currentValue: purchasePrice,
                monthlyRent: monthlyRent,
                monthlyMortgage: monthlyMortgage,
                propertyType: propertyType || 'Single Family',
                beds: beds || null,
                baths: baths || null,
                sqft: sqft || null,
                yearBuilt: yearBuilt || null,
                purchaseDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            properties.push(property);
            saveProperties();
            updateDisplay();
            updateStats();
            debouncedUpdateCharts();
            
            // Clear form and hide results
            document.getElementById('propertyAddressInput').value = '';
            document.getElementById('analysisResults').style.display = 'none';
            
            showMessage('Property added to portfolio successfully!', 'success');
        }
        
        // Fetch property details estimates based on location
        async function fetchPropertyDetails(locationData) {
            // This would normally call various APIs for property details
            // For now, return reasonable estimates based on location
            
            const estimates = {
                beds: 3,
                baths: 2,
                sqft: 1500,
                year: 2000,
                price: 500000,
                rentEstimate: 2500,
                propertyType: 'Single Family',
                taxRate: 0.012,
                insuranceRate: 0.004,
                hoaMonthly: 150
            };
            
            // Adjust estimates based on state/city if available
            if (locationData.state === 'CA') {
                estimates.price *= 1.5;
                estimates.rentEstimate *= 1.4;
            } else if (locationData.state === 'TX') {
                estimates.price *= 0.8;
                estimates.rentEstimate *= 0.9;
                estimates.taxRate = 0.02;
            }
            
            return estimates;
        }
        
        // Gemini API configuration
        const GEMINI_API_KEY = 'AIzaSyCgpECc-whrISaCwlwxXiZV_YppN4dTQT4';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
        
        // Calculate financial metrics
        function calculateFinancialMetrics(property) {
            const purchasePrice = property.price || 0;
            const monthlyRent = property.rentEstimate || 0;
            const downPayment = purchasePrice * 0.2; // Assume 20% down
            const loanAmount = purchasePrice - downPayment;
            
            // Monthly expenses
            const mortgageRate = 0.07 / 12; // 7% annual rate
            const mortgageMonths = 360; // 30 years
            const monthlyMortgage = loanAmount * (mortgageRate * Math.pow(1 + mortgageRate, mortgageMonths)) / (Math.pow(1 + mortgageRate, mortgageMonths) - 1);
            const monthlyTaxes = (purchasePrice * (property.taxRate || 0.012)) / 12;
            const monthlyInsurance = (purchasePrice * (property.insuranceRate || 0.004)) / 12;
            const monthlyHOA = property.hoaMonthly || 0;
            const monthlyMaintenance = purchasePrice * 0.001; // 0.1% monthly maintenance
            const propertyManagement = monthlyRent * 0.1; // 10% property management
            
            const totalMonthlyExpenses = monthlyMortgage + monthlyTaxes + monthlyInsurance + monthlyHOA + monthlyMaintenance + propertyManagement;
            const monthlyCashFlow = monthlyRent - totalMonthlyExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            
            // Investment metrics
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((monthlyRent * 12 - (monthlyTaxes + monthlyInsurance + monthlyHOA + monthlyMaintenance) * 12) / purchasePrice) * 100;
            const dscr = monthlyRent / monthlyMortgage;
            
            // 5-year projection
            const rentGrowthRate = 0.03; // 3% annual
            const appreciationRate = 0.04; // 4% annual
            let totalReturn = 0;
            let projectedValue = purchasePrice;
            let projectedRent = monthlyRent;
            
            for (let year = 1; year <= 5; year++) {
                projectedValue *= (1 + appreciationRate);
                projectedRent *= (1 + rentGrowthRate);
                const yearCashFlow = (projectedRent - totalMonthlyExpenses) * 12;
                totalReturn += yearCashFlow;
            }
            
            const equity5Year = projectedValue - (loanAmount * 0.85); // Approximate remaining balance
            const totalReturn5Year = totalReturn + equity5Year - downPayment;
            const roi5Year = (totalReturn5Year / downPayment) * 100;
            
            return {
                purchasePrice,
                downPayment,
                monthlyRent,
                totalMonthlyExpenses,
                monthlyCashFlow,
                annualCashFlow,
                cashOnCashReturn,
                capRate,
                dscr,
                roi5Year,
                projectedValue,
                projectedRent
            };
        }
        
        // Generate comprehensive AI insights
        async function generateAIInsights() {
            const address = document.getElementById('propertyAddressInput').value.trim();
            
            if (!address) {
                showMessage('Please enter a property address first', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            try {
                // Get location data
                const locationData = await geocodeAddress(address);
                
                // Fetch property estimates
                const propertyDetails = await fetchPropertyDetails(locationData);
                
                // Calculate financial metrics
                const metrics = calculateFinancialMetrics(propertyDetails);
                
                // Prepare comprehensive prompt for Gemini
                const prompt = `
                    You are an experienced real estate investor and financial advisor. Analyze this property and provide comprehensive investment insights.
                    
                    Property Details:
                    - Address: ${address}
                    - Location: ${locationData.city}, ${locationData.state}
                    - Estimated Price: $${propertyDetails.price.toLocaleString()}
                    - Estimated Rent: $${propertyDetails.rentEstimate.toLocaleString()}/month
                    - Property Type: ${propertyDetails.propertyType}
                    - Bedrooms: ${propertyDetails.beds}, Bathrooms: ${propertyDetails.baths}
                    - Square Feet: ${propertyDetails.sqft}
                    - Year Built: ${propertyDetails.year}
                    
                    Financial Metrics:
                    - Monthly Cash Flow: $${metrics.monthlyCashFlow.toFixed(2)}
                    - Annual Cash Flow: $${metrics.annualCashFlow.toFixed(2)}
                    - Cash-on-Cash Return: ${metrics.cashOnCashReturn.toFixed(2)}%
                    - Cap Rate: ${metrics.capRate.toFixed(2)}%
                    - Debt Service Coverage Ratio: ${metrics.dscr.toFixed(2)}
                    - 5-Year ROI Projection: ${metrics.roi5Year.toFixed(2)}%
                    
                    Provide a comprehensive analysis including:
                    1. Overall Investment Rating (Excellent/Good/Fair/Poor)
                    2. Key Strengths and Opportunities
                    3. Risk Assessment:
                       - Crime risk level for the neighborhood
                       - Natural disaster risks (flood, earthquake, hurricane)
                       - Market volatility risk
                       - Tenant risk factors
                    4. Profitability Analysis:
                       - Is the cash flow sustainable?
                       - How does it compare to the 8% cash-on-cash target?
                       - Cap rate analysis (6%+ is good)
                       - DSCR analysis (1.25+ is preferred)
                    5. 5-Year Investment Outlook:
                       - Expected appreciation
                       - Rental growth potential
                       - Exit strategy recommendations
                    6. Specific Recommendations:
                       - Should they buy, hold, or pass?
                       - Suggested improvements to increase ROI
                       - Alternative investment strategies
                    
                    Format your response with clear sections and bullet points. Be specific and data-driven.
                `;
                
                // Call Gemini API
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                const aiAnalysis = data.candidates[0].content.parts[0].text;
                
                // Display comprehensive results
                displayAIInsights(propertyDetails, metrics, aiAnalysis, locationData);
                
            } catch (error) {
                console.error('Error generating AI insights:', error);
                document.getElementById('analysisLoading').style.display = 'none';
                showMessage('Error generating AI insights. Please try again.', 'error');
            }
        }
        
        // Display AI insights in a comprehensive format
        function displayAIInsights(property, metrics, aiAnalysis, location) {
            const cashFlowClass = metrics.monthlyCashFlow >= 0 ? 'positive' : 'negative';
            const cocClass = metrics.cashOnCashReturn >= 8 ? 'positive' : metrics.cashOnCashReturn >= 5 ? 'warning' : 'negative';
            const capClass = metrics.capRate >= 6 ? 'positive' : metrics.capRate >= 4 ? 'warning' : 'negative';
            const dscrClass = metrics.dscr >= 1.25 ? 'positive' : metrics.dscr >= 1.0 ? 'warning' : 'negative';
            
            document.getElementById('analysisResults').innerHTML = `
                <div class="ai-insights-container">
                    <h2 style="color: #764ba2; margin-bottom: 20px;">
                        <i class="fas fa-brain"></i> AI Market Insights
                    </h2>
                    
                    <div class="analysis-section">
                        <h3>Property Overview</h3>
                        <div class="property-details">
                            <p><strong>Address:</strong> ${property.address || location.formatted}</p>
                            <p><strong>Type:</strong> ${property.propertyType} | <strong>Beds/Baths:</strong> ${property.beds}/${property.baths}</p>
                            <p><strong>Square Feet:</strong> ${property.sqft.toLocaleString()} | <strong>Year Built:</strong> ${property.year}</p>
                            <p><strong>List Price:</strong> $${property.price.toLocaleString()} | <strong>Rent Estimate:</strong> $${property.rentEstimate.toLocaleString()}/mo</p>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h3>Financial Metrics Dashboard</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Monthly Cash Flow</div>
                                <div class="metric-value ${cashFlowClass}">
                                    $${metrics.monthlyCashFlow.toFixed(0)}
                                </div>
                                <div class="metric-subtext">Annual: $${metrics.annualCashFlow.toFixed(0)}</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">Cash-on-Cash Return</div>
                                <div class="metric-value ${cocClass}">
                                    ${metrics.cashOnCashReturn.toFixed(1)}%
                                </div>
                                <div class="metric-subtext">Target: 8%+</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">Cap Rate</div>
                                <div class="metric-value ${capClass}">
                                    ${metrics.capRate.toFixed(1)}%
                                </div>
                                <div class="metric-subtext">Good: 6%+</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">DSCR</div>
                                <div class="metric-value ${dscrClass}">
                                    ${metrics.dscr.toFixed(2)}
                                </div>
                                <div class="metric-subtext">Preferred: 1.25+</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">5-Year ROI</div>
                                <div class="metric-value positive">
                                    ${metrics.roi5Year.toFixed(0)}%
                                </div>
                                <div class="metric-subtext">Projected Total Return</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-label">Down Payment</div>
                                <div class="metric-value">
                                    $${metrics.downPayment.toLocaleString()}
                                </div>
                                <div class="metric-subtext">20% Down</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-section ai-analysis">
                        <h3>AI Investment Analysis</h3>
                        <div class="ai-content">
                            ${formatAIResponse(aiAnalysis)}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h3>Investment Calculator</h3>
                        <table class="investment-table">
                            <tr>
                                <th>Monthly Income</th>
                                <th>Monthly Expenses</th>
                                <th>Net Cash Flow</th>
                            </tr>
                            <tr>
                                <td class="positive">$${metrics.monthlyRent.toLocaleString()}</td>
                                <td class="negative">$${metrics.totalMonthlyExpenses.toFixed(0)}</td>
                                <td class="${cashFlowClass}">$${metrics.monthlyCashFlow.toFixed(0)}</td>
                            </tr>
                        </table>
                        
                        <h4 style="margin-top: 15px;">5-Year Projection</h4>
                        <table class="investment-table">
                            <tr>
                                <th>Current Value</th>
                                <th>5-Year Value</th>
                                <th>Monthly Rent (5yr)</th>
                            </tr>
                            <tr>
                                <td>$${property.price.toLocaleString()}</td>
                                <td class="positive">$${metrics.projectedValue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                                <td class="positive">$${metrics.projectedRent.toFixed(0)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addPropertyFromAnalysis()">
                            <i class="fas fa-plus"></i> Add to Portfolio
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('propertyAddressInput').value=''; document.getElementById('analysisResults').style.display='none';">
                            <i class="fas fa-redo"></i> New Analysis
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
        }
        
        // Format AI response with proper HTML structure
        function formatAIResponse(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^(\d+\.)\s+(.*)$/gm, '<li>$2</li>')
                .replace(/^[-‚Ä¢]\s+(.*)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }
        
        // Add property from AI analysis
        function addPropertyFromAnalysis() {
            const address = document.getElementById('propertyAddressInput').value.trim();
            if (address) {
                // This will trigger the existing analyzeNewProperty function
                analyzeNewProperty();
            }
        }
        
        // Handle window clicks for closing modals
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
    
    <!-- Performance Optimization Script -->
    <script src="performance-fix.js"></script>
</body>
</html>