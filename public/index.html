<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Tracker</title>
    <!-- Cache control for development - remove in production -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Dark Theme Variables */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-hover: #2d2d2d;
            --bg-input: #1f1f1f;
            --bg-modal: #1a1a1a;
            
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            
            --border-color: #333333;
            --border-light: #404040;
            
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #06b6d4;
            
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Container Styles */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            padding: 30px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: var(--accent-primary);
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--accent-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }
        
        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-export {
            background: var(--accent-info);
            color: white;
        }
        
        .btn-export:hover {
            background: #0891b2;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Card Styles */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-light);
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Filter Section */
        .filter-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Table Styles */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
            position: relative;
        }

        /* Allow tooltips to overflow the table container */
        thead {
            position: relative;
        }
        
        table {
            width: 100%;
            min-width: 2900px;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            text-align: left;
            padding: 16px 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Zebra striping for better readability */
        tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.02);
        }

        tbody tr:nth-child(even) {
            background: var(--bg-card);
        }

        /* Solid backgrounds for sticky columns - Checkbox (odd rows) */
        tbody tr:nth-child(odd) td:nth-child(1) {
            background: #252525 !important;
            background-color: #252525 !important;
            z-index: 1002 !important;
        }

        /* Solid backgrounds for sticky columns - Checkbox (even rows) */
        tbody tr:nth-child(even) td:nth-child(1) {
            background: #242424 !important;
            background-color: #242424 !important;
            z-index: 1002 !important;
        }

        /* Solid backgrounds for sticky columns - Rank (odd rows) */
        tbody tr:nth-child(odd) td:nth-child(2) {
            background: #252525 !important;
            background-color: #252525 !important;
            z-index: 1001 !important;
        }

        /* Solid backgrounds for sticky columns - Rank (even rows) */
        tbody tr:nth-child(even) td:nth-child(2) {
            background: #242424 !important;
            background-color: #242424 !important;
            z-index: 1001 !important;
        }

        /* Solid backgrounds for sticky columns - Address (odd rows) */
        tbody tr:nth-child(odd) td:nth-child(3) {
            background: #252525 !important;
            background-color: #252525 !important;
            z-index: 999 !important;
        }

        /* Solid backgrounds for sticky columns - Address (even rows) */
        tbody tr:nth-child(even) td:nth-child(3) {
            background: #242424 !important;
            background-color: #242424 !important;
            z-index: 999 !important;
        }

        /* Add visual separation border to sticky columns - Address column */
        tbody td:nth-child(3)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        thead th:nth-child(3)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: rgba(255, 255, 255, 0.15);
            z-index: 1;
        }

        /* Column grouping with subtle backgrounds - adjusted for checkbox + rank + address columns */
        tbody td:nth-child(4),
        tbody td:nth-child(5),
        tbody td:nth-child(6),
        tbody td:nth-child(7) {
            background: rgba(59, 130, 246, 0.03); /* Property info - blue tint */
        }

        tbody td:nth-child(12),
        tbody td:nth-child(13),
        tbody td:nth-child(14),
        tbody td:nth-child(15),
        tbody td:nth-child(16),
        tbody td:nth-child(17) {
            background: rgba(239, 68, 68, 0.03); /* Expenses - red tint */
        }

        tbody td:nth-child(19),
        tbody td:nth-child(20),
        tbody td:nth-child(21),
        tbody td:nth-child(22) {
            background: rgba(34, 197, 94, 0.03); /* Returns - green tint */
        }

        /* Rank column styling (now 2nd column) */
        tbody td:nth-child(2) {
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-primary);
            text-align: center;
        }

        /* Top 3 ranks get special colors */
        tbody tr:nth-child(1) td:nth-child(2) {
            color: #fbbf24; /* Gold */
            font-size: 18px;
        }

        tbody tr:nth-child(2) td:nth-child(2) {
            color: #94a3b8; /* Silver */
            font-size: 17px;
        }

        tbody tr:nth-child(3) td:nth-child(2) {
            color: #cd7f32; /* Bronze */
            font-size: 16px;
        }

        /* Sticky checkbox column */
        thead th:first-child {
            position: sticky;
            left: 0;
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            z-index: 1003;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 50px;
            min-width: 50px;
        }

        tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 1002;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.4);
            width: 50px;
            min-width: 50px;
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
        }

        /* Sticky rank column (now 2nd column) */
        thead th:nth-child(2) {
            position: sticky;
            left: 50px;
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            z-index: 1002;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 60px;
            min-width: 60px;
        }

        tbody td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 1001;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.4);
            width: 60px;
            min-width: 60px;
        }

        /* Sticky address column (now 3rd column) */
        thead th:nth-child(3) {
            position: sticky;
            left: 110px;
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.5);
            min-width: 220px;
        }

        tbody td:nth-child(3) {
            position: sticky;
            left: 110px;
            z-index: 999;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.4);
            min-width: 220px;
            font-weight: 500;
        }

        /* Ensure non-sticky columns are below sticky ones */
        tbody td:not(:first-child):not(:nth-child(2)):not(:nth-child(3)) {
            z-index: 1;
        }

        thead th:not(:first-child):not(:nth-child(2)):not(:nth-child(3)) {
            z-index: 2;
        }
        
        /* Rental listings table styling */
        #rentalListingsContent table {
            font-size: 0.9em;
        }
        
        #rentalListingsContent tbody tr:hover {
            background: var(--bg-hover) !important;
            transition: background 0.2s ease;
        }
        
        #rentalListingsContent .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }
        
        /* Improved hover state */
        tbody tr:hover {
            background: rgba(59, 130, 246, 0.08) !important;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Maintain column group colors on hover - Checkbox column */
        tbody tr:hover td:nth-child(1) {
            background: #2a3a4a !important;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.25);
            z-index: 1002 !important;
        }

        /* Maintain column group colors on hover - Rank column */
        tbody tr:hover td:nth-child(2) {
            background: #2a3a4a !important;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.25);
            z-index: 1001 !important;
        }

        /* Maintain column group colors on hover - Address column (sticky) */
        tbody tr:hover td:nth-child(3) {
            background: linear-gradient(90deg, #2a3a4a 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            background-color: #2a3a4a !important;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.25);
            z-index: 999 !important;
        }

        /* Property info columns */
        tbody tr:hover td:nth-child(4),
        tbody tr:hover td:nth-child(5),
        tbody tr:hover td:nth-child(6),
        tbody tr:hover td:nth-child(7) {
            background: rgba(59, 130, 246, 0.1);
        }

        /* Expense columns */
        tbody tr:hover td:nth-child(12),
        tbody tr:hover td:nth-child(13),
        tbody tr:hover td:nth-child(14),
        tbody tr:hover td:nth-child(15),
        tbody tr:hover td:nth-child(16),
        tbody tr:hover td:nth-child(17) {
            background: rgba(239, 68, 68, 0.08);
        }

        /* Return columns */
        tbody tr:hover td:nth-child(19),
        tbody tr:hover td:nth-child(20),
        tbody tr:hover td:nth-child(21),
        tbody tr:hover td:nth-child(22) {
            background: rgba(34, 197, 94, 0.08);
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        /* Info icon tooltip styling */
        .info-icon {
            display: inline-block;
            margin-left: 6px;
            cursor: help;
            color: var(--accent-info);
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            vertical-align: middle;
            position: relative;
        }

        .info-icon:hover {
            opacity: 1;
            color: var(--accent-primary);
        }

        .info-icon i {
            font-size: 13px;
        }

        /* Custom tooltip */
        .info-icon[data-tooltip] {
            position: relative;
        }

        .info-icon[data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            white-space: normal;
            width: 300px;
            max-width: 90vw;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            border: 1px solid var(--accent-info);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 9999;
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
        }

        .info-icon[data-tooltip]::after {
            content: '';
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: var(--accent-info);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 9999;
        }

        .info-icon[data-tooltip]:hover::before,
        .info-icon[data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Special positioning for first column (rank) tooltip to avoid cutoff */
        thead th:first-child .info-icon[data-tooltip]::before {
            top: 50%;
            left: calc(100% + 15px);
            transform: translateY(-50%);
            width: 280px;
        }

        thead th:first-child .info-icon[data-tooltip]::after {
            top: 50%;
            left: calc(100% + 9px);
            transform: translateY(-50%) rotate(-90deg);
            border-bottom-color: var(--accent-info);
        }

        /* Ensure th with info icons have proper spacing */
        th {
            white-space: nowrap;
            position: relative;
        }
        
        
        .modal-content {
            position: relative;
            background: var(--bg-modal);
            margin: 20px auto;
            padding: 0;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            /* animation: slideIn 0.3s ease; - Removed for instant display */
            border: 1px solid var(--border-color);
            /* Force instant display - no animations or transitions */
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
        
        .modal-header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .modal-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Analysis Section Styles */
        .analysis-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .analysis-section h3 {
            color: var(--text-primary);
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .metric-value.positive {
            color: var(--accent-success);
        }
        
        .metric-value.negative {
            color: var(--accent-danger);
        }
        
        .metric-value.warning {
            color: var(--accent-warning);
        }
        
        .metric-subtext {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Investment Table */
        .investment-table {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .investment-table th {
            background: var(--bg-secondary);
            padding: 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .investment-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .investment-table td.positive {
            color: var(--accent-success);
            font-weight: 500;
        }
        
        .investment-table td.negative {
            color: var(--accent-danger);
            font-weight: 500;
        }
        
        /* Status Indicators */
        .status-available {
            color: var(--accent-success);
            font-weight: 500;
        }
        
        .status-sold {
            color: var(--accent-danger);
            font-weight: 500;
        }
        
        .status-pending {
            color: var(--accent-warning);
            font-weight: 500;
        }
        
        /* Icons */
        .icon-refresh {
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .icon-refresh:hover {
            color: var(--accent-primary);
            transform: rotate(180deg);
        }
        
        .text-warning {
            color: var(--accent-warning) !important;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Removed fadeIn animation for instant display
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        } */
        
        /* Removed slideIn animation for instant display
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        } */
        
        /* Export Button Styles */
        .export-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* AI Content Formatting */
        .ai-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            line-height: 1.8;
            color: var(--text-primary);
        }
        
        .ai-content h4 {
            color: var(--accent-primary);
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        .ai-content ul {
            margin-left: 20px;
            color: var(--text-secondary);
        }
        
        .ai-content strong {
            color: var(--text-primary);
        }
        
        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }
        
        /* Mobile Navigation Styles */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 10px;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .mobile-nav {
            display: block;
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        
        .mobile-nav.active {
            left: 0;
        }
        
        .mobile-nav-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-nav-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .mobile-nav-content {
            padding: 20px;
        }
        
        .mobile-nav-item {
            display: block;
            padding: 15px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .mobile-nav-item:hover {
            background: var(--bg-hover);
            padding-left: 30px;
        }
        
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        
        .mobile-nav-overlay.active {
            display: block;
        }
        
        /* Mobile Property Cards */
        .mobile-property-card {
            display: block;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mobile-property-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .mobile-card-address {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .mobile-card-location {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .mobile-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .mobile-card-stat {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .mobile-card-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .mobile-card-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .mobile-card-stat-value.positive {
            color: var(--accent-success);
        }
        
        .mobile-card-stat-value.negative {
            color: var(--accent-danger);
        }
        
        .mobile-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .mobile-card-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .mobile-card-btn.primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .mobile-card-btn.secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .mobile-card-btn.danger {
            background: var(--accent-danger);
            color: white;
        }
        
        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-secondary);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .mobile-bottom-nav-content {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        
        .mobile-bottom-nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .mobile-bottom-nav-item:hover {
            color: var(--accent-primary);
        }
        
        .mobile-bottom-nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .mobile-bottom-nav-item span {
            font-size: 12px;
        }
        
        /* Mobile Filter Panel */
        .mobile-filter-toggle {
            display: none;
            width: 100%;
            padding: 15px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mobile-filter-toggle:hover {
            background: #2563eb;
        }
        
        .mobile-filter-panel {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .mobile-filter-panel.active {
            display: block;
        }
        
        /* Touch-friendly form inputs */
        @media (max-width: 768px) {
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 15px;
                touch-action: manipulation;
            }
            
            .btn {
                min-height: 44px; /* iOS touch target size */
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        
        /* Responsive Design - Enhanced Mobile Styles */
        @media (max-width: 768px) {
            /* Adjust container padding for mobile */
            .container {
                padding: 10px;
                padding-bottom: 80px; /* Space for bottom nav */
            }
            
            /* Mobile header adjustments */
            .header {
                padding: 15px 0;
                position: sticky;
                top: 0;
                z-index: 999;
            }
            
            .header-content {
                padding: 0 60px; /* Space for menu button */
                text-align: center;
                position: relative;
            }
            
            .header h1 {
                font-size: 24px;
                gap: 10px;
            }
            
            .header h1 i {
                font-size: 20px;
            }
            
            /* Show mobile elements */
            .mobile-nav-toggle {
                display: block;
            }
            
            .mobile-bottom-nav {
                display: block;
            }
            
            .mobile-filter-toggle {
                display: block;
            }
            
            /* Hide desktop table and show mobile cards */
            .table-container {
                display: none;
            }
            
            .mobile-property-card {
                display: block;
            }
            
            /* Stats cards - more compact on mobile */
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            /* Filter section - hidden by default on mobile */
            .filter-section {
                display: none;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
                min-width: unset;
            }
            
            /* Modal adjustments for mobile */
            .modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }
            
            .modal-header {
                border-radius: 0;
                padding: 15px 20px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .modal-header h2 {
                font-size: 20px;
            }
            
            .modal-body {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Form adjustments */
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* Property details grid */
            .property-details {
                grid-template-columns: 1fr;
            }
            
            /* Metrics grid */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 20px;
            }
            
            /* Investment table on mobile */
            .investment-table {
                font-size: 14px;
            }
            
            .investment-table th,
            .investment-table td {
                padding: 10px 8px;
            }
            
            /* Export controls */
            .export-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-controls .btn {
                width: 100%;
            }
            
            /* AI content formatting */
            .ai-content {
                padding: 15px;
                font-size: 14px;
            }
            
            /* Loading spinner */
            .loading {
                width: 30px;
                height: 30px;
            }
            
            /* Hide desktop-only elements */
            .header-content > div:last-child {
                display: none; /* Hide desktop add button */
            }
        }
        
        /* Small phones */
        @media (max-width: 380px) {
            .header h1 {
                font-size: 20px;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .mobile-card-stats {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Swipe gestures support */
        .swipe-hint {
            display: none;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .swipe-hint {
                display: block;
            }
        }
        
        /* Touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .btn:active,
            .mobile-card-btn:active,
            .mobile-nav-item:active,
            .mobile-bottom-nav-item:active {
                transform: scale(0.95);
                opacity: 0.8;
            }
            
            .mobile-property-card:active {
                transform: scale(0.98);
            }
        }
        
        /* Editable fields */
        .editable-field {
            transition: all 0.2s ease;
            border-radius: 4px;
            display: inline-block;
        }
        
        .editable-field:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        /* Inline edit input */
        .inline-edit-input {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: inherit;
            font-weight: inherit;
            width: 120px;
            text-align: right;
        }
        
        /* Animations - Removed for instant display
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        } */
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Notification animations - Removed for instant display
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        } */
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Modal Styles - Fixed for immediate response */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            /* No animations for immediate response */
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Ensure modal shows immediately when display:block */
        .modal[style*="display: block"] {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-content {
            background-color: var(--bg-modal);
            margin: 50px auto;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            /* animation: slideIn 0.3s ease; - Removed for instant display */
            /* Force instant display - no animations or transitions */
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }

        /* Global override to ensure ALL modals display instantly */
        .modal,
        .modal *,
        .modal-content,
        .modal-content * {
            animation: none !important;
            transition: none !important;
        }

        /* When modal is shown, ensure immediate visibility */
        .modal[style*="display: block"],
        .modal[style*="display: flex"] {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .modal[style*="display: block"] .modal-content,
        .modal[style*="display: flex"] .modal-content {
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
        
        .modal-header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(80vh - 120px);
            overflow-y: auto;
        }
        
        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover,
        .close:focus {
            color: var(--text-primary);
        }
        
        /* Form styles within modals */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Analysis section within modals */
        .analysis-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .analysis-section h3 {
            margin: 0 0 16px 0;
            color: var(--accent-primary);
            font-size: 20px;
        }
        
        /* Property details grid */
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .detail-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* FINAL OVERRIDE: Absolutely ensure NO animations on modals */
        .modal,
        .modal *,
        .modal-content,
        .modal-content *,
        .modal[style*="display: block"],
        .modal[style*="display: block"] *,
        .modal[style*="display: block"] .modal-content,
        .modal[style*="display: block"] .modal-content * {
            animation: none !important;
            transition: none !important;
            animation-duration: 0s !important;
            transition-duration: 0s !important;
            animation-delay: 0s !important;
            transition-delay: 0s !important;
        }

        /* Ensure immediate visibility for displayed modals */
        .modal[style*="display: block"] {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .modal[style*="display: block"] .modal-content {
            opacity: 1 !important;
            transform: none !important;
            visibility: visible !important;
        }
    </style>
    <!-- XLSX library for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Mammoth.js library for Word document parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-header">
            <h3 style="color: var(--text-primary); margin: 0;">Menu</h3>
            <button class="mobile-nav-close" onclick="closeMobileNav()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-nav-content">
            <a href="#" class="mobile-nav-item" onclick="openAddPropertyModal(); closeMobileNav();">
                <i class="fas fa-plus-circle"></i> Add Property
            </a>
            <a href="#" class="mobile-nav-item" onclick="showAnalyzeModal(); closeMobileNav();">
                <i class="fas fa-search"></i> Analyze Property
            </a>
            <a href="#" class="mobile-nav-item" onclick="exportData(); closeMobileNav();">
                <i class="fas fa-download"></i> Export Data
            </a>
            <a href="#" class="mobile-nav-item" onclick="showMarketInsights(); closeMobileNav();">
                <i class="fas fa-brain"></i> Market Insights
            </a>
            <a href="#" class="mobile-nav-item" onclick="load17SampleProperties(); closeMobileNav();">
                <i class="fas fa-database"></i> Load Sample Data
            </a>
            <a href="#" class="mobile-nav-item" onclick="clearAllProperties(); closeMobileNav();">
                <i class="fas fa-trash"></i> Clear All Properties
            </a>
        </div>
    </div>
    
    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="closeMobileNav()"></div>
    
    <div class="header">
        <div class="header-content">
            <!-- Mobile Menu Button -->
            <button class="mobile-nav-toggle" onclick="openMobileNav()">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-chart-line"></i> Real Estate Investment Tracker</h1>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button id="compareBtn" class="btn" style="display: none; background: var(--accent-info); color: white;">
                    <i class="fas fa-balance-scale"></i> Compare <span id="compareCount">0</span> Properties
                </button>
                <button class="btn btn-primary" onclick="openAddPropertyModal()">
                    <i class="fas fa-plus"></i> Add Property
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-value" id="totalProperties">0</div>
                <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">$0</div>
                <div class="stat-label">Portfolio Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEquity">$0</div>
                <div class="stat-label">Total Equity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyCashFlow">$0</div>
                <div class="stat-label">Monthly Cash Flow</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCashOnCash">0%</div>
                <div class="stat-label">Avg Cash-on-Cash</div>
            </div>
        </div>

        <!-- Mobile Filter Toggle -->
        <button class="mobile-filter-toggle" onclick="toggleMobileFilters()">
            <i class="fas fa-filter"></i> Filters & Search
        </button>
        
        <!-- Mobile Filter Panel (wraps existing filter section) -->
        <div class="mobile-filter-panel" id="mobileFilterPanel">
            <!-- Filters -->
            <div class="filter-section" style="display: block !important; margin-bottom: 0;">
            <div class="filter-row">
                <div class="filter-group">
                    <label>City</label>
                    <select id="filterCity" onchange="filterProperties()">
                        <option value="">All Cities</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="filterProperties()">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="sold">Sold</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Cash Flow</label>
                    <input type="number" id="filterMinCashFlow" placeholder="Min cash flow" onchange="filterProperties()">
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search properties..." oninput="filterProperties()">
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-times"></i> Reset
                </button>
            </div>
        </div>
        </div> <!-- End mobile-filter-panel -->

        <!-- Mobile Property Cards Container -->
        <div id="mobilePropertyCards" style="display: none;">
            <!-- Mobile cards will be inserted here -->
        </div>

        <!-- Properties Table -->
        <div class="table-container">
            <table id="propertyTable">
                <thead>
                    <tr>
                        <th style="text-align: center; width: 50px; min-width: 50px;">
                            <input type="checkbox" id="selectAllProperties" style="cursor: pointer;">
                        </th>
                        <th style="text-align: center;">
                            #
                            <span class="info-icon" data-tooltip="Ranking by Monthly Cash Flow (highest to lowest). Top 3 get special colors: 🥇 Gold, 🥈 Silver, 🥉 Bronze.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>Address</th>
                        <th>City</th>
                        <th>Type</th>
                        <th>Bed/Bath</th>
                        <th>Sqft</th>
                        <th>
                            Purchase Price
                            <span class="info-icon" data-tooltip="The actual or estimated price paid to acquire the property. This is the basis for calculating returns and equity.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Est. Value
                            <span class="info-icon" data-tooltip="Current estimated market value from RentCast API based on comparable properties and market trends.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Monthly Rent
                            <span class="info-icon" data-tooltip="Actual monthly rental income collected (or expected) from the property. Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Rent Est.
                            <span class="info-icon" data-tooltip="Estimated monthly rent from RentCast API based on similar properties in the area.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Mortgage
                            <span class="info-icon" data-tooltip="Monthly mortgage payment (P&I). Based on loan amount, 6.5% interest, 30-year term. Auto-calculated but editable.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Property Tax
                            <span class="info-icon" data-tooltip="Monthly property tax. Default: 1.2% of purchase price annually. Varies by location. Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Insurance
                            <span class="info-icon" data-tooltip="Monthly property insurance. Default: 0.4% of purchase price annually. Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            HOA
                            <span class="info-icon" data-tooltip="Monthly HOA or condo fees. Enter actual amount or $0 if none. Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Maintenance
                            <span class="info-icon" data-tooltip="Monthly maintenance reserve. Default: 1% of purchase price annually (the '1% rule'). Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Management Fee
                            <span class="info-icon" data-tooltip="Monthly property management fee. Default: 8% of monthly rent (industry standard 8-10%). Click to edit.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Vacancy Rate
                            <span class="info-icon" data-tooltip="Expected vacancy percentage. Default: 7% (base), Stress: 9-10%, Low-risk: 5-6%. Reduces effective rental income.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Cash Flow
                            <span class="info-icon" data-tooltip="Monthly profit after all expenses. Formula: (Monthly Rent × (1 - Vacancy Rate)) - Mortgage - Property Tax - Insurance - HOA - Maintenance - Management Fee.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Annual CF
                            <span class="info-icon" data-tooltip="Total yearly cash flow. Formula: Monthly Cash Flow × 12. Positive means profit, negative means loss.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Cash-on-Cash
                            <span class="info-icon" data-tooltip="Annual return on your down payment investment. Formula: (Annual Cash Flow ÷ Down Payment) × 100. Good: >8%, Great: >12%.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Cap Rate
                            <span class="info-icon" data-tooltip="Return on investment if paid all cash. Formula: (Net Operating Income ÷ Purchase Price) × 100. Excludes mortgage. Good: >6%, Great: >10%.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            Down Payment
                            <span class="info-icon" data-tooltip="Upfront cash investment to purchase the property. Defaults to 20% of purchase price. Click to edit custom amount.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>
                            DSCR
                            <span class="info-icon" data-tooltip="Debt Service Coverage Ratio - Measures ability to cover mortgage. Formula: Net Operating Income ÷ Annual Debt Service. Minimum: 1.0, Good: >1.25.">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- Properties will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Property Details Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-home"></i> Property Details</h2>
                <span class="close" onclick="closeModal('propertyModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Property details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Add New Property</h2>
                <span class="close" onclick="closeModal('addPropertyModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPropertyForm">
                    <!-- New full address field -->
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label for="fullAddress" style="font-weight: 600; color: var(--accent-primary);">Quick Add: Paste Full Address</label>
                        <input type="text" id="fullAddress" 
                               placeholder="e.g. 1613 Capistrano Ave Las Vegas, NV 89169" 
                               style="background: var(--bg-primary); border: 2px solid var(--border-light);" 
                               oninput="parseAndFillAddress()">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Paste or type a complete address to auto-fill the fields below
                        </small>
                    </div>
                    
                    <!-- Bulk Import Section -->
                    <div class="form-group" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight: 600; color: var(--accent-primary);">Bulk Import: Upload Excel/CSV/Word File</label>
                        <input type="file" id="bulkImportFile" accept=".csv,.xlsx,.xls,.docx,.doc" 
                               style="display: none;" onchange="handleFileUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulkImportFile').click()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-file-upload"></i> Choose Excel/CSV/Word File
                        </button>
                        <small style="color: var(--text-muted); display: block; margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Upload a file with property addresses. Supported formats: CSV, Excel (.xlsx, .xls), Word (.docx)
                        </small>
                        <div id="fileUploadStatus" style="margin-top: 10px; display: none;">
                            <div class="loading"></div>
                            <p style="color: var(--text-secondary);">Processing file...</p>
                        </div>
                        <div id="importPreview" style="margin-top: 15px; display: none;">
                            <h4 style="color: var(--accent-primary); margin-bottom: 10px;">Properties to Import:</h4>
                            <div id="importPreviewList" style="max-height: 200px; overflow-y: auto; background: var(--bg-primary); padding: 10px; border-radius: 4px;"></div>
                            <button type="button" class="btn btn-primary" onclick="confirmBulkImport()" style="margin-top: 10px;">
                                <i class="fas fa-check"></i> Import All Properties
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelBulkImport()" style="margin-top: 10px; margin-left: 10px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <span style="color: var(--text-muted);">— OR —</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Street Address *</label>
                        <input type="text" id="address" name="address" required placeholder="123 Main St">
                    </div>
                    
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required placeholder="Las Vegas">
                    </div>
                    
                    <div class="form-group">
                        <label for="state">State *</label>
                        <input type="text" id="state" name="state" required placeholder="NV" maxlength="2" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="zip">ZIP Code *</label>
                        <input type="text" id="zip" name="zip" required placeholder="89101">
                    
                    <div class="form-group">
                        <label for="propertyType">Property Type</label>
                        <select id="propertyType" name="propertyType">
                            <option value="single-family">Single Family</option>
                            <option value="condo">Condo</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchasePrice">Purchase Price</label>
                        <input type="number" id="purchasePrice" name="purchasePrice" placeholder="500000">
                        <small style="color: var(--text-muted);">Optional - Leave blank to fetch from RentCast</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="monthlyRent">Monthly Rent</label>
                        <input type="number" id="monthlyRent" name="monthlyRent" placeholder="2500">
                        <small style="color: var(--text-muted);">Optional - Leave blank to fetch from RentCast</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="beds">Bedrooms</label>
                        <input type="number" id="beds" name="beds" placeholder="3">
                    </div>
                    
                    <div class="form-group">
                        <label for="baths">Bathrooms</label>
                        <input type="number" id="baths" name="baths" step="0.5" placeholder="2">
                    </div>
                    
                    <div class="form-group">
                        <label for="sqft">Square Feet</label>
                        <input type="number" id="sqft" name="sqft" placeholder="1500">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Property
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Analyze Property Modal -->
    <div id="analyzeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-search"></i> Analyze Property</h2>
                <span class="close" onclick="closeModal('analyzeModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="propertyAddressInput">Enter Property Address</label>
                    <input type="text" id="propertyAddressInput" placeholder="e.g., 123 Main St, Las Vegas, NV 89101" 
                           onkeypress="if(event.key === 'Enter') analyzeNewProperty()">
                </div>
                
                <button class="btn btn-primary" onclick="analyzeNewProperty()">
                    <i class="fas fa-search"></i> Analyze
                </button>
                
                <div id="analysisLoading" style="display: none; text-align: center; margin-top: 20px;">
                    <div class="loading"></div>
                    <p>Analyzing property...</p>
                </div>

                <div id="analysisResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Property Comparison Modal -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content" style="max-width: 95%; width: 1400px;">
            <div class="modal-header">
                <h2><i class="fas fa-balance-scale"></i> Property Comparison & AI Analysis</h2>
                <span class="close" onclick="closeModal('comparisonModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- AI Analysis Section -->
                <div id="aiAnalysisSection" style="background: var(--bg-secondary); border: 2px solid #3b82f6; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; color: #3b82f6; font-size: 20px; font-weight: 600;">
                        <i class="fas fa-robot"></i> AI Investment Analysis
                    </h3>
                    <div id="aiAnalysisContent">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; color: #3b82f6;"></i>
                            <p style="color: var(--text-primary);">Analyzing properties and generating investment recommendations...</p>
                        </div>
                    </div>
                </div>

                <!-- Comparison Table -->
                <div style="overflow-x: auto;">
                    <table id="comparisonTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 12px; text-align: left; border: 1px solid var(--border-color);">Metric</th>
                                <!-- Property columns will be added here -->
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                            <!-- Comparison rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Market Insights Modal -->
    <div id="marketInsightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-brain"></i> AI Market Insights</h2>
                <span class="close" onclick="closeModal('marketInsightsModal')">&times;</span>
            </div>
            <div class="modal-body" id="marketInsightsBody">
                <div id="marketInsightsLoading" style="text-align: center;">
                    <div class="loading"></div>
                    <p>Generating market insights...</p>
                </div>
                <div id="marketInsightsContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let properties = [];
        let selectedPropertyIndex = null;
        let samplePropertiesLoaded = false;
        let selectedProperties = []; // Track selected properties for comparison

        // Property selection handlers
        window.handlePropertySelection = function() {
            const checkboxes = document.querySelectorAll('.property-select-checkbox:checked');
            selectedProperties = Array.from(checkboxes).map(cb => parseInt(cb.dataset.propertyIndex));

            const compareBtn = document.getElementById('compareBtn');
            const compareCount = document.getElementById('compareCount');

            if (selectedProperties.length > 0 && selectedProperties.length <= 5) {
                compareBtn.style.display = 'block';
                compareCount.textContent = selectedProperties.length;
            } else if (selectedProperties.length > 5) {
                // Uncheck the last selected checkbox
                checkboxes[checkboxes.length - 1].checked = false;
                selectedProperties.pop();
                showNotification('Maximum 5 properties can be compared', 'warning');
            } else {
                compareBtn.style.display = 'none';
            }

            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllProperties');
            const totalCheckboxes = document.querySelectorAll('.property-select-checkbox').length;
            selectAllCheckbox.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
        }

        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAllProperties');
            const checkboxes = document.querySelectorAll('.property-select-checkbox');

            if (selectAllCheckbox.checked) {
                // Select only first 5
                checkboxes.forEach((cb, index) => {
                    cb.checked = index < 5;
                });
                if (checkboxes.length > 5) {
                    showNotification('Only first 5 properties selected (maximum limit)', 'info');
                }
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }

            handlePropertySelection();
        }

        // Open comparison modal
        window.openComparisonModal = function() {
            console.log('🔵 openComparisonModal called');
            console.log('selectedProperties:', selectedProperties);
            console.log('properties array length:', properties.length);

            if (!selectedProperties || selectedProperties.length < 2) {
                showNotification('Please select at least 2 properties to compare', 'warning');
                return;
            }

            // Get selected property objects
            const selectedProps = selectedProperties.map(index => {
                console.log('Getting property at index:', index, 'Property:', properties[index]);
                return properties[index];
            });
            console.log('Selected properties for comparison:', selectedProps);

            // Get modal first
            const modal = document.getElementById('comparisonModal');
            if (!modal) {
                console.error('❌ Comparison modal not found!');
                showNotification('Error: Comparison modal not found', 'error');
                return;
            }

            // Reset AI analysis loading state
            const aiContent = document.getElementById('aiAnalysisContent');
            if (aiContent) {
                aiContent.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; color: #3b82f6;"></i>
                        <p style="color: var(--text-primary);">Analyzing properties and generating investment recommendations...</p>
                    </div>
                `;
            }

            // Open modal IMMEDIATELY (synchronous) - set all visibility properties
            console.log('Opening modal NOW...');

            // Find modal content
            const modalContent = modal.querySelector('.modal-content');

            // Remove ALL animations and transitions before showing
            modal.style.animation = 'none';
            modal.style.transition = 'none';
            modal.style.display = 'block';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';

            if (modalContent) {
                modalContent.style.animation = 'none';
                modalContent.style.transition = 'none';
                modalContent.style.opacity = '1';
                modalContent.style.transform = 'none';
                modalContent.style.visibility = 'visible';
            }

            document.body.style.overflow = 'hidden';
            console.log('✅ Modal opened - display:', modal.style.display, 'opacity:', modal.style.opacity, 'visibility:', modal.style.visibility);

            // Build comparison table synchronously
            console.log('Building comparison table...');
            try {
                window.buildComparisonTable(selectedProps);
            } catch (error) {
                console.error('❌ Error building comparison table:', error);
            }

            // Scroll modal to top
            modal.scrollTop = 0;

            // Start AI analysis asynchronously (don't block)
            console.log('Starting AI analysis in background...');
            setTimeout(() => {
                window.performAIAnalysis(selectedProps).catch(error => {
                    console.error('❌ AI analysis error:', error);
                });
            }, 100);
        }

        // Build comparison table
        window.buildComparisonTable = function(props) {
            try {
                console.log('🔵 buildComparisonTable called with', props.length, 'properties');

                const table = document.getElementById('comparisonTable');
                if (!table) {
                    console.error('❌ Comparison table not found!');
                    return;
                }

                const thead = table.querySelector('thead tr');
                const tbody = document.getElementById('comparisonTableBody');

                if (!thead || !tbody) {
                    console.error('❌ Table head or body not found!');
                    return;
                }

                // Clear previous content
                thead.innerHTML = '<th style="padding: 12px; text-align: left; border: 1px solid var(--border-color); position: sticky; left: 0; background: var(--bg-secondary); z-index: 1;">Metric</th>';
                tbody.innerHTML = '';
                console.log('✅ Table cleared');

                // Add property column headers
                props.forEach((prop, index) => {
                    console.log(`Adding header for property ${index + 1}:`, prop.address, prop);
                    const th = document.createElement('th');
                    th.style.cssText = 'padding: 12px; border: 1px solid var(--border-color); min-width: 200px;';
                    th.innerHTML = `
                        <div style="font-weight: 600;">${prop.address || 'Unknown'}</div>
                        <div style="font-size: 12px; color: var(--text-muted); font-weight: normal;">${prop.city || ''}, ${prop.state || ''}</div>
                    `;
                    thead.appendChild(th);
                });

            // Define metrics to compare
            const metrics = [
                { label: 'Purchase Price', key: 'purchasePrice', format: 'currency' },
                { label: 'Estimated Value', key: 'estimatedValue', format: 'currency' },
                { label: 'Monthly Rent', key: 'monthlyRent', format: 'currency' },
                { label: 'Cash Flow', key: 'monthlyCashFlow', format: 'currency', highlight: true },
                { label: 'Annual Cash Flow', key: 'annualCashFlow', format: 'currency' },
                { label: 'Cash-on-Cash Return', key: 'cashOnCashReturn', format: 'percentage' },
                { label: 'Cap Rate', key: 'capRate', format: 'percentage' },
                { label: 'Down Payment', key: 'downPayment', format: 'currency' },
                { label: 'Mortgage', key: 'mortgage', format: 'currency' },
                { label: 'Property Tax', key: 'propertyTax', format: 'currency' },
                { label: 'Insurance', key: 'insurance', format: 'currency' },
                { label: 'HOA', key: 'hoa', format: 'currency' },
                { label: 'Maintenance', key: 'maintenance', format: 'currency' },
                { label: 'Management Fee', key: 'managementFees', format: 'currency' },
                { label: 'Vacancy Rate', key: 'vacancyRate', format: 'percentage' },
                { label: 'Beds/Baths', key: 'beds', format: 'bedsBaths' },
                { label: 'Square Feet', key: 'sqft', format: 'number' },
                { label: 'Property Type', key: 'propertyType', format: 'text' }
            ];

            // Create rows for each metric
            metrics.forEach(metric => {
                const tr = document.createElement('tr');
                tr.style.cssText = metric.highlight ? 'background: rgba(59, 130, 246, 0.1);' : '';

                // Metric label
                const labelTd = document.createElement('td');
                labelTd.style.cssText = 'padding: 12px; border: 1px solid var(--border-color); font-weight: 500; position: sticky; left: 0; background: var(--bg-card); z-index: 1;';
                labelTd.textContent = metric.label;
                tr.appendChild(labelTd);

                // Property values
                props.forEach((prop, propIndex) => {
                    const td = document.createElement('td');
                    td.style.cssText = 'padding: 12px; border: 1px solid var(--border-color); text-align: right;';

                    let value = prop[metric.key];
                    let displayValue = '';

                    // Debug logging for missing values
                    if (value === undefined || value === null) {
                        console.log(`⚠️ Missing ${metric.key} for property ${propIndex + 1} (${prop.address})`);
                    }

                    if (metric.format === 'currency') {
                        displayValue = formatCurrency(Number(value) || 0);
                    } else if (metric.format === 'percentage') {
                        displayValue = (Number(value) || 0).toFixed(1) + '%';
                    } else if (metric.format === 'number') {
                        displayValue = (Number(value) || 0).toLocaleString();
                    } else if (metric.format === 'bedsBaths') {
                        displayValue = `${prop.beds || 0}/${prop.baths || 0}`;
                    } else {
                        displayValue = value || 'N/A';
                    }

                    td.textContent = displayValue;

                    // Highlight best values
                    if (metric.highlight && metric.format === 'currency') {
                        const values = props.map(p => Number(p[metric.key]) || 0);
                        const maxValue = Math.max(...values);
                        if (Number(value) === maxValue && maxValue > 0) {
                            td.style.cssText += ' background: rgba(34, 197, 94, 0.2); font-weight: 600; color: #10b981;';
                        }
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            console.log('✅ Comparison table built successfully');
            } catch (error) {
                console.error('❌ Error in buildComparisonTable:', error);
                throw error;
            }
        }

        // Perform AI analysis
        window.performAIAnalysis = async function(props) {
            const aiContent = document.getElementById('aiAnalysisContent');

            try {
                console.log('🤖 Starting AI analysis for properties:', props);

                // Prepare property data for AI
                const propertyData = props.map((prop, index) => {
                    console.log(`Property ${index + 1} data:`, prop);
                    return {
                        id: index + 1,
                        address: prop.address,
                        city: prop.city,
                        state: prop.state,
                        purchasePrice: Number(prop.purchasePrice) || 0,
                        estimatedValue: Number(prop.estimatedValue) || 0,
                        monthlyRent: Number(prop.monthlyRent) || 0,
                        monthlyCashFlow: Number(prop.monthlyCashFlow) || 0,
                        annualCashFlow: Number(prop.annualCashFlow) || 0,
                        cashOnCashReturn: Number(prop.cashOnCashReturn) || 0,
                        capRate: Number(prop.capRate) || 0,
                        downPayment: Number(prop.downPayment) || 0,
                        mortgage: Number(prop.mortgage) || 0,
                        propertyTax: Number(prop.propertyTax) || 0,
                        insurance: Number(prop.insurance) || 0,
                        hoa: Number(prop.hoa) || 0,
                        maintenance: Number(prop.maintenance) || 0,
                        managementFees: Number(prop.managementFees) || 0,
                        vacancyRate: Number(prop.vacancyRate) || 7,
                        beds: prop.beds,
                        baths: prop.baths,
                        sqft: prop.sqft,
                        propertyType: prop.propertyType
                    };
                });

                console.log('📤 Sending AI analysis request with data:', propertyData);

                // Create abort controller for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                // Call AI analysis API
                const response = await fetch('/api/ai/compare-properties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ properties: propertyData }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('📥 AI analysis response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ AI analysis failed:', response.status, errorText);
                    throw new Error(`AI analysis failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('✅ AI analysis data received:', data);

                // Display AI analysis with professional styling
                aiContent.innerHTML = `
                    <div style="line-height: 1.8; color: var(--text-primary);">
                        <!-- Recommended Property Card -->
                        <div style="background: var(--bg-card); border-left: 4px solid #10b981; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; color: #10b981; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-trophy"></i> Recommended Property
                            </h4>
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">
                                ${data.recommendedProperty}
                            </div>
                        </div>

                        <!-- Investment Analysis Card -->
                        <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; color: #3b82f6; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> Investment Analysis
                            </h4>
                            <div style="white-space: pre-wrap; color: var(--text-primary); line-height: 1.6;">${data.analysis}</div>
                        </div>

                        <!-- Profit Projection Card -->
                        <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; color: #10b981; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-chart-line"></i> 5-Year Profit Projection
                            </h4>
                            <div style="color: var(--text-primary); line-height: 1.6;">${data.profitProjection}</div>
                        </div>

                        <!-- Risk Assessment Card -->
                        <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; color: #f59e0b; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-exclamation-triangle"></i> Risk Assessment
                            </h4>
                            <div style="color: var(--text-primary); line-height: 1.6;">${data.riskAssessment}</div>
                        </div>

                        <!-- Realtor's Advice Card -->
                        <div style="background: var(--bg-card); border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; color: #3b82f6; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-user-tie"></i> Professional Realtor's Advice
                            </h4>
                            <div style="color: var(--text-primary); line-height: 1.6;">${data.realtorAdvice}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('❌ AI analysis error:', error);
                const errorMessage = error.name === 'AbortError'
                    ? 'Request timed out after 30 seconds'
                    : error.message || 'Unknown error';
                aiContent.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 12px; color: #f59e0b;"></i>
                        <p style="color: var(--text-primary);">AI analysis is currently unavailable.</p>
                        <p style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">
                            Error: ${errorMessage}
                        </p>
                        <p style="font-size: 14px; color: var(--text-muted); margin-top: 8px;">
                            The comparison table below shows all property metrics for manual evaluation.
                        </p>
                    </div>
                `;
            }
        }

        // Edit field inline
        function editField(index, field, currentValue, isInModal = false) {
            console.log('Editing field:', field, 'for property at index:', index, 'Current value:', currentValue);
            
            // Stop the event from bubbling up to the row click handler
            if (event) {
                event.stopPropagation();
            }
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'inline-edit-input';
            input.value = currentValue;
            input.min = '0';

            // Set appropriate step based on field type
            if (field === 'vacancyRate') {
                input.step = '0.1';
                input.max = '100';
            } else if (field === 'monthlyRent') {
                input.step = '50';
            } else if (field === 'downPayment' || field === 'purchasePrice') {
                input.step = '1000';
            } else if (['propertyTax', 'insurance', 'hoa', 'maintenance', 'managementFees', 'mortgage'].includes(field)) {
                input.step = '10';
            } else {
                input.step = '100';
            }
            
            // Get the element that was clicked
            const clickedElement = event.target;
            const originalHTML = clickedElement.innerHTML;
            
            // Replace the content with input
            clickedElement.innerHTML = '';
            clickedElement.appendChild(input);
            input.focus();
            input.select();
            
            // Save function
            const saveValue = () => {
                const newValue = parseFloat(input.value) || 0;
                
                if (newValue !== currentValue && newValue >= 0) {
                    // Find property by ID if in modal, otherwise by index
                    let propertyToUpdate;
                    let propertyIndex;
                    
                    // Always use index to find property
                    propertyIndex = index;
                    propertyToUpdate = properties[index];
                    
                    if (propertyToUpdate) {
                        // Update the property
                        propertyToUpdate[field] = newValue;
                        
                        // Recalculate metrics
                        calculatePropertyMetrics(propertyToUpdate);
                        
                        // Save to database and localStorage
                        saveProperties();
                        
                        // Update the display
                        updateDisplay();
                        
                        // If modal is open, refresh it
                        if (isInModal) {
                            showPropertyDetails(propertyIndex);
                        }
                        
                        // Show success notification
                        const fieldName = field === 'purchasePrice' ? 'Purchase Price' :
                                         field === 'monthlyRent' ? 'Monthly Rent' :
                                         field === 'downPayment' ? 'Down Payment' :
                                         field === 'propertyTax' ? 'Property Tax' :
                                         field === 'insurance' ? 'Insurance' :
                                         field === 'hoa' ? 'HOA' :
                                         field === 'maintenance' ? 'Maintenance' :
                                         field === 'managementFees' ? 'Management Fee' :
                                         field === 'mortgage' ? 'Mortgage' :
                                         field === 'vacancyRate' ? 'Vacancy Rate' : field;

                        const displayValue = field === 'vacancyRate' ? `${newValue.toFixed(1)}%` : formatCurrency(newValue);
                        showNotification(`${fieldName} updated to ${displayValue}`, 'success');
                    }
                } else {
                    // Restore original value if invalid or unchanged
                    clickedElement.innerHTML = originalHTML;
                }
            };
            
            // Handle blur and enter key
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveValue();
                }
                if (e.key === 'Escape') {
                    clickedElement.innerHTML = originalHTML;
                }
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--accent-success)' : 'var(--accent-info)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Mobile Navigation Functions
        function openMobileNav() {
            document.getElementById('mobileNav').classList.add('active');
            document.getElementById('mobileNavOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
        
        function closeMobileNav() {
            document.getElementById('mobileNav').classList.remove('active');
            document.getElementById('mobileNavOverlay').classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // Toggle mobile filters
        function toggleMobileFilters() {
            const panel = document.getElementById('mobileFilterPanel');
            const toggle = document.querySelector('.mobile-filter-toggle');
            
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                toggle.innerHTML = '<i class="fas fa-filter"></i> Filters & Search';
            } else {
                panel.classList.add('active');
                toggle.innerHTML = '<i class="fas fa-times"></i> Hide Filters';
            }
        }
        
        // Scroll to top function for mobile
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Show analyze modal (wrapper for consistency)
        function showAnalyzeModal() {
            openAnalyzeModal();
        }
        
        // Clear all properties with confirmation
        function clearAllProperties() {
            if (confirm('Are you sure you want to clear all properties? This action cannot be undone.')) {
                properties = [];
                localStorage.removeItem('properties');
                updateDisplay();
                showNotification('All properties have been cleared', 'success');
            }
        }
        
        // Create mobile property card HTML
        function createMobilePropertyCard(property, index) {
            const cardHtml = `
                <div class="mobile-property-card" onclick="showPropertyDetails(${index})">
                    <div class="mobile-card-header">
                        <div>
                            <div class="mobile-card-address">${property.address}</div>
                            <div class="mobile-card-location">${property.city}, ${property.state} ${property.zip}</div>
                        </div>
                        ${property.realTimeData ? '<span style="color: var(--accent-success);"><i class="fas fa-check-circle"></i></span>' : ''}
                    </div>
                    
                    <div class="mobile-card-stats">
                        <div class="mobile-card-stat">
                            <div class="mobile-card-stat-label">Purchase Price</div>
                            <div class="mobile-card-stat-value">${formatCurrency(property.purchasePrice || 0)}</div>
                        </div>
                        <div class="mobile-card-stat">
                            <div class="mobile-card-stat-label">Monthly Rent</div>
                            <div class="mobile-card-stat-value">${formatCurrency(property.monthlyRent || 0)}</div>
                        </div>
                        <div class="mobile-card-stat">
                            <div class="mobile-card-stat-label">Cash Flow</div>
                            <div class="mobile-card-stat-value ${property.cashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(property.cashFlow || 0)}</div>
                        </div>
                        <div class="mobile-card-stat">
                            <div class="mobile-card-stat-label">Cash-on-Cash</div>
                            <div class="mobile-card-stat-value ${property.cocReturn >= 8 ? 'positive' : 'warning'}">${property.cocReturn ? property.cocReturn.toFixed(1) + '%' : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="mobile-card-actions">
                        <button class="mobile-card-btn primary" onclick="event.stopPropagation(); showPropertyDetails(${index})">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        <button class="mobile-card-btn secondary" onclick="event.stopPropagation(); refreshProperty(${index})">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="mobile-card-btn danger" onclick="event.stopPropagation(); deleteProperty(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            return cardHtml;
        }
        
        // Update mobile property cards display
        function updateMobilePropertyCards() {
            const container = document.getElementById('mobilePropertyCards');
            if (!container) return;
            
            // Check if we're on mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                container.style.display = 'block';
                
                // Use the same filter function as the table for consistency
                const filteredProperties = getFilteredProperties();
                
                if (properties.length === 0) {
                    // No properties at all
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <i class="fas fa-home" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>No Properties Yet</h3>
                            <p style="margin-bottom: 20px;">Start building your real estate portfolio!</p>
                            <button class="btn btn-primary" onclick="openAddPropertyModal()" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Add Your First Property
                            </button>
                        </div>
                    `;
                } else if (filteredProperties.length === 0) {
                    // Properties exist but filtered out
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <i class="fas fa-filter" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>No Properties Match Filters</h3>
                            <p>Try adjusting your search criteria</p>
                            <button class="btn btn-secondary" onclick="resetFilters()" style="margin-top: 20px;">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    `;
                } else {
                    // Show property cards
                    container.innerHTML = filteredProperties.map((property, index) => 
                        createMobilePropertyCard(property, properties.indexOf(property))
                    ).join('');
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Helper function to get filtered properties (reuse existing filter logic)
        function filterPropertiesData() {
            const cityFilter = document.getElementById('filterCity').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const minCashFlow = document.getElementById('filterMinCashFlow').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            return properties.filter(property => {
                if (cityFilter && property.city !== cityFilter) return false;
                if (statusFilter && property.status !== statusFilter) return false;
                if (minCashFlow && property.cashFlow < parseFloat(minCashFlow)) return false;
                if (searchTerm) {
                    const searchStr = `${property.address} ${property.city} ${property.state} ${property.zip}`.toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                return true;
            });
        }
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateMobilePropertyCards();
            }, 250);
        });
        
        // Add swipe gesture support for mobile cards
        let touchStartX = 0;
        let touchEndX = 0;
        
        function handleSwipe(element, leftAction, rightAction) {
            element.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });
            
            element.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipeGesture();
            });
            
            function handleSwipeGesture() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0 && leftAction) {
                        // Swipe left
                        leftAction();
                    } else if (diff < 0 && rightAction) {
                        // Swipe right
                        rightAction();
                    }
                }
            }
        }

        // Check and sync properties between localStorage and server
        async function checkAndSyncProperties() {
            console.log('🔄 Checking property sync...');
            
            try {
                // Get server status
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                
                if (status.databaseConnected) {
                    console.log('✅ Database is connected');
                    
                    // Don't automatically clear localStorage
                    // Instead, we'll handle sync in loadProperties
                    const localProps = localStorage.getItem('properties');
                    if (localProps) {
                        const parsed = JSON.parse(localProps);
                        console.log(`📱 Found ${parsed.length} properties in localStorage - will sync with database`);
                    }
                } else {
                    console.warn('⚠️ Database not connected - using localStorage only');
                }
            } catch (error) {
                console.error('Error checking sync:', error);
            }
        }

        // Modal functions - MUST be defined outside DOMContentLoaded for onclick handlers
        window.openModal = function(modalId) {
            console.log(`Opening modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal not found: ${modalId}`);
                return;
            }
            
            // Find modal content
            const modalContent = modal.querySelector('.modal-content');
            
            // Remove ALL animations and transitions before showing
            modal.style.animation = 'none';
            modal.style.transition = 'none';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            
            if (modalContent) {
                modalContent.style.animation = 'none';
                modalContent.style.transition = 'none';
                modalContent.style.opacity = '1';
                modalContent.style.transform = 'none';
                modalContent.style.visibility = 'visible';
            }
            
            // Display the modal
            modal.style.display = 'block';
            
            // Force a repaint to ensure the display change is applied immediately
            void modal.offsetHeight;
            
            // Double-check visibility
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
        }

        window.closeModal = function(modalId) {
            console.log(`Closing modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Restore body scrolling
                document.body.style.overflow = '';
            }
        }

        window.openAddPropertyModal = function() {
            console.log('Opening Add Property Modal');
            document.getElementById('addPropertyForm').reset();
            document.getElementById('fullAddress').value = ''; // Clear the full address field
            window.openModal('addPropertyModal');
        }

        window.openAnalyzeModal = function() {
            console.log('Opening Analyze Modal');
            document.getElementById('propertyAddressInput').value = '';
            document.getElementById('analysisResults').innerHTML = '';
            document.getElementById('analysisLoading').style.display = 'none';
            window.openModal('analyzeModal');
        }

        // Analyze new property
        window.analyzeNewProperty = async function() {
            console.log('Analyzing new property');
            const address = document.getElementById('propertyAddressInput').value.trim();
            
            if (!address) {
                alert('Please enter a property address');
                return;
            }
            
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            try {
                // Parse address
                const parsedAddress = parseAddressComponents(address);
                
                // Show basic analysis without making API call
                generatePropertyAnalysis(address);
                
                // Add a note about fetching real-time data
                const analysisResults = document.getElementById('analysisResults');
                const apiNote = document.createElement('div');
                apiNote.style.cssText = 'background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--border-color);';
                apiNote.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="color: var(--accent-info);"></i> 
                        To fetch real-time market data from RentCast, add this property and click the refresh icon.
                    </p>
                    <button class="btn btn-primary" onclick="
                        document.getElementById('addPropertyForm').reset();
                        document.getElementById('fullAddress').value = '${address.replace(/'/g, "\\'")}';
                        parseAndFillAddress();
                        closeModal('analyzeModal');
                        openAddPropertyModal();
                    ">
                        <i class="fas fa-plus"></i> Add This Property
                    </button>
                `;
                analysisResults.appendChild(apiNote);
                
            } catch (error) {
                console.error('Error analyzing property:', error);
                alert('Error analyzing property. Please try again.');
            } finally {
                document.getElementById('analysisLoading').style.display = 'none';
                document.getElementById('analysisResults').style.display = 'block';
            }
        }

        // Generate AI market insights
        window.generateMarketInsights = async function() {
            console.log('Generating Market Insights');
            window.openModal('marketInsightsModal');
            document.getElementById('marketInsightsLoading').style.display = 'block';
            document.getElementById('marketInsightsContent').style.display = 'none';
            
            try {
                const marketData = await fetchMarketData();
                const content = generateMarketInsightsContent(marketData);
                
                document.getElementById('marketInsightsContent').innerHTML = content;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } catch (error) {
                console.error('Error generating insights:', error);
                document.getElementById('marketInsightsContent').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to generate market insights at this time. Please try again later.</p>
                    </div>
                `;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } finally {
                document.getElementById('marketInsightsLoading').style.display = 'none';
            }
        }

        // Global variables for bulk import
        let pendingBulkImportProperties = [];

        // Handle file upload
        window.handleFileUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name);
            document.getElementById('fileUploadStatus').style.display = 'block';
            document.getElementById('importPreview').style.display = 'none';

            try {
                let importedProperties = [];

                if (file.name.endsWith('.csv')) {
                    importedProperties = await parseCSVFile(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    importedProperties = await parseExcelFile(file);
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    const addresses = await parseWordFile(file);
                    // Convert addresses to property objects for Word files
                    importedProperties = addresses.map(addr => ({ address: addr }));
                } else {
                    throw new Error('Unsupported file format. Please use CSV, Excel, or Word files.');
                }

                if (importedProperties.length === 0) {
                    throw new Error('No valid properties found in the file.');
                }

                // Store for bulk import
                pendingBulkImportProperties = importedProperties;

                // Show preview
                showImportPreview(importedProperties);

                // If we found incomplete properties, show a warning
                if (importedProperties.length === 0 && (file.name.endsWith('.xlsx') || file.name.endsWith('.docx'))) {
                    const fileType = file.name.endsWith('.xlsx') ? 'Excel' : 'Word';
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: var(--accent-warning); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;';
                    warningDiv.innerHTML = `
                        <h4 style="margin-bottom: 10px;">⚠️ Could not parse addresses from ${fileType} file</h4>
                        <p style="margin-bottom: 10px;">Make sure your ${fileType} file has complete addresses in one of these formats:</p>
                        <ul style="margin-left: 20px;">
                            <li>Single line: "123 Main St, Las Vegas, NV 89101"</li>
                            <li>Two lines: "123 Main St" (next line) "Las Vegas, NV 89101"</li>
                            ${fileType === 'Excel' ? '<li>Two cells: "123 Main St" | "Las Vegas, NV 89101"</li>' : ''}
                        </ul>
                        <p style="margin-top: 10px;">Check the browser console for detailed parsing information.</p>
                    `;
                    document.getElementById('importPreview').insertBefore(warningDiv, document.getElementById('importPreview').firstChild);
                    document.getElementById('importPreview').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error processing file:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('fileUploadStatus').style.display = 'none';
                // Reset file input
                event.target.value = '';
            }
        }

        // Parse CSV file
        // Smart column mapping function
        function mapColumnName(columnName) {
            const normalized = columnName.toLowerCase().trim().replace(/[_\s-]+/g, '');

            const mappings = {
                // Address fields
                'address': 'address',
                'streetaddress': 'address',
                'street': 'address',
                'propertyaddress': 'address',

                // Location fields
                'city': 'city',
                'town': 'city',
                'state': 'state',
                'zip': 'zip',
                'zipcode': 'zip',
                'postalcode': 'zip',

                // Property details
                'type': 'propertyType',
                'propertytype': 'propertyType',
                'beds': 'beds',
                'bed': 'beds',
                'bedrooms': 'beds',
                'bedroom': 'beds',
                'baths': 'baths',
                'bath': 'baths',
                'bathrooms': 'baths',
                'bathroom': 'baths',
                'sqft': 'sqft',
                'squarefeet': 'sqft',
                'squarefootage': 'sqft',
                'size': 'sqft',

                // Financial - Purchase
                'purchaseprice': 'purchasePrice',
                'price': 'purchasePrice',
                'cost': 'purchasePrice',
                'saleprice': 'purchasePrice',

                // Financial - Value
                'estvalue': 'estimatedValue',
                'estimatedvalue': 'estimatedValue',
                'value': 'estimatedValue',
                'marketvalue': 'estimatedValue',
                'currentvalue': 'estimatedValue',

                // Financial - Rent
                'monthlyrent': 'monthlyRent',
                'rent': 'monthlyRent',
                'rentalincome': 'monthlyRent',
                'rentestimate': 'rentEstimate',
                'rentest': 'rentEstimate',
                'estimatedrent': 'rentEstimate',

                // Financial - Expenses
                'mortgage': 'mortgage',
                'monthlymortgage': 'mortgage',
                'loan': 'mortgage',
                'loanpayment': 'mortgage',

                'propertytax': 'propertyTax',
                'tax': 'propertyTax',
                'taxes': 'propertyTax',
                'monthlytax': 'propertyTax',

                'insurance': 'insurance',
                'homeinsurance': 'insurance',
                'propertyinsurance': 'insurance',

                'hoa': 'hoa',
                'hoafees': 'hoa',
                'hoafee': 'hoa',
                'condofee': 'hoa',

                'maintenance': 'maintenance',
                'repair': 'maintenance',
                'repairs': 'maintenance',
                'maintenancecost': 'maintenance',

                'managementfee': 'managementFees',
                'managementfees': 'managementFees',
                'pmfee': 'managementFees',
                'propertymanagement': 'managementFees',

                'vacancyrate': 'vacancyRate',
                'vacancy': 'vacancyRate',

                // Financial - Returns
                'cashflow': 'monthlyCashFlow',
                'monthlycashflow': 'monthlyCashFlow',
                'netincome': 'monthlyCashFlow',

                'annualcf': 'annualCashFlow',
                'annualcashflow': 'annualCashFlow',
                'yearlyincome': 'annualCashFlow',

                'cashoncash': 'cashOnCashReturn',
                'cashoncashreturn': 'cashOnCashReturn',
                'coc': 'cashOnCashReturn',
                'cocreturn': 'cashOnCashReturn',

                'caprate': 'capRate',
                'cap': 'capRate',
                'capitalizationrate': 'capRate',

                'downpayment': 'downPayment',
                'down': 'downPayment',
                'deposit': 'downPayment',
                'initialinvestment': 'downPayment'
            };

            return mappings[normalized] || null;
        }

        async function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());

                        if (lines.length === 0) {
                            resolve([]);
                            return;
                        }

                        // Helper function to parse CSV line (handles quotes and commas)
                        const parseCSVLine = (line) => {
                            const result = [];
                            let current = '';
                            let inQuotes = false;

                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];

                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }

                            if (current) {
                                result.push(current.trim());
                            }

                            return result;
                        };


                        // Parse header row
                        const headerFields = parseCSVLine(lines[0]);
                        const columnMap = {};
                        headerFields.forEach((header, index) => {
                            const mappedName = mapColumnName(header);
                            if (mappedName) {
                                columnMap[index] = mappedName;
                            }
                        });

                        console.log('📊 CSV Column Mapping:', columnMap);

                        // Parse data rows
                        const properties = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;

                            const fields = parseCSVLine(line);
                            const property = {};

                            // Map each field to property object
                            fields.forEach((value, index) => {
                                const fieldName = columnMap[index];
                                if (fieldName && value) {
                                    // Clean and parse numeric values
                                    let cleanValue = value.replace(/[$,%]/g, '').trim();

                                    // Check if it's a numeric field
                                    const numericFields = ['purchasePrice', 'estimatedValue', 'monthlyRent', 'rentEstimate',
                                        'mortgage', 'propertyTax', 'insurance', 'hoa', 'maintenance', 'managementFees',
                                        'vacancyRate', 'monthlyCashFlow', 'annualCashFlow', 'cashOnCashReturn',
                                        'capRate', 'downPayment', 'beds', 'baths', 'sqft'];

                                    if (numericFields.includes(fieldName)) {
                                        const numValue = parseFloat(cleanValue);
                                        property[fieldName] = isNaN(numValue) ? null : numValue;
                                    } else {
                                        property[fieldName] = cleanValue;
                                    }
                                }
                            });

                            // Only add if we have at least an address
                            if (property.address) {
                                properties.push(property);
                            }
                        }

                        console.log(`✅ Parsed ${properties.length} properties from CSV with full data`);
                        resolve(properties);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Parse Excel file
        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert to JSON - get all data
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                        if (jsonData.length === 0) {
                            resolve([]);
                            return;
                        }


                        console.log('📊 Excel raw data:', jsonData);

                        // Parse header row (first row)
                        const headerRow = jsonData[0];
                        const columnMap = {};
                        headerRow.forEach((header, index) => {
                            if (header) {
                                const mappedName = mapColumnName(header.toString());
                                if (mappedName) {
                                    columnMap[index] = mappedName;
                                }
                            }
                        });

                        console.log('📊 Excel Column Mapping:', columnMap);

                        // Parse data rows
                        const properties = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;

                            const property = {};

                            // Map each cell to property object
                            row.forEach((value, index) => {
                                const fieldName = columnMap[index];
                                if (fieldName && value !== null && value !== undefined && value !== '') {
                                    // Clean and parse values
                                    let cleanValue = value.toString().replace(/[$,%]/g, '').trim();

                                    // Check if it's a numeric field
                                    const numericFields = ['purchasePrice', 'estimatedValue', 'monthlyRent', 'rentEstimate',
                                        'mortgage', 'propertyTax', 'insurance', 'hoa', 'maintenance', 'managementFees',
                                        'vacancyRate', 'monthlyCashFlow', 'annualCashFlow', 'cashOnCashReturn',
                                        'capRate', 'downPayment', 'beds', 'baths', 'sqft'];

                                    if (numericFields.includes(fieldName)) {
                                        const numValue = parseFloat(cleanValue);
                                        property[fieldName] = isNaN(numValue) ? null : numValue;
                                    } else {
                                        property[fieldName] = cleanValue;
                                    }
                                }
                            });

                            // Only add if we have at least an address
                            if (property.address) {
                                properties.push(property);
                            }
                        }

                        console.log(`✅ Parsed ${properties.length} properties from Excel with full data`);
                        resolve(properties);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Parse Word document file
        async function parseWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        
                        // Use mammoth to extract text from the Word document
                        mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                            .then(function(result) {
                                const text = result.value;
                                console.log('Extracted text from Word document:', text);
                                
                                // Parse addresses from the extracted text
                                const addresses = [];
                                
                                // Split text by newlines
                                const lines = text.split(/\r?\n/).filter(line => line.trim());
                                
                                console.log('Parsing', lines.length, 'lines from Word document');
                                
                                let i = 0;
                                while (i < lines.length) {
                                    const line = lines[i].trim();
                                    
                                    if (!line) {
                                        i++;
                                        continue;
                                    }
                                    
                                    console.log(`Line ${i}: "${line}"`);
                                    
                                    // Check if it's a complete address
                                    if (line.match(/,.*[A-Z]{2}\s+\d{5}/) || line.match(/\d{5}(?:-\d{4})?$/)) {
                                        // Looks like a complete address
                                        addresses.push(line);
                                        console.log('  -> Complete address found');
                                    } else {
                                        // Might be a street address, check next line for city/state/zip
                                        const streetPattern = /^\d+\s+[A-Za-z\s]+$/;
                                        const cityStateZipPattern = /[A-Za-z\s]+,?\s*[A-Z]{2}\s+\d{5}(?:-\d{4})?/;
                                        
                                        if (streetPattern.test(line) && i + 1 < lines.length) {
                                            const nextLine = lines[i + 1].trim();
                                            console.log(`  Checking next line: "${nextLine}"`);
                                            
                                            if (cityStateZipPattern.test(nextLine)) {
                                                // Combine the two lines
                                                const fullAddress = `${line}, ${nextLine}`;
                                                addresses.push(fullAddress);
                                                console.log('  -> Combined address:', fullAddress);
                                                i++; // Skip the next line since we used it
                                            }
                                        }
                                    }
                                    
                                    i++;
                                }
                                
                                // Also try to find addresses in table format (common in Word docs)
                                // Look for patterns like "Address" followed by actual addresses
                                const tablePattern = /(?:address|property|location)[\s:]*([^\n]+)/gi;
                                let match;
                                while ((match = tablePattern.exec(text)) !== null) {
                                    const potentialAddress = match[1].trim();
                                    // Validate it looks like an address
                                    if (potentialAddress.match(/\d+.*[A-Z]{2}\s+\d{5}/) && 
                                        !addresses.includes(potentialAddress)) {
                                        addresses.push(potentialAddress);
                                        console.log('Found address in table format:', potentialAddress);
                                    }
                                }
                                
                                // Remove duplicates
                                const uniqueAddresses = [...new Set(addresses)];
                                
                                console.log('Final parsed addresses from Word:', uniqueAddresses);
                                resolve(uniqueAddresses);
                            })
                            .catch(function(err) {
                                console.error('Mammoth parsing error:', err);
                                reject(new Error('Failed to parse Word document: ' + err.message));
                            });
                            
                    } catch (error) {
                        console.error('Word parsing error:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Show import preview
        function showImportPreview(properties) {
            const previewList = document.getElementById('importPreviewList');
            previewList.innerHTML = '';

            properties.forEach((property, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 8px; border-bottom: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.02);';

                // Build preview text with available fields
                let previewText = `<strong>${property.address || 'Unknown Address'}</strong>`;
                const details = [];

                if (property.city) details.push(property.city);
                if (property.purchasePrice) details.push(`Price: $${Number(property.purchasePrice).toLocaleString()}`);
                if (property.monthlyRent) details.push(`Rent: $${Number(property.monthlyRent).toLocaleString()}`);
                if (property.beds) details.push(`${property.beds} beds`);

                if (details.length > 0) {
                    previewText += `<br><small style="color: var(--text-muted);">${details.join(' • ')}</small>`;
                }

                item.innerHTML = `
                    <small style="color: var(--accent-primary); font-weight: bold;">${index + 1}.</small>
                    <div style="margin-left: 20px;">${previewText}</div>
                `;
                previewList.appendChild(item);
            });

            document.getElementById('importPreview').style.display = 'block';

            // Update preview header
            const header = document.querySelector('#importPreview h4');
            header.textContent = `Properties to Import (${properties.length} found):`;
        }

        // Confirm bulk import
        window.confirmBulkImport = async function() {
            if (pendingBulkImportProperties.length === 0) {
                showNotification('No properties to import', 'error');
                return;
            }

            // Hide preview and show progress
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileUploadStatus').style.display = 'block';
            document.querySelector('#fileUploadStatus p').textContent = `Importing ${pendingBulkImportProperties.length} properties...`;

            let successCount = 0;
            let failCount = 0;
            const failedAddresses = [];
            const failedProperties = []; // Track detailed failure info
            const propertiesToCreate = [];

            // Process all property objects
            for (let i = 0; i < pendingBulkImportProperties.length; i++) {
                const importedProperty = pendingBulkImportProperties[i];

                try {
                    // Update progress
                    document.querySelector('#fileUploadStatus p').textContent =
                        `Processing property ${i + 1} of ${pendingBulkImportProperties.length}...`;

                    // If address isn't already parsed, parse it
                    if (!importedProperty.city || !importedProperty.state) {
                        const parsedAddress = parseAddressComponents(importedProperty.address);
                        if (parsedAddress) {
                            if (!importedProperty.city) importedProperty.city = parsedAddress.city;
                            if (!importedProperty.state) importedProperty.state = parsedAddress.state;
                            if (!importedProperty.zip) importedProperty.zip = parsedAddress.zip;
                            if (!importedProperty.address) importedProperty.address = parsedAddress.streetAddress;
                        }
                    }

                    // Validate required fields
                    if (!importedProperty.address) {
                        throw new Error('Missing address');
                    }

                    // Create complete property object with imported data
                    const property = {
                        address: importedProperty.address,
                        city: importedProperty.city || null,
                        state: importedProperty.state || null,
                        zip: importedProperty.zip || null,
                        propertyType: importedProperty.propertyType || 'Single Family',
                        purchasePrice: importedProperty.purchasePrice || null,
                        monthlyRent: importedProperty.monthlyRent || null,
                        beds: importedProperty.beds || null,
                        baths: importedProperty.baths || null,
                        sqft: importedProperty.sqft || null,
                        mortgage: importedProperty.mortgage || null,
                        propertyTax: importedProperty.propertyTax || null,
                        insurance: importedProperty.insurance || null,
                        hoa: importedProperty.hoa || null,
                        maintenance: importedProperty.maintenance || null,
                        managementFees: importedProperty.managementFees || null,
                        vacancyRate: importedProperty.vacancyRate || 7,
                        downPayment: importedProperty.downPayment || null,
                        estimatedValue: importedProperty.estimatedValue || null,
                        rentEstimate: importedProperty.rentEstimate || null,
                        status: 'available',
                        rentcastCache: null,
                        needsRentCastData: !importedProperty.estimatedValue, // Only fetch if not provided
                        realTimeData: !!importedProperty.estimatedValue
                    };

                    // Skip RentCast API calls during bulk import to minimize API usage
                    console.log(`Property ${i + 1}: ${property.address} - imported with data`);

                    // Calculate metrics based on imported or default values
                    calculatePropertyMetrics(property);

                    // Add to list to create
                    propertiesToCreate.push(property);

                } catch (error) {
                    console.error(`Error processing property "${importedProperty.address}":`, error);
                    failCount++;
                    failedAddresses.push(importedProperty.address || 'Unknown');
                    failedProperties.push({
                        address: importedProperty.address || 'Unknown',
                        error: `Processing error: ${error.message}`,
                        stage: 'processing'
                    });
                }
            }
            
            // Now create all properties in the database
            document.querySelector('#fileUploadStatus p').textContent = `Saving ${propertiesToCreate.length} properties to database...`;
            
            let existingCount = 0;
            const existingProperties = [];
            const createdProperties = [];
            
            // Create each property individually to handle duplicates properly
            for (let i = 0; i < propertiesToCreate.length; i++) {
                const property = propertiesToCreate[i];
                
                try {
                    // Update progress
                    document.querySelector('#fileUploadStatus p').textContent = 
                        `Saving property ${i + 1} of ${propertiesToCreate.length}: ${property.address}...`;
                    
                    // Log what we're about to send
                    console.log(`🔄 Saving property ${i + 1}/${propertiesToCreate.length}:`, {
                        address: property.address,
                        city: property.city,
                        state: property.state,
                        zip: property.zip,
                        hasAllRequired: !!(property.address && property.city && property.state)
                    });
                    
                    // Clean property data for database
                    const sanitizedProperty = sanitizePropertyForDatabase(property);
                    
                    // Try to create in database
                    const response = await fetch('/api/properties', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sanitizedProperty)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Check if this is a temporary save (database not connected)
                        const hasWarning = data.warning && data.warning.includes('locally only');
                        const hasTemporaryId = data.data.id && typeof data.data.id === 'number' && data.data.id > 1700000000000; // Timestamp-based IDs
                        
                        if (hasWarning || hasTemporaryId) {
                            console.warn(`⚠️ Property "${property.address}" saved locally only (database not connected)`);
                            console.log('Temporary ID:', data.data.id, 'Warning:', data.warning);
                        }
                        
                        // Property created successfully (but might be temporary)
                        const createdProperty = {
                            ...property,
                            ...data.data,
                            // Mark if this is a temporary save
                            _isTemporary: hasWarning || hasTemporaryId,
                            // Preserve camelCase fields
                            purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                            monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                        };
                        
                        properties.push(createdProperty);
                        createdProperties.push(createdProperty);
                        successCount++;
                        
                        console.log(`${hasWarning ? '⚠️' : '✅'} Property created: ${property.address} with ID ${createdProperty.id}${hasWarning ? ' (TEMPORARY)' : ''}`);
                    } else if (response.status === 409) {
                        // Property already exists
                        existingCount++;
                        existingProperties.push(property.address);
                        console.log(`⚠️ Property already exists: ${property.address}`);
                        
                        // Check if property exists in database and load it
                        if (data.propertyId) {
                            try {
                                const existingPropResponse = await fetch(`/api/properties/${data.propertyId}`);
                                if (existingPropResponse.ok) {
                                    const existingPropData = await existingPropResponse.json();
                                    if (existingPropData.success && existingPropData.data) {
                                        // Add to local array if not already there
                                        const alreadyInArray = properties.find(p => p.id === data.propertyId);
                                        if (!alreadyInArray) {
                                            properties.push(existingPropData.data);
                                            console.log(`📥 Loaded existing property from database: ${property.address}`);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('Failed to load existing property:', error);
                            }
                        }
                        
                        // If it was reactivated, still count as success
                        if (data.message === 'Property reactivated successfully') {
                            successCount++;
                        }
                    } else {
                        // Other error - log detailed information
                        failCount++;
                        failedAddresses.push(property.address);
                        failedProperties.push({
                            address: property.address,
                            error: data.error || 'Unknown server error',
                            status: response.status,
                            stage: 'database_save',
                            propertyData: {
                                address: property.address,
                                city: property.city,
                                state: property.state,
                                zip: property.zip,
                                propertyType: property.propertyType
                            }
                        });
                        
                        console.error(`❌ PROPERTY IMPORT FAILED: ${property.address}`);
                        console.error(`   Error: ${data.error || 'Unknown error'}`);
                        console.error(`   Status: ${response.status}`);
                        console.error(`   Property data sent:`, {
                            address: property.address,
                            city: property.city,
                            state: property.state,
                            zip: property.zip,
                            propertyType: property.propertyType,
                            purchasePrice: property.purchasePrice,
                            monthlyRent: property.monthlyRent,
                            dataKeys: Object.keys(property)
                        });
                        console.error(`   Full server response:`, data);
                    }
                    
                } catch (error) {
                    console.error(`❌ NETWORK ERROR saving property "${property.address}":`, error);
                    console.error(`   Property data that failed:`, property);
                    failCount++;
                    failedAddresses.push(property.address);
                    failedProperties.push({
                        address: property.address,
                        error: `Network error: ${error.message}`,
                        stage: 'network',
                        propertyData: {
                            address: property.address,
                            city: property.city,
                            state: property.state,
                            zip: property.zip
                        }
                    });
                }
            }
            
            // Update localStorage with all properties
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // CRITICAL: Sync all properties with database to ensure persistence
            console.log('🔄 Syncing all properties with database...');
            const saveResult = await saveProperties();
            if (saveResult && saveResult.warning) {
                console.warn('⚠️ Save warning:', saveResult.warning);
            } else {
                console.log('✅ All properties synced with database');
            }
            
            // Update display
            updateDisplay();
            
            // Hide loading
            document.getElementById('fileUploadStatus').style.display = 'none';
            
            // Show results
            let message = '';
            if (successCount > 0) {
                message = `Successfully imported ${successCount} properties`;
            }
            if (existingCount > 0) {
                message += (message ? '. ' : '') + `${existingCount} properties already exist`;
            }
            if (failCount > 0) {
                message += (message ? '. ' : '') + `Failed to import ${failCount} properties`;
                console.log('Failed addresses:', failedAddresses);
                
                // Show detailed failure summary
                console.error('\n🚨 IMPORT FAILURE SUMMARY:');
                console.error(`Total failed properties: ${failedProperties.length}`);
                failedProperties.forEach((failure, index) => {
                    console.error(`\n--- Failed Property ${index + 1} ---`);
                    console.error(`Address: ${failure.address}`);
                    console.error(`Stage: ${failure.stage}`);
                    console.error(`Error: ${failure.error}`);
                    if (failure.status) console.error(`HTTP Status: ${failure.status}`);
                    if (failure.propertyData) {
                        console.error('Property Data:', failure.propertyData);
                    }
                });
                console.error('\n💡 TROUBLESHOOTING TIPS:');
                console.error('- Check that all addresses have city, state, and ZIP');
                console.error('- Ensure no special characters in addresses');
                console.error('- Verify addresses are not duplicates');
                console.error('- Check server logs for database errors');
            }
            
            // Check for temporary properties
            const temporaryProperties = properties.filter(p => p._isTemporary);
            if (temporaryProperties.length > 0) {
                message += `. WARNING: ${temporaryProperties.length} properties saved locally only (database not connected)`;
                console.warn(`⚠️ ${temporaryProperties.length} properties have temporary IDs and are not saved to database:`, 
                    temporaryProperties.map(p => ({ address: p.address, id: p.id })));
            }
            
            // Show notification
            showNotification(message || 'No properties imported', 
                temporaryProperties.length > 0 ? 'warning' : (successCount > 0 ? 'success' : 'warning'));
            
            // Show detailed info about existing properties if any
            if (existingProperties.length > 0) {
                console.log('🏠 Properties that already exist:', existingProperties);
                setTimeout(() => {
                    showNotification(`Already in portfolio: ${existingProperties.slice(0, 3).join(', ')}${existingProperties.length > 3 ? ` and ${existingProperties.length - 3} more` : ''}`, 'info');
                }, 2000);
            }
            
            // Show warning about temporary saves
            if (temporaryProperties.length > 0) {
                setTimeout(() => {
                    showNotification(`⚠️ ${temporaryProperties.length} properties saved locally only. Refresh the page when database is connected to persist them.`, 'warning');
                }, existingProperties.length > 0 ? 4000 : 2000);
            }
            
            // Show additional notification about RentCast data
            if (successCount > 0) {
                setTimeout(() => {
                    showNotification('Click the refresh icon (🔄) on each property to fetch market data from RentCast', 'info');
                }, existingProperties.length > 0 ? 4000 : 2000);
            }
            
            // Close modal if all successful or only duplicates
            if (failCount === 0 && propertiesToCreate.length > 0) {
                closeModal('addPropertyModal');
            }
            
            // Reset
            pendingBulkImportProperties = [];
        }

        // Cancel bulk import
        window.cancelBulkImport = function() {
            pendingBulkImportProperties = [];
            document.getElementById('importPreview').style.display = 'none';
            showNotification('Import cancelled', 'info');
        }

        // Generate AI Market Insights with Gemini
        window.generateAIInsights = async function() {
            console.log('Generating AI Insights');
            const modal = document.getElementById('marketInsightsModal');
            const modalTitle = modal.querySelector('.modal-header h2');
            modalTitle.innerHTML = '<i class="fas fa-brain"></i> AI Market Insights';
            
            window.openModal('marketInsightsModal');
            document.getElementById('marketInsightsLoading').style.display = 'block';
            document.getElementById('marketInsightsContent').style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:3000/api/gemini/market-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ properties })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate AI insights');
                }

                const data = await response.json();
                
                document.getElementById('marketInsightsContent').innerHTML = data.insights;
                document.getElementById('marketInsightsContent').style.display = 'block';
                
                // Add download button if not exists
                const modalBody = document.querySelector('#marketInsightsModal .modal-body');
                if (!modalBody.querySelector('.download-btn')) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-primary download-btn';
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
                    downloadBtn.onclick = () => downloadMarketReport(data.insights);
                    modalBody.appendChild(downloadBtn);
                }
            } catch (error) {
                console.error('Error generating AI insights:', error);
                document.getElementById('marketInsightsContent').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to generate AI insights. Please check your Gemini API configuration.</p>
                    </div>
                `;
                document.getElementById('marketInsightsContent').style.display = 'block';
            } finally {
                document.getElementById('marketInsightsLoading').style.display = 'none';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing Real Estate Tracker...');
            
            // Check and sync properties first
            await checkAndSyncProperties();
            
            // Check API and database status
            await checkAPIStatus();
            
            // Load properties
            await loadProperties();
            
            // Setup UI
            setupEventListeners();
            
            // Update display after everything is loaded
            updateDisplay();
            
            // Force mobile cards update on initial load for mobile devices
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    updateMobilePropertyCards();
                    console.log('📱 Mobile view initialized');
                }, 100);
            }
        });
        
        // Check API and database connection status
        async function checkAPIStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('🏛️ Server health check:', data);
                
                if (data.database !== 'connected') {
                    console.warn('⚠️ Database is not connected. Properties will be stored locally only.');
                    if (typeof showNotification === 'function') {
                        showNotification('Database offline - properties saved locally only', 'warning');
                    }
                }
                
                return data;
            } catch (error) {
                console.error('Failed to check API status:', error);
                return { status: 'error', database: 'disconnected' };
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('addPropertyForm').addEventListener('submit', handleAddProperty);

            // Setup compare button event listener
            const compareBtn = document.getElementById('compareBtn');
            if (compareBtn) {
                console.log('✅ Setting up compare button event listener');
                // Remove any existing listeners first
                compareBtn.replaceWith(compareBtn.cloneNode(true));
                const newCompareBtn = document.getElementById('compareBtn');
                newCompareBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔵 Compare button clicked!');
                    if (window.openComparisonModal) {
                        window.openComparisonModal();
                    } else {
                        console.error('❌ openComparisonModal function not found!');
                    }
                }, { capture: true });
            } else {
                console.error('❌ Compare button not found during setup');
            }

            // Setup select all checkbox event listener
            const selectAllCheckbox = document.getElementById('selectAllProperties');
            if (selectAllCheckbox) {
                console.log('✅ Setting up select all checkbox event listener');
                selectAllCheckbox.addEventListener('change', function(e) {
                    window.toggleSelectAll();
                });
            }

            // Setup delegated event listener for property checkboxes
            const propertyTable = document.getElementById('propertyTable');
            if (propertyTable) {
                console.log('✅ Setting up delegated event listener for property checkboxes');
                propertyTable.addEventListener('change', function(e) {
                    if (e.target.classList.contains('property-select-checkbox')) {
                        console.log('🔵 Property checkbox changed:', e.target.dataset.propertyIndex);
                        window.handlePropertySelection();
                    }
                });
            }

            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                    // Restore body scrolling
                    document.body.style.overflow = '';
                }
            };
        }

        // Load properties from server/localStorage
        async function loadProperties() {
            console.log('📥 Loading properties...');
            
            // First check what's in localStorage
            const localStorageData = localStorage.getItem('properties');
            if (localStorageData) {
                const localProperties = JSON.parse(localStorageData);
                console.log(`📱 LocalStorage has ${localProperties.length} properties`);
                const localWithIds = localProperties.filter(p => p.id);
                const localWithoutIds = localProperties.filter(p => !p.id);
                console.log(`  - With IDs: ${localWithIds.length}`);
                console.log(`  - Without IDs: ${localWithoutIds.length}`);
                if (localWithoutIds.length > 0) {
                    console.warn('  - Properties without IDs:', localWithoutIds.map(p => p.address));
                }
            } else {
                console.log('📱 No properties in localStorage');
            }
            
            try {
                // Try to load from server first
                const response = await fetch('/api/properties');
                if (response.ok) {
                    const data = await response.json();
                    console.log(`📊 Server response: success=${data.success}, properties=${data.data?.length || 0}`);
                    
                    if (data.success && data.data) {
                        // Always use server data when available
                        properties = data.data;
                        
                        // Ensure all properties have proper field names for the UI
                        properties = properties.map(p => {
                            // Clean up any string IDs that might exist
                            let cleanId = p.id;
                            if (typeof p.id === 'string' && isNaN(parseInt(p.id))) {
                                console.warn(`⚠️ Found property with string ID: ${p.id}, will need to be fixed`);
                                cleanId = null; // Mark as needing a proper ID
                            } else if (typeof p.id === 'string' && !isNaN(parseInt(p.id))) {
                                // Convert numeric string to number
                                cleanId = parseInt(p.id);
                                console.log(`📋 Converted string ID "${p.id}" to number ${cleanId}`);
                            }
                            
                            return {
                                ...p,
                                id: cleanId,
                                // Ensure camelCase versions exist for UI
                                purchasePrice: p.purchasePrice || p.purchase_price,
                                monthlyRent: p.monthlyRent || p.monthly_rent,
                                currentValue: p.currentValue || p.value_estimate || p.purchase_price || p.purchasePrice,
                                propertyTax: p.propertyTax || p.property_tax,
                                managementFees: p.managementFees || p.management_fees,
                                cashFlow: p.cashFlow || p.cash_flow,
                                monthlyCashFlow: p.cashFlow || p.cash_flow,
                                cocReturn: p.cocReturn || p.coc_return,
                                cashOnCashReturn: p.cocReturn || p.coc_return,
                                capRate: p.capRate || p.cap_rate,
                                rentToValue: p.rentToValue || p.rent_to_value,
                                floodRisk: p.floodRisk || p.flood_risk,
                                marketRisk: p.marketRisk || p.market_risk
                            };
                        });
                        
                        // After loading from server, update localStorage to sync
                        localStorage.setItem('properties', JSON.stringify(properties));
                        
                        console.log(`✅ Loaded ${properties.length} properties from server and synced to localStorage`);
                        
                        // Calculate metrics for all properties after loading
                        properties.forEach(prop => {
                            if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                calculatePropertyMetrics(prop);
                            }
                        });
                        
                        // Debug: Check first 2 properties
                        if (properties.length > 0) {
                            console.log('🔍 Sample properties:');
                            properties.slice(0, 2).forEach((p, i) => {
                                console.log(`Property ${i+1}: ${p.address}`, {
                                    id: p.id,
                                    purchasePrice: p.purchasePrice,
                                    monthlyRent: p.monthlyRent,
                                    cashFlow: p.cashFlow,
                                    monthlyCashFlow: p.monthlyCashFlow
                                });
                            });
                        }
                    } else if (data.warning) {
                        // Server is not connected, use localStorage
                        console.warn('⚠️', data.warning);
                        const saved = localStorage.getItem('properties');
                        if (saved) {
                            properties = JSON.parse(saved);
                            console.log(`📱 Loaded ${properties.length} properties from localStorage (database offline)`);
                            // Calculate metrics for properties loaded from localStorage
                            properties.forEach(prop => {
                                if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                    calculatePropertyMetrics(prop);
                                }
                            });
                        } else {
                            properties = [];
                        }
                    }
                } else {
                    // Server error, fallback to localStorage
                    console.error('❌ Server response not OK:', response.status);
                    const saved = localStorage.getItem('properties');
                    if (saved) {
                        properties = JSON.parse(saved);
                        console.log(`📱 Loaded ${properties.length} properties from localStorage (server error)`);
                        
                        // Clean up any string IDs in localStorage data
                        properties = properties.map(p => {
                            let cleanId = p.id;
                            if (typeof p.id === 'string' && isNaN(parseInt(p.id))) {
                                console.warn(`⚠️ Found property with invalid string ID during localStorage fallback: ${p.id}`);
                                cleanId = null; // Will need proper ID from database
                            } else if (typeof p.id === 'string' && !isNaN(parseInt(p.id))) {
                                cleanId = parseInt(p.id);
                                console.log(`📋 Converted string ID "${p.id}" to number ${cleanId} during localStorage fallback`);
                            }
                            return { ...p, id: cleanId };
                        });
                        
                        // Calculate metrics for properties loaded from localStorage
                        properties.forEach(prop => {
                            if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                                calculatePropertyMetrics(prop);
                            }
                        });
                        
                        // Save cleaned properties back to localStorage
                        localStorage.setItem('properties', JSON.stringify(properties));
                    } else {
                        properties = [];
                    }
                }
            } catch (error) {
                console.error('❌ Error loading properties:', error);
                // Network error, fallback to localStorage
                const saved = localStorage.getItem('properties');
                if (saved) {
                    properties = JSON.parse(saved);
                    console.log(`📱 Loaded ${properties.length} properties from localStorage (network error)`);
                    
                    // Clean up any string IDs in localStorage data
                    properties = properties.map(p => {
                        let cleanId = p.id;
                        if (typeof p.id === 'string' && isNaN(parseInt(p.id))) {
                            console.warn(`⚠️ Found property with invalid string ID during network error: ${p.id}`);
                            cleanId = null; // Will need proper ID from database
                        } else if (typeof p.id === 'string' && !isNaN(parseInt(p.id))) {
                            cleanId = parseInt(p.id);
                            console.log(`📋 Converted string ID "${p.id}" to number ${cleanId} during network error`);
                        }
                        return { ...p, id: cleanId };
                    });
                    
                    // Calculate metrics for properties loaded from localStorage
                    properties.forEach(prop => {
                        if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined) {
                            calculatePropertyMetrics(prop);
                        }
                    });
                    
                    // Save cleaned properties back to localStorage
                    localStorage.setItem('properties', JSON.stringify(properties));
                } else {
                    properties = [];
                    console.log('📱 No properties in localStorage');
                }
            }
            
            updateDisplay();
        }

        // Sanitize property data for database - remove invalid fields and map field names
        function sanitizePropertyForDatabase(property) {
            // Define valid database fields (based on schema.sql)
            const validFields = [
                'address', 'city', 'state', 'zip', 'purchase_price', 'down_payment', 'monthly_rent',
                'hoa', 'property_tax', 'insurance', 'management_fees', 'maintenance', 'repairs',
                'vacancy', 'vacancy_rate', 'capex', 'mortgage', 'coc_return', 'rent_to_value', 'cap_rate',
                'crime_score', 'flood_risk', 'market_risk', 'bedrooms', 'bathrooms',
                'square_footage', 'year_built', 'lot_size', 'property_type', 'county',
                'rent_estimate', 'value_estimate', 'status', 'notes', 'last_updated',
                'data_source', 'rentcast_data'
            ];

            // Field mapping from frontend names to database column names
            const fieldMapping = {
                'beds': 'bedrooms',
                'baths': 'bathrooms',
                'sqft': 'square_footage',
                'yearBuilt': 'year_built',
                'purchasePrice': 'purchase_price',
                'downPayment': 'down_payment',
                'monthlyRent': 'monthly_rent',
                'propertyTax': 'property_tax',
                'managementFees': 'management_fees',
                'vacancyRate': 'vacancy_rate',
                'cashFlow': null, // This is a calculated field, don't send it
                'monthlyCashFlow': null, // This is a calculated field, don't send it
                'annualCashFlow': null, // This is a calculated field, don't send it
                'cashOnCashReturn': null, // This is a calculated field, don't send it
                'cocReturn': 'coc_return',
                'rentToValue': 'rent_to_value',
                'capRate': 'cap_rate',
                'crimeScore': 'crime_score',
                'floodRisk': 'flood_risk',
                'marketRisk': 'market_risk',
                'squareFootage': 'square_footage',
                'propertyType': 'property_type',
                'rentEstimate': 'rent_estimate',
                'valueEstimate': 'value_estimate',
                'estimatedValue': 'value_estimate',
                'currentValue': 'value_estimate',
                'lastUpdated': 'last_updated',
                'dataSource': 'data_source',
                'lastRentCastUpdate': 'last_updated',
                // Remove invalid fields that don't exist in database
                'dateAdded': null,
                'date_added': null,
                'owner': null,
                'monthly_cash_flow': null,
                'needsRentCastData': null,
                'rentcastCache': null,
                'realTimeData': null,
                '_isTemporary': null,
                'created_at': null, // Don't send this, let database handle it
                'updated_at': null  // Don't send this, let database handle it
            };

            const cleanProperty = {};

            // Process each field in the property
            Object.keys(property).forEach(key => {
                if (fieldMapping.hasOwnProperty(key)) {
                    // Field has a mapping
                    const mappedKey = fieldMapping[key];
                    if (mappedKey) {
                        // Valid mapped field
                        cleanProperty[mappedKey] = property[key];
                    }
                    // If mappedKey is null, skip this field (it's invalid)
                } else if (validFields.includes(key)) {
                    // Field is already in correct database format
                    cleanProperty[key] = property[key];
                }
                // Skip unknown fields that aren't in mapping or valid fields
            });

            console.log(`🧹 Sanitized property fields: ${Object.keys(cleanProperty).length} valid fields`);
            return cleanProperty;
        }

        // Save properties
        async function saveProperties() {
            // Always save to localStorage
            localStorage.setItem('properties', JSON.stringify(properties));
            
            // Try to save to server
            let updatedCount = 0;
            let createdCount = 0;
            let failedCount = 0;
            
            try {
                // First check if database is connected
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                
                if (!status.databaseConnected) {
                    console.warn('⚠️ Database not connected - saving to localStorage only');
                    return { success: false, warning: 'Database not connected - data saved locally only' };
                }
                
                for (let i = 0; i < properties.length; i++) {
                    const property = properties[i];
                    
                    // Check if this property has a temporary ID (timestamp-based) or invalid string ID
                    const hasTemporaryId = property.id && typeof property.id === 'number' && property.id > 1700000000000;
                    const hasStringId = property.id && typeof property.id === 'string';
                    const hasInvalidId = hasStringId || !Number.isInteger(property.id);
                    const isTemporary = property._isTemporary || hasTemporaryId || hasInvalidId;
                    
                    if (!property.id || isTemporary) {
                        // New property or temporary property, create it
                        if (hasStringId) {
                            console.log(`🔄 Re-creating property with invalid string ID: ${property.address} (old ID: ${property.id})`);
                        } else {
                            console.log(isTemporary ? 
                                `🔄 Re-creating temporary property in database: ${property.address} (old ID: ${property.id})` : 
                                `Creating new property in database: ${property.address}`);
                        }
                        
                        // Clean property data and map field names properly
                        const propertyToCreate = sanitizePropertyForDatabase(property);
                        
                        console.log('📦 Data being sent to server:', {
                            address: propertyToCreate.address,
                            city: propertyToCreate.city,
                            state: propertyToCreate.state,
                            zip: propertyToCreate.zip,
                            purchasePrice: propertyToCreate.purchasePrice,
                            monthlyRent: propertyToCreate.monthlyRent
                        });
                        
                        const response = await fetch('/api/properties', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(propertyToCreate)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            // Check if this is still a temporary save
                            const stillTemporary = data.warning && data.warning.includes('locally only');
                            
                            // CRITICAL: Update the property in the array with the server response
                            properties[i] = {
                                ...property,
                                ...data.data,
                                // Mark if still temporary
                                _isTemporary: stillTemporary,
                                // Ensure camelCase fields are preserved
                                purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                                monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                            };
                            
                            // Remove _isTemporary flag if property was saved to database
                            if (!stillTemporary && properties[i]._isTemporary !== undefined) {
                                delete properties[i]._isTemporary;
                            }
                            
                            createdCount++;
                            console.log(`✅ Property ${stillTemporary ? 'saved locally' : 'created in database'} with ID:`, properties[i].id);
                            if (isTemporary && !stillTemporary) {
                                console.log('✅ Temporary property successfully persisted to database!');
                            }
                            
                            // Show warning if database wasn't available
                            if (data.warning) {
                                console.warn('⚠️ Warning:', data.warning);
                            }
                        } else {
                            console.error('❌ Failed to create property:', data.error || 'Unknown error');
                            
                            // Show error notification if available
                            if (typeof showNotification === 'function' && data.error) {
                                showNotification(data.error, 'error');
                            }
                            
                            // If it's a duplicate property error, fetch it from the database
                            if (data.existingProperty && data.propertyId) {
                                console.log('🔍 Property already exists, fetching from database...');
                                try {
                                    const existingPropResponse = await fetch(`/api/properties/${data.propertyId}`);
                                    if (existingPropResponse.ok) {
                                        const existingPropData = await existingPropResponse.json();
                                        if (existingPropData.success && existingPropData.data) {
                                            // Update the property in the array with database data
                                            const dbId = existingPropData.data.id;
                                            
                                            // Ensure we use the numeric ID from database
                                            properties[i] = {
                                                ...property,
                                                ...existingPropData.data,
                                                id: dbId, // Force use of database ID
                                                // Preserve camelCase fields
                                                purchasePrice: existingPropData.data.purchasePrice || existingPropData.data.purchase_price || property.purchasePrice,
                                                monthlyRent: existingPropData.data.monthlyRent || existingPropData.data.monthly_rent || property.monthlyRent
                                            };
                                            console.log('✅ Updated property with database ID:', properties[i].id);
                                            
                                            // Update localStorage immediately
                                            localStorage.setItem('properties', JSON.stringify(properties));
                                        }
                                    }
                                } catch (fetchError) {
                                    console.error('Failed to fetch existing property:', fetchError);
                                }
                            }
                        }
                    } else {
                        // Existing property, update it
                        // Debug: Log what we're sending for first 2 properties
                        if (property.address === '1613 Capistrano Ave' || property.address === '1701 Canosa Ave') {
                            console.log(`📤 Saving property: ${property.address}`, {
                                id: property.id,
                                beds: property.beds,
                                bedrooms: property.bedrooms,
                                realTimeData: property.realTimeData,
                                estimatedValue: property.estimatedValue,
                                rentEstimate: property.rentEstimate,
                                lastRentCastUpdate: property.lastRentCastUpdate
                            });
                        }
                        
                        // Clean property data and map field names properly
                        const propertyToSave = sanitizePropertyForDatabase(property);
                        
                        const response = await fetch(`/api/properties/${property.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(propertyToSave)
                        });
                        if (response.ok) {
                            const updatedData = await response.json();
                            console.log(`✅ Updated property ${property.id}: ${property.address}, ${property.city}`);
                            
                            // Debug: Check what the server returned for first 2 properties
                            if (property.address === '1613 Capistrano Ave' || property.address === '1701 Canosa Ave') {
                                console.log(`📥 Server returned for ${property.address}:`, {
                                    beds: updatedData.data.beds,
                                    bedrooms: updatedData.data.bedrooms,
                                    realTimeData: updatedData.data.realTimeData,
                                    estimatedValue: updatedData.data.estimatedValue
                                });
                            }
                            
                            updatedCount++;
                        } else {
                            console.error(`Failed to update property ${property.id}:`, await response.text());
                        }
                    }
                }
                
                // Log summary of save operation
                console.log(`💾 Save complete: ${createdCount} created, ${updatedCount} updated`);
                
                // Check which properties have IDs
                const withIds = properties.filter(p => p.id);
                const withoutIds = properties.filter(p => !p.id);
                
                console.log(`📊 Property Status:
                - Total properties: ${properties.length}
                - With database IDs: ${withIds.length}
                - Without database IDs: ${withoutIds.length}`);
                
                if (withoutIds.length > 0) {
                    console.warn('⚠️ Properties without database IDs:', withoutIds.map(p => p.address));
                }
                
                // IMPORTANT: Update localStorage again with all the new IDs
                localStorage.setItem('properties', JSON.stringify(properties));
                console.log('✅ Updated localStorage with all property data');
            } catch (error) {
                console.error('Error saving to server:', error);
                failedCount = properties.filter(p => !p.id).length;
                // Continue anyway, we have localStorage backup
            }
            
            // Return save result
            return {
                success: true,
                createdCount,
                updatedCount,
                failedCount,
                localStorageSaved: true
            };
        }

        // Update display
        function updateDisplay() {
            updateStats();
            updateTable();
            updateCityFilter();
            updateMobilePropertyCards(); // Update mobile cards too
        }

        // Update statistics
        function updateStats() {
            const availableProperties = properties.filter(p => p.status !== 'sold');
            
            const totalProperties = properties.length;
            
            // Calculate total value safely
            const totalValue = availableProperties.reduce((sum, p) => {
                const value = parseFloat(p.estimatedValue) || parseFloat(p.currentValue) || parseFloat(p.purchasePrice) || 0;
                return sum + (isNaN(value) ? 0 : value);
            }, 0);
            
            // Calculate total equity safely
            const totalEquity = availableProperties.reduce((sum, p) => {
                const value = parseFloat(p.estimatedValue) || parseFloat(p.currentValue) || parseFloat(p.purchasePrice) || 0;
                const purchasePrice = parseFloat(p.purchasePrice) || 0;
                const loan = purchasePrice * 0.8;
                const equity = value - loan;
                return sum + (isNaN(equity) ? 0 : equity);
            }, 0);
            
            // Calculate total cash flow safely
            const totalCashFlow = availableProperties.reduce((sum, p) => {
                const cashFlow = parseFloat(p.monthlyCashFlow) || parseFloat(p.cashFlow) || 0;
                return sum + (isNaN(cashFlow) ? 0 : cashFlow);
            }, 0);
            
            // Calculate average cash-on-cash safely
            let avgCashOnCash = 0;
            if (availableProperties.length > 0) {
                const validCocReturns = availableProperties
                    .map(p => parseFloat(p.cashOnCashReturn) || parseFloat(p.cocReturn) || 0)
                    .filter(coc => !isNaN(coc) && coc !== 0);
                
                if (validCocReturns.length > 0) {
                    avgCashOnCash = validCocReturns.reduce((sum, coc) => sum + coc, 0) / validCocReturns.length;
                }
            }
            
            // Count temporary properties
            const temporaryCount = properties.filter(p => p._isTemporary).length;
            
            // Update DOM elements
            document.getElementById('totalProperties').textContent = totalProperties;
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('monthlyCashFlow').textContent = formatCurrency(totalCashFlow);
            document.getElementById('avgCashOnCash').textContent = avgCashOnCash.toFixed(1) + '%';
            
            // Update total properties display with warning if there are temporary properties
            if (temporaryCount > 0) {
                const totalPropertiesElement = document.getElementById('totalProperties');
                totalPropertiesElement.innerHTML = `${totalProperties} <span style="color: #f59e0b; font-size: 14px;" title="${temporaryCount} properties saved locally only">⚠️</span>`;
            }
            
        }

        // Update table
        function updateTable() {
            console.log('🔄 updateTable called');
            console.log('📦 Total properties in global array:', properties.length);

            const tbody = document.getElementById('propertyTableBody');
            if (!tbody) {
                console.error('❌ Table body element not found!');
                return;
            }

            tbody.innerHTML = '';
            console.log('🧹 Cleared tbody');

            const filteredProperties = getFilteredProperties();
            console.log('📊 Filtered properties count:', filteredProperties.length);

            // Debug: Check order of properties in table
            if (filteredProperties.length > 0) {
                console.log('📊 Table order - First property details:');
                const firstProp = filteredProperties[0];
                console.log('First property:', {
                    address: firstProp.address,
                    city: firstProp.city,
                    beds: firstProp.beds,
                    baths: firstProp.baths,
                    purchasePrice: firstProp.purchasePrice,
                    monthlyRent: firstProp.monthlyRent
                });
            } else {
                console.warn('⚠️ No filtered properties to display');
                console.log('Total properties in array:', properties.length);
                if (properties.length > 0) {
                    console.log('Sample property from global array:', {
                        address: properties[0].address,
                        city: properties[0].city
                    });
                }
            }

            let successCount = 0;
            let failCount = 0;

            filteredProperties.forEach((property, index) => {
                try {
                    const globalIndex = properties.indexOf(property);
                    const rank = index + 1; // Add rank based on position after sorting
                    console.log(`Creating row ${rank}/${filteredProperties.length} for:`, property.address);
                    const row = createPropertyRow(property, globalIndex, rank);
                    if (row) {
                        tbody.appendChild(row);
                        successCount++;
                        console.log(`✅ Row ${rank} appended successfully`);
                    } else {
                        failCount++;
                        console.error('❌ createPropertyRow returned null for property:', property.address);
                    }
                } catch (error) {
                    failCount++;
                    console.error('❌ Error creating row for property:', property.address, error);
                    console.error('Stack trace:', error.stack);
                }
            });

            console.log(`✅ updateTable completed. Success: ${successCount}, Failed: ${failCount}, Rows in tbody: ${tbody.children.length}`);
        }

        // Create property row
        function createPropertyRow(property, index, rank = null) {
            console.log('🏠 Creating row for:', property.address, 'Index:', index, 'Rank:', rank);

            // Add validation
            if (!property) {
                console.error('❌ Property is null or undefined at index:', index);
                return null;
            }

            try {
                const row = document.createElement('tr');
                row.onclick = () => showPropertyDetails(index);

                const statusClass = property.status === 'sold' ? 'status-sold' :
                                   property.status === 'pending' ? 'status-pending' : 'status-available';

                // Calculate additional metrics if not already calculated
                if (!property.monthlyCashFlow || isNaN(property.monthlyCashFlow)) {
                    console.log('Calculating metrics for:', property.address);
                    try {
                        calculatePropertyMetrics(property);
                    } catch (calcError) {
                        console.error('Error calculating metrics:', calcError);
                        // Set defaults if calculation fails
                        property.monthlyCashFlow = 0;
                        property.annualCashFlow = 0;
                        property.cashOnCashReturn = 0;
                        property.capRate = 0;
                    }
                }

                const cashFlowClass = (property.monthlyCashFlow || 0) >= 0 ? 'positive' : 'negative';
                const annualCashFlowClass = (property.annualCashFlow || 0) >= 0 ? 'positive' : 'negative';

                // Calculate DSCR (Debt Service Coverage Ratio)
                const purchasePrice = Number(property.purchasePrice || property.estimatedValue || 0);
                const downPayment = Number(property.downPayment || (purchasePrice * 0.2));
                const loanAmount = purchasePrice - downPayment;
                const monthlyMortgage = Number(calculateMortgagePayment(loanAmount, 0.065, 30));
                const noi = (Number(property.monthlyRent || property.rentEstimate || 0) * 12) - (Number(calculateTotalExpenses(property)) * 12);
                const annualDebtService = monthlyMortgage * 12;
                const dscr = annualDebtService > 0 ? noi / annualDebtService : 0;

                // Determine styling classes for financial metrics
                const capRateClass = (property.capRate || 0) >= 6 ? 'positive' : 'warning';
                const cashOnCashClass = (property.cashOnCashReturn || 0) >= 8 ? 'positive' : 'warning';
                const dscrClass = dscr >= 1.25 ? 'positive' : dscr >= 1.0 ? 'warning' : 'negative';

                row.innerHTML = `
                <td onclick="event.stopPropagation();" style="text-align: center;">
                    <input type="checkbox" class="property-select-checkbox" data-property-index="${index}" style="cursor: pointer;">
                </td>
                <td onclick="event.stopPropagation();" style="text-align: center;">
                    ${rank !== null ? rank : '-'}
                </td>
                <td>
                    ${property.address || ''}
                    ${property._isTemporary ?
                        '<span style="color: #f59e0b; font-size: 12px; margin-left: 8px;" title="Property saved locally only - Database not connected">⚠️</span>' :
                        ''
                    }
                </td>
                <td style="min-width: 120px;">${property.city || ''}</td>
                <td style="min-width: 100px;">${property.propertyType || 'Single Family'}</td>
                <td style="min-width: 80px; text-align: center;">
                    ${property.beds || property.bedrooms || 0}/${property.baths || property.bathrooms || 0}
                </td>
                <td style="min-width: 80px; text-align: right;">
                    ${property.sqft || property.squareFootage ? (property.sqft || property.squareFootage).toLocaleString() : 'N/A'}
                </td>
                <td style="min-width: 120px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'purchasePrice', ${Number(property.purchasePrice) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.purchasePrice) || 0)}
                    </span>
                </td>
                <td style="min-width: 120px; text-align: right;">
                    ${formatCurrency(Number(property.estimatedValue || property.currentValue || property.purchasePrice) || 0)}
                    ${property.realTimeData && property.estimatedValue ? '<span style="color: #10b981; font-size: 10px;">📊</span>' : ''}
                </td>
                <td style="min-width: 120px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'monthlyRent', ${Number(property.monthlyRent) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.monthlyRent) || 0)}
                    </span>
                </td>
                <td style="min-width: 120px; text-align: right;">
                    ${formatCurrency(Number(property.rentEstimate) || 0)}
                    ${property.realTimeData && property.rentEstimate ? '<span style="color: #10b981; font-size: 10px;">📊</span>' : ''}
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'mortgage', ${Number(property.mortgage) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.mortgage) || 0)}
                    </span>
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'propertyTax', ${Number(property.propertyTax) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.propertyTax) || 0)}
                    </span>
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'insurance', ${Number(property.insurance) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.insurance) || 0)}
                    </span>
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'hoa', ${Number(property.hoa) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.hoa) || 0)}
                    </span>
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'maintenance', ${Number(property.maintenance) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.maintenance) || 0)}
                    </span>
                </td>
                <td style="min-width: 100px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'managementFees', ${Number(property.managementFees) || 0})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(Number(property.managementFees) || 0)}
                    </span>
                </td>
                <td style="min-width: 80px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'vacancyRate', ${property.vacancyRate !== undefined ? Number(property.vacancyRate) : 7})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${Number(property.vacancyRate !== undefined ? property.vacancyRate : 7).toFixed(1)}%
                    </span>
                </td>
                <td class="${cashFlowClass}" style="min-width: 100px; text-align: right; font-weight: 500;">
                    ${formatCurrency(Number(property.monthlyCashFlow) || 0)}
                </td>
                <td class="${annualCashFlowClass}" style="min-width: 100px; text-align: right;">
                    ${formatCurrency(Number(property.annualCashFlow) || 0)}
                </td>
                <td class="${cashOnCashClass}" style="min-width: 90px; text-align: right; font-weight: 500;">
                    ${Number(property.cashOnCashReturn || 0).toFixed(1)}%
                </td>
                <td class="${capRateClass}" style="min-width: 80px; text-align: right; font-weight: 500;">
                    ${Number(property.capRate || 0).toFixed(1)}%
                </td>
                <td style="min-width: 120px; text-align: right;">
                    <span class="editable-field" onclick="event.stopPropagation(); editField(${index}, 'downPayment', ${downPayment})"
                          style="cursor: pointer; border-bottom: 1px dashed var(--border-light); padding: 2px 4px;"
                          title="Click to edit">
                        ${formatCurrency(downPayment)}
                    </span>
                </td>
                <td class="${dscrClass}" style="min-width: 80px; text-align: right; font-weight: 500;">
                    ${dscr > 0 ? Number(dscr).toFixed(2) : 'N/A'}
                </td>
                <td class="${statusClass}" style="min-width: 80px; text-align: center;">
                    ${property.status || 'Available'}
                </td>
                <td onclick="event.stopPropagation()" style="min-width: 80px;">
                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                        <i class="fas fa-sync-alt icon-refresh ${property.rentcastCache ? '' : 'text-warning'}"
                           onclick="refreshProperty(${index})"
                           title="Refresh RentCast Data"></i>
                        ${property.realTimeData ?
                            '<span style="color: #10b981; font-size: 12px;" title="RentCast data available">📊</span>' :
                            '<span style="color: #ef4444; font-size: 12px;" title="No RentCast data - click refresh">❌</span>'
                        }
                    </div>
                </td>
            `;

                console.log('✅ Row created successfully for:', property.address);
                return row;
            } catch (error) {
                console.error('❌ Error in createPropertyRow for:', property.address, error);
                return null;
            }
        }

        // Show property details
        async function showPropertyDetails(index) {
            selectedPropertyIndex = index;
            const property = properties[index];
            
            document.getElementById('modalTitle').innerHTML = `<i class="fas fa-home"></i> ${property.address}`;
            document.getElementById('modalBody').innerHTML = generatePropertyDetailsHTML(property, index);
            document.getElementById('propertyModal').style.display = 'block';
            
            // Fetch and display rental listings
            await fetchAndDisplayRentalListings(property);
            
            // Fetch and display market statistics
            await fetchAndDisplayMarketStats(property);
        }

        // Generate property details HTML
        function generatePropertyDetailsHTML(property, propertyIndex) {
            // Debug log to check property data in modal
            console.log('🏠 Property data in modal:', {
                address: property.address,
                beds: property.beds,
                baths: property.baths,
                sqft: property.sqft,
                yearBuilt: property.yearBuilt,
                estimatedValue: property.estimatedValue,
                currentValue: property.currentValue,
                realTimeData: property.realTimeData
            });

            const purchasePrice = property.purchasePrice || 0;
            const downPayment = property.downPayment || (purchasePrice * 0.2);
            const loanAmount = purchasePrice - downPayment;

            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);

            const totalExpenses = calculateTotalExpenses(property);
            const noi = (property.monthlyRent || 0) * 12 - totalExpenses * 12;
            const capRate = property.purchasePrice > 0 ? (noi / property.purchasePrice) * 100 : 0;
            
            return `
                ${property._isTemporary ? `
                <div style="background: #451a03; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="color: #f59e0b; font-size: 20px;">⚠️</span>
                    <div>
                        <strong style="color: #f59e0b;">Property Saved Locally Only</strong>
                        <p style="color: #fbbf24; margin: 0; font-size: 14px;">This property is not yet saved to the database. It will be persisted when the database connection is restored.</p>
                    </div>
                </div>
                ` : ''}
                <div class="analysis-section">
                    <h3>Property Information</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${property.address || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${property.city || ''}, ${property.state || ''} ${property.zip || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${property.propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms / Bathrooms</div>
                            <div class="detail-value">${property.beds || 0} / ${property.baths || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${(property.sqft || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">${property.yearBuilt || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${property.status || 'Available'}</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>Financial Analysis</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Purchase Price</div>
                            <div class="metric-value editable-field" 
                                 onclick="event.stopPropagation(); editField(${propertyIndex}, 'purchasePrice', ${property.purchasePrice || 0}, true)" 
                                 style="cursor: pointer; border-bottom: 2px dashed var(--border-light);"
                                 title="Click to edit">
                                ${formatCurrency(property.purchasePrice || 0)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Current Value</div>
                            <div class="metric-value">${formatCurrency(property.currentValue || property.purchasePrice || 0)}</div>
                        </div>
                        ${property.estimatedValue ? `
                        <div class="metric-card">
                            <div class="metric-label">Est. Value (RentCast)</div>
                            <div class="metric-value">${formatCurrency(property.estimatedValue)}</div>
                        </div>
                        ` : ''}
                        <div class="metric-card">
                            <div class="metric-label">Monthly Rent</div>
                            <div class="metric-value positive editable-field"
                                 onclick="event.stopPropagation(); editField(${propertyIndex}, 'monthlyRent', ${property.monthlyRent || 0}, true)" 
                                 style="cursor: pointer; border-bottom: 2px dashed var(--border-light);"
                                 title="Click to edit">
                                ${formatCurrency(property.monthlyRent || 0)}
                            </div>
                        </div>
                        ${property.rentEstimate ? `
                        <div class="metric-card">
                            <div class="metric-label">Rent Est. (RentCast)</div>
                            <div class="metric-value positive">${formatCurrency(property.rentEstimate)}</div>
                        </div>
                        ` : ''}
                        <div class="metric-card">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${(property.monthlyCashFlow || 0) >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(property.monthlyCashFlow || 0)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${(property.cashOnCashReturn || 0) >= 8 ? 'positive' : 'warning'}">
                                ${(property.cashOnCashReturn || 0).toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Down Payment</div>
                            <div class="metric-value editable-field"
                                 onclick="event.stopPropagation(); editField(${propertyIndex}, 'downPayment', ${downPayment}, true)"
                                 style="cursor: pointer; border-bottom: 2px dashed var(--border-light);"
                                 title="Click to edit">
                                ${formatCurrency(downPayment)}
                            </div>
                        </div>
                    </div>
                </div>

                ${property.marketStats ? `
                <div class="analysis-section">
                    <h3>Market Statistics (${property.zip})</h3>
                    <div class="metrics-grid">
                        ${property.marketStats.medianRent ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(property.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.medianPrice ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(property.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.avgDaysOnMarket ? `
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${property.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${property.marketStats.inventoryCount ? `
                        <div class="metric-card">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${property.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Additional RentCast Data Section -->
                ${(property.stories || property.garage || property.pool || property.fireplace || property.basement || 
                   property.airConditioning || property.heating || property.foundation || property.roofType || 
                   property.exteriorWall || property.architecturalStyle) ? `
                <div class="analysis-section">
                    <h3>Property Features & Details</h3>
                    <div class="property-details">
                        ${property.stories ? `
                        <div class="detail-item">
                            <div class="detail-label">Stories</div>
                            <div class="detail-value">${property.stories}</div>
                        </div>
                        ` : ''}
                        ${property.garage ? `
                        <div class="detail-item">
                            <div class="detail-label">Garage Spaces</div>
                            <div class="detail-value">${property.garage}</div>
                        </div>
                        ` : ''}
                        ${property.lotSize ? `
                        <div class="detail-item">
                            <div class="detail-label">Lot Size</div>
                            <div class="detail-value">${property.lotSize.toLocaleString()} sq ft</div>
                        </div>
                        ` : ''}
                        ${property.pool !== undefined ? `
                        <div class="detail-item">
                            <div class="detail-label">Pool</div>
                            <div class="detail-value">${property.pool ? 'Yes' : 'No'}</div>
                        </div>
                        ` : ''}
                        ${property.fireplace !== undefined ? `
                        <div class="detail-item">
                            <div class="detail-label">Fireplace</div>
                            <div class="detail-value">${property.fireplace ? 'Yes' : 'No'}</div>
                        </div>
                        ` : ''}
                        ${property.basement !== undefined ? `
                        <div class="detail-item">
                            <div class="detail-label">Basement</div>
                            <div class="detail-value">${property.basement ? 'Yes' : 'No'}</div>
                        </div>
                        ` : ''}
                        ${property.airConditioning !== undefined ? `
                        <div class="detail-item">
                            <div class="detail-label">Air Conditioning</div>
                            <div class="detail-value">${property.airConditioning ? 'Yes' : 'No'}</div>
                        </div>
                        ` : ''}
                        ${property.heating ? `
                        <div class="detail-item">
                            <div class="detail-label">Heating</div>
                            <div class="detail-value">${property.heating}</div>
                        </div>
                        ` : ''}
                        ${property.foundation ? `
                        <div class="detail-item">
                            <div class="detail-label">Foundation</div>
                            <div class="detail-value">${property.foundation}</div>
                        </div>
                        ` : ''}
                        ${property.roofType ? `
                        <div class="detail-item">
                            <div class="detail-label">Roof Type</div>
                            <div class="detail-value">${property.roofType}</div>
                        </div>
                        ` : ''}
                        ${property.exteriorWall ? `
                        <div class="detail-item">
                            <div class="detail-label">Exterior</div>
                            <div class="detail-value">${property.exteriorWall}</div>
                        </div>
                        ` : ''}
                        ${property.architecturalStyle ? `
                        <div class="detail-item">
                            <div class="detail-label">Style</div>
                            <div class="detail-value">${property.architecturalStyle}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Tax & Assessment Data -->
                ${(property.taxAssessedValue || property.taxAssessedYear || property.propertyTaxes || 
                   property.lastSaleDate || property.lastSalePrice) ? `
                <div class="analysis-section">
                    <h3>Tax & Sales History</h3>
                    <div class="property-details">
                        ${property.taxAssessedValue ? `
                        <div class="detail-item">
                            <div class="detail-label">Tax Assessed Value</div>
                            <div class="detail-value">${formatCurrency(property.taxAssessedValue)}</div>
                        </div>
                        ` : ''}
                        ${property.taxAssessedYear ? `
                        <div class="detail-item">
                            <div class="detail-label">Assessment Year</div>
                            <div class="detail-value">${property.taxAssessedYear}</div>
                        </div>
                        ` : ''}
                        ${property.propertyTaxes ? `
                        <div class="detail-item">
                            <div class="detail-label">Annual Property Tax</div>
                            <div class="detail-value">${formatCurrency(property.propertyTaxes)}</div>
                        </div>
                        ` : ''}
                        ${property.lastSaleDate ? `
                        <div class="detail-item">
                            <div class="detail-label">Last Sale Date</div>
                            <div class="detail-value">${new Date(property.lastSaleDate).toLocaleDateString()}</div>
                        </div>
                        ` : ''}
                        ${property.lastSalePrice ? `
                        <div class="detail-item">
                            <div class="detail-label">Last Sale Price</div>
                            <div class="detail-value">${formatCurrency(property.lastSalePrice)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Owner Information -->
                ${(property.ownerName || property.ownerType || property.ownerOccupied !== undefined) ? `
                <div class="analysis-section">
                    <h3>Owner Information</h3>
                    <div class="property-details">
                        ${property.ownerName ? `
                        <div class="detail-item">
                            <div class="detail-label">Owner Name</div>
                            <div class="detail-value">${property.ownerName}</div>
                        </div>
                        ` : ''}
                        ${property.ownerType ? `
                        <div class="detail-item">
                            <div class="detail-label">Owner Type</div>
                            <div class="detail-value">${property.ownerType}</div>
                        </div>
                        ` : ''}
                        ${property.ownerOccupied !== undefined ? `
                        <div class="detail-item">
                            <div class="detail-label">Owner Occupied</div>
                            <div class="detail-value">${property.ownerOccupied ? 'Yes' : 'No'}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Value Ranges -->
                ${(property.rentRangeLow || property.rentRangeHigh || property.priceRangeLow || property.priceRangeHigh) ? `
                <div class="analysis-section">
                    <h3>Estimated Ranges</h3>
                    <div class="metrics-grid">
                        ${(property.rentRangeLow || property.rentRangeHigh) ? `
                        <div class="metric-card">
                            <div class="metric-label">Rent Range</div>
                            <div class="metric-value positive">
                                ${property.rentRangeLow ? formatCurrency(property.rentRangeLow) : '?'} - 
                                ${property.rentRangeHigh ? formatCurrency(property.rentRangeHigh) : '?'}
                            </div>
                        </div>
                        ` : ''}
                        ${(property.priceRangeLow || property.priceRangeHigh) ? `
                        <div class="metric-card">
                            <div class="metric-label">Value Range</div>
                            <div class="metric-value">
                                ${property.priceRangeLow ? formatCurrency(property.priceRangeLow) : '?'} - 
                                ${property.priceRangeHigh ? formatCurrency(property.priceRangeHigh) : '?'}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Rental Listings Section -->
                <div class="analysis-section" style="margin-top: 20px;">
                    <h3>🏠 Comparable Rental Listings</h3>
                    <div id="rentalListingsLoading" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading rental listings...
                    </div>
                    <div id="rentalListingsContent" style="display: none;">
                        <!-- Rental listings will be populated here -->
                    </div>
                </div>

                <div id="aiAnalysisSection" style="display: none; margin: 20px 0;">
                    <h3>🤖 AI Investment Analysis</h3>
                    <div id="aiAnalysisContent" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; border: 1px solid var(--border-color);"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generatePropertyAIAnalysis(${selectedPropertyIndex})" style="background: #8b5cf6;">
                        <i class="fas fa-brain"></i> AI Analysis
                    </button>
                    ${property.status !== 'sold' ? `
                        <button class="btn btn-secondary" onclick="editProperty(${selectedPropertyIndex})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-success" onclick="markAsSold(${selectedPropertyIndex})">
                            <i class="fas fa-check"></i> Mark as Sold
                        </button>
                    ` : ''}
                    <button class="btn btn-danger" onclick="deleteProperty(${selectedPropertyIndex})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
        }

        // Refresh property data
        async function refreshProperty(index) {
            const property = properties[index];
            if (!property) {
                console.error('No property found at index:', index);
                return;
            }
            
            try {
                // Animate the refresh icon
                const rows = document.querySelectorAll('#propertyTableBody tr');
                const refreshIcon = rows[index]?.querySelector('.icon-refresh');
                if (refreshIcon) {
                    refreshIcon.style.animation = 'spin 1s linear infinite';
                }
                
                console.log(`🔄 Refreshing property ${index}:`, {
                    address: property.address,
                    city: property.city,
                    state: property.state,
                    zip: property.zip
                });
                
                // Validate address components
                if (!property.address || !property.city || !property.state) {
                    throw new Error(`Incomplete address for property: ${property.address || 'No address'}`);
                }
                
                // Check if we have recent cached data (less than 24 hours old)
                const cacheAge = property.rentcastCache?.timestamp ? 
                    (Date.now() - new Date(property.rentcastCache.timestamp).getTime()) / (1000 * 60 * 60) : Infinity;
                
                if (cacheAge < 24 && property.rentcastCache?.data) {
                    console.log('📦 Cache is recent (< 24 hours old), consider using cached data');
                }
                
                // Fetch updated data from RentCast
                const fullAddress = `${property.address}, ${property.city}, ${property.state} ${property.zip}`;
                console.log('📍 Full address for API call:', fullAddress);
                console.log('🎯 API Call Strategy: Optimized to minimize calls');
                
                const rentcastData = await fetchRentCastData({
                    streetAddress: property.address,
                    city: property.city,
                    state: property.state,
                    zip: property.zip
                });
                
                console.log('📊 RentCast API response:', rentcastData);
                if (rentcastData?.data?.apiCallCount) {
                    console.log(`🎯 Total API calls made: ${rentcastData.data.apiCallCount}`);
                }
                
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    console.log('✅ RentCast data found, updating property...');
                    
                    // Store original values for comparison
                    const originalRent = property.monthlyRent;
                    const originalValue = property.currentValue;
                    
                    // Cache the full RentCast API response
                    property.rentcastCache = {
                        data: rentcastData.data,
                        timestamp: new Date().toISOString(),
                        success: true
                    };
                    
                    // Update property with new data - mark as real-time data
                    property.realTimeData = true;
                    property.lastRentCastUpdate = new Date().toISOString();
                    
                    // Update with fetched data - preserve our field naming convention
                    const mappedData = {
                        ...rentcastData.data,
                        // Ensure we have both sets of field names for compatibility
                        beds: rentcastData.data.beds || rentcastData.data.bedrooms,
                        baths: rentcastData.data.baths || rentcastData.data.bathrooms,
                        sqft: rentcastData.data.sqft || rentcastData.data.squareFootage,
                        // Also keep the database column names
                        bedrooms: rentcastData.data.beds || rentcastData.data.bedrooms,
                        bathrooms: rentcastData.data.baths || rentcastData.data.bathrooms,
                        square_footage: rentcastData.data.sqft || rentcastData.data.squareFootage,
                        // Ensure yearBuilt is set
                        yearBuilt: rentcastData.data.yearBuilt,
                        year_built: rentcastData.data.yearBuilt,
                        // CRITICAL: Ensure rentEstimate and estimatedValue are properly set
                        rentEstimate: rentcastData.data.rentEstimate || rentcastData.data.rent_estimate || 
                                     property.rentEstimate || property.monthlyRent,
                        estimatedValue: rentcastData.data.estimatedValue || rentcastData.data.value_estimate || 
                                       rentcastData.data.currentValue || property.estimatedValue || property.purchasePrice,
                        // Also set the alternative field names for compatibility
                        rent_estimate: rentcastData.data.rentEstimate || rentcastData.data.rent_estimate,
                        value_estimate: rentcastData.data.estimatedValue || rentcastData.data.value_estimate,
                        currentValue: rentcastData.data.estimatedValue || rentcastData.data.value_estimate || 
                                     rentcastData.data.currentValue || property.currentValue || property.purchasePrice
                    };
                    
                    Object.assign(property, mappedData);
                    
                    // Debug log to check property data
                    console.log('📊 Property after RentCast update:', {
                        basicInfo: {
                            beds: property.beds,
                            baths: property.baths,
                            sqft: property.sqft,
                            yearBuilt: property.yearBuilt
                        },
                        pricing: {
                            estimatedValue: property.estimatedValue,
                            currentValue: property.currentValue,
                            rentEstimate: property.rentEstimate,
                            rentRange: `${property.rentRangeLow || 'N/A'} - ${property.rentRangeHigh || 'N/A'}`,
                            priceRange: `${property.priceRangeLow || 'N/A'} - ${property.priceRangeHigh || 'N/A'}`
                        },
                        features: {
                            pool: property.pool,
                            garage: property.garage,
                            basement: property.basement,
                            fireplace: property.fireplace,
                            stories: property.stories,
                            lotSize: property.lotSize
                        },
                        taxInfo: {
                            taxAssessedValue: property.taxAssessedValue,
                            taxAssessedYear: property.taxAssessedYear,
                            propertyTaxes: property.propertyTaxes
                        },
                        ownerInfo: {
                            ownerName: property.ownerName,
                            ownerType: property.ownerType,
                            ownerOccupied: property.ownerOccupied
                        },
                        saleHistory: {
                            lastSaleDate: property.lastSaleDate,
                            lastSalePrice: property.lastSalePrice
                        }
                    });
                    
                    // Recalculate financial metrics
                    calculatePropertyMetrics(property);
                    
                    // Log what changed
                    console.log('📈 Property updated:', {
                        rentChange: `${originalRent} → ${property.monthlyRent || property.rentEstimate}`,
                        valueChange: `${originalValue} → ${property.currentValue || property.estimatedValue}`,
                        hasMarketStats: !!property.marketStats
                    });
                    
                    // IMPORTANT: Force save to database with updated RentCast data
                    console.log('💾 Saving RentCast data to database for property:', property.id || 'No ID');
                    
                    // Check if property has a valid integer ID
                    const hasValidId = property.id && Number.isInteger(property.id) && property.id > 0;
                    
                    if (!hasValidId) {
                        console.warn('⚠️ Property has invalid or missing database ID:', property.id, 'type:', typeof property.id);
                        
                        // First check if property already exists in database by address
                        try {
                            const checkResponse = await fetch(`/api/properties/search?address=${encodeURIComponent(property.address)}&city=${encodeURIComponent(property.city)}&state=${encodeURIComponent(property.state)}`);
                            
                            if (checkResponse.ok) {
                                const checkData = await checkResponse.json();
                                if (checkData.success && checkData.data && checkData.data.id) {
                                    // Property exists, update with correct ID
                                    property.id = checkData.data.id;
                                    console.log('✅ Found existing property in database with ID:', property.id);
                                    
                                    // CRITICAL: Update the property in the array to ensure the new ID persists
                                    properties[index].id = checkData.data.id;
                                    
                                    // Save to localStorage immediately to persist the correct ID
                                    localStorage.setItem('properties', JSON.stringify(properties));
                                    console.log('💾 Updated property ID in localStorage');
                                } else {
                                    // Property doesn't exist, create it
                                    console.log('🔄 Property not found in database, creating new one');
                                    const sanitizedProperty = sanitizePropertyForDatabase(property);
                                    
                                    const createResponse = await fetch('/api/properties', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(sanitizedProperty)
                                    });
                                    
                                    if (createResponse.ok) {
                                        const createData = await createResponse.json();
                                        if (createData.success && createData.data && createData.data.id) {
                                            property.id = createData.data.id;
                                            properties[index].id = createData.data.id;
                                            console.log('✅ Property created in database with ID:', property.id);
                                            
                                            // Save to localStorage to persist the new ID
                                            localStorage.setItem('properties', JSON.stringify(properties));
                                        }
                                    } else {
                                        const errorData = await createResponse.json();
                                        console.error('❌ Failed to create property:', errorData.error);
                                        
                                        // If it's a duplicate error, try to find the existing property
                                        if (errorData.error?.includes('already exists')) {
                                            console.log('🔍 Duplicate detected, searching for existing property...');
                                            // The property was created between our check and create attempt
                                            // Try the search again
                                            const recheckResponse = await fetch(`/api/properties/search?address=${encodeURIComponent(property.address)}&city=${encodeURIComponent(property.city)}&state=${encodeURIComponent(property.state)}`);
                                            if (recheckResponse.ok) {
                                                const recheckData = await recheckResponse.json();
                                                if (recheckData.success && recheckData.data && recheckData.data.id) {
                                                    property.id = recheckData.data.id;
                                                    properties[index].id = recheckData.data.id;
                                                    console.log('✅ Found existing property after duplicate error, ID:', property.id);
                                                    
                                                    // Save to localStorage to persist the correct ID
                                                    localStorage.setItem('properties', JSON.stringify(properties));
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('❌ Failed to check/create property in database:', error);
                        }
                    }
                    
                    // Save all properties (this will update the database)
                    await saveProperties();
                    updateDisplay();
                    
                    // Success - data refreshed and saved
                    console.log('✅ Property data refreshed and saved successfully');
                    
                } else {
                    console.warn('⚠️ No RentCast data returned:', rentcastData);
                    
                    // Try to get specific error details
                    let errorMessage = 'No data available for this address from RentCast API.';
                    if (rentcastData && rentcastData.error) {
                        errorMessage = `API Error: ${rentcastData.error}`;
                    }
                    
                    // Log warning without interrupting the user
                    console.warn(`⚠️ Refresh completed but no new data found for ${fullAddress}. ${errorMessage}`);
                }
            } catch (error) {
                console.error('❌ Error refreshing property:', error);
                // Only log errors to console, don't interrupt the user
                console.error(`Failed to refresh data for ${property.address || 'Unknown address'}:`, error.message);
            } finally {
                // Stop animation
                const rows = document.querySelectorAll('#propertyTableBody tr');
                const refreshIcon = rows[index]?.querySelector('.icon-refresh');
                if (refreshIcon) {
                    refreshIcon.style.animation = '';
                }
            }
        }

        // Fetch RentCast data
        async function fetchRentCastData(address, forceRefresh = true) {
            let apiCallCount = 0; // Track number of API calls
            try {
                console.log('🌐 Fetching RentCast data for:', address);
                
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                console.log('📋 API Parameters:', params.toString());
                
                // OPTIMIZATION: Try to get all data from the properties endpoint first
                console.log('🎯 Making single API call to properties endpoint...');
                apiCallCount++;
                const response = await fetch(`/api/rentcast/properties?${params}`);
                const data = await response.json();
                
                console.log('🏘️ Properties API Response:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    const property = data.data[0];
                    console.log('✅ Found property data:', property);
                    
                    // DEBUG: Log ALL fields returned by RentCast to identify correct field names
                    console.log('🔍 ALL RentCast fields:', Object.keys(property));
                    console.log('📋 Full RentCast response:', JSON.stringify(property, null, 2));
                    
                    // CRITICAL DEBUG: Identify fields that might contain rent/value data
                    console.log('\n🚨 FIELD ANALYSIS - Looking for rent/value fields:');
                    Object.entries(property).forEach(([key, value]) => {
                        if (value !== null && value !== undefined && value !== '' && value !== 0) {
                            // Check if this might be a rent field
                            const keyLower = key.toLowerCase();
                            if (keyLower.includes('rent') || keyLower.includes('monthly') || 
                                (typeof value === 'number' && value > 500 && value < 10000)) {
                                console.log(`  💰 Possible RENT field: ${key} = ${value}`);
                            }
                            // Check if this might be a value/price field
                            if (keyLower.includes('value') || keyLower.includes('price') || 
                                keyLower.includes('estimate') || keyLower.includes('worth') ||
                                (typeof value === 'number' && value > 50000)) {
                                console.log(`  🏠 Possible VALUE field: ${key} = ${value}`);
                            }
                        }
                    });
                    console.log('🚨 END FIELD ANALYSIS\n');
                    
                    // Check if property data already includes rent and value estimates
                    const hasRentEstimate = property.rent || property.rentEstimate || property.rentRangeLow;
                    const hasValueEstimate = property.price || property.value || property.estimatedValue;
                    
                    console.log('📋 Checking existing data:', {
                        hasRentEstimate,
                        hasValueEstimate,
                        rentValue: property.rent || property.rentEstimate || property.rentRangeLow,
                        valueEstimate: property.price || property.value || property.estimatedValue
                    });
                    
                    // Only fetch additional data if not already present
                    let rentData = null;
                    let valueData = null;
                    let marketData = null;
                    
                    // OPTIMIZATION: The properties endpoint often includes rent/value estimates
                    // Check if we actually need additional calls
                    console.log('🔍 Property data contains:', {
                        rentFields: {
                            rent: property.rent,
                            rentRangeLow: property.rentRangeLow,
                            rentRangeHigh: property.rentRangeHigh
                        },
                        valueFields: {
                            price: property.price,
                            priceRangeLow: property.priceRangeLow,
                            priceRangeHigh: property.priceRangeHigh
                        }
                    });
                    
                    // SMART OPTIMIZATION: Check if properties endpoint has rent/value data
                    // If not, make ONE additional call to get the estimates
                    let needsEstimates = false;
                    
                    // Check if we got rent/value estimates from properties endpoint
                    const gotRentFromProperties = property.rent || property.rentEstimate || 
                                                 property.monthlyRent || property.rentValue ||
                                                 property.rentRangeLow || property.rentMin ||
                                                 property.rentLow || property.minRent;
                    
                    const gotValueFromProperties = property.price || property.value || 
                                                  property.estimatedValue || property.marketValue ||
                                                  property.priceRangeLow || property.priceMin ||
                                                  property.priceLow || property.minPrice ||
                                                  property.currentValue || property.assessedValue;
                    
                    console.log('📊 Data from properties endpoint:', {
                        hasRent: !!gotRentFromProperties,
                        rentValue: gotRentFromProperties || 'NOT FOUND',
                        hasValue: !!gotValueFromProperties,
                        valueAmount: gotValueFromProperties || 'NOT FOUND'
                    });
                    
                    // If we didn't get estimates from properties endpoint, fetch them
                    if (!gotRentFromProperties || !gotValueFromProperties) {
                        console.log('⚠️ Missing estimates from properties endpoint, fetching additional data...');
                        
                        // Make parallel calls to minimize total time
                        const promises = [];
                        
                        // Need rent estimate?
                        if (!gotRentFromProperties) {
                            console.log('📊 Fetching rent estimate...');
                            promises.push(
                                fetch(`/api/rentcast/rent-estimate?${params}`)
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success && result.data) {
                                            console.log('✅ Got rent estimate:', result.data);
                                            rentData = result.data;
                                            // RentCast rent-estimate endpoint typically returns: { rent, rentRangeLow, rentRangeHigh }
                                            if (result.data.rent) {
                                                property.rent = result.data.rent;
                                                property.rentEstimate = result.data.rent;
                                            }
                                        }
                                    })
                                    .catch(err => console.error('Error fetching rent estimate:', err))
                            );
                        }
                        
                        // Need value estimate?
                        if (!gotValueFromProperties) {
                            console.log('🏠 Fetching value estimate from /api/rentcast/value-estimate...');
                            promises.push(
                                fetch(`/api/rentcast/value-estimate?${params}`)
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success && result.data) {
                                            console.log('✅ Got value estimate:', result.data);
                                            valueData = result.data;
                                            // RentCast value-estimate endpoint typically returns: { price, priceRangeLow, priceRangeHigh }
                                            if (result.data.price || result.data.value) {
                                                property.estimatedValue = result.data.price || result.data.value;
                                                property.price = result.data.price || result.data.value;
                                            }
                                        }
                                    })
                                    .catch(err => console.error('Error fetching value estimate:', err))
                            );
                        }
                        
                        // Wait for all promises to complete
                        if (promises.length > 0) {
                            apiCallCount += promises.length;
                            await Promise.all(promises);
                        }
                    }
                    
                    console.log(`📊 Total API calls: ${apiCallCount}`);
                    
                    // Extract ALL available data from RentCast response
                    // This preserves all fields returned by the API for maximum data capture
                    const extractedData = {
                        // First, preserve ALL original data from RentCast
                        ...property,
                        
                        // Map RentCast field names to our application's field names
                        // These mappings ensure compatibility with the UI
                        beds: property.bedrooms || property.beds,
                        baths: property.bathrooms || property.baths,
                        sqft: property.squareFootage || property.squareFeet || property.sqft,
                        yearBuilt: property.yearBuilt,
                        
                        // Preserve both field name variations for maximum compatibility
                        bedrooms: property.bedrooms || property.beds,
                        bathrooms: property.bathrooms || property.baths,
                        squareFootage: property.squareFootage || property.squareFeet || property.sqft,
                        square_footage: property.squareFootage || property.squareFeet || property.sqft,
                        year_built: property.yearBuilt,
                        
                        // Extract rent data - check ALL possible field names RentCast might use
                        // Including data from the separate rent-estimate endpoint if it was called
                        rentEstimate: property.rent || property.rentEstimate || property.rentEst || property.rentValue || 
                                    property.monthlyRent || property.estimatedRent || property.estimatedMonthlyRent ||
                                    property.rentRangeLow || property.rentLow || property.minRent ||
                                    rentData?.rent || rentData?.rentEstimate,
                        rent_estimate: property.rent || property.rentEstimate || property.rentEst || property.rentValue || 
                                     property.monthlyRent || property.estimatedRent || property.estimatedMonthlyRent ||
                                     property.rentRangeLow || property.rentLow || property.minRent ||
                                     rentData?.rent || rentData?.rentEstimate,
                        rentRangeLow: property.rentRangeLow || rentData?.rentRangeLow,
                        rentRangeHigh: property.rentRangeHigh || rentData?.rentRangeHigh,
                        
                        // Extract value/price data - check ALL possible field names RentCast might use
                        // Including data from BOTH rent-estimate and value-estimate endpoints
                        estimatedValue: property.price || property.value || property.valueEstimate || property.estimatedValue || 
                                      property.estimatedPrice || property.marketValue || property.currentValue || 
                                      property.assessedValue || property.priceEst || property.valueEst ||
                                      property.priceRangeLow || property.priceLow || property.minPrice ||
                                      valueData?.price || valueData?.value || valueData?.estimatedValue ||
                                      rentData?.price || rentData?.value || rentData?.estimatedValue,
                        value_estimate: property.price || property.value || property.valueEstimate || property.estimatedValue || 
                                      property.estimatedPrice || property.marketValue || property.currentValue || 
                                      property.assessedValue || property.priceEst || property.valueEst ||
                                      property.priceRangeLow || property.priceLow || property.minPrice ||
                                      valueData?.price || valueData?.value || valueData?.estimatedValue ||
                                      rentData?.price || rentData?.value || rentData?.estimatedValue,
                        priceRangeLow: property.priceRangeLow || valueData?.priceRangeLow,
                        priceRangeHigh: property.priceRangeHigh || valueData?.priceRangeHigh,
                        
                        // Property characteristics
                        propertyType: property.propertyType || property.type,
                        lotSize: property.lotSize || property.lotSquareFeet,
                        county: property.county,
                        
                        // Additional RentCast fields that might be available
                        // Tax and assessment data
                        taxAssessedValue: property.taxAssessedValue || property.assessedValue,
                        taxAssessedYear: property.taxAssessedYear || property.assessedYear,
                        propertyTaxes: property.propertyTaxes || property.taxes,
                        
                        // Owner information
                        ownerName: property.ownerName,
                        ownerType: property.ownerType,
                        ownerOccupied: property.ownerOccupied,
                        
                        // Property features
                        stories: property.stories || property.numStories,
                        garage: property.garage || property.garageSpaces,
                        pool: property.pool,
                        fireplace: property.fireplace,
                        basement: property.basement,
                        airConditioning: property.airConditioning || property.ac,
                        heating: property.heating,
                        
                        // Construction details
                        foundation: property.foundation,
                        roofType: property.roofType || property.roof,
                        exteriorWall: property.exteriorWall || property.exterior,
                        architecturalStyle: property.architecturalStyle || property.style,
                        
                        // Sale history
                        lastSaleDate: property.lastSaleDate || property.soldDate,
                        lastSalePrice: property.lastSalePrice || property.soldPrice,
                        
                        // Market data
                        marketStats: marketData || {},
                        daysOnMarket: property.daysOnMarket,
                        listingDate: property.listingDate,
                        
                        // Preserve any other fields that RentCast might return
                        // This ensures we don't lose any data
                        ...(property.additionalDetails || {}),
                        
                        // Add metadata
                        dataSource: 'RentCast API',
                        fetchedAt: new Date().toISOString(),
                        realTimeData: true,
                        apiCallCount: apiCallCount // Track how many API calls were made
                    };
                    
                    console.log('📊 Extracted RentCast data with fields:', Object.keys(extractedData).length);
                    console.log('🔍 Sample of extracted data:', {
                        basicInfo: {
                            beds: extractedData.beds,
                            baths: extractedData.baths,
                            sqft: extractedData.sqft,
                            yearBuilt: extractedData.yearBuilt
                        },
                        pricing: {
                            rentEstimate: extractedData.rentEstimate,
                            estimatedValue: extractedData.estimatedValue,
                            rentRange: `${extractedData.rentRangeLow || 'N/A'} - ${extractedData.rentRangeHigh || 'N/A'}`,
                            priceRange: `${extractedData.priceRangeLow || 'N/A'} - ${extractedData.priceRangeHigh || 'N/A'}`
                        },
                        features: {
                            pool: extractedData.pool,
                            garage: extractedData.garage,
                            basement: extractedData.basement
                        }
                    });
                    
                    // CRITICAL DEBUG: Show what rent/value fields we actually found
                    console.log('🎯 CRITICAL VALUES CHECK:', {
                        rentEstimate: extractedData.rentEstimate || 'NOT FOUND',
                        estimatedValue: extractedData.estimatedValue || 'NOT FOUND',
                        alternativeRentFields: {
                            rent: property.rent,
                            rentEstimate: property.rentEstimate,
                            rentValue: property.rentValue,
                            monthlyRent: property.monthlyRent,
                            fromRentAPI: rentData?.rent
                        },
                        alternativeValueFields: {
                            value: property.value,
                            price: property.price,
                            estimatedValue: property.estimatedValue,
                            marketValue: property.marketValue,
                            fromValueAPI: valueData?.price || valueData?.value
                        },
                        apiCallsDetail: {
                            totalCalls: apiCallCount,
                            propertiesEndpoint: 'Called',
                            rentEndpoint: rentData ? 'Called' : 'Not called',
                            valueEndpoint: valueData ? 'Called' : 'Not called'
                        }
                    });
                    
                    return {
                        success: true,
                        data: extractedData
                    };
                } else {
                    console.warn('⚠️ Properties API returned no data:', data);
                    
                    // NO FALLBACK CALLS - Keep it to 1 API call only
                    console.log('⚠️ Properties API returned no data - NOT making additional calls');
                    console.log('📊 Total API calls: 1 (as requested)');
                    
                    return { 
                        success: false, 
                        error: data.error || 'No property data found',
                        message: data.message || 'The address may not exist in RentCast database'
                    };
                }
                
                console.log(`📊 Total RentCast API calls made: ${apiCallCount}`);
            } catch (error) {
                console.error('❌ Error fetching RentCast data:', error);
                console.log(`📊 Total RentCast API calls made before error: ${apiCallCount}`);
                return { 
                    success: false, 
                    error: error.message,
                    message: 'Network or server error occurred'
                };
            }
        }

        // Fetch rent estimate
        async function fetchRentEstimate(address) {
            try {
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                const response = await fetch(`/api/rentcast/rent-estimate?${params}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching rent estimate:', error);
            }
            return null;
        }

        // Fetch value estimate
        async function fetchValueEstimate(address) {
            try {
                const params = new URLSearchParams({
                    address: address.streetAddress || address.address,
                    city: address.city,
                    state: address.state,
                    zipcode: address.zip
                });
                
                const response = await fetch(`/api/rentcast/value-estimate?${params}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching value estimate:', error);
            }
            return null;
        }

        // Fetch market statistics
        async function fetchMarketStats(zipCode) {
            try {
                const response = await fetch(`/api/rentcast/market-stats?zipCode=${zipCode}&historyRange=12`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (error) {
                console.error('Error fetching market stats:', error);
            }
            return null;
        }

        // Fetch and display rental listings
        // Fetch and display market statistics
        async function fetchAndDisplayMarketStats(property) {
            try {
                console.log('📈 Displaying market stats section for:', property.zip);
                
                // Add market stats section
                const marketStatsHTML = `
                    <div class="property-section">
                        <h3><i class="fas fa-chart-line"></i> Market Statistics</h3>
                        <div id="marketStatsContent" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>Market statistics are not loaded to minimize API usage.</p>
                            <p style="margin-top: 10px; color: var(--text-muted);">
                                To view current market statistics, please click the refresh icon 
                                <i class="fas fa-sync-alt" style="color: var(--accent-primary);"></i> 
                                on this property in the main table.
                            </p>
                        </div>
                    </div>
                `;
                
                // Add to modal after rental listings
                const rentalSection = document.querySelector('#rentalListingsContent').parentElement.parentElement;
                if (rentalSection) {
                    rentalSection.insertAdjacentHTML('afterend', marketStatsHTML);
                }
                
                console.log('📦 Skipping market stats API call - use refresh button to load data');
                
                // IMPORTANT: API calls removed to prevent excessive usage
                // Market stats are only fetched when user explicitly clicks refresh
                // This follows our caching strategy to minimize RentCast API calls
            } catch (error) {
                console.error('Error displaying market stats section:', error);
                const statsContent = document.getElementById('marketStatsContent');
                if (statsContent) {
                    statsContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>Unable to display market statistics section.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Display market statistics
        function displayMarketStats(stats, property) {
            document.getElementById('marketStatsLoading').style.display = 'none';
            document.getElementById('marketStatsContent').style.display = 'block';
            
            const html = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${stats.rentalData?.medianRent ? formatCurrency(stats.rentalData.medianRent) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Median Sale Price</div>
                            <div class="metric-value">${stats.saleData?.medianPrice ? formatCurrency(stats.saleData.medianPrice) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${stats.rentalData?.averageDaysOnMarket ? Math.round(stats.rentalData.averageDaysOnMarket) : 'N/A'} days</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Rentals</div>
                            <div class="metric-value">${stats.rentalData?.totalListings || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${stats.rentalData || stats.salesData ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-secondary);">Historical Trends</h4>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                        ${stats.rentalData && stats.rentalData.history ? `
                            <div style="margin-bottom: 10px;">
                                <strong>Rental Market (Last 3 months):</strong><br>
                                ${Object.entries(stats.rentalData.history).slice(-3).map(([key, data]) => 
                                    `${key}: ${formatCurrency(data.medianRent)} (${data.totalListings} listings)`
                                ).join(', ')}
                            </div>
                        ` : ''}
                        ${stats.saleData && stats.saleData.history ? `
                            <div>
                                <strong>Sales Market (Last 3 months):</strong><br>
                                ${Object.entries(stats.saleData.history).slice(-3).map(([key, data]) => 
                                    `${key}: ${formatCurrency(data.medianPrice)} (${data.totalListings} listings)`
                                ).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <p style="margin: 0; font-size: 0.9em;">
                        <strong>📊 Market Context:</strong> 
                        ${getMarketContext(stats, property)}
                    </p>
                </div>
            `;
            
            document.getElementById('marketStatsContent').innerHTML = html;
        }
        
        // Get market context message
        function getMarketContext(stats, property) {
            if (!stats.rentalData?.medianRent) return 'Limited market data available for this ZIP code.';
            
            const rentRatio = property.rentEstimate / stats.rentalData.medianRent;
            if (rentRatio > 1.1) {
                return `This property's estimated rent is ${((rentRatio - 1) * 100).toFixed(0)}% above the ZIP code median. This could indicate premium features or a desirable location within the area.`;
            } else if (rentRatio < 0.9) {
                return `This property's estimated rent is ${((1 - rentRatio) * 100).toFixed(0)}% below the ZIP code median. Consider evaluating if improvements could justify higher rent.`;
            } else {
                return 'This property aligns well with the median rental rates in the ZIP code.';
            }
        }

        async function fetchAndDisplayRentalListings(property) {
            try {
                console.log('🏠 Displaying rental listings section for:', property.address);
                // Hide loading indicator immediately
                document.getElementById('rentalListingsLoading').style.display = 'none';
                document.getElementById('rentalListingsContent').style.display = 'block';
                
                // Instead of making API calls, show a message to use the refresh button
                document.getElementById('rentalListingsContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                        <p>Rental listings data is not loaded to minimize API usage.</p>
                        <p style="margin-top: 10px; color: var(--text-muted);">
                            To view current rental listings, please click the refresh icon 
                            <i class="fas fa-sync-alt" style="color: var(--accent-primary);"></i> 
                            on this property in the main table.
                        </p>
                    </div>
                `;
                
                console.log('📦 Skipping rental listings API call - use refresh button to load data');
                
                // IMPORTANT: API calls removed to prevent excessive usage
                // Rental listings are only fetched when user explicitly clicks refresh
                // This follows our caching strategy to minimize RentCast API calls
            } catch (error) {
                console.error('Error in rental listings section:', error);
                document.getElementById('rentalListingsLoading').style.display = 'none';
                document.getElementById('rentalListingsContent').style.display = 'block';
                document.getElementById('rentalListingsContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                        <p>Unable to display rental listings section.</p>
                    </div>
                `;
            }
        }

        // Show no listings message with helpful information
        function showNoListingsMessage(property) {
            document.getElementById('rentalListingsLoading').style.display = 'none';
            document.getElementById('rentalListingsContent').style.display = 'block';
            document.getElementById('rentalListingsContent').innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <i class="fas fa-home" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;"></i>
                    <p style="font-weight: 500; margin-bottom: 15px;">No rental listings found in the area.</p>
                    
                    <div style="text-align: left; max-width: 500px; margin: 0 auto; background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                        <p style="margin: 0 0 10px 0; font-size: 0.9em;">
                            <strong>Possible reasons:</strong>
                        </p>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.85em; color: var(--text-muted);">
                            <li>Limited rental inventory in ZIP ${property.zip}</li>
                            <li>No current listings match the property criteria</li>
                            <li>The area may have low rental turnover</li>
                            <li>RentCast may not have complete coverage for this ZIP code</li>
                        </ul>
                        
                        <p style="margin: 15px 0 0 0; font-size: 0.85em; color: var(--text-secondary);">
                            <strong>Alternatives:</strong> Try searching on 
                            <a href="https://www.zillow.com/homes/for_rent/${property.zip}_rb/" target="_blank" style="color: var(--accent-primary);">Zillow</a>, 
                            <a href="https://www.realtor.com/apartments/${property.city}-${property.state}/${property.zip}" target="_blank" style="color: var(--accent-primary);">Realtor.com</a>, or
                            <a href="https://www.apartments.com/${property.city.toLowerCase()}-${property.state.toLowerCase()}/${property.zip}/" target="_blank" style="color: var(--accent-primary);">Apartments.com</a>
                        </p>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="retryWithCityState(${JSON.stringify({city: property.city, state: property.state, zip: property.zip}).replace(/"/g, '&quot;')})" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Try searching by ${property.city}, ${property.state}
                    </button>
                    
                    <button class="btn btn-secondary" onclick="testRentCastAPI('${property.zip}')" style="margin-top: 15px; margin-left: 10px;">
                        <i class="fas fa-vial"></i> Test API Response
                    </button>
                </div>
            `;
        }

        // Retry rental search with city/state instead of ZIP
        async function retryWithCityState(location) {
            document.getElementById('rentalListingsLoading').style.display = 'block';
            document.getElementById('rentalListingsContent').style.display = 'none';
            
            try {
                const params = new URLSearchParams({
                    city: location.city,
                    state: location.state,
                    radius: 10,
                    limit: 50
                });
                
                console.log('🔍 Retrying with city/state:', params.toString());
                
                const response = await fetch(`/api/rentcast/rental-listings?${params}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const property = properties.find(p => p.zip === location.zip) || { zip: location.zip };
                    displayRentalListings(data.data, property);
                    
                    // Add note about city/state search
                    const noteDiv = document.createElement('div');
                    noteDiv.style.cssText = 'padding: 10px; background: var(--bg-secondary); border: 1px solid var(--accent-info); border-radius: 4px; margin-bottom: 10px;';
                    noteDiv.innerHTML = `
                        <i class="fas fa-info-circle" style="color: var(--accent-info);"></i>
                        <span style="color: var(--text-secondary); margin-left: 5px;">
                            Showing rentals for ${location.city}, ${location.state} area (not limited to ZIP ${location.zip})
                        </span>
                    `;
                    document.getElementById('rentalListingsContent').insertBefore(noteDiv, document.getElementById('rentalListingsContent').firstChild);
                } else {
                    showNoListingsMessage({ city: location.city, state: location.state, zip: location.zip });
                }
            } catch (error) {
                console.error('Error retrying with city/state:', error);
                showNoListingsMessage({ city: location.city, state: location.state, zip: location.zip });
            }
        }

        // Test RentCast API directly
        async function testRentCastAPI(zipCode) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-card);
                padding: 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <h3 style="margin-bottom: 15px;">RentCast API Test for ZIP ${zipCode}</h3>
                <div id="apiTestResults" style="font-family: monospace; font-size: 0.85em;">
                    <p>Testing different API configurations...</p>
                </div>
                <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="margin-top: 15px;">Close</button>
            `;
            
            document.body.appendChild(modal);
            
            const resultsDiv = document.getElementById('apiTestResults');
            let results = '';
            
            // Test 1: ZIP only
            try {
                results += '<p><strong>Test 1: ZIP only</strong></p>';
                const response1 = await fetch(`/api/rentcast/rental-listings?zip=${zipCode}&limit=5`);
                const data1 = await response1.json();
                results += `<pre>${JSON.stringify(data1, null, 2)}</pre><hr>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p><hr>`;
            }
            
            // Test 2: ZIP without bedroom filter
            try {
                results += '<p><strong>Test 2: ZIP without bedroom filter</strong></p>';
                const response2 = await fetch(`/api/rentcast/rental-listings?zip=${zipCode}&limit=10`);
                const data2 = await response2.json();
                results += `<pre>${JSON.stringify(data2, null, 2)}</pre><hr>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p><hr>`;
            }
            
            // Test 3: Check API status
            try {
                results += '<p><strong>Test 3: API Status Check</strong></p>';
                const response3 = await fetch('/api/status');
                const data3 = await response3.json();
                results += `<pre>${JSON.stringify(data3, null, 2)}</pre>`;
            } catch (error) {
                results += `<p style="color: var(--accent-danger);">Error: ${error.message}</p>`;
            }
            
            resultsDiv.innerHTML = results;
        }

        // Display rental listings
        function displayRentalListings(listings, property) {
            console.log('📊 Displaying rental listings:', listings);
            document.getElementById('rentalListingsLoading').style.display = 'none';
            document.getElementById('rentalListingsContent').style.display = 'block';
            
            // Calculate average rent from listings
            const avgRent = listings.reduce((sum, l) => sum + (l.rent || l.price || 0), 0) / listings.length;
            const rentDiff = property.rentEstimate ? ((property.rentEstimate - avgRent) / avgRent * 100).toFixed(1) : 0;
            
            let html = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="metric-card">
                            <div class="metric-label">Listings Found</div>
                            <div class="metric-value">${listings.length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Market Rent</div>
                            <div class="metric-value">${formatCurrency(avgRent)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${calculateAvgDaysOnMarket(listings)}</div>
                        </div>
                        ${property.rentEstimate ? `
                        <div class="metric-card">
                            <div class="metric-label">Your Rent vs Market</div>
                            <div class="metric-value ${rentDiff >= 0 ? 'positive' : 'negative'}">
                                ${rentDiff >= 0 ? '+' : ''}${rentDiff}%
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                            <tr>
                                <th style="text-align: left; padding: 10px; border-bottom: 2px solid var(--border-color);">Address</th>
                                <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--border-color);">Bed/Bath</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">Sqft</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">Rent</th>
                                <th style="text-align: right; padding: 10px; border-bottom: 2px solid var(--border-color);">$/Sqft</th>
                                <th style="text-align: center; padding: 10px; border-bottom: 2px solid var(--border-color);">Days Listed</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            listings.forEach((listing, index) => {
                // Log the first listing structure for debugging
                if (index === 0) {
                    console.log('📋 First listing structure:', listing);
                }
                
                const rent = listing.rent || listing.price || listing.rentAmount || listing.monthlyRent || 0;
                const sqft = listing.squareFootage || listing.squareFeet || listing.sqft || listing.size || 0;
                const pricePerSqft = sqft && rent ? (rent / sqft).toFixed(2) : 'N/A';
                
                // Use daysOnMarket from API or calculate from listedDate
                const daysListed = listing.daysOnMarket || listing.daysActive || 
                    (listing.listedDate || listing.datePosted ? 
                        Math.floor((Date.now() - new Date(listing.listedDate || listing.datePosted).getTime()) / (1000 * 60 * 60 * 24)) : 
                        'N/A');
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-light); ${index % 2 === 0 ? 'background: var(--bg-secondary);' : ''}">
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${listing.propertyType ? `
                                    <div style="width: 50px; height: 50px; background: var(--bg-card); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas ${getPropertyIcon(listing.propertyType)}" style="font-size: 20px; color: var(--accent-primary);"></i>
                                    </div>
                                ` : ''}
                                <div>
                                    <div style="font-weight: 500;">
                                        ${listing.addressLine1 || listing.formattedAddress || listing.address || listing.street || 'N/A'}
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                                        ${listing.city || ''} ${listing.state || listing.stateCode || ''} ${listing.zipCode || listing.zip || listing.postalCode || ''}
                                    </div>
                                    ${listing.county ? `<div style="font-size: 0.8em; color: var(--text-muted);">${listing.county} County</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center; padding: 12px;">
                            ${listing.bedrooms || 0}/${listing.bathrooms || 0}
                        </td>
                        <td style="text-align: right; padding: 12px;">
                            ${sqft ? sqft.toLocaleString() : 'N/A'}
                        </td>
                        <td style="text-align: right; padding: 12px; font-weight: 500; color: var(--accent-success);">
                            ${formatCurrency(rent)}
                        </td>
                        <td style="text-align: right; padding: 12px;">
                            ${pricePerSqft !== 'N/A' ? `$${pricePerSqft}` : pricePerSqft}
                        </td>
                        <td style="text-align: center; padding: 12px;">
                            <div style="${daysListed > 30 ? 'color: var(--accent-warning);' : ''}">
                                ${daysListed !== 'N/A' ? `${daysListed}d` : 'N/A'}
                            </div>
                            ${listing.status ? `
                                <div style="font-size: 0.8em; margin-top: 2px; color: ${listing.status === 'Active' ? 'var(--accent-success)' : 'var(--text-muted)'}">
                                    ${listing.status}
                                </div>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-info); margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 0.9em;">
                            <strong>💡 Market Insight:</strong> 
                            ${rentDiff > 5 ? 
                                `Your estimated rent is ${rentDiff}% above the market average. This property may have premium features or the market data may be outdated.` :
                                rentDiff < -5 ?
                                `Your estimated rent is ${Math.abs(rentDiff)}% below the market average. Consider reviewing your rental pricing strategy.` :
                                `Your estimated rent is aligned with the current market rates in this area.`
                            }
                        </p>
                    </div>
                    
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <p style="margin: 0; font-size: 0.85em; color: var(--text-secondary);">
                            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                            <strong>Note:</strong> Property photos are not available through the RentCast API. 
                            To view property photos and detailed listings, visit popular real estate websites like Zillow, Realtor.com, or Apartments.com
                            and search for rentals in the ${property.zip || 'area'} zip code.
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('rentalListingsContent').innerHTML = html;
        }

        // Calculate property metrics
        // Financial calculation formulas:
        // 1. Effective Rent = Monthly Rent × (1 - Vacancy Rate)
        // 2. Monthly Cash Flow = Effective Rent - Mortgage - Total Expenses
        // 3. Annual Cash Flow = Monthly Cash Flow × 12
        // 4. Cash-on-Cash Return = (Annual Cash Flow ÷ Down Payment) × 100
        // 5. Net Operating Income (NOI) = (Annual Rent × (1 - Vacancy Rate)) - Annual Expenses (excludes mortgage)
        // 6. Cap Rate = (NOI ÷ Purchase Price) × 100
        // 7. DSCR = NOI ÷ Annual Debt Service (mortgage payments)
        //
        // Assumptions:
        // - Mortgage: 30-year fixed at 6.5% interest rate
        // - Down Payment: 20% of purchase price (or custom)
        // - Vacancy Rate: 7% (or custom)
        function calculatePropertyMetrics(property) {
            const purchasePrice = Number(property.purchasePrice || property.estimatedValue || 0) || 0;
            const monthlyRent = Number(property.monthlyRent || property.rentEstimate || 0) || 0;
            const downPayment = Number(property.downPayment || (purchasePrice * 0.2)) || 0;
            const loanAmount = Math.max(0, purchasePrice - downPayment);
            const vacancyRate = property.vacancyRate !== undefined && !isNaN(property.vacancyRate) ?
                Number(property.vacancyRate) : 7.00;

            // Calculate or use stored mortgage
            const monthlyMortgage = property.mortgage !== undefined && !isNaN(property.mortgage) ?
                Number(property.mortgage) : calculateMortgagePayment(loanAmount, 0.065, 30);

            // Store calculated mortgage back to property if not already set (ensure no NaN)
            if (property.mortgage === undefined || isNaN(property.mortgage)) {
                property.mortgage = monthlyMortgage || 0;
            }
            if (property.vacancyRate === undefined || isNaN(property.vacancyRate)) {
                property.vacancyRate = 7.00;
            }

            const totalExpenses = calculateTotalExpenses(property);
            const effectiveRent = monthlyRent * (1 - vacancyRate / 100);

            property.monthlyCashFlow = effectiveRent - monthlyMortgage - totalExpenses;
            property.annualCashFlow = property.monthlyCashFlow * 12;
            property.cashOnCashReturn = downPayment > 0 ? (property.annualCashFlow / downPayment) * 100 : 0;

            const noi = (monthlyRent * 12 * (1 - vacancyRate / 100)) - (totalExpenses * 12);
            property.capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;

            // Ensure no NaN values
            if (isNaN(property.monthlyCashFlow)) property.monthlyCashFlow = 0;
            if (isNaN(property.annualCashFlow)) property.annualCashFlow = 0;
            if (isNaN(property.cashOnCashReturn)) property.cashOnCashReturn = 0;
            if (isNaN(property.capRate)) property.capRate = 0;
        }

        // Calculate total expenses
        // Uses stored values if available, otherwise calculates defaults
        // Default assumptions (industry standard):
        // - Property Tax: 1.2% of purchase price annually (varies by location)
        // - Insurance: 0.4% of purchase price annually
        // - Maintenance: 1% of purchase price annually (the "1% rule")
        // - Property Management: 8% of monthly rent (standard range: 8-10%)
        // - HOA: User-provided or $0
        function calculateTotalExpenses(property) {
            const purchasePrice = Number(property.purchasePrice || property.estimatedValue || 0) || 0;
            const monthlyRent = Number(property.monthlyRent || property.rentEstimate || 0) || 0;

            // Use stored values or calculate defaults, ensure no NaN
            const propertyTax = property.propertyTax !== undefined && !isNaN(property.propertyTax) ?
                Number(property.propertyTax) : (purchasePrice * 0.012) / 12;
            const insurance = property.insurance !== undefined && !isNaN(property.insurance) ?
                Number(property.insurance) : (purchasePrice * 0.004) / 12;
            const hoa = property.hoa !== undefined && !isNaN(property.hoa) ?
                Number(property.hoa) : 0;
            const maintenance = property.maintenance !== undefined && !isNaN(property.maintenance) ?
                Number(property.maintenance) : (purchasePrice * 0.01) / 12;
            const managementFees = property.managementFees !== undefined && !isNaN(property.managementFees) ?
                Number(property.managementFees) : (monthlyRent * 0.08);

            // Store calculated values back to property if not already set (ensure no NaN)
            if (property.propertyTax === undefined || isNaN(property.propertyTax)) property.propertyTax = propertyTax || 0;
            if (property.insurance === undefined || isNaN(property.insurance)) property.insurance = insurance || 0;
            if (property.hoa === undefined || isNaN(property.hoa)) property.hoa = hoa || 0;
            if (property.maintenance === undefined || isNaN(property.maintenance)) property.maintenance = maintenance || 0;
            if (property.managementFees === undefined || isNaN(property.managementFees)) property.managementFees = managementFees || 0;

            const total = propertyTax + insurance + hoa + maintenance + managementFees;
            return isNaN(total) ? 0 : total;
        }

        // Calculate mortgage payment
        function calculateMortgagePayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 12;
            const numPayments = years * 12;
            
            if (monthlyRate === 0) return principal / numPayments;
            
            const payment = principal * 
                (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return payment;
        }

        // Get property type icon
        function getPropertyIcon(propertyType) {
            const type = (propertyType || '').toLowerCase();
            if (type.includes('single family') || type.includes('house')) return 'fa-home';
            if (type.includes('condo') || type.includes('condominium')) return 'fa-building';
            if (type.includes('townhouse') || type.includes('townhome')) return 'fa-city';
            if (type.includes('apartment')) return 'fa-building';
            if (type.includes('duplex') || type.includes('triplex') || type.includes('fourplex')) return 'fa-house-user';
            if (type.includes('mobile') || type.includes('manufactured')) return 'fa-caravan';
            if (type.includes('land') || type.includes('lot')) return 'fa-mountain';
            return 'fa-home';
        }
        
        // Calculate average days on market
        function calculateAvgDaysOnMarket(listings) {
            const validListings = listings.filter(l => l.daysOnMarket || l.listedDate);
            if (validListings.length === 0) return 'N/A';
            
            const totalDays = validListings.reduce((sum, listing) => {
                const days = listing.daysOnMarket || 
                    (listing.listedDate ? 
                        Math.floor((Date.now() - new Date(listing.listedDate).getTime()) / (1000 * 60 * 60 * 24)) : 
                        0);
                return sum + days;
            }, 0);
            
            return Math.round(totalDays / validListings.length) + ' days';
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Show notification message
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? 'var(--accent-success)' : type === 'error' ? 'var(--accent-danger)' : 'var(--accent-info)'};
                color: white;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                /* animation: slideIn 0.3s ease; - Removed for instant display */
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Handle add property
        async function handleAddProperty(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Property...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const property = {};
                
                for (let [key, value] of formData.entries()) {
                    property[key] = value;
                }
                
                // Convert numeric fields
                property.purchasePrice = parseFloat(property.purchasePrice) || 0;
                property.monthlyRent = parseFloat(property.monthlyRent) || 0;
                property.beds = parseInt(property.beds) || 0;
                property.baths = parseFloat(property.baths) || 0;
                property.sqft = parseInt(property.sqft) || 0;
                
                // Set defaults
                property.status = 'available';
                property.dateAdded = new Date().toISOString();
                
                // Try to fetch additional data from RentCast
                const rentcastData = await fetchRentCastData(property);
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    // Cache the full RentCast API response
                    property.rentcastCache = {
                        data: rentcastData.data,
                        timestamp: new Date().toISOString(),
                        success: true
                    };
                    
                    // Merge with proper field mapping
                    const mappedData = {
                        ...rentcastData.data,
                        // Ensure we have both sets of field names
                        beds: rentcastData.data.beds || rentcastData.data.bedrooms || property.beds,
                        baths: rentcastData.data.baths || rentcastData.data.bathrooms || property.baths,
                        sqft: rentcastData.data.sqft || rentcastData.data.squareFootage || property.sqft,
                        // Database column names
                        bedrooms: rentcastData.data.beds || rentcastData.data.bedrooms || property.beds,
                        bathrooms: rentcastData.data.baths || rentcastData.data.bathrooms || property.baths,
                        square_footage: rentcastData.data.sqft || rentcastData.data.squareFootage || property.sqft
                    };
                    Object.assign(property, mappedData);
                    
                    // If user didn't provide purchase price or rent, use RentCast estimates
                    if (!property.purchasePrice && rentcastData.data.estimatedValue) {
                        property.purchasePrice = rentcastData.data.estimatedValue;
                        property.currentValue = rentcastData.data.estimatedValue;
                        console.log('Using RentCast estimated value:', property.purchasePrice);
                    }
                    
                    if (!property.monthlyRent && rentcastData.data.rentEstimate) {
                        property.monthlyRent = rentcastData.data.rentEstimate;
                        console.log('Using RentCast rent estimate:', property.monthlyRent);
                    }
                }
                
                // Set current value if not already set
                if (!property.currentValue) {
                    property.currentValue = property.purchasePrice || 0;
                }
                
                // Validate that we have minimum required data
                if (!property.address || !property.city || !property.state || !property.zip) {
                    throw new Error('Please provide complete address information');
                }
                
                // Calculate metrics
                calculatePropertyMetrics(property);
                
                // Create property in database first
                console.log('Creating property in database:', property.address);
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(property)
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // CRITICAL: Add the complete property from server response with ID
                    const propertyWithId = {
                        ...property,
                        ...data.data,
                        // Preserve camelCase fields
                        purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                        monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                    };
                    
                    console.log('✅ Property created with ID:', propertyWithId.id);
                    console.log('Property with ID:', propertyWithId);
                    
                    // Add to properties array
                    properties.push(propertyWithId);
                    
                    // Update localStorage immediately
                    localStorage.setItem('properties', JSON.stringify(properties));
                    console.log('✅ Updated localStorage with new property');
                    
                    updateDisplay();
                    closeModal('addPropertyModal');
                    
                    // Show success message
                    if (typeof showNotification === 'function') {
                        showNotification(`Property "${property.address}" added successfully!`, 'success');
                    }
                } else {
                    throw new Error(data.error || 'Failed to create property');
                }
                
            } catch (error) {
                console.error('Error adding property:', error);
                alert(error.message || 'Error adding property. Please try again.');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        // Generate enhanced property analysis
        function generateEnhancedPropertyAnalysis(address, propertyData) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = propertyData.downPayment || (purchasePrice * 0.2);
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            const totalExpenses = calculateTotalExpenses({
                purchasePrice,
                monthlyRent,
                hoaMonthly: propertyData.hoaMonthly || 0
            });
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            
            document.getElementById('analysisResults').innerHTML = `
                <div class="analysis-section">
                    <h3>📍 Property Details</h3>
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${propertyData.address || address}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">City, State ZIP</div>
                            <div class="detail-value">${propertyData.city}, ${propertyData.state} ${propertyData.zip}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">${propertyData.propertyType || 'Single Family'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms / Bathrooms</div>
                            <div class="detail-value">${propertyData.beds || 0} / ${propertyData.baths || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">${(propertyData.sqft || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estimated Value</div>
                            <div class="detail-value">${formatCurrency(purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rent Estimate</div>
                            <div class="detail-value">${formatCurrency(monthlyRent)}/mo</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>📊 Investment Analysis</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(monthlyCashFlow)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">
                                ${cashOnCashReturn.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Down Payment</div>
                            <div class="metric-value">
                                ${formatCurrency(downPayment)}
                            </div>
                        </div>
                    </div>
                </div>

                ${propertyData.marketStats && Object.keys(propertyData.marketStats).length > 0 ? `
                <div class="analysis-section">
                    <h3>📈 Market Statistics (${propertyData.zip})</h3>
                    <div class="metrics-grid">
                        ${propertyData.marketStats.medianRent ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPrice ? `
                        <div class="metric-card">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.avgDaysOnMarket ? `
                        <div class="metric-card">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${propertyData.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.inventoryCount ? `
                        <div class="metric-card">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${propertyData.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="export-controls">
                    <button class="btn btn-export" onclick="exportAnalysisReport('${address}', ${JSON.stringify(propertyData).replace(/"/g, '&quot;')})">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button class="btn btn-primary" onclick="addPropertyFromAnalysis(${JSON.stringify(propertyData).replace(/"/g, '&quot;')})">
                        <i class="fas fa-plus"></i> Add to Portfolio
                    </button>
                </div>
            `;
        }

        // Generate basic property analysis (fallback)
        function generatePropertyAnalysis(address) {
            const parsedAddress = parseAddressComponents(address);
            const estimatedPrice = 500000;
            const estimatedRent = 2500;
            
            generateEnhancedPropertyAnalysis(address, {
                address: parsedAddress.streetAddress,
                city: parsedAddress.city,
                state: parsedAddress.state,
                zip: parsedAddress.zip,
                estimatedValue: estimatedPrice,
                rentEstimate: estimatedRent,
                beds: 3,
                baths: 2,
                sqft: 1500,
                propertyType: 'Single Family'
            });
        }

        // Parse address components - enhanced to handle various formats
        function parseAddressComponents(address) {
            let streetAddress = '', city = '', state = '', zip = '';
            
            // First try comma-separated format
            let parts = address.split(',').map(s => s.trim());
            
            if (parts.length >= 3) {
                // Format: "123 Main St, Las Vegas, NV 89169"
                streetAddress = parts[0];
                city = parts[1];
                
                const stateZip = parts[2].trim().split(' ');
                if (stateZip.length >= 2) {
                    state = stateZip[0];
                    zip = stateZip[1];
                } else if (stateZip.length === 1) {
                    state = stateZip[0];
                }
            } else {
                // Try parsing without commas: "123 Main St Las Vegas NV 89169"
                // Look for ZIP code pattern
                const zipMatch = address.match(/(\d{5}(?:-\d{4})?)$/);
                if (zipMatch) {
                    zip = zipMatch[1];
                    address = address.replace(zipMatch[0], '').trim();
                }
                
                // Look for state abbreviation (2 uppercase letters at the end)
                const stateMatch = address.match(/\b([A-Z]{2})\s*$/);
                if (stateMatch) {
                    state = stateMatch[1];
                    address = address.replace(stateMatch[0], '').trim();
                }
                
                // Split remaining address
                const words = address.split(' ');
                if (words.length >= 3) {
                    // Assume last part is city, rest is street address
                    // Common patterns: city names can be 1-3 words
                    // Check for common multi-word city patterns
                    const addressLower = address.toLowerCase();
                    const multiWordCities = ['las vegas', 'los angeles', 'san francisco', 'san diego', 'new york', 'salt lake city', 'san antonio', 'santa monica', 'san jose'];
                    
                    let cityFound = false;
                    for (const cityName of multiWordCities) {
                        if (addressLower.includes(cityName)) {
                            const cityIndex = addressLower.indexOf(cityName);
                            streetAddress = address.substring(0, cityIndex).trim();
                            city = address.substring(cityIndex, cityIndex + cityName.length).trim();
                            // Preserve original case
                            city = words.slice(-cityName.split(' ').length).join(' ');
                            cityFound = true;
                            break;
                        }
                    }
                    
                    if (!cityFound) {
                        // Default: assume last 1-2 words are city
                        const possibleCityWords = Math.min(2, Math.max(1, words.length - 2));
                        city = words.slice(-possibleCityWords).join(' ');
                        streetAddress = words.slice(0, -possibleCityWords).join(' ');
                    }
                }
            }
            
            // Clean up state abbreviation to uppercase
            if (state) {
                state = state.toUpperCase();
            }
            
            return { streetAddress: streetAddress || address, city, state, zip };
        }
        
        // Parse and fill address fields in Add Property form
        function parseAndFillAddress() {
            const fullAddress = document.getElementById('fullAddress').value.trim();
            
            if (!fullAddress) {
                return;
            }
            
            const parsed = parseAddressComponents(fullAddress);
            
            // Fill in the individual fields
            if (parsed.streetAddress) {
                document.getElementById('address').value = parsed.streetAddress;
            }
            if (parsed.city) {
                document.getElementById('city').value = parsed.city;
            }
            if (parsed.state) {
                document.getElementById('state').value = parsed.state;
            }
            if (parsed.zip) {
                document.getElementById('zip').value = parsed.zip;
            }
            
            // Visual feedback - briefly highlight filled fields
            ['address', 'city', 'state', 'zip'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field.value) {
                    field.style.border = '2px solid var(--accent-success)';
                    field.style.transition = 'border 0.3s ease';
                    setTimeout(() => {
                        field.style.border = '';
                    }, 1000);
                }
            });
        }

        // Export analysis report
        function exportAnalysisReport(address, propertyData) {
            const reportContent = generateReportHTML(address, propertyData);
            
            // Create a blob with the HTML content
            const blob = new Blob([reportContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `property-analysis-${propertyData.address || 'report'}-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Generate report HTML
        function generateReportHTML(address, propertyData) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = propertyData.downPayment || (purchasePrice * 0.2);
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
            
            const totalExpenses = calculateTotalExpenses({
                purchasePrice,
                monthlyRent,
                hoaMonthly: propertyData.hoaMonthly || 0
            });
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Property Analysis Report - ${propertyData.address || address}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #f5f5f5;
                    }
                    .header {
                        background: #1a1a1a;
                        color: white;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                    }
                    .header h1 {
                        margin: 0;
                        font-size: 28px;
                    }
                    .header p {
                        margin: 10px 0 0 0;
                        color: #ccc;
                    }
                    .section {
                        background: white;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .section h2 {
                        color: #333;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #3b82f6;
                        padding-bottom: 10px;
                    }
                    .metrics {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                    }
                    .metric-label {
                        color: #666;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .warning { color: #f59e0b; }
                    .details {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 15px;
                    }
                    .detail-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid #eee;
                    }
                    .detail-label {
                        color: #666;
                    }
                    .detail-value {
                        font-weight: 500;
                    }
                    .footer {
                        text-align: center;
                        color: #666;
                        margin-top: 40px;
                        padding: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Property Investment Analysis</h1>
                    <p>${propertyData.address || address}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="section">
                    <h2>Property Details</h2>
                    <div class="details">
                        <div class="detail-row">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">${propertyData.city}, ${propertyData.state} ${propertyData.zip}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Property Type</span>
                            <span class="detail-value">${propertyData.propertyType || 'Single Family'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bedrooms</span>
                            <span class="detail-value">${propertyData.beds || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Bathrooms</span>
                            <span class="detail-value">${propertyData.baths || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Square Feet</span>
                            <span class="detail-value">${propertyData.sqft ? propertyData.sqft.toLocaleString() : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Year Built</span>
                            <span class="detail-value">${propertyData.yearBuilt || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Financial Analysis</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Purchase Price</div>
                            <div class="metric-value">${formatCurrency(purchasePrice)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Down Payment (20%)</div>
                            <div class="metric-value">${formatCurrency(downPayment)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Monthly Rent</div>
                            <div class="metric-value">${formatCurrency(monthlyRent)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Monthly Mortgage</div>
                            <div class="metric-value">${formatCurrency(monthlyMortgage)}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Investment Metrics</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(monthlyCashFlow)}
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">
                                ${cashOnCashReturn.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">
                                ${capRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Annual Cash Flow</div>
                            <div class="metric-value ${annualCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(annualCashFlow)}
                            </div>
                        </div>
                    </div>
                </div>

                ${propertyData.marketStats && Object.keys(propertyData.marketStats).length > 0 ? `
                <div class="section">
                    <h2>Market Statistics (${propertyData.zip})</h2>
                    <div class="metrics">
                        ${propertyData.marketStats.medianRent ? `
                        <div class="metric">
                            <div class="metric-label">Median Rent</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianRent)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.medianPrice ? `
                        <div class="metric">
                            <div class="metric-label">Median Price</div>
                            <div class="metric-value">${formatCurrency(propertyData.marketStats.medianPrice)}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.avgDaysOnMarket ? `
                        <div class="metric">
                            <div class="metric-label">Avg Days on Market</div>
                            <div class="metric-value">${propertyData.marketStats.avgDaysOnMarket}</div>
                        </div>
                        ` : ''}
                        ${propertyData.marketStats.inventoryCount ? `
                        <div class="metric">
                            <div class="metric-label">Inventory Count</div>
                            <div class="metric-value">${propertyData.marketStats.inventoryCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="footer">
                    <p>Real Estate Investment Tracker</p>
                    <p>This report is for informational purposes only.</p>
                </div>
            </body>
            </html>
            `;
        }

        // Add property from analysis
        async function addPropertyFromAnalysis(propertyData) {
            const property = {
                ...propertyData,
                purchasePrice: propertyData.estimatedValue || propertyData.price || 500000,
                monthlyRent: propertyData.rentEstimate || 2500,
                currentValue: propertyData.estimatedValue || propertyData.price || 500000,
                status: 'available',
                dateAdded: new Date().toISOString()
            };
            
            calculatePropertyMetrics(property);
            
            // Create property in database first
            try {
                console.log('Creating property in database:', property.address);
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(property)
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Add the complete property from server response with ID
                    const propertyWithId = {
                        ...property,
                        ...data.data,
                        // Preserve camelCase fields
                        purchasePrice: data.data.purchasePrice || data.data.purchase_price || property.purchasePrice,
                        monthlyRent: data.data.monthlyRent || data.data.monthly_rent || property.monthlyRent
                    };
                    
                    console.log('✅ Property created with ID:', propertyWithId.id);
                    
                    // Add to properties array
                    properties.push(propertyWithId);
                    
                    // Update localStorage immediately
                    localStorage.setItem('properties', JSON.stringify(properties));
                    console.log('✅ Updated localStorage with new property');
                    
                    updateDisplay();
                    closeModal('analyzeModal');
                    alert('Property added to portfolio!');
                } else {
                    throw new Error(data.error || 'Failed to create property');
                }
            } catch (error) {
                console.error('Error adding property:', error);
                alert(error.message || 'Error adding property. Please try again.');
            }
        }

        // Generate market insights content
        function generateMarketInsightsContent(marketData) {
            const availableProperties = properties.filter(p => p.status !== 'sold');
            const totalValue = availableProperties.reduce((sum, p) => sum + (p.currentValue || p.purchasePrice || 0), 0);
            const avgCashFlow = availableProperties.length > 0 ? 
                availableProperties.reduce((sum, p) => sum + (p.monthlyCashFlow || 0), 0) / availableProperties.length : 0;
            
            let content = `
                <div class="analysis-section">
                    <h3>📊 Portfolio Overview</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Properties</div>
                            <div class="metric-value">${properties.length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Portfolio Value</div>
                            <div class="metric-value">${formatCurrency(totalValue)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Monthly Cash Flow</div>
                            <div class="metric-value ${avgCashFlow >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(avgCashFlow)}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Markets</div>
                            <div class="metric-value">${Object.keys(marketData).length}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Market analysis by ZIP
            for (const [zip, data] of Object.entries(marketData)) {
                const propertiesInZip = properties.filter(p => p.zip === zip && p.status !== 'sold');
                if (propertiesInZip.length === 0) continue;
                
                content += `
                    <div class="analysis-section">
                        <h3>📍 Market Analysis: ${zip}</h3>
                        <p><strong>Properties in this market:</strong> ${propertiesInZip.length}</p>
                        
                        <div class="metrics-grid">
                            ${data.medianRent ? `
                            <div class="metric-card">
                                <div class="metric-label">Median Rent</div>
                                <div class="metric-value">${formatCurrency(data.medianRent)}</div>
                            </div>
                            ` : ''}
                            ${data.medianPrice ? `
                            <div class="metric-card">
                                <div class="metric-label">Median Price</div>
                                <div class="metric-value">${formatCurrency(data.medianPrice)}</div>
                            </div>
                            ` : ''}
                            ${data.avgDaysOnMarket ? `
                            <div class="metric-card">
                                <div class="metric-label">Avg Days on Market</div>
                                <div class="metric-value">${data.avgDaysOnMarket}</div>
                            </div>
                            ` : ''}
                            ${data.yearOverYearPriceChange ? `
                            <div class="metric-card">
                                <div class="metric-label">YoY Price Change</div>
                                <div class="metric-value ${data.yearOverYearPriceChange >= 0 ? 'positive' : 'negative'}">
                                    ${data.yearOverYearPriceChange.toFixed(1)}%
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="ai-content" style="margin-top: 20px;">
                            <h4>Market Insights</h4>
                            <p>${generateZipCodeInsights(zip, data, propertiesInZip)}</p>
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="analysis-section">
                    <h3>🎯 Investment Recommendations</h3>
                    <div class="ai-content">
                        ${generateInvestmentRecommendations(properties, marketData)}
                    </div>
                </div>
                
                <div class="export-controls">
                    <button class="btn btn-export" onclick="exportMarketInsights()">
                        <i class="fas fa-download"></i> Export Market Report
                    </button>
                </div>
            `;
            
            return content;
        }

        // Generate insights for a specific ZIP code
        function generateZipCodeInsights(zip, data, propertiesInZip) {
            const avgPropertyRent = propertiesInZip.reduce((sum, p) => sum + (p.monthlyRent || 0), 0) / propertiesInZip.length;
            const rentComparison = data.medianRent ? ((avgPropertyRent - data.medianRent) / data.medianRent * 100).toFixed(1) : 0;
            
            let insights = [];
            
            if (data.medianRent && rentComparison > 0) {
                insights.push(`Your properties in ${zip} are achieving rents ${rentComparison}% above the market median, indicating strong rental performance.`);
            } else if (data.medianRent && rentComparison < -10) {
                insights.push(`Your properties in ${zip} are renting ${Math.abs(rentComparison)}% below market median. Consider evaluating rent increases.`);
            }
            
            if (data.avgDaysOnMarket < 30) {
                insights.push(`Properties in this area are selling quickly (avg ${data.avgDaysOnMarket} days), indicating high demand.`);
            } else if (data.avgDaysOnMarket > 90) {
                insights.push(`Properties are taking longer to sell (avg ${data.avgDaysOnMarket} days), which may provide negotiation opportunities.`);
            }
            
            if (data.yearOverYearPriceChange > 5) {
                insights.push(`Strong price appreciation of ${data.yearOverYearPriceChange.toFixed(1)}% year-over-year suggests a growing market.`);
            } else if (data.yearOverYearPriceChange < 0) {
                insights.push(`Prices have declined ${Math.abs(data.yearOverYearPriceChange).toFixed(1)}% year-over-year. This could present buying opportunities.`);
            }
            
            return insights.length > 0 ? insights.join(' ') : 'Market data suggests stable conditions in this area.';
        }

        // Generate investment recommendations
        function generateInvestmentRecommendations(properties, marketData) {
            const recommendations = [];
            
            // Analyze portfolio performance
            const avgCashOnCash = properties.filter(p => p.status !== 'sold').reduce((sum, p) => sum + (p.cashOnCashReturn || 0), 0) / properties.length;
            
            if (avgCashOnCash >= 8) {
                recommendations.push('<li><strong>Portfolio Performance:</strong> Your portfolio is achieving excellent returns with an average cash-on-cash return of ' + avgCashOnCash.toFixed(1) + '%. Continue focusing on similar property profiles.</li>');
            } else if (avgCashOnCash < 5) {
                recommendations.push('<li><strong>Portfolio Optimization:</strong> Consider strategies to improve returns, such as reducing expenses, increasing rents where possible, or focusing on higher cash-flow properties.</li>');
            }
            
            // Market-specific recommendations
            for (const [zip, data] of Object.entries(marketData)) {
                if (data.yearOverYearPriceChange > 8) {
                    recommendations.push(`<li><strong>${zip} Market:</strong> Strong appreciation trend. Consider acquiring more properties in this area before prices rise further.</li>`);
                }
                
                if (data.inventoryCount && data.inventoryCount < 50) {
                    recommendations.push(`<li><strong>${zip} Inventory:</strong> Low inventory (${data.inventoryCount} properties) suggests a seller's market. Act quickly on good opportunities.</li>`);
                }
            }
            
            // Diversification advice
            const uniqueZips = [...new Set(properties.map(p => p.zip))];
            if (uniqueZips.length < 3) {
                recommendations.push('<li><strong>Diversification:</strong> Consider expanding into additional markets to reduce geographic concentration risk.</li>');
            }
            
            return '<ul>' + recommendations.join('') + '</ul>';
        }

        // Export market insights
        function exportMarketInsights() {
            const content = document.getElementById('marketInsightsContent').innerHTML;
            const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Market Insights Report - ${new Date().toLocaleDateString()}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 1000px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #f5f5f5;
                    }
                    .header {
                        background: #1a1a1a;
                        color: white;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        text-align: center;
                    }
                    .analysis-section {
                        background: white;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .metrics-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric-card {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                    }
                    .metric-label {
                        color: #666;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .ai-content {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 6px;
                        margin-top: 20px;
                    }
                    h3 { color: #333; margin-bottom: 15px; }
                    h4 { color: #3b82f6; margin: 15px 0 10px 0; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>AI Market Insights Report</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                ${content}
            </body>
            </html>
            `;
            
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market-insights-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Filter properties
        function filterProperties() {
            updateTable();
            updateMobilePropertyCards(); // Also update mobile view when filtering
        }

        // Get filtered properties
        function getFilteredProperties() {
            let filtered = [...properties];
            
            // Ensure all properties have metrics calculated before filtering
            filtered.forEach(prop => {
                if (prop.monthlyRent !== undefined && prop.purchasePrice !== undefined && !prop.monthlyCashFlow) {
                    calculatePropertyMetrics(prop);
                }
            });
            
            const cityFilter = document.getElementById('filterCity').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const minCashFlowValue = document.getElementById('filterMinCashFlow').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            if (cityFilter) {
                filtered = filtered.filter(p => p.city === cityFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(p => p.status === statusFilter);
            }
            
            // Only apply cash flow filter if a value is explicitly entered
            if (minCashFlowValue !== '' && minCashFlowValue !== null) {
                const minCashFlow = parseFloat(minCashFlowValue);
                if (!isNaN(minCashFlow)) {
                    filtered = filtered.filter(p => (p.monthlyCashFlow || 0) >= minCashFlow);
                }
            }
            
            if (searchText) {
                filtered = filtered.filter(p =>
                    (p.address && p.address.toLowerCase().includes(searchText)) ||
                    (p.city && p.city.toLowerCase().includes(searchText)) ||
                    (p.zip && p.zip.includes(searchText))
                );
            }

            // Sort by monthly cash flow (highest first)
            filtered.sort((a, b) => {
                const cashFlowA = Number(a.monthlyCashFlow) || 0;
                const cashFlowB = Number(b.monthlyCashFlow) || 0;
                return cashFlowB - cashFlowA; // Descending order
            });

            return filtered;
        }

        // Update city filter
        function updateCityFilter() {
            const cities = [...new Set(properties.map(p => p.city).filter(c => c))];
            const select = document.getElementById('filterCity');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Cities</option>';
            cities.sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterCity').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterMinCashFlow').value = '';
            document.getElementById('searchInput').value = '';
            filterProperties();
        }

        // Edit property
        function editProperty(index) {
            const property = properties[index];
            if (!property) return;
            
            // Populate form
            document.getElementById('address').value = property.address || '';
            document.getElementById('city').value = property.city || '';
            document.getElementById('state').value = property.state || '';
            document.getElementById('zip').value = property.zip || '';
            document.getElementById('propertyType').value = property.propertyType || 'single-family';
            document.getElementById('purchasePrice').value = property.purchasePrice || '';
            document.getElementById('monthlyRent').value = property.monthlyRent || '';
            document.getElementById('beds').value = property.beds || '';
            document.getElementById('baths').value = property.baths || '';
            document.getElementById('sqft').value = property.sqft || '';
            
            // Update form submit handler
            document.getElementById('addPropertyForm').onsubmit = function(e) {
                e.preventDefault();
                updateProperty(index);
            };
            
            openModal('addPropertyModal');
        }

        // Update property
        function updateProperty(index) {
            const formData = new FormData(document.getElementById('addPropertyForm'));
            const updatedData = {};
            
            for (let [key, value] of formData.entries()) {
                updatedData[key] = value;
            }
            
            // Convert numeric fields
            updatedData.purchasePrice = parseFloat(updatedData.purchasePrice) || 0;
            updatedData.monthlyRent = parseFloat(updatedData.monthlyRent) || 0;
            updatedData.beds = parseInt(updatedData.beds) || 0;
            updatedData.baths = parseFloat(updatedData.baths) || 0;
            updatedData.sqft = parseInt(updatedData.sqft) || 0;
            
            // Update property
            Object.assign(properties[index], updatedData);
            calculatePropertyMetrics(properties[index]);
            
            // Save and update display
            saveProperties();
            updateDisplay();
            closeModal('addPropertyModal');
            
            // Reset form handler
            document.getElementById('addPropertyForm').onsubmit = handleAddProperty;
        }

        // Mark property as sold
        function markAsSold(index) {
            if (confirm('Mark this property as sold?')) {
                properties[index].status = 'sold';
                properties[index].soldDate = new Date().toISOString();
                saveProperties();
                updateDisplay();
                closeModal('propertyModal');
            }
        }

        // Delete property
        async function deleteProperty(index) {
            if (confirm('Are you sure you want to delete this property?')) {
                const property = properties[index];
                
                // If property has an ID, delete it from the database
                if (property.id) {
                    try {
                        console.log(`🗑️ Deleting property ${property.id} from database...`);
                        const response = await fetch(`/api/properties/${property.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            console.log('✅ Property deleted from database');
                        } else {
                            console.error('❌ Failed to delete from database');
                            showNotification('Failed to delete property from database', 'error');
                            return; // Don't remove from local array if database delete failed
                        }
                    } catch (error) {
                        console.error('❌ Error deleting property:', error);
                        showNotification('Error deleting property', 'error');
                        return; // Don't remove from local array if database delete failed
                    }
                }
                
                // Remove from local array
                properties.splice(index, 1);
                
                // Update localStorage
                localStorage.setItem('properties', JSON.stringify(properties));
                
                updateDisplay();
                closeModal('propertyModal');
            }
        }

        // Format AI response
        function formatAIResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Fetch real property data using existing functions or fallback
        async function fetchRealPropertyData(address) {
            try {
                const parsedAddress = parseAddressComponents(address);
                const rentcastData = await fetchRentCastData(parsedAddress);
                
                if (rentcastData && rentcastData.success && rentcastData.data) {
                    return {
                        success: true,
                        data: {
                            ...rentcastData.data,
                            city: parsedAddress.city,
                            state: parsedAddress.state,
                            zip: parsedAddress.zip,
                            formattedAddress: address
                        }
                    };
                }
                
                // Fallback to estimated data
                return {
                    success: true,
                    data: {
                        address: parsedAddress.streetAddress,
                        city: parsedAddress.city,
                        state: parsedAddress.state,
                        zip: parsedAddress.zip,
                        formattedAddress: address,
                        estimatedValue: 500000,
                        rentEstimate: 2500,
                        beds: 3,
                        baths: 2,
                        sqft: 1500,
                        propertyType: 'Single Family'
                    }
                };
            } catch (error) {
                console.error('Error fetching property data:', error);
                throw error;
            }
        }
        // Generate AI analysis for individual property
        async function generatePropertyAIAnalysis(propertyIndex) {
            const property = properties[propertyIndex];
            if (!property) {
                alert('Property not found');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('aiAnalysisContent').innerHTML = 'Generating AI analysis...';
                document.getElementById('aiAnalysisSection').style.display = 'block';
                
                console.log('🤖 Generating AI analysis for property:', property.address);
                
                // Calculate financial metrics
                const purchasePrice = property.purchasePrice || property.estimatedValue || 0;
                const monthlyRent = property.monthlyRent || property.rentEstimate || 0;
                const downPayment = property.downPayment || (purchasePrice * 0.2);
                const loanAmount = purchasePrice - downPayment;
                const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.065, 30);
                const totalExpenses = calculateTotalExpenses(property);
                const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
                const annualCashFlow = monthlyCashFlow * 12;
                const cashOnCashReturn = downPayment > 0 ? (annualCashFlow / downPayment) * 100 : 0;
                const noi = monthlyRent * 12 - totalExpenses * 12;
                const capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;
                const dscr = monthlyMortgage > 0 ? (monthlyRent * 12) / (monthlyMortgage * 12) : 0;
                
                // 5-year projections
                const rentGrowth = 0.03;
                const appreciationRate = 0.04;
                const projectedValue5yr = purchasePrice * Math.pow(1 + appreciationRate, 5);
                const projectedRent5yr = monthlyRent * Math.pow(1 + rentGrowth, 5);
                const totalReturn5yr = (projectedValue5yr - purchasePrice) + (annualCashFlow * 5);
                const roi5yr = downPayment > 0 ? (totalReturn5yr / downPayment) * 100 : 0;
                
                // Create enhanced prompt for individual property analysis
                const prompt = `You are a real estate investment expert. Analyze this property and provide a comprehensive investment report.

PROPERTY DETAILS:
Address: ${property.address}, ${property.city}, ${property.state} ${property.zip}
Property Type: ${property.propertyType || 'Single Family'}
Bedrooms: ${property.beds || property.bedrooms || 'N/A'}
Bathrooms: ${property.baths || property.bathrooms || 'N/A'}
Square Feet: ${property.sqft || property.squareFootage || 'N/A'}
Year Built: ${property.yearBuilt || 'N/A'}

FINANCIAL ANALYSIS:
Purchase Price: $${purchasePrice.toLocaleString()}
Down Payment (20%): $${downPayment.toLocaleString()}
Monthly Rent: $${monthlyRent.toLocaleString()}
Rent Estimate (RentCast): $${property.rentEstimate || 'N/A'}
Estimated Value (RentCast): $${property.estimatedValue ? property.estimatedValue.toLocaleString() : 'N/A'}

CASH FLOW ANALYSIS:
Monthly Cash Flow: $${monthlyCashFlow.toLocaleString()}
Annual Cash Flow: $${annualCashFlow.toLocaleString()}
Cash-on-Cash Return: ${cashOnCashReturn.toFixed(2)}%
Cap Rate: ${capRate.toFixed(2)}%
Debt Service Coverage Ratio: ${dscr.toFixed(2)}

PROJECTIONS (5-Year):
Projected Property Value: $${projectedValue5yr.toLocaleString()}
Projected Monthly Rent: $${projectedRent5yr.toLocaleString()}
Total ROI (5-Year): ${roi5yr.toFixed(1)}%

MARKET DATA:
${property.marketStats ? JSON.stringify(property.marketStats, null, 2) : 'Market data not available'}

DATA SOURCE: ${property.realTimeData ? 'Real-time RentCast API data' : 'Manual/estimated data'}
Last Updated: ${property.lastRentCastUpdate ? new Date(property.lastRentCastUpdate).toLocaleDateString() : 'N/A'}

Please provide a comprehensive analysis covering:

1. **INVESTMENT GRADE** (A+ to F): Overall rating with brief explanation
2. **FINANCIAL PERFORMANCE**: Analysis of cash flow, returns, and key ratios
3. **MARKET POSITION**: How this property compares to market averages
4. **RISK ASSESSMENT**: Identify potential risks and concerns
5. **GROWTH POTENTIAL**: Long-term appreciation and income growth prospects
6. **RECOMMENDATIONS**: Specific actionable advice (buy, hold, pass, negotiate)
7. **OPTIMIZATION OPPORTUNITIES**: Ways to improve returns
8. **RED FLAGS**: Any concerning aspects that need attention

Format your response in clear sections with bullet points where appropriate. Be specific and actionable in your recommendations.`;

                // Send to AI for analysis
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (!response.ok) {
                    throw new Error(`AI Analysis failed: ${response.status}`);
                }
                
                const aiData = await response.json();
                if (!aiData.success) {
                    throw new Error(aiData.error || 'AI analysis failed');
                }
                
                // Format and display the analysis
                const analysisText = aiData.analysis || 'No analysis returned';
                document.getElementById('aiAnalysisContent').innerHTML = formatAIResponse(analysisText);
                
                console.log('✅ AI analysis completed successfully');
                
            } catch (error) {
                console.error('❌ Error generating property AI analysis:', error);
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <div style="color: var(--accent-danger); padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid var(--accent-danger);">
                        <h4 style="margin-top: 0;">❌ Analysis Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        
                        <p><strong>Troubleshooting:</strong></p>
                        <ul style="margin: 10px 0;">
                            <li>Make sure the server is running (npm start)</li>
                            <li>Check that you're accessing http://localhost:3000</li>
                            <li>Verify Gemini API key is configured</li>
                            <li>Check server console for detailed errors</li>
                        </ul>
                        
                        <button class="btn btn-secondary" onclick="generatePropertyAIAnalysis(${propertyIndex})" style="margin-top: 10px;">
                            <i class="fas fa-redo"></i> Retry Analysis
                        </button>
                    </div>
                `;
            }
        }

        // Export AI Insights Report
        function exportAIInsightsReport(address, propertyData, aiAnalysis) {
            const purchasePrice = propertyData.estimatedValue || propertyData.price || 500000;
            const monthlyRent = propertyData.rentEstimate || 2500;
            const downPayment = propertyData.downPayment || (purchasePrice * 0.2);
            const loanAmount = purchasePrice - downPayment;
            const monthlyMortgage = calculateMortgagePayment(loanAmount, 0.07, 30);
            
            const propertyTax = (purchasePrice * 0.012) / 12;
            const insurance = (purchasePrice * 0.004) / 12;
            const maintenance = purchasePrice * 0.001;
            const management = monthlyRent * 0.1;
            const totalExpenses = propertyTax + insurance + maintenance + management;
            
            const monthlyCashFlow = monthlyRent - monthlyMortgage - totalExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const noi = monthlyRent * 12 - totalExpenses * 12;
            const capRate = (noi / purchasePrice) * 100;
            const dscr = monthlyRent / monthlyMortgage;
            
            const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>AI Investment Analysis - ${address}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        max-width: 900px;
                        margin: 0 auto;
                        padding: 20px;
                        background: #0a0a0a;
                        color: #ffffff;
                    }
                    .header {
                        background: #1a1a1a;
                        padding: 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        text-align: center;
                        border: 1px solid #333;
                    }
                    .header h1 {
                        margin: 0;
                        color: #3b82f6;
                    }
                    .section {
                        background: #1a1a1a;
                        padding: 25px;
                        margin-bottom: 20px;
                        border-radius: 8px;
                        border: 1px solid #333;
                    }
                    .section h2 {
                        color: #3b82f6;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #3b82f6;
                        padding-bottom: 10px;
                    }
                    .metrics {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .metric {
                        background: #242424;
                        padding: 20px;
                        border-radius: 6px;
                        text-align: center;
                        border: 1px solid #404040;
                    }
                    .metric-label {
                        color: #b0b0b0;
                        font-size: 14px;
                        margin-bottom: 8px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: bold;
                        color: #ffffff;
                    }
                    .positive { color: #10b981; }
                    .negative { color: #ef4444; }
                    .warning { color: #f59e0b; }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                        background: #242424;
                    }
                    th, td {
                        padding: 12px;
                        text-align: left;
                        border-bottom: 1px solid #404040;
                    }
                    th {
                        background: #1a1a1a;
                        font-weight: 600;
                        color: #3b82f6;
                    }
                    .ai-content {
                        background: #242424;
                        padding: 20px;
                        border-radius: 6px;
                        margin-top: 20px;
                        border: 1px solid #404040;
                        color: #ffffff;
                    }
                    .ai-content h3 {
                        color: #3b82f6;
                        margin-top: 0;
                    }
                    .footer {
                        text-align: center;
                        color: #808080;
                        margin-top: 40px;
                        padding: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>AI Investment Analysis Report</h1>
                    <p>${address}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="section">
                    <h2>Financial Metrics Summary</h2>
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">Monthly Cash Flow</div>
                            <div class="metric-value ${monthlyCashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthlyCashFlow)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cash-on-Cash Return</div>
                            <div class="metric-value ${cashOnCashReturn >= 8 ? 'positive' : 'warning'}">${cashOnCashReturn.toFixed(1)}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cap Rate</div>
                            <div class="metric-value ${capRate >= 6 ? 'positive' : 'warning'}">${capRate.toFixed(1)}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">DSCR</div>
                            <div class="metric-value ${dscr >= 1.25 ? 'positive' : 'warning'}">${dscr.toFixed(2)}</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>AI Analysis</h2>
                    <div class="ai-content">
                        ${formatAIResponse(aiAnalysis)}
                    </div>
                </div>

                <div class="footer">
                    <p>Real Estate Investment Tracker - AI Powered Analysis</p>
                    <p>This report is for informational purposes only. Consult with professionals before making investment decisions.</p>
                </div>
            </body>
            </html>
            `;
            
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-investment-analysis-${address.replace(/[^a-z0-9]/gi, '-')}-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        /* REMOVED - Test property button was removed
        // Add test property for RentCast testing
        async function addTestProperty() {
            const testProperty = {
                address: '1500 S Eastern Ave',
                city: 'Las Vegas',
                state: 'NV',
                zip: '89104',
                propertyType: 'single-family',
                purchasePrice: 450000,
                monthlyRent: 2100,
                beds: 3,
                baths: 2,
                sqft: 1500,
                currentValue: 450000,
                status: 'available',
                dateAdded: new Date().toISOString(),
                realTimeData: false
            };
            
            console.log('🧪 Adding test property for RentCast testing:', testProperty);
            
            // Calculate initial metrics
            calculatePropertyMetrics(testProperty);
            
            // Add to properties array
            properties.push(testProperty);
            
            // Save and update display
            await saveProperties();
            updateDisplay();
            
            // Show instructions
            // Log success message to console instead of showing alert
            console.log(`🧪 Test Property Added Successfully!`);
            console.log(`📍 Address: ${testProperty.address}, ${testProperty.city}, ${testProperty.state} ${testProperty.zip}`);
            console.log(`💡 This address is known to work with RentCast API for testing!`);
        }
        */ // End of removed addTestProperty function
        
        // Debug: Log that we reached the end of script
        console.log('✅ Main script loaded completely');
        
        // Debug: Check if functions exist
        console.log('Function check:', {
            openModal: typeof window.openModal,
            closeModal: typeof window.closeModal,
            openAddPropertyModal: typeof window.openAddPropertyModal,
            openAnalyzeModal: typeof window.openAnalyzeModal,
            generateMarketInsights: typeof window.generateMarketInsights,
            generateAIInsights: typeof window.generateAIInsights,
            analyzeNewProperty: typeof window.analyzeNewProperty
        });

        // Initialize application on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing Real Estate Tracker...');
            
            try {
                // Load properties from server/localStorage
                await loadProperties();
                console.log('✅ Properties loaded:', properties.length);
                
                // Update mobile property cards if on mobile
                if (window.innerWidth <= 768) {
                    updateMobilePropertyCards();
                    console.log('📱 Mobile property cards updated');
                }
                
                // Handle window resize
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        updateDisplay();
                        updateMobilePropertyCards();
                    }, 250);
                });
                
                console.log('✅ Initialization complete');
            } catch (error) {
                console.error('❌ Error during initialization:', error);
            }
        });
    </script>
    
    <!-- Mobile Property Cards Display Fix -->
    <script>
    (function() {
        console.log('🔧 COMPREHENSIVE Mobile Display Fix Starting...');
        
        // Debug function to check current state
        function debugMobileState() {
            console.log('📊 Debug Info:');
            console.log('- Properties defined:', typeof properties !== 'undefined');
            console.log('- Properties count:', typeof properties !== 'undefined' ? properties.length : 'N/A');
            console.log('- Window width:', window.innerWidth);
            console.log('- Is mobile:', window.innerWidth <= 768);
            console.log('- Container exists:', !!document.getElementById('mobilePropertyCards'));
            
            const localData = localStorage.getItem('properties');
            console.log('- LocalStorage has data:', !!localData);
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    console.log('- LocalStorage properties count:', parsed.length);
                } catch (e) {
                    console.log('- LocalStorage data is invalid');
                }
            }
        }
        
        // Enhanced force update function
        function forceUpdateMobileDisplay() {
            console.log('🔄 Force updating mobile display...');
            
            const container = document.getElementById('mobilePropertyCards');
            if (!container) {
                console.error('❌ Mobile container not found!');
                return;
            }
            
            const isMobile = window.innerWidth <= 768;
            const tableContainer = document.querySelector('.table-container');
            
            if (!isMobile) {
                container.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'block';
                return;
            }
            
            // Mobile view - ensure visibility
            container.style.display = 'block';
            if (tableContainer) tableContainer.style.display = 'none';
            
            // Check if properties exist
            if (typeof properties === 'undefined' || !properties || properties.length === 0) {
                console.log('📭 No properties available');
                
                // Try to load from localStorage as fallback
                const localData = localStorage.getItem('properties');
                if (localData) {
                    try {
                        window.properties = JSON.parse(localData);
                        console.log('✅ Restored properties from localStorage:', properties.length);
                    } catch (e) {
                        console.error('❌ Failed to parse localStorage:', e);
                        window.properties = [];
                    }
                }
                
                if (!properties || properties.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <i class="fas fa-home" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>No Properties Yet</h3>
                            <p style="margin-bottom: 20px;">Start building your real estate portfolio!</p>
                            <button class="btn btn-primary" onclick="openAddPropertyModal()" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Add Your First Property
                            </button>
                            <div style="margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px; font-size: 12px;">
                                <strong>Debug:</strong> No properties loaded. Check console for details.
                            </div>
                        </div>
                    `;
                    return;
                }
            }
            
            // Get filtered properties
            let filteredProperties = properties;
            if (typeof getFilteredProperties === 'function') {
                filteredProperties = getFilteredProperties();
            }
            
            console.log(`📱 Rendering ${filteredProperties.length} of ${properties.length} properties`);
            
            if (filteredProperties.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-filter" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>No Properties Match Filters</h3>
                        <p>Try adjusting your search criteria</p>
                        <button class="btn btn-secondary" onclick="resetFilters()" style="margin-top: 20px;">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            // Create property cards
            let cardsHtml = '';
            filteredProperties.forEach((property, i) => {
                const globalIndex = properties.indexOf(property);
                
                if (typeof createMobilePropertyCard === 'function') {
                    cardsHtml += createMobilePropertyCard(property, globalIndex);
                } else {
                    // Fallback card HTML
                    cardsHtml += `
                        <div class="mobile-property-card" style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="margin-bottom: 15px;">
                                <h4 style="margin: 0; font-size: 18px; color: #333;">${property.address || 'Unknown Address'}</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                    ${property.city || 'Unknown'}, ${property.state || 'XX'} ${property.zip || ''}
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Purchase Price</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333;">
                                        $${((property.purchasePrice || property.purchase_price || 0) / 1000).toFixed(0)}k
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Monthly Rent</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333;">
                                        $${(property.monthlyRent || property.monthly_rent || 0).toLocaleString()}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Cash Flow</div>
                                    <div style="font-size: 16px; font-weight: 600; color: ${(property.cashFlow || property.monthlyCashFlow || 0) >= 0 ? '#28a745' : '#dc3545'};">
                                        $${(property.cashFlow || property.monthlyCashFlow || property.cash_flow || 0).toLocaleString()}
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">CoC Return</div>
                                    <div style="font-size: 16px; font-weight: 600; color: ${(property.cocReturn || property.cashOnCashReturn || 0) >= 8 ? '#28a745' : '#ffc107'};">
                                        ${property.cocReturn || property.cashOnCashReturn || property.coc_return ? 
                                            ((property.cocReturn || property.cashOnCashReturn || property.coc_return).toFixed(1) + '%') : 
                                            'N/A'}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button onclick="showPropertyDetails(${globalIndex})" 
                                    style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                <button onclick="refreshProperty(${globalIndex})" 
                                    style="padding: 10px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 14px;">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="deleteProperty(${globalIndex})" 
                                    style="padding: 10px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = cardsHtml;
            console.log(`✅ Rendered ${filteredProperties.length} property cards`);
        }
        
        // Override the updateMobilePropertyCards function with enhanced version
        const originalUpdate = window.updateMobilePropertyCards;
        window.updateMobilePropertyCards = function() {
            console.log('📱 updateMobilePropertyCards called (enhanced)');
            debugMobileState();
            
            try {
                if (originalUpdate && typeof originalUpdate === 'function') {
                    originalUpdate.call(this);
                } else {
                    forceUpdateMobileDisplay();
                }
            } catch (error) {
                console.error('❌ Error in updateMobilePropertyCards:', error);
                forceUpdateMobileDisplay();
            }
        };
        
        // Ensure properties are available globally
        if (typeof properties === 'undefined') {
            console.log('⚠️ Creating global properties array');
            window.properties = [];
        }
        
        // Set up delayed initialization to ensure everything is loaded
        function initializeMobileDisplay() {
            console.log('🚀 Initializing mobile display (delayed)...');
            debugMobileState();
            
            if (window.innerWidth <= 768) {
                forceUpdateMobileDisplay();
            }
        }
        
        // Multiple initialization attempts to ensure it works
        setTimeout(initializeMobileDisplay, 100);
        setTimeout(initializeMobileDisplay, 500);
        setTimeout(initializeMobileDisplay, 1000);
        setTimeout(initializeMobileDisplay, 2000);
        
        // Also initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMobileDisplay);
        } else {
            initializeMobileDisplay();
        }
        
        console.log('✅ COMPREHENSIVE Mobile Display Fix Applied');
    })();
    </script>
    
    <!-- EMERGENCY FIX COMPLETELY REMOVED - It was breaking working modal functions -->
    <!--
    <script>
    /* COMPLETELY DISABLED AND REMOVED
        console.log('🚨 EMERGENCY FIX: Redefining modal functions...');
        
        // Helper function to safely get element
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`❌ Element not found: ${id}`);
            }
            return element;
        }
        
        // Redefine openModal function with lag fix
        window.openModal = function(modalId) {
            console.log(`🔧 EMERGENCY openModal called with: ${modalId}`);
            try {
                const modal = safeGetElement(modalId);
                if (modal) {
                    // Remove any animations temporarily
                    const originalAnimation = modal.style.animation;
                    modal.style.animation = 'none';
                    
                    // Show modal
                    modal.style.display = 'block';
                    
                    // Force immediate repaint to fix lag
                    void modal.offsetWidth; // Force reflow
                    modal.style.opacity = '1';
                    modal.style.visibility = 'visible';
                    
                    // Restore animation after repaint
                    requestAnimationFrame(() => {
                        modal.style.animation = originalAnimation || '';
                    });
                    
                    console.log(`✅ Modal opened with repaint fix: ${modalId}`);
                } else {
                    console.error(`❌ Cannot open modal - element not found: ${modalId}`);
                }
            } catch (error) {
                console.error('❌ Error in openModal:', error);
            }
        };
        
        // Redefine closeModal function
        window.closeModal = function(modalId) {
            console.log(`🔧 EMERGENCY closeModal called with: ${modalId}`);
            try {
                const modal = safeGetElement(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    // Restore body scrolling
                    document.body.style.overflow = '';
                    console.log(`✅ Modal closed: ${modalId}`);
                }
            } catch (error) {
                console.error('❌ Error in closeModal:', error);
            }
        };
        
        // Redefine openAnalyzeModal function
        window.openAnalyzeModal = function() {
            console.log('🔧 EMERGENCY openAnalyzeModal called');
            try {
                // Check if analyzeModal exists (note: no hyphen!)
                const modal = safeGetElement('analyzeModal');
                if (!modal) {
                    console.error('❌ analyzeModal not found in DOM');
                    // List all modals in DOM for debugging
                    const allModals = document.querySelectorAll('.modal');
                    console.log('📋 Available modals:', Array.from(allModals).map(m => m.id));
                    return;
                }
                
                // Open the modal
                window.openModal('analyzeModal');
                
                // Clear form
                const form = safeGetElement('analyze-form');
                if (form) {
                    form.reset();
                    console.log('✅ Analyze form reset');
                }
                
                // Clear results
                const results = safeGetElement('analyze-results');
                if (results) {
                    results.innerHTML = '';
                    console.log('✅ Analyze results cleared');
                }
            } catch (error) {
                console.error('❌ Error in openAnalyzeModal:', error);
            }
        };
        
        // Redefine generateMarketInsights function
        window.generateMarketInsights = function() {
            console.log('🔧 EMERGENCY generateMarketInsights called');
            try {
                // Check if marketInsightsModal exists (note: camelCase!)
                const modal = safeGetElement('marketInsightsModal');
                if (!modal) {
                    console.error('❌ marketInsightsModal not found in DOM');
                    // List all modals in DOM for debugging
                    const allModals = document.querySelectorAll('.modal');
                    console.log('📋 Available modals:', Array.from(allModals).map(m => m.id));
                    return;
                }
                
                // Check if properties exist
                if (typeof window.properties === 'undefined' || !Array.isArray(window.properties)) {
                    console.error('❌ Properties array not found or invalid');
                    window.properties = [];
                }
                
                if (window.properties.length === 0) {
                    alert('Add some properties first to generate insights!');
                    return;
                }
                
                // Open the modal
                window.openModal('marketInsightsModal');
                
                // Generate insights
                if (typeof window.generateAIInsights === 'function') {
                    console.log('✅ Calling generateAIInsights...');
                    window.generateAIInsights();
                } else {
                    console.error('❌ generateAIInsights function not found');
                    // Fallback: Show basic message
                    const content = safeGetElement('insights-content');
                    if (content) {
                        content.innerHTML = '<p>AI insights generation is currently unavailable. Please refresh the page and try again.</p>';
                    }
                }
            } catch (error) {
                console.error('❌ Error in generateMarketInsights:', error);
            }
        };
        
        // Test modal existence on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 EMERGENCY FIX: Checking modal elements...');
            
            const modalsToCheck = ['analyzeModal', 'marketInsightsModal', 'addPropertyModal', 'propertyModal'];
            modalsToCheck.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    console.log(`✅ Modal found: ${modalId}`);
                } else {
                    console.error(`❌ Modal NOT found: ${modalId}`);
                }
            });
            
            // Check if buttons exist and have correct onclick handlers
            const analyzeBtn = document.querySelector('button[onclick*="openAnalyzeModal"]');
            const insightsBtn = document.querySelector('button[onclick*="generateMarketInsights"]');
            
            if (analyzeBtn) {
                console.log('✅ Analyze button found');
            } else {
                console.error('❌ Analyze button NOT found');
            }
            
            if (insightsBtn) {
                console.log('✅ Insights button found');
            } else {
                console.error('❌ Insights button NOT found');
            }
            
            // Final function availability check
            console.log('📋 Final function check:', {
                openModal: typeof window.openModal,
                closeModal: typeof window.closeModal,
                openAnalyzeModal: typeof window.openAnalyzeModal,
                generateMarketInsights: typeof window.generateMarketInsights
            });
        });
        
        console.log('✅ EMERGENCY FIX: Modal functions redefined successfully');
    */ // END OF DISABLED EMERGENCY FIX
    </script>
    -->
        
        <!-- ============= MODAL LAG FIX COMPLETELY REMOVED ============= -->
        <!--
        <script>
        /* DISABLED AND REMOVED - This was overriding working modal functions
        // Fix for delayed modal response - Final override
        setTimeout(() => {
            console.log('🚀 Applying final modal lag fix...');
            
            // Store references to current functions
            const _openModal = window.openModal;
            const _openAnalyzeModal = window.openAnalyzeModal;
            const _generateMarketInsights = window.generateMarketInsights;
            
            // Enhanced openModal with immediate response
            window.openModal = function(modalId) {
                console.log(`⚡ Fast openModal: ${modalId}`);
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                // Find modal content element
                const modalContent = modal.querySelector('.modal-content');
                
                // Disable ALL transitions/animations on modal and content
                modal.style.transition = 'none !important';
                modal.style.animation = 'none !important';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                
                if (modalContent) {
                    modalContent.style.transition = 'none !important';
                    modalContent.style.animation = 'none !important';
                    modalContent.style.opacity = '1';
                    modalContent.style.transform = 'none';
                    modalContent.style.visibility = 'visible';
                }
                
                // Show immediately
                modal.style.display = 'block';
                
                // Force repaint
                void modal.offsetHeight;
                
                // Ensure visibility after repaint
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                
                // Keep animations disabled for instant response
                // Do NOT re-enable animations as it causes lag
            };
            
            // Fast openAnalyzeModal
            window.openAnalyzeModal = function() {
                console.log('⚡ Fast openAnalyzeModal');
                // Clear fields
                const input = document.getElementById('propertyAddressInput');
                const results = document.getElementById('analysisResults');
                const loading = document.getElementById('analysisLoading');
                
                if (input) input.value = '';
                if (results) results.innerHTML = '';
                if (loading) loading.style.display = 'none';
                
                // Use fast openModal
                window.openModal('analyzeModal');
            };
            
            // Fast generateMarketInsights
            window.generateMarketInsights = async function() {
                console.log('⚡ Fast generateMarketInsights');
                // Open modal immediately
                window.openModal('marketInsightsModal');
                
                // Show loading state
                const loading = document.getElementById('marketInsightsLoading');
                const content = document.getElementById('marketInsightsContent');
                
                if (loading) loading.style.display = 'block';
                if (content) content.style.display = 'none';
                
                // Load market insights content
                try {
                    const marketData = await fetchMarketData();
                    const html = generateMarketInsightsContent(marketData);
                    
                    if (content) content.innerHTML = html;
                    if (content) content.style.display = 'block';
                } catch (error) {
                    console.error('Error generating insights:', error);
                    if (content) {
                        content.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Unable to generate market insights at this time. Please try again later.</p>
                            </div>
                        `;
                        content.style.display = 'block';
                    }
                } finally {
                    if (loading) loading.style.display = 'none';
                }
            };
            
            // Fast openAddPropertyModal (ensure consistency)
            window.openAddPropertyModal = function() {
                console.log('⚡ Fast openAddPropertyModal');
                // Clear form
                const form = document.getElementById('addPropertyForm');
                const fullAddress = document.getElementById('fullAddress');
                
                if (form) form.reset();
                if (fullAddress) fullAddress.value = '';
                
                // Use fast openModal
                window.openModal('addPropertyModal');
            };
            
            console.log('✅ Modal lag fix applied - immediate response enabled');
        }, 100); // Small delay to ensure everything is loaded
        */ // END OF DISABLED MODAL LAG FIX
    </script>
    -->
    
    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav">
        <div class="mobile-bottom-nav-content">
            <a href="#" class="mobile-bottom-nav-item" onclick="scrollToTop()">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="mobile-bottom-nav-item" onclick="openAddPropertyModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </a>
            <a href="#" class="mobile-bottom-nav-item" onclick="showAnalyzeModal()">
                <i class="fas fa-search"></i>
                <span>Analyze</span>
            </a>
            <a href="#" class="mobile-bottom-nav-item" onclick="exportData()">
                <i class="fas fa-download"></i>
                <span>Export</span>
            </a>
        </div>
    </div>
    
</body>
</html>