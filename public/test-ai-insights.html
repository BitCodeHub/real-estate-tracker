<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Market Insights</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .test-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-properties {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .property-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .property-card h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .property-card p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        button {
            background: #764ba2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5a3990;
        }
        
        #results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <h1>AI Market Insights Test</h1>
    
    <div class="test-section">
        <h2>Test Properties</h2>
        <p>Click on any property below to test the AI Market Insights feature:</p>
        
        <div class="test-properties">
            <div class="property-card">
                <h3>Premium Location</h3>
                <p><strong>Address:</strong> 123 Ocean View Dr, Malibu, CA 90265</p>
                <p><strong>Expected Price:</strong> ~$2,500,000</p>
                <p><strong>Expected Rent:</strong> ~$8,000/mo</p>
                <button onclick="testProperty('123 Ocean View Dr, Malibu, CA 90265')">Test AI Analysis</button>
            </div>
            
            <div class="property-card">
                <h3>Suburban Family Home</h3>
                <p><strong>Address:</strong> 456 Maple Street, Plano, TX 75023</p>
                <p><strong>Expected Price:</strong> ~$450,000</p>
                <p><strong>Expected Rent:</strong> ~$2,800/mo</p>
                <button onclick="testProperty('456 Maple Street, Plano, TX 75023')">Test AI Analysis</button>
            </div>
            
            <div class="property-card">
                <h3>Urban Condo</h3>
                <p><strong>Address:</strong> 789 Downtown Ave, Austin, TX 78701</p>
                <p><strong>Expected Price:</strong> ~$600,000</p>
                <p><strong>Expected Rent:</strong> ~$3,200/mo</p>
                <button onclick="testProperty('789 Downtown Ave, Austin, TX 78701')">Test AI Analysis</button>
            </div>
            
            <div class="property-card">
                <h3>Investment Property</h3>
                <p><strong>Address:</strong> 321 College Ave, Columbus, OH 43201</p>
                <p><strong>Expected Price:</strong> ~$250,000</p>
                <p><strong>Expected Rent:</strong> ~$1,800/mo</p>
                <button onclick="testProperty('321 College Ave, Columbus, OH 43201')">Test AI Analysis</button>
            </div>
        </div>
        
        <h3 style="margin-top: 30px;">Custom Address Test</h3>
        <input type="text" id="customAddress" placeholder="Enter any address" style="width: 400px; padding: 10px; margin-right: 10px;">
        <button onclick="testProperty(document.getElementById('customAddress').value)">Test Custom Address</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="loading" class="loading" style="display: none;">Loading AI analysis...</div>
        <div id="results"></div>
    </div>
    
    <script>
        // Copy the AI functions from main index.html
        const GEMINI_API_KEY = 'AIzaSyCgpECc-whrISaCwlwxXiZV_YppN4dTQT4';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
        
        // Simple geocoding function for testing
        async function geocodeAddress(address) {
            // For testing, return mock data based on state
            const state = address.includes('CA') ? 'CA' : 
                        address.includes('TX') ? 'TX' : 
                        address.includes('OH') ? 'OH' : 'NY';
            
            const city = address.includes('Malibu') ? 'Malibu' :
                        address.includes('Plano') ? 'Plano' :
                        address.includes('Austin') ? 'Austin' :
                        address.includes('Columbus') ? 'Columbus' : 'Unknown';
            
            return {
                formatted: address,
                city: city,
                state: state,
                lat: 34.0522,
                lng: -118.2437
            };
        }
        
        // Fetch property details (mock for testing)
        async function fetchPropertyDetails(locationData) {
            const estimates = {
                beds: 3,
                baths: 2,
                sqft: 1500,
                year: 2000,
                price: 500000,
                rentEstimate: 2500,
                propertyType: 'Single Family',
                taxRate: 0.012,
                insuranceRate: 0.004,
                hoaMonthly: 150
            };
            
            // Adjust based on location
            if (locationData.city === 'Malibu') {
                estimates.price = 2500000;
                estimates.rentEstimate = 8000;
                estimates.sqft = 3500;
                estimates.beds = 4;
                estimates.baths = 3;
            } else if (locationData.city === 'Plano') {
                estimates.price = 450000;
                estimates.rentEstimate = 2800;
            } else if (locationData.city === 'Austin') {
                estimates.price = 600000;
                estimates.rentEstimate = 3200;
                estimates.propertyType = 'Condo';
            } else if (locationData.city === 'Columbus') {
                estimates.price = 250000;
                estimates.rentEstimate = 1800;
                estimates.hoaMonthly = 50;
            }
            
            return estimates;
        }
        
        // Calculate financial metrics (same as main file)
        function calculateFinancialMetrics(property) {
            const purchasePrice = property.price || 0;
            const monthlyRent = property.rentEstimate || 0;
            const downPayment = purchasePrice * 0.2;
            const loanAmount = purchasePrice - downPayment;
            
            const mortgageRate = 0.07 / 12;
            const mortgageMonths = 360;
            const monthlyMortgage = loanAmount * (mortgageRate * Math.pow(1 + mortgageRate, mortgageMonths)) / (Math.pow(1 + mortgageRate, mortgageMonths) - 1);
            const monthlyTaxes = (purchasePrice * (property.taxRate || 0.012)) / 12;
            const monthlyInsurance = (purchasePrice * (property.insuranceRate || 0.004)) / 12;
            const monthlyHOA = property.hoaMonthly || 0;
            const monthlyMaintenance = purchasePrice * 0.001;
            const propertyManagement = monthlyRent * 0.1;
            
            const totalMonthlyExpenses = monthlyMortgage + monthlyTaxes + monthlyInsurance + monthlyHOA + monthlyMaintenance + propertyManagement;
            const monthlyCashFlow = monthlyRent - totalMonthlyExpenses;
            const annualCashFlow = monthlyCashFlow * 12;
            
            const cashOnCashReturn = (annualCashFlow / downPayment) * 100;
            const capRate = ((monthlyRent * 12 - (monthlyTaxes + monthlyInsurance + monthlyHOA + monthlyMaintenance) * 12) / purchasePrice) * 100;
            const dscr = monthlyRent / monthlyMortgage;
            
            // 5-year projection
            const rentGrowthRate = 0.03;
            const appreciationRate = 0.04;
            let totalReturn = 0;
            let projectedValue = purchasePrice;
            let projectedRent = monthlyRent;
            
            for (let year = 1; year <= 5; year++) {
                projectedValue *= (1 + appreciationRate);
                projectedRent *= (1 + rentGrowthRate);
                const yearCashFlow = (projectedRent - totalMonthlyExpenses) * 12;
                totalReturn += yearCashFlow;
            }
            
            const equity5Year = projectedValue - (loanAmount * 0.85);
            const totalReturn5Year = totalReturn + equity5Year - downPayment;
            const roi5Year = (totalReturn5Year / downPayment) * 100;
            
            return {
                purchasePrice,
                downPayment,
                monthlyRent,
                totalMonthlyExpenses,
                monthlyCashFlow,
                annualCashFlow,
                cashOnCashReturn,
                capRate,
                dscr,
                roi5Year,
                projectedValue,
                projectedRent
            };
        }
        
        async function testProperty(address) {
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            
            try {
                const locationData = await geocodeAddress(address);
                const propertyDetails = await fetchPropertyDetails(locationData);
                const metrics = calculateFinancialMetrics(propertyDetails);
                
                // Prepare prompt
                const prompt = `
                    You are an experienced real estate investor and financial advisor. Analyze this property and provide comprehensive investment insights.
                    
                    Property Details:
                    - Address: ${address}
                    - Location: ${locationData.city}, ${locationData.state}
                    - Estimated Price: $${propertyDetails.price.toLocaleString()}
                    - Estimated Rent: $${propertyDetails.rentEstimate.toLocaleString()}/month
                    - Property Type: ${propertyDetails.propertyType}
                    - Bedrooms: ${propertyDetails.beds}, Bathrooms: ${propertyDetails.baths}
                    - Square Feet: ${propertyDetails.sqft}
                    - Year Built: ${propertyDetails.year}
                    
                    Financial Metrics:
                    - Monthly Cash Flow: $${metrics.monthlyCashFlow.toFixed(2)}
                    - Annual Cash Flow: $${metrics.annualCashFlow.toFixed(2)}
                    - Cash-on-Cash Return: ${metrics.cashOnCashReturn.toFixed(2)}%
                    - Cap Rate: ${metrics.capRate.toFixed(2)}%
                    - Debt Service Coverage Ratio: ${metrics.dscr.toFixed(2)}
                    - 5-Year ROI Projection: ${metrics.roi5Year.toFixed(2)}%
                    
                    Provide a comprehensive analysis including:
                    1. Overall Investment Rating (Excellent/Good/Fair/Poor)
                    2. Key Strengths and Opportunities
                    3. Risk Assessment:
                       - Crime risk level for the neighborhood
                       - Natural disaster risks (flood, earthquake, hurricane)
                       - Market volatility risk
                       - Tenant risk factors
                    4. Profitability Analysis:
                       - Is the cash flow sustainable?
                       - How does it compare to the 8% cash-on-cash target?
                       - Cap rate analysis (6%+ is good)
                       - DSCR analysis (1.25+ is preferred)
                    5. 5-Year Investment Outlook:
                       - Expected appreciation
                       - Rental growth potential
                       - Exit strategy recommendations
                    6. Specific Recommendations:
                       - Should they buy, hold, or pass?
                       - Suggested improvements to increase ROI
                       - Alternative investment strategies
                    
                    Format your response with clear sections and bullet points. Be specific and data-driven.
                `;
                
                // Call Gemini API
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                const aiAnalysis = data.candidates[0].content.parts[0].text;
                
                // Display results
                document.getElementById('results').innerHTML = `
                    <h3>Property: ${address}</h3>
                    <h4>Financial Metrics:</h4>
                    <ul>
                        <li>Monthly Cash Flow: $${metrics.monthlyCashFlow.toFixed(2)}</li>
                        <li>Cash-on-Cash Return: ${metrics.cashOnCashReturn.toFixed(2)}%</li>
                        <li>Cap Rate: ${metrics.capRate.toFixed(2)}%</li>
                        <li>DSCR: ${metrics.dscr.toFixed(2)}</li>
                        <li>5-Year ROI: ${metrics.roi5Year.toFixed(2)}%</li>
                    </ul>
                    <h4>AI Analysis:</h4>
                    <div>${aiAnalysis}</div>
                `;
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('results').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>