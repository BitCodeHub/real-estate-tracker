<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diagnose Click Issue</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #00ff00;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        .section {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .success { color: #00ff00; }
        .info { color: #00ffff; }
        button {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005500;
        }
        pre {
            background: #111;
            padding: 10px;
            border: 1px solid #333;
            overflow-x: auto;
        }
        .test-address {
            color: #00ffff;
            text-decoration: underline;
            cursor: pointer;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Real-Time Click Diagnostics</h1>
        
        <div class="section">
            <h2>Step 1: Load Main App in iFrame</h2>
            <button onclick="loadApp()">Load Application</button>
            <button onclick="runAllDiagnostics()">Run All Diagnostics</button>
            <div id="appStatus"></div>
        </div>
        
        <div class="section">
            <h2>Step 2: DOM Analysis</h2>
            <div id="domAnalysis"></div>
        </div>
        
        <div class="section">
            <h2>Step 3: Event Listener Analysis</h2>
            <div id="eventAnalysis"></div>
        </div>
        
        <div class="section">
            <h2>Step 4: Function Availability</h2>
            <div id="functionAnalysis"></div>
        </div>
        
        <div class="section">
            <h2>Step 5: Live Click Test</h2>
            <div id="clickTest"></div>
        </div>
        
        <div class="section">
            <h2>Step 6: Console Monitor</h2>
            <div id="consoleMonitor" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        
        <iframe id="appFrame" src="/" style="width: 100%; height: 400px; border: 1px solid #00ff00; margin-top: 20px; display: none;"></iframe>
    </div>
    
    <script>
        const logs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        // Intercept console logs
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logs.push({ type: 'log', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateConsoleMonitor();
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logs.push({ type: 'error', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateConsoleMonitor();
        };
        
        function updateConsoleMonitor() {
            const monitor = document.getElementById('consoleMonitor');
            monitor.innerHTML = logs.slice(-10).reverse().map(log => 
                `<div class="${log.type === 'error' ? 'error' : 'info'}">[${log.time}] ${escapeHtml(log.message)}</div>`
            ).join('');
        }
        
        function loadApp() {
            const frame = document.getElementById('appFrame');
            const status = document.getElementById('appStatus');
            
            frame.style.display = 'block';
            frame.src = '/';
            
            status.innerHTML = '<div class="warning">Loading application...</div>';
            
            frame.onload = function() {
                status.innerHTML = '<div class="success">‚úì Application loaded</div>';
                setTimeout(() => {
                    runAllDiagnostics();
                }, 1000);
            };
        }
        
        async function runAllDiagnostics() {
            console.log('Starting diagnostics...');
            
            // Get iframe window
            const frame = document.getElementById('appFrame');
            const frameWindow = frame.contentWindow;
            const frameDoc = frame.contentDocument;
            
            // DOM Analysis
            analyzeDom(frameDoc);
            
            // Event Listener Analysis
            analyzeEventListeners(frameDoc, frameWindow);
            
            // Function Analysis
            analyzeFunctions(frameWindow);
            
            // Click Test
            setupClickTest(frameDoc, frameWindow);
        }
        
        function analyzeDom(doc) {
            const output = document.getElementById('domAnalysis');
            let html = '<h3>DOM Elements Check:</h3>';
            
            const checks = [
                { id: 'propertyTableBody', desc: 'Table Body' },
                { id: 'propertyModal', desc: 'Property Modal' },
                { id: 'modalTitle', desc: 'Modal Title' },
                { id: 'modalBody', desc: 'Modal Body' }
            ];
            
            checks.forEach(check => {
                const element = doc.getElementById(check.id);
                html += `<div class="${element ? 'success' : 'error'}">
                    ${check.desc} (#${check.id}): ${element ? '‚úì Found' : '‚úó Missing'}
                </div>`;
                
                if (element && check.id === 'propertyTableBody') {
                    const rows = element.querySelectorAll('tr');
                    const addressSpans = element.querySelectorAll('[data-action="show-property"]');
                    html += `<div class="info">  ‚Üí Table has ${rows.length} rows</div>`;
                    html += `<div class="info">  ‚Üí Found ${addressSpans.length} clickable addresses</div>`;
                    
                    if (addressSpans.length > 0) {
                        const firstSpan = addressSpans[0];
                        html += `<div class="info">  ‚Üí First address: "${firstSpan.textContent.trim()}"</div>`;
                        html += `<div class="info">  ‚Üí Has data-action: "${firstSpan.getAttribute('data-action')}"</div>`;
                        html += `<div class="info">  ‚Üí Has data-index: "${firstSpan.getAttribute('data-index')}"</div>`;
                    }
                }
            });
            
            output.innerHTML = html;
        }
        
        function analyzeEventListeners(doc, win) {
            const output = document.getElementById('eventAnalysis');
            let html = '<h3>Event Listener Check:</h3>';
            
            const tbody = doc.getElementById('propertyTableBody');
            
            if (tbody) {
                // Check for delegation setup
                const hasDelegation = tbody.hasAttribute('data-delegation-setup');
                html += `<div class="${hasDelegation ? 'success' : 'error'}">
                    Table delegation setup: ${hasDelegation ? '‚úì Yes' : '‚úó No'}
                </div>`;
                
                // Try to trigger setupTableEventDelegation
                if (win.setupTableEventDelegation && typeof win.setupTableEventDelegation === 'function') {
                    html += '<div class="warning">Calling setupTableEventDelegation()...</div>';
                    win.setupTableEventDelegation();
                    
                    const nowHasDelegation = tbody.hasAttribute('data-delegation-setup');
                    html += `<div class="${nowHasDelegation ? 'success' : 'error'}">
                        After manual setup: ${nowHasDelegation ? '‚úì Success' : '‚úó Failed'}
                    </div>`;
                }
                
                // Check for event listeners using Chrome's getEventListeners equivalent
                try {
                    // Create a test click event
                    const testClick = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: win
                    });
                    
                    // Add temporary listener to check
                    let listenerCalled = false;
                    const tempListener = (e) => { listenerCalled = true; };
                    tbody.addEventListener('click', tempListener);
                    tbody.dispatchEvent(testClick);
                    tbody.removeEventListener('click', tempListener);
                    
                    html += `<div class="${listenerCalled ? 'success' : 'warning'}">
                        Event propagation test: ${listenerCalled ? '‚úì Working' : '‚ö† Check needed'}
                    </div>`;
                } catch (e) {
                    html += `<div class="error">Event test error: ${e.message}</div>`;
                }
            } else {
                html += '<div class="error">Table body not found!</div>';
            }
            
            output.innerHTML = html;
        }
        
        function analyzeFunctions(win) {
            const output = document.getElementById('functionAnalysis');
            let html = '<h3>Function Availability:</h3>';
            
            const functions = [
                'showPropertyDetail',
                'closeModal',
                'setupTableEventDelegation',
                'renderTable',
                'refreshSingleProperty',
                'properties'
            ];
            
            functions.forEach(func => {
                const exists = typeof win[func] !== 'undefined';
                const type = exists ? typeof win[func] : 'undefined';
                html += `<div class="${exists ? 'success' : 'error'}">
                    window.${func}: ${exists ? `‚úì ${type}` : '‚úó Missing'}
                </div>`;
                
                if (func === 'properties' && exists && Array.isArray(win[func])) {
                    html += `<div class="info">  ‚Üí Contains ${win[func].length} properties</div>`;
                }
            });
            
            output.innerHTML = html;
        }
        
        function setupClickTest(doc, win) {
            const output = document.getElementById('clickTest');
            let html = '<h3>Live Click Testing:</h3>';
            
            // Find first clickable address
            const firstAddress = doc.querySelector('[data-action="show-property"]');
            
            if (firstAddress) {
                html += '<div class="info">Found clickable address. Testing different click methods:</div>';
                
                // Method 1: Direct click()
                html += '<div>Method 1: <button onclick="testDirectClick()">Test element.click()</button></div>';
                
                // Method 2: Dispatch event
                html += '<div>Method 2: <button onclick="testDispatchEvent()">Test dispatchEvent()</button></div>';
                
                // Method 3: Direct function call
                html += '<div>Method 3: <button onclick="testDirectFunction()">Test showPropertyDetail(0)</button></div>';
                
                // Show what will be clicked
                html += `<div class="info">Target element: <span class="test-address">${firstAddress.textContent.trim()}</span></div>`;
                html += `<div class="info">Target index: ${firstAddress.getAttribute('data-index')}</div>`;
                
                window.testDirectClick = function() {
                    console.log('Testing direct click()...');
                    firstAddress.click();
                    checkModalState(doc);
                };
                
                window.testDispatchEvent = function() {
                    console.log('Testing dispatchEvent()...');
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: win
                    });
                    firstAddress.dispatchEvent(clickEvent);
                    checkModalState(doc);
                };
                
                window.testDirectFunction = function() {
                    console.log('Testing direct function call...');
                    if (win.showPropertyDetail) {
                        win.showPropertyDetail(0);
                        checkModalState(doc);
                    } else {
                        console.error('showPropertyDetail not found!');
                    }
                };
                
            } else {
                html += '<div class="error">No clickable addresses found in the table!</div>';
            }
            
            html += '<div id="clickResult" style="margin-top: 10px;"></div>';
            output.innerHTML = html;
        }
        
        function checkModalState(doc) {
            const modal = doc.getElementById('propertyModal');
            const result = document.getElementById('clickResult');
            
            if (modal) {
                const display = modal.style.display;
                const computedDisplay = doc.defaultView.getComputedStyle(modal).display;
                
                result.innerHTML = `
                    <div class="${display === 'block' ? 'success' : 'warning'}">
                        Modal style.display: ${display || 'not set'}
                    </div>
                    <div class="${computedDisplay !== 'none' ? 'success' : 'warning'}">
                        Modal computed display: ${computedDisplay}
                    </div>
                `;
                
                if (display === 'block' || computedDisplay !== 'none') {
                    result.innerHTML += '<div class="success">‚úì Modal opened successfully!</div>';
                } else {
                    result.innerHTML += '<div class="error">‚úó Modal did not open</div>';
                }
            } else {
                result.innerHTML = '<div class="error">Modal element not found!</div>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Auto-load on page load
        window.onload = function() {
            console.log('Diagnostic tool loaded');
            loadApp();
        };
    </script>
</body>
</html>